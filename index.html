<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IHC Hub - Inverse Lookup + Quiz + Cascade v2.24</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --subtext: #64748b;
      --accent: #4f46e5;
      --pos: #059669;
      --neg: #dc2626;
      --warn: #d97706;
      --border: #e2e8f0;
      --shadow: rgba(0, 0, 0, 0.1);
      --fbf: #3b82f6;
      --sacco: #a855f7;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 30px;
      border-bottom: 3px solid var(--border);
    }

    h1 {
      font-size: 2.8rem;
      margin-bottom: 10px;
      background: linear-gradient(135deg, var(--fbf), var(--pos));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .version {
      color: var(--subtext);
      font-size: 0.95rem;
      margin-bottom: 15px;
    }

    .header-badges {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-block;
      background: var(--fbf);
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .badge.fbf { background: var(--fbf); }
    .badge.inverse { background: var(--warn); }
    .badge.quiz { background: var(--pos); }

    /* TAB NAVIGATION */
    .tabs-wrapper {
      background: var(--card);
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 30px;
      display: flex;
      gap: 8px;
      box-shadow: 0 2px 8px var(--shadow);
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      color: var(--subtext);
      transition: all 0.3s ease;
    }

    .tab-btn:hover { background: var(--bg); }
    .tab-btn.active { background: var(--fbf); color: white; }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* INVERSE LOOKUP STYLES */
    .lookup-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin-bottom: 40px;
    }

    .marker-panel {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 12px var(--shadow);
    }

    .marker-panel h2 {
      font-size: 1.4rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .marker-panel.positive h2 { color: var(--pos); }
    .marker-panel.negative h2 { color: var(--neg); }

    .marker-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 600px;
      overflow-y: auto;
      padding: 15px;
      background: var(--bg);
      border-radius: 8px;
      min-height: 100px;
      transition: all 0.3s ease;
      border: 2px dashed transparent;
    }

    .marker-grid.drag-over-pos {
      background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%);
      border-color: var(--pos);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2);
    }

    .marker-grid.drag-over-neg {
      background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);
      border-color: var(--neg);
      box-shadow: 0 8px 20px rgba(220, 38, 38, 0.2);
    }

    .marker-item {
      padding: 12px 15px;
      background: white;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: grab;
      user-select: none;
      transition: all 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px var(--shadow);
    }

    .marker-item:active { cursor: grabbing; opacity: 0.7; transform: scale(1.02); }
    .marker-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow); }
    .marker-item.dragging { opacity: 0.5; transform: scale(0.95); }

    .marker-item.selected-pos {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      border: 3px solid var(--pos);
      font-weight: 700;
      color: #065f46;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .marker-item.selected-neg {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border: 3px solid var(--neg);
      font-weight: 700;
      color: #7f1d1d;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    .marker-badge {
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 700;
    }

    .marker-badge.pos { background: var(--pos); color: white; }
    .marker-badge.neg { background: var(--neg); color: white; }

    .controls {
      grid-column: 1 / -1;
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-analyze { background: var(--fbf); color: white; }
    .btn-analyze:hover { transform: scale(1.05); box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3); }
    .btn-reset { background: var(--subtext); color: white; }
    .btn-reset:hover { background: #475569; }

    /* RESULTS */
    .results-container {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 12px var(--shadow);
    }

    .results-container h2 {
      font-size: 1.5rem;
      margin-bottom: 25px;
      color: var(--text);
    }

    .diagnosis-result {
      padding: 20px;
      background: var(--bg);
      border-left: 6px solid;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .diagnosis-result.high { border-color: var(--pos); background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%); }
    .diagnosis-result.medium { border-color: var(--warn); background: linear-gradient(135deg, #fef3c7 0%, #fefce8 100%); }
    .diagnosis-result.low { border-color: #94a3b8; background: linear-gradient(135deg, #f1f5f9 0%, #f8fafc 100%); }

    .dx-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .dx-name { font-size: 1.2rem; font-weight: 700; }

    .dx-score {
      font-size: 1.3rem;
      font-weight: 900;
      padding: 6px 15px;
      border-radius: 6px;
      background: white;
      box-shadow: 0 2px 6px var(--shadow);
    }

    .dx-score.high { color: var(--pos); }
    .dx-score.medium { color: var(--warn); }
    .dx-score.low { color: #94a3b8; }

    .dx-reasoning { font-size: 0.95rem; color: #475569; line-height: 1.7; }
    .marker-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }

    .marker-tag { padding: 4px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; }
    .marker-tag.pos { background: #dcfce7; color: #065f46; border: 1px solid #6ee7b7; }
    .marker-tag.neg { background: #fee2e2; color: #7f1d1d; border: 1px solid #fca5a5; }
    .marker-tag.sacco { background: #f3e8ff; color: #6b21a8; border: 1px solid #c084fc; font-style: italic; }

    /* QUIZ MODE */
    .quiz-container { max-width: 1000px; margin: 0 auto; }

    .quiz-card {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 4px 12px var(--shadow);
      text-align: center;
      margin-bottom: 30px;
    }

    .quiz-title { font-size: 1.8rem; margin-bottom: 30px; color: var(--fbf); font-weight: 700; }

    .markers-display {
      background: var(--bg);
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      border: 2px solid var(--fbf);
    }

    .markers-display h3 { margin-bottom: 15px; color: var(--text); }

    .marker-list-quiz { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }

    .marker-chip {
      padding: 10px 20px;
      background: white;
      border: 2px solid var(--fbf);
      border-radius: 20px;
      font-weight: 600;
      color: var(--fbf);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .diagnosis-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .dx-option {
      padding: 20px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      text-align: center;
    }

    .dx-option:hover { transform: translateY(-4px); box-shadow: 0 8px 16px var(--shadow); border-color: var(--fbf); }
    .dx-option.selected { background: var(--fbf); color: white; border-color: var(--fbf); }

    .feedback {
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      font-size: 1.1rem;
      font-weight: 600;
      display: none;
    }

    .feedback.correct { background: #dcfce7; color: #065f46; border: 2px solid var(--pos); display: block; }
    .feedback.incorrect { background: #fee2e2; color: #7f1d1d; border: 2px solid var(--neg); display: block; }

    .stats {
      background: var(--bg);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
      display: flex;
      justify-content: space-around;
      gap: 20px;
    }

    .stat-box { flex: 1; }
    .stat-label { font-size: 0.9rem; color: var(--subtext); margin-bottom: 5px; }
    .stat-value { font-size: 2rem; font-weight: 900; color: var(--fbf); }

    .empty-state { text-align: center; padding: 60px 20px; color: var(--subtext); }
    .empty-state h2 { font-size: 1.5rem; margin-bottom: 15px; color: var(--text); }

    .info-box {
      background: #fef3c7;
      border: 2px solid var(--warn);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 25px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .info-box span { font-size: 1.5rem; flex-shrink: 0; }
    .info-box div { flex: 1; }

    /* CASCADE TAB */
    .cascade-card {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 4px 12px var(--shadow);
    }

    .cascade-card h2 { font-size: 1.8rem; margin-bottom: 20px; color: var(--fbf); }
    .cascade-card p { font-size: 1.1rem; color: var(--subtext); margin-bottom: 30px; line-height: 1.8; }

    .cascade-card a {
      display: inline-block;
      background: var(--warn);
      color: white;
      padding: 16px 40px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 700;
      font-size: 1.1rem;
      transition: all 0.3s ease;
    }

    .cascade-card a:hover { transform: scale(1.05); box-shadow: 0 8px 20px rgba(217, 119, 6, 0.3); }

    /* MARKER COUNT BADGE */
    .marker-count {
      display: inline-block;
      background: var(--fbf);
      color: white;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 700;
      margin-left: 8px;
    }

    @media (max-width: 1200px) {
      .lookup-container { grid-template-columns: 1fr; }
      .controls { flex-direction: column; }
      h1 { font-size: 2rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üß¨ IHC Hub</h1>
      <p class="version">v2.24 ‚Äî Strumenti integrati per diagnostica IHC pratica e gamified
        <br><strong style="color: var(--pos);">v2.24 FIX:</strong> Allineato a PDF Master Anticorpi_FBF (144 marker bianco) | +15 marker (Alk D5F3, CD-10, CD-14, CD-56, CD-138, MUC-2/4/6, Inibina-Œ±, PDL1 SP142, CMV, HPV, IgG, Androgeni, Annexin A1)
      </p>
      <div class="header-badges">
        <span class="badge fbf">85+ marker FBF</span>
        <span class="badge inverse">Inverse Lookup</span>
        <span class="badge quiz">Quiz Mode</span>
      </div>
    </header>

    <!-- TAB NAVIGATION -->
    <div class="tabs-wrapper">
      <button class="tab-btn active" onclick="switchTab('inverse')">üîç Inverse Lookup</button>
      <button class="tab-btn" onclick="switchTab('quiz')">üéÆ Quiz Mode</button>
      <button class="tab-btn" onclick="switchTab('cascade')">üìä IHC Cascade v2.24</button>
    </div>

    <!-- ============== INVERSE LOOKUP TAB ============== -->
    <div id="inverse-tab" class="tab-content active">
      <div class="info-box">
        <span>üí°</span>
        <div>
          <strong>Come usare:</strong> Trascina i marker dalla sezione "Disponibili" nelle colonne "Positivi" o "Negativi". Poi clicca "ANALIZZA MARKER" per calcolare le diagnosi pi√π probabili.
          <br><strong style="color: var(--pos);">v2.24:</strong> Marker allineati a PDF Master (144 FBF). In attesa conferma definitiva.
        </div>
      </div>

      <div class="lookup-container">
        <!-- POSITIVE MARKERS -->
        <div class="marker-panel positive">
          <h2>‚úÖ Marker Positivi <span class="marker-count" id="posCount">0</span></h2>
          <p style="font-size: 0.9rem; color: var(--subtext); margin-bottom: 10px;">Trascina marker qui ‚Üí</p>
          <div class="marker-grid" id="positivePanel" ondrop="handleDrop(event, 'positive')" ondragover="handleDragOver(event, 'positive')" ondragleave="handleDragLeave(event, 'positive')">
          </div>
        </div>

        <!-- NEGATIVE MARKERS -->
        <div class="marker-panel negative">
          <h2>‚ùå Marker Negativi <span class="marker-count" id="negCount" style="background: var(--neg);">0</span></h2>
          <p style="font-size: 0.9rem; color: var(--subtext); margin-bottom: 10px;">Trascina marker qui ‚Üí</p>
          <div class="marker-grid" id="negativePanel" ondrop="handleDrop(event, 'negative')" ondragover="handleDragOver(event, 'negative')" ondragleave="handleDragLeave(event, 'negative')">
          </div>
        </div>

        <!-- AVAILABLE MARKERS (TO DRAG) -->
        <div style="grid-column: 1 / -1; padding: 25px; background: var(--card); border: 3px dashed var(--fbf); border-radius: 12px;">
          <h3 style="margin-bottom: 15px; color: var(--fbf); display: flex; align-items: center; gap: 8px;">
            <span>üìã</span> Marker Disponibili FBF ‚Äî Ordine Alfabetico
            <span class="marker-count" id="availCount">0</span>
          </h3>
          <div class="marker-grid" id="availableMarkers" style="max-height: 400px; min-height: 200px; border: 2px dashed var(--fbf); display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; padding: 15px; overflow-y: auto;">
          </div>
        </div>

        <!-- CONTROLS -->
        <div class="controls">
          <button class="btn btn-analyze" onclick="analyzeMarkers()">üîç ANALIZZA MARKER</button>
          <button class="btn btn-reset" onclick="resetLookup()">üîÑ RESET</button>
        </div>
      </div>

      <!-- RESULTS -->
      <div id="lookupResults" style="display: none;">
        <div class="results-container">
          <h2>üìä RISULTATI BAYESIANI</h2>
          <div id="diagnosisResults"></div>
        </div>
      </div>

      <div id="emptyLookupState" class="empty-state">
        <h2>üëà Trascina marker nelle colonne</h2>
        <p>Seleziona i marker positivi e negativi, poi clicca "ANALIZZA MARKER"</p>
      </div>
    </div>

    <!-- ============== QUIZ MODE TAB ============== -->
    <div id="quiz-tab" class="tab-content">
      <div class="quiz-container">
        <div class="quiz-card">
          <div class="quiz-title">üéÆ INDOVINA LA DIAGNOSI</div>
          
          <div class="stats">
            <div class="stat-box">
              <div class="stat-label">Corrette</div>
              <div class="stat-value" id="correctCount">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Streak üî•</div>
              <div class="stat-value" id="streakCount">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Accuracy %</div>
              <div class="stat-value" id="accuracyPercent">0%</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Totale</div>
              <div class="stat-value" id="totalCount">0</div>
            </div>
          </div>

          <div class="markers-display">
            <h3>Questi marker sono POSITIVI:</h3>
            <div class="marker-list-quiz" id="quizMarkersList"></div>
          </div>

          <p style="font-size: 1.05rem; color: var(--subtext); margin-bottom: 25px;">Qual √® la diagnosi pi√π probabile?</p>

          <div class="diagnosis-options" id="quizOptions"></div>
          <div id="quizFeedback" class="feedback"></div>

          <button class="btn btn-analyze" onclick="nextQuizRound()" style="margin-top: 20px;">‚è≠Ô∏è PROSSIMA DIAGNOSI</button>
        </div>
      </div>
    </div>

    <!-- ============== CASCADE TAB ============== -->
    <div id="cascade-tab" class="tab-content">
      <div class="cascade-card">
        <h2>üìä IHC Cascade v2.22</h2>
        <p>
          Tool completo per diagnosi differenziale da profilo immunoistochimico.<br>
          <strong>Big Four (CK7, CK20, TTF-1, CDX2) + Pannelli specifici + Probabilit√† Bayesiane</strong>
        </p>
        <a href="./cascade.html" target="_blank">üîó Apri IHC Cascade v2.22</a>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // v2.23 FIX: MARKER DATABASE - SOLO FBF (da CSV definitivo)
    // ORDINE ALFABETICO
    // Rimossi: CD10 (SACCO), CD56 (SACCO), MyoD1 (SACCO)
    // Aggiunti: marker FBF mancanti dal CSV
    // ============================================
    
    // v2.24: 143 marker da PDF Master "Anticorpi_FBF" (BIANCO = FBF+SACCO)
    // In attesa di conferma definitiva
    const markers = [
      // A
      'Actina HHF35',
      'Actina m.l. (SMA)',
      'AFP',
      'Alk D5F3',
      'Androgeni',
      'Annexin A1',
      'Arginasi',
      'ATRX',
      // B
      'BCL-1',
      'BCL-2',
      'BCL-6',
      'BCL-10',
      'BRG-1/SMARCA4',
      'Œ≤-Catenina',
      // C
      'CA-125',
      'CA-IX',
      'Calcitonina',
      'Caldesmon',
      'Calponina',
      'Calretinina',
      'CD-1',
      'CD-2',
      'CD-3',
      'CD-4',
      'CD-5',
      'CD-7',
      'CD-8',
      'CD-10',
      'CD-14',
      'CD-15',
      'CD-19',
      'CD-20',
      'CD-21',
      'CD-23',
      'CD-30',
      'CD-31',
      'CD-34',
      'CD-38',
      'CD-44',
      'CD-45',
      'CD-56',
      'CD-61',
      'CD-68 KP1',
      'CD-68 PG-M1',
      'CD-79a',
      'CD-99',
      'CD-117',
      'CD-138',
      'CD-163',
      'CDK4',
      'CDX-2',
      'CEA Mono',
      'CK 5/6',
      'CK 7',
      'CK 19',
      'CK 20',
      'CK 34Œ≤E12',
      'CK AE1/AE3',
      'CK CAM 5.2',
      'Claudina-18',
      'CMV',
      'C-myc',
      'Cromogranina',
      // D
      'D2-40',
      'Desmina',
      'DOG1',
      // E
      'E-Caderina',
      'EMA',
      'EP-CAM',
      'ER',
      'ERG',
      // F
      'Fattore VIII',
      'Fattore XIII',
      'Fumarato Idratasi',
      // G
      'Galectina 3',
      'GATA3',
      'GFAP',
      'Glicoforina',
      'Glut-1',
      'Glut Sintetasi',
      'Glypican-3',
      // H
      'HCG',
      'Hep-Par-1 (HSA)',
      'HER-2',
      'HGAL',
      'HHV8',
      'HMB45',
      'HPV',
      // I
      'IDH1',
      'IgG',
      'IgG4',
      'Inibina-Œ±',
      // K
      'Ki-67',
      'Œ∫',
      // L
      'Œª',
      // M
      'Mammoglobina',
      'MDM2',
      'Melan-A',
      'Mieloperossidasi',
      'Miogenina',
      'MLH1',
      'MSH2',
      'MSH6',
      'MUC-2',
      'MUC-4',
      'MUC-6',
      'MUM-1',
      // N
      'Napsina',
      'Neurofilamenti',
      'NKX3',
      'NSE',
      // O
      'Olig-2',
      // P
      'p16',
      'p40',
      'p53',
      'p57',
      'p63',
      'PAX-5',
      'PAX-8',
      'PDL1 (SP142)',
      'PDL1 (SP263)',
      'PHH3',
      'PLAP',
      'PMS2',
      'PR',
      'PRAME',
      'PSA',
      'PSAP',
      'PTEN',
      // R
      'Racemasi',
      'RCC',
      // S
      'S100',
      'SALL4',
      'SATB2',
      'Sinaptofsina',
      'SOX-10',
      'SOX-11',
      'STAT6',
      // T
      'TdT',
      'Thyroglobulin',
      'TTF-1',
      // V
      'Vimentina',
      // W
      'WT1'
    ];

    // ============================================
    // v2.24: DIAGNOSIS DATABASE
    // Allineato a PDF Master. +15 marker disponibili.
    // Aggiunto: Mieloma (CD-138), CUP workup migliorato
    // ============================================
    
    const diagnoses = [
      // === CARCINOMI ===
      { name: 'Adenocarcinoma Polmonare', markers: { pos: ['TTF-1', 'Napsina', 'CK 7'], neg: ['CK 20', 'CDX-2', 'SATB2'] }, score: 89 },
      { name: 'Carcinoma Mammario', markers: { pos: ['ER', 'PR', 'GATA3', 'Mammoglobina'], neg: ['CK 20', 'TTF-1', 'CDX-2'] }, score: 90 },
      { name: 'Adenocarcinoma Colorettale', markers: { pos: ['CK 20', 'CDX-2', 'SATB2'], neg: ['CK 7', 'TTF-1'] }, score: 87 },
      { name: 'Carcinoma Epatocellulare (HCC)', markers: { pos: ['Hep-Par-1 (HSA)', 'Glypican-3', 'Arginasi', 'AFP'], neg: ['CK 7', 'CK 20'] }, score: 95 },
      { name: 'Adenocarcinoma Pancreatico', markers: { pos: ['CK 7', 'CK 19', 'p53'], neg: ['TTF-1', 'SATB2'] }, score: 88 },
      { name: 'Carcinoma Ovarico HGSC', markers: { pos: ['PAX-8', 'WT1', 'CA-125', 'ER', 'p53'], neg: ['CK 20', 'CDX-2', 'GATA3'] }, score: 88 },
      { name: 'Carcinoma Uroteliale', markers: { pos: ['GATA3', 'CK 7', 'CK 20', 'p63'], neg: ['PSA', 'TTF-1', 'CDX-2'] }, score: 85 },
      { name: 'Carcinoma Prostatico', markers: { pos: ['PSA', 'PSAP', 'NKX3', 'ERG'], neg: ['CK 7', 'CK 20', 'GATA3'] }, score: 91 },
      { name: 'Carcinoma Renale (RCC)', markers: { pos: ['PAX-8', 'RCC', 'CA-IX', 'Vimentina'], neg: ['CK 20', 'TTF-1', 'CK 7'] }, score: 84 },
      { name: 'Carcinoma Tiroideo (PTC)', markers: { pos: ['TTF-1', 'Thyroglobulin', 'PAX-8', 'CK 19'], neg: ['CK 20', 'CDX-2', 'Calcitonina'] }, score: 92 },
      { name: 'Mesotelioma Epitelioide', markers: { pos: ['Calretinina', 'WT1', 'D2-40', 'CK 5/6'], neg: ['CK 20', 'TTF-1', 'PAX-8'] }, score: 86 },
      { name: 'Carcinoma Squamoso (SCC)', markers: { pos: ['p40', 'p63', 'CK 5/6'], neg: ['CK 7', 'CK 20', 'TTF-1'] }, score: 87 },

      // === NEUROENDOCRINE ===
      { name: 'Neoplasia Neuroendocrina GI', markers: { pos: ['Sinaptofsina', 'Cromogranina', 'CDX-2'], neg: ['TTF-1'] }, score: 88 },
      { name: 'Neoplasia Neuroendocrina Polmonare', markers: { pos: ['Sinaptofsina', 'Cromogranina', 'TTF-1'], neg: ['CDX-2', 'CK 20'] }, score: 86 },

      // === MELANOMA & NEURAL ===
      { name: 'Melanoma', markers: { pos: ['S100', 'SOX-10', 'Melan-A', 'HMB45', 'PRAME'], neg: ['CK AE1/AE3', 'CD-20', 'CD-45'] }, score: 93 },
      { name: 'MPNST', markers: { pos: ['S100', 'SOX-10', 'Vimentina'], neg: ['Melan-A', 'HMB45', 'Desmina'] }, score: 80 },

      // === SARCOMI ===
      { name: 'GIST', markers: { pos: ['CD-117', 'DOG1', 'CD-34'], neg: ['Desmina', 'S100', 'SOX-10'] }, score: 94 },
      { name: 'Leiomiosarcoma', markers: { pos: ['Actina HHF35', 'Actina m.l. (SMA)', 'Desmina', 'Caldesmon'], neg: ['S100', 'CD-34', 'CD-117'] }, score: 91 },
      { name: 'Rabdomiosarcoma', markers: { pos: ['Desmina', 'Miogenina'], neg: ['CD-20', 'CD-3', 'S100'] }, score: 93 },
      { name: 'Sarcoma Sinoviale', markers: { pos: ['CK AE1/AE3', 'EMA', 'BCL-2', 'CD-99'], neg: ['Desmina', 'S100', 'CD-34'] }, score: 90 },
      { name: 'Sarcoma di Ewing', markers: { pos: ['CD-99', 'Vimentina'], neg: ['Desmina', 'Miogenina', 'CD-20'] }, score: 94 },
      { name: 'Tumore Fibroso Solitario', markers: { pos: ['STAT6', 'CD-34', 'Vimentina', 'BCL-2'], neg: ['Desmina', 'S100'] }, score: 92 },
      { name: 'Liposarcoma Dedifferenziato', markers: { pos: ['MDM2', 'CDK4', 'Vimentina'], neg: ['CD-20', 'Desmina', 'S100'] }, score: 85 },

      // === LINFOMI ===
      { name: 'DLBCL', markers: { pos: ['CD-20', 'CD-79a', 'PAX-5', 'BCL-6', 'MUM-1'], neg: ['CD-3', 'TdT'] }, score: 92 },
      { name: 'Linfoma T Periferico', markers: { pos: ['CD-3', 'CD-5', 'CD-45'], neg: ['CD-20', 'TdT', 'PAX-5'] }, score: 85 },
      { name: 'Linfoma Linfoblastico', markers: { pos: ['TdT', 'CD-19', 'CD-99'], neg: ['CD-20'] }, score: 93 },
      { name: 'Linfoma di Hodgkin', markers: { pos: ['CD-15', 'CD-30'], neg: ['CD-20', 'CD-3', 'CD-45'] }, score: 91 },
      { name: 'Mieloma/Plasmacitoma', markers: { pos: ['CD-138', 'MUM-1', 'Œ∫', 'Œª'], neg: ['CD-20', 'CD-3', 'PAX-5'] }, score: 90 },

      // === GCT ===
      { name: 'Seminoma/Disgerminoma', markers: { pos: ['SALL4', 'PLAP', 'CD-117'], neg: ['AFP', 'CK AE1/AE3'] }, score: 91 },
      { name: 'Yolk Sac Tumor', markers: { pos: ['AFP', 'SALL4', 'Glypican-3'], neg: ['CD-30', 'HCG'] }, score: 89 },
      { name: 'Coriocarcinoma', markers: { pos: ['HCG', 'CK AE1/AE3'], neg: ['SALL4', 'AFP'] }, score: 88 },
    ];

    let positiveMarkers = new Set();
    let negativeMarkers = new Set();
    let quizStats = { correct: 0, total: 0, streak: 0 };
    let currentQuizDx = null;

    function init() {
      renderAvailableMarkers();
      nextQuizRound();
    }

    // ============================================
    // INVERSE LOOKUP
    // ============================================

    function updateCounts() {
      document.getElementById('posCount').textContent = positiveMarkers.size;
      document.getElementById('negCount').textContent = negativeMarkers.size;
      const avail = markers.filter(m => !positiveMarkers.has(m) && !negativeMarkers.has(m));
      document.getElementById('availCount').textContent = avail.length;
    }

    function renderAvailableMarkers() {
      const available = markers.filter(m => !positiveMarkers.has(m) && !negativeMarkers.has(m));
      const container = document.getElementById('availableMarkers');
      
      container.innerHTML = available.map(m => `
        <div class="marker-item" 
             draggable="true" 
             ondragstart="handleDragStart(event, '${m}')"
             ondragend="handleDragEnd(event)">
          <span style="font-size: 0.85rem;">${m}</span>
        </div>
      `).join('');

      if (available.length === 0) {
        container.innerHTML = '<p style="color: var(--subtext); text-align: center; padding: 20px;">‚úÖ Tutti i marker sono stati selezionati!</p>';
      }

      renderSelectedMarkers();
      updateCounts();
    }

    function renderSelectedMarkers() {
      const posPanel = document.getElementById('positivePanel');
      const negPanel = document.getElementById('negativePanel');

      posPanel.innerHTML = Array.from(positiveMarkers).sort().map(m => `
        <div class="marker-item selected-pos" 
             draggable="true" 
             ondragstart="handleDragStart(event, '${m}')"
             ondblclick="removeMarker('${m}')">
          <span>${m}</span>
          <span class="marker-badge pos">‚úÖ</span>
        </div>
      `).join('');

      if (positiveMarkers.size === 0) {
        posPanel.innerHTML = '<p style="color: var(--subtext); text-align: center; padding: 20px;">Trascina marker positivi qui</p>';
      }

      negPanel.innerHTML = Array.from(negativeMarkers).sort().map(m => `
        <div class="marker-item selected-neg"
             draggable="true" 
             ondragstart="handleDragStart(event, '${m}')"
             ondblclick="removeMarker('${m}')">
          <span>${m}</span>
          <span class="marker-badge neg">‚ùå</span>
        </div>
      `).join('');

      if (negativeMarkers.size === 0) {
        negPanel.innerHTML = '<p style="color: var(--subtext); text-align: center; padding: 20px;">Trascina marker negativi qui</p>';
      }
    }

    function removeMarker(marker) {
      positiveMarkers.delete(marker);
      negativeMarkers.delete(marker);
      renderAvailableMarkers();
    }

    let draggedMarker = null;

    function handleDragStart(event, marker) {
      draggedMarker = marker;
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', marker);
      event.target.closest('.marker-item').classList.add('dragging');
    }

    function handleDragEnd(event) {
      event.target.closest('.marker-item')?.classList.remove('dragging');
      document.querySelectorAll('.marker-grid').forEach(g => {
        g.classList.remove('drag-over-pos', 'drag-over-neg');
      });
    }

    function handleDragOver(event, type) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
      const grid = event.currentTarget;
      grid.classList.add(type === 'positive' ? 'drag-over-pos' : 'drag-over-neg');
    }

    function handleDragLeave(event, type) {
      const grid = event.currentTarget;
      grid.classList.remove(type === 'positive' ? 'drag-over-pos' : 'drag-over-neg');
    }

    function handleDrop(event, type) {
      event.preventDefault();
      const marker = draggedMarker || event.dataTransfer.getData('text/plain');
      
      positiveMarkers.delete(marker);
      negativeMarkers.delete(marker);

      if (type === 'positive') {
        positiveMarkers.add(marker);
      } else if (type === 'negative') {
        negativeMarkers.add(marker);
      }

      renderAvailableMarkers();
      
      const grid = event.currentTarget;
      grid.classList.remove('drag-over-pos', 'drag-over-neg');
    }

    function analyzeMarkers() {
      if (positiveMarkers.size === 0 && negativeMarkers.size === 0) {
        alert('Seleziona almeno un marker!');
        return;
      }

      const results = calculateBayesian();
      displayResults(results);

      document.getElementById('emptyLookupState').style.display = 'none';
      document.getElementById('lookupResults').style.display = 'block';
    }

    function calculateBayesian() {
      const scores = [];

      diagnoses.forEach(dx => {
        let score = 0;
        let reasoning = [];
        let matchCount = 0;

        // Score positive matches
        dx.markers.pos.forEach(marker => {
          if (positiveMarkers.has(marker)) {
            score += 15;
            matchCount++;
            reasoning.push(`‚úÖ ${marker} presente`);
          }
        });

        // Score negative matches (confirmatory exclusions)
        dx.markers.neg.forEach(marker => {
          if (negativeMarkers.has(marker)) {
            score += 12;
            matchCount++;
            reasoning.push(`‚ùå ${marker} assente (esclude alternative)`);
          }
        });

        // Penalty: expected positive but found negative
        dx.markers.pos.forEach(marker => {
          if (negativeMarkers.has(marker)) {
            score -= 25; // Heavy penalty
            reasoning.push(`‚ö†Ô∏è ${marker} NEGATIVO (atteso positivo!) ‚Äî penalit√†`);
          }
        });

        // Penalty: expected negative but found positive
        dx.markers.neg.forEach(marker => {
          if (positiveMarkers.has(marker)) {
            score -= 20;
            reasoning.push(`‚ö†Ô∏è ${marker} POSITIVO (atteso negativo!) ‚Äî penalit√†`);
          }
        });

        // Bonus for multiple concordant matches
        if (matchCount >= 4) {
          score += 25;
          reasoning.push(`üéØ ${matchCount} marker concordanti (profilo forte)`);
        } else if (matchCount >= 3) {
          score += 15;
          reasoning.push(`üéØ ${matchCount} marker concordanti`);
        }

        if (score > 0) {
          scores.push({ ...dx, bayesianScore: score, reasoning });
        }
      });

      return scores
        .sort((a, b) => b.bayesianScore - a.bayesianScore)
        .slice(0, 8);
    }

    function displayResults(results) {
      const container = document.getElementById('diagnosisResults');
      
      if (results.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>‚ùå Nessuna diagnosi matcha i marker selezionati. Verifica la selezione.</p></div>';
        return;
      }

      const maxScore = results[0].bayesianScore;

      container.innerHTML = results.map((dx, idx) => {
        const relativeScore = dx.bayesianScore / maxScore;
        const percentage = Math.round(50 + (relativeScore * 45));
        const confidence = percentage >= 80 ? 'high' : percentage >= 65 ? 'medium' : 'low';

        return `
          <div class="diagnosis-result ${confidence}">
            <div class="dx-header">
              <div class="dx-name">${idx + 1}. ${dx.name}</div>
              <div class="dx-score ${confidence}">${percentage}%</div>
            </div>
            <div class="dx-reasoning">
              ${dx.reasoning.join('<br>') || 'Nessun match specifico'}
            </div>
            <div class="marker-list">
              ${dx.markers.pos.map(m => `<span class="marker-tag ${positiveMarkers.has(m) ? 'pos' : ''}">${m}</span>`).join('')}
              ${dx.markers.neg.map(m => `<span class="marker-tag ${negativeMarkers.has(m) ? 'neg' : ''}">${m}</span>`).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function resetLookup() {
      positiveMarkers.clear();
      negativeMarkers.clear();
      renderAvailableMarkers();
      document.getElementById('emptyLookupState').style.display = 'block';
      document.getElementById('lookupResults').style.display = 'none';
    }

    // ============================================
    // QUIZ MODE
    // ============================================

    function nextQuizRound() {
      currentQuizDx = diagnoses[Math.floor(Math.random() * diagnoses.length)];
      const quizMarkers = currentQuizDx.markers.pos.slice(0, Math.min(currentQuizDx.markers.pos.length, 4));

      document.getElementById('quizMarkersList').innerHTML = quizMarkers
        .map(m => `<span class="marker-chip">${m}</span>`).join('');

      // Pick 4 random diagnoses including the correct one
      const shuffled = [...diagnoses].sort(() => Math.random() - 0.5);
      const options = shuffled.filter(d => d.name !== currentQuizDx.name).slice(0, 3);
      options.push(currentQuizDx);
      options.sort(() => Math.random() - 0.5);

      document.getElementById('quizOptions').innerHTML = options
        .map((dx, idx) => `
          <div class="dx-option" onclick="selectAnswer(${idx}, '${dx.name.replace(/'/g, "\\'")}')">
            ${dx.name}
          </div>
        `).join('');

      document.getElementById('quizFeedback').className = 'feedback';
      document.getElementById('quizFeedback').innerHTML = '';
    }

    function selectAnswer(idx, name) {
      const isCorrect = name === currentQuizDx.name;
      const feedback = document.getElementById('quizFeedback');

      quizStats.total++;
      if (isCorrect) {
        quizStats.correct++;
        quizStats.streak++;
        feedback.className = 'feedback correct';
        feedback.innerHTML = `‚úÖ CORRETTO! Era <strong>${currentQuizDx.name}</strong>`;
      } else {
        quizStats.streak = 0;
        feedback.className = 'feedback incorrect';
        feedback.innerHTML = `‚ùå SBAGLIATO! Era <strong>${currentQuizDx.name}</strong> ‚Äî Profilo: ${currentQuizDx.markers.pos.join(', ')}`;
      }

      updateStats();
      setTimeout(() => nextQuizRound(), 2500);
    }

    function updateStats() {
      document.getElementById('correctCount').textContent = quizStats.correct;
      document.getElementById('totalCount').textContent = quizStats.total;
      document.getElementById('streakCount').textContent = quizStats.streak;
      const accuracy = quizStats.total > 0 ? Math.round((quizStats.correct / quizStats.total) * 100) : 0;
      document.getElementById('accuracyPercent').textContent = accuracy + '%';
    }

    // ============================================
    // TAB SWITCHING
    // ============================================

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
    }

    init();
  </script>
</body>
</html>

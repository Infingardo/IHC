<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IHC Cascade v2.3 - CUP Diagnostic Tool</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --subtext: #64748b;
      --accent: #4f46e5;
      --pos: #059669;
      --neg: #dc2626;
      --warn: #d97706;
      --border: #e2e8f0;
      --shadow: rgba(0, 0, 0, 0.1);
      --sacco: #e879f9;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border);
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(135deg, var(--accent), var(--pos));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .version {
      color: var(--subtext);
      font-size: 0.9rem;
    }

    .version strong {
      color: var(--warn);
    }

    /* STEP 1: First-Line Orientation */
    .first-line {
      background: linear-gradient(135deg, #fef3c7, #fed7aa);
      border: 2px solid var(--warn);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px var(--shadow);
    }

    .first-line h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: #92400e;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .first-line .step-label {
      background: var(--warn);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    /* Big Four */
    .big-four {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .marker-group {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .marker-group h3 {
      font-size: 1.1rem;
      margin-bottom: 15px;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .marker-btn-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .marker-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--border);
      background: white;
      color: var(--text);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all 0.2s;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .marker-btn:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .marker-btn.positive {
      background: var(--pos);
      color: white;
      border-color: var(--pos);
    }

    .marker-btn.negative {
      background: var(--neg);
      color: white;
      border-color: var(--neg);
    }

    .marker-btn.not-tested {
      opacity: 0.5;
    }

    /* Panel Selection */
    .panel-selection {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .panel-selection h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: var(--accent);
    }

    .panel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .panel-btn {
      padding: 15px;
      background: white;
      border: 2px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all 0.2s;
      text-align: center;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .panel-btn:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .panel-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* Marker Panel */
    .marker-panel {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      display: none;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .marker-panel.active {
      display: block;
    }

    .marker-panel h3 {
      font-size: 1.2rem;
      margin-bottom: 20px;
      color: var(--accent);
    }

    .marker-section {
      margin-bottom: 25px;
    }

    .marker-section-label {
      font-size: 0.85rem;
      color: var(--subtext);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .marker-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
    }

    .marker-item {
      display: flex;
      gap: 6px;
    }

    .marker-item button {
      flex: 1;
      padding: 10px;
      border: 2px solid var(--border);
      background: white;
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      min-width: 40px;
      box-shadow: 0 1px 2px var(--shadow);
    }

    .marker-item button:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 6px var(--shadow);
    }

    .marker-item button.positive {
      background: var(--pos);
      color: white;
      border-color: var(--pos);
    }

    .marker-item button.negative {
      background: var(--neg);
      color: white;
      border-color: var(--neg);
    }

    .marker-item button.not-tested {
      opacity: 0.4;
    }

    /* SACCO-only marker badge */
    .sacco-badge {
      background: var(--sacco);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 4px;
    }

    /* ‚≠ê NEW v2.4: Morphology Check Section */
    .morphology-check {
      background: linear-gradient(135deg, #f0fdf4, #dcfce7);
      border: 2px solid var(--pos);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px var(--shadow);
    }

    .morphology-check h2 {
      font-size: 1.3rem;
      margin-bottom: 10px;
      color: #065f46;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .morphology-check p {
      color: #065f46;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }

    .morphology-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
    }

    .morphology-item {
      background: white;
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      transition: all 0.2s;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .morphology-item:hover {
      border-color: var(--pos);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .morphology-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .morphology-item label {
      flex: 1;
      cursor: pointer;
      font-size: 0.95rem;
      color: var(--text);
    }

    .morphology-item.checked {
      border-color: var(--pos);
      background: #f0fdf4;
    }

    /* Results */
    .results {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .results h2 {
      font-size: 1.3rem;
      margin-bottom: 20px;
      color: var(--accent);
    }

    .result-section {
      margin-bottom: 25px;
    }

    .result-section h3 {
      font-size: 1.1rem;
      margin-bottom: 15px;
      color: var(--pos);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .diagnosis-card,
    .alert-card,
    .suggestion-card {
      background: #f8fafc;
      border-left: 4px solid var(--accent);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .diagnosis-card.high {
      border-left-color: var(--pos);
    }

    .diagnosis-card.medium {
      border-left-color: var(--warn);
    }

    .diagnosis-card.low {
      border-left-color: var(--subtext);
    }

    .alert-card {
      border-left-color: var(--warn);
      background: #fef3c7;
    }

    .alert-card.redflag {
      border-left-color: var(--neg);
      background: #fee2e2;
    }

    /* ‚≠ê v2.6 FIX: Classi alert curable e advisory */
    .alert-card.curable {
      border-left-color: var(--pos);
      background: #dcfce7;
    }

    .alert-card.advisory {
      border-left-color: var(--accent);
      background: #eff6ff;
    }

    .suggestion-card {
      border-left-color: var(--accent);
    }

    /* ‚≠ê NEW v2.5: Auto-panel suggestion clickable */
    .suggestion-card.auto-panel {
      cursor: pointer;
      transition: all 0.2s;
      border-left-width: 4px;
    }

    .suggestion-card.auto-panel:hover {
      background: #eff6ff;
      border-left-color: var(--pos);
      transform: translateX(4px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .suggestion-card.auto-panel .card-detail {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .suggestion-card.auto-panel .card-detail::after {
      content: '‚Üí';
      font-size: 1.2rem;
      color: var(--accent);
      margin-left: auto;
    }

    .card-title {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 1rem;
    }

    .card-detail {
      color: var(--subtext);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .confidence-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 8px;
    }

    .confidence-badge.high {
      background: #d1fae5;
      color: #065f46;
    }

    .confidence-badge.medium {
      background: #fed7aa;
      color: #92400e;
    }

    .confidence-badge.low {
      background: #e2e8f0;
      color: #475569;
    }

    /* Actions */
    .actions {
      display: flex;
      gap: 12px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px var(--shadow);
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: #4338ca;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .btn-secondary {
      background: white;
      color: var(--text);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--accent);
      box-shadow: 0 4px 12px var(--shadow);
    }

    /* Bibliografia */
    .bibliography {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .bibliography h2 {
      font-size: 1.3rem;
      margin-bottom: 20px;
      color: var(--accent);
    }

    .bibliography-content {
      color: var(--subtext);
      font-size: 0.9rem;
      line-height: 1.8;
    }

    .bibliography-content strong {
      color: var(--text);
    }

    /* Disclaimer */
    .disclaimer {
      background: #fef3c7;
      border: 2px solid var(--warn);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      color: var(--text);
      font-size: 0.9rem;
      line-height: 1.6;
      box-shadow: 0 2px 4px var(--shadow);
    }

    .disclaimer strong {
      color: #92400e;
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 20px;
      color: var(--subtext);
      font-size: 0.85rem;
      border-top: 1px solid var(--border);
    }

    /* Responsive */
    @media (max-width: 768px) {
      h1 {
        font-size: 1.8rem;
      }

      .big-four {
        grid-template-columns: 1fr;
      }

      .panel-grid {
        grid-template-columns: 1fr;
      }

      .marker-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
    }

    /* Utility */
    code {
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      color: var(--accent);
      border: 1px solid var(--border);
    }

    em {
      color: var(--warn);
      font-style: normal;
      font-weight: 600;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--subtext);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üî¨ IHC Cascade CUP</h1>
      <p class="version">
        Version <strong>2.10.0 ULTIMATE</strong> | 
        Dr. Filippo Bianchi | 
        SC Anatomia Patologica ASST Fatebenefratelli-Sacco
      </p>
      <p class="version" style="margin-top: 8px;">
        <strong style="color: var(--pos);">v2.10 ULTIMATE (NotebookLM + Workflow):</strong> 
        Morfologia STEP 1 (prima IHC!) + Sede-specific (7 sedi, pannelli lean) + 
        Dati clinici (et√†/sesso/sede) | 
        57 marker, 15 morfologie, workflow epistemologico corretto
      </p>
    </header>

    <!-- ‚≠ê NEW v2.10: STEP 0 - Dati Clinici -->
    <div style="background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border: 2px solid #6b7280; border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 12px var(--shadow);">
      <h2 style="font-size: 1.3rem; margin-bottom: 15px; color: #1f2937; display: flex; align-items: center; gap: 10px;">
        <span style="background: #6b7280; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">STEP 0</span>
        Dati Clinici Essenziali
      </h2>
      <p style="color: #374151; margin-bottom: 15px; font-size: 0.9rem;">
        <strong>‚ö†Ô∏è Obbligatorio:</strong> La probabilit√† pre-test √® definita da et√†, sesso e sede anatomica. 
        Questi dati orientano l'algoritmo IHC e ottimizzano il risparmio di tessuto.
      </p>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
        <div>
          <label style="display: block; font-weight: 600; color: #1f2937; margin-bottom: 8px;">
            Et√† paziente (anni):
          </label>
          <input type="number" id="patientAge" min="0" max="120" 
                 style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem;"
                 placeholder="Es: 67">
        </div>
        
        <div>
          <label style="display: block; font-weight: 600; color: #1f2937; margin-bottom: 8px;">
            Sesso:
          </label>
          <select id="patientSex" 
                  style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem;">
            <option value="">Non specificato</option>
            <option value="M">Maschio</option>
            <option value="F">Femmina</option>
          </select>
        </div>
        
        <div>
          <label style="display: block; font-weight: 600; color: #1f2937; margin-bottom: 8px;">
            Sede biopsia:
          </label>
          <select id="biopsySite" 
                  style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem;">
            <option value="">Seleziona sede...</option>
            <option value="ln_cervical">Linfonodo cervicale (collo)</option>
            <option value="ln_axillary">Linfonodo ascellare</option>
            <option value="ln_inguinal">Linfonodo inguinale</option>
            <option value="liver">Metastasi epatica</option>
            <option value="bone">Metastasi ossea</option>
            <option value="lung">Metastasi polmonare</option>
            <option value="effusion">Versamento sieroso</option>
            <option value="soft_tissue">Tessuti molli</option>
            <option value="other">Altra sede</option>
          </select>
        </div>
      </div>
      
      <p style="margin-top: 15px; font-size: 0.85rem; color: #6b7280; font-style: italic;">
        üí° <strong>Nota:</strong> Sede biopsia attiva alert specifici e pannelli lean ottimizzati 
        per risparmiare tessuto (es. "Ascella donna" ‚Üí GATA3/TRPS1 immediati, salta Big Four).
      </p>
    </div>

    <!-- ‚≠ê v2.10: Morfologia EE ‚Üí STEP 1 (PRIMA IHC!) -->
    <div class="morphology-check">
      <h2>
        <span style="background: var(--pos); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">STEP 1</span>
        Morfologia EE ‚Äî "Il Vetrino Non Mente"
      </h2>
      <p>
        <strong style="color: var(--pos);">‚ö†Ô∏è PRIMA di QUALSIASI IHC:</strong> il vetrino non mente, 
        la morfologia detta la chimica. L'immunoistochimica va sempre orientata e correlata alla morfologia EE. 
        <strong style="color: var(--pos);">v2.10: Morfologia guida workflow</strong> 
        (blocca pannelli inappropriati, attiva alert game-changers).
      </p>
      
      <div class="morphology-grid">
        <!-- Architettura -->
        <div style="grid-column: 1 / -1; font-weight: 600; color: var(--accent); margin-top: 10px; margin-bottom: 5px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">
          üìê ARCHITETTURA
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="arch_gland">
          <label for="arch_gland">Ghiandolare</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="arch_solid">
          <label for="arch_solid">Solida</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="arch_trabec">
          <label for="arch_trabec">Trabecolare</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="arch_micropap">
          <label for="arch_micropap">üÜï Micropapillare (filigree-like)</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="arch_lepidic">
          <label for="arch_lepidic">üÜï Lepidico (crescita alveolare)</label>
        </div>

        <!-- Citologia -->
        <div style="grid-column: 1 / -1; font-weight: 600; color: var(--accent); margin-top: 15px; margin-bottom: 5px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">
          üî¨ CITOLOGIA
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="cyto_signet">
          <label for="cyto_signet">üÜï Signet-ring cells (anello castone)</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="cyto_clear">
          <label for="cyto_clear">üÜï Clear cell (cellule chiare)</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="cyto_srbc">
          <label for="cyto_srbc">üÜï Small round blue cell (SRBC)</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="cyto_spindle">
          <label for="cyto_spindle">üÜï Spindle cell (fusocellulare)</label>
        </div>

        <!-- Differenziazione -->
        <div style="grid-column: 1 / -1; font-weight: 600; color: var(--accent); margin-top: 15px; margin-bottom: 5px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">
          üß¨ DIFFERENZIAZIONE
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="diff_squamous">
          <label for="diff_squamous">üÜï Squamoso (perle cornee/ponti)</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="pigment">
          <label for="pigment">Pigmento melanina</label>
        </div>

        <!-- Pattern Specifici -->
        <div style="grid-column: 1 / -1; font-weight: 600; color: var(--accent); margin-top: 15px; margin-bottom: 5px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">
          üéØ PATTERN SPECIFICI
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="zellballen">
          <label for="zellballen">Zellballen (nidi)</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="vascolar">
          <label for="vascolar">Vascolare anastomosante</label>
        </div>

        <!-- Attivit√† Proliferativa -->
        <div style="grid-column: 1 / -1; font-weight: 600; color: var(--accent); margin-top: 15px; margin-bottom: 5px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">
          ‚ö° ATTIVIT√Ä PROLIFERATIVA
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="necro">
          <label for="necro">Necrosi presente</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="mitosi">
          <label for="mitosi">Mitosi frequenti (>10/HPF)</label>
        </div>
      </div>
    </div>

    <!-- ‚≠ê v2.10: STEP 2 - First-Line (dopo morfologia!) -->
    <div class="first-line">
      <h2>
        <span class="step-label">STEP 2</span>
        Orientamento Iniziale IHC
      </h2>
      <p style="color: #92400e; margin-bottom: 15px; font-size: 0.9rem;">
        <strong>Dopo morfologia EE:</strong> CK AE1/AE3 (epiteliale), CD45 (linfoide), 
        Vimentin (mesenchimale), S100 (melanoma/neural). <strong style="color: var(--pos);">Il reagente va interpretato alla luce di STEP 1.</strong>
      </p>
      <div class="big-four" id="firstLine">
        <!-- Generated by JavaScript -->
      </div>
    </div>

    <!-- ‚≠ê NEW v2.5: Auto-Panel Suggestions -->
    <div id="autoPanelSuggestions" style="display: none; margin-bottom: 30px;">
      <!-- Generated by updateAutoPanelSuggestions() -->
    </div>

    <!-- ‚≠ê v2.6 NEW: CK‚àí Callout Guardrail -->
    <div id="ckNegativeCallout" style="display: none;">
      <div style="background: linear-gradient(135deg, #fef3c7, #fed7aa); border: 2px solid var(--warn); border-radius: 12px; padding: 20px; margin-bottom: 30px; box-shadow: 0 4px 12px var(--shadow);">
        <h3 style="font-size: 1.1rem; margin-bottom: 12px; color: #92400e; display: flex; align-items: center; gap: 8px;">
          ‚ö†Ô∏è GUARDRAIL ‚Äî CK AE1/AE3 Negativo con Morfologia Epiteliale
        </h3>
        <p style="color: #92400e; margin-bottom: 10px; font-size: 0.95rem;">
          <strong>Se morfologia ghiandolare/trabecolare/solida MA CK‚àí:</strong>
        </p>
        <ul style="color: #92400e; margin-left: 20px; font-size: 0.9rem; line-height: 1.6;">
          <li><strong>Ripeti CK</strong> con clone diverso (AE1/AE3 + CAM5.2)</li>
          <li>Verifica <strong>fissazione</strong> e <strong>recupero antigenico</strong></li>
          <li>Considera <strong>EMA, MOC31, Claudina-4</strong> <span style="color: #b45309;">(se disponibili; altrimenti consulenza esterna)</span></li>
          <li>Alcuni carcinomi sono <strong>CK‚àí veri</strong>: renale cromofobo, epatoide, rabdoide</li>
          <li>Pannello alternativo: <strong>PAX8, GATA3, ER</strong> (carcinomi site-specific)</li>
        </ul>
        <p style="color: #92400e; margin-top: 10px; font-size: 0.85rem; font-style: italic;">
          <strong>Il vetrino non mente:</strong> morfologia EE + IHC = diagnosi integrata
        </p>
      </div>
    </div>

    <!-- ‚≠ê v2.10: STEP 3 - Big Four (conditionally shown if CK+) -->
    <div id="bigFourSection" style="display: none;">
      <div style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); border: 2px solid var(--accent); border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 12px var(--shadow);">
        <h2 style="font-size: 1.3rem; margin-bottom: 15px; color: #1e40af; display: flex; align-items: center; gap: 10px;">
          <span style="background: var(--accent); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">STEP 3</span>
          Big Four (SE CK+)
        </h2>
        <p style="color: #1e40af; margin-bottom: 15px; font-size: 0.9rem;">
          <strong>Solo se CK AE1/AE3 positivo:</strong> orienta l'origine dell'adenocarcinoma. 
          <strong style="color: var(--pos);">Pu√≤ essere saltato se sede anatomica chiara (es. ascella donna ‚Üí GATA3 diretto).</strong>
        </p>
        <div class="big-four" id="bigFour">
          <!-- Generated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Panel Selection -->
    <div class="panel-selection">
      <h2>
        <span style="background: var(--accent); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-right: 10px;">STEP 3</span>
        Pannelli IHC Specifici
      </h2>
      <div class="panel-grid" id="panelGrid">
        <!-- Generated by JavaScript -->
      </div>
    </div>

    <!-- Marker Panels -->
    <div id="markerPanels">
      <!-- Generated by JavaScript -->
    </div>

    <!-- Actions -->
    <div class="actions">
      <button class="btn btn-primary" onclick="calculate()">üîç Calcola Diagnosi</button>
      <button class="btn btn-secondary" onclick="resetAll()">üîÑ Reset Tutto</button>
      <button class="btn btn-secondary" onclick="toggleBibliography()">üìö Bibliografia</button>
    </div>

    <!-- Results -->
    <div class="results" id="results" style="display: none;">
      <h2>üìä Risultati</h2>
      
      <div class="result-section" id="alertsSection" style="display: none;">
        <h3>‚ö†Ô∏è Alert & Red Flags</h3>
        <div id="alertsContainer"></div>
      </div>

      <div class="result-section" id="diagnosesSection" style="display: none;">
        <h3>üéØ Diagnosi Differenziali</h3>
        <div id="diagnosesContainer"></div>
      </div>

      <div class="result-section" id="suggestionsSection" style="display: none;">
        <h3>üí° Suggerimenti</h3>
        <div id="suggestionsContainer"></div>
      </div>

      <div class="result-section" id="gapsSection" style="display: none;">
        <h3>üîß Marcatori Non Disponibili FBF</h3>
        <div id="gapsContainer"></div>
      </div>
    </div>

    <!-- Bibliografia -->
    <div class="bibliography" id="bibliography" style="display: none;">
      <h2>üìö Bibliografia</h2>
      <div class="bibliography-content" id="bibliographyContent">
        <!-- Generated by JavaScript -->
      </div>
    </div>

    <!-- Disclaimer -->
    <div class="disclaimer">
      <strong>‚öï Disclaimer v2.10 ULTIMATE (Workflow + Sede-Specific)</strong> ‚Äî Supporto didattico-decisionale per CUP con <strong>approccio epistemologicamente corretto</strong>.<br><br>
      <strong>v2.10 WORKFLOW RE-DESIGN (Osservazione critica Filippo + NotebookLM):</strong><br>
      ‚Ä¢ <strong>MORFOLOGIA ‚Üí STEP 1</strong> (PRIMA di ogni IHC): "Il vetrino non mente, la morfologia detta la chimica"<br>
      ‚Ä¢ <strong>Dati clinici ‚Üí STEP 0</strong> (et√†, sesso, sede): Probabilit√† pre-test definita da clinica<br>
      ‚Ä¢ <strong>First-line ‚Üí STEP 2</strong> (orientato da morfologia): Il reagente va interpretato alla luce del vetrino<br>
      ‚Ä¢ <strong>Big Four ‚Üí STEP 3</strong> (pu√≤ essere saltato se sede chiara)<br><br>
      <strong>v2.10 SEDE-SPECIFIC (NotebookLM):</strong><br>
      ‚Ä¢ <strong>7 sedi anatomiche:</strong> Cervicale, Ascellare, Inguinale, Fegato, Osso, Polmone, Versamenti<br>
      ‚Ä¢ <strong>Alert automatici:</strong> Ascella donna ‚Üí "Breast-like CUP" GATA3 >90%, salta Big Four<br>
      ‚Ä¢ <strong>Pannelli lean:</strong> Osso maschio (PSA/NKX3/ERG/TTF1/PAX8) vs pannello generico 15-20 marker<br>
      ‚Ä¢ <strong>Risparmio tessuto:</strong> 60-80% marker, diagnosi pi√π rapida, outcome-based<br><br>
      <strong>v2.9 MARKER EMERGENTI:</strong> TRPS1 (mammella 98.7%), INSM1 (NE 96.4%), BCL10 (acinare 90-95%), CK17 (uroteliale/PDAC), NUT (midline), Œ≤-catenina (SPT).<br>
      <strong>v2.9.1 COERENZA LOGICA:</strong> CK‚àí disclaimer, Melanoma/TNBC DDx, CK7‚àí/20‚àí guardrail.<br>
      <strong>v2.8 CURABILI-FIRST:</strong> 7 morfologie game-changers, SOX10 DDx (TNBC 69%, MPNST H3K27me3).<br><br>
      <strong>57 marker, 15 morfologie, workflow Rosai-compliant, sede-specific validated.</strong> 
      <strong>"Una metastasi ossea PSA+/NKX3+ non sta mentendo: √® prostata" ‚Äî NotebookLM 2026</strong>
    </div>

    <footer>
      <p>&copy; 2026 ASST Fatebenefratelli-Sacco | IHC Cascade v2.10 ULTIMATE | 
      Uso interno e didattico</p>
      <p style="margin-top: 8px; font-size: 0.75rem;">
        "Workflow epistemologico: Morfologia STEP 1 prima IHC + Sede-specific 7 alert + Pannelli lean risparmio 60-80% tessuto"
      </p>
    </footer>
  </div>

  <script>
    // ============================================
    // PART 1: DATA STRUCTURES & STATE v2.3
    // ============================================
    // ============================================
    // MARKER DEFINITIONS v2.3
    // ============================================
    
    const markers = [
      // First-line orientation
      { id: 'CKAE1', name: 'CK AE1/AE3', cat: 'firstline' },
      { id: 'CD45', name: 'CD45', cat: 'firstline' },
      { id: 'Vim', name: 'Vimentin', cat: 'firstline' },
      { id: 'S100', name: 'S100', cat: 'firstline' },
      
      // Big Four
      { id: 'CK7', name: 'CK7', cat: 'bigfour' },
      { id: 'CK20', name: 'CK20', cat: 'bigfour' },
      { id: 'TTF1', name: 'TTF-1', cat: 'bigfour' },
      { id: 'CDX2', name: 'CDX2', cat: 'bigfour' },
      
      // Carcinoma general
      { id: 'PAX8', name: 'PAX8', cat: 'carcinoma' },
      { id: 'Napsina', name: 'Napsin-A', cat: 'carcinoma' },
      { id: 'ER', name: 'ER', cat: 'carcinoma' },
      { id: 'GATA3', name: 'GATA3', cat: 'carcinoma' },
      { id: 'Mammoglobin', name: 'Mammoglobin', cat: 'carcinoma' },
      { id: 'PSA', name: 'PSA', cat: 'carcinoma' },
      { id: 'PSAP', name: 'PSAP', cat: 'carcinoma' },
      { id: 'NKX3', name: 'NKX3', cat: 'carcinoma' },
      { id: 'ERG', name: 'ERG', cat: 'carcinoma' }, // ‚≠ê NEW v2.3
      { id: 'Arginasi', name: 'Arginase-1', cat: 'carcinoma' },
      { id: 'HSA', name: 'Hep-Par-1', cat: 'carcinoma' },
      { id: 'WT1', name: 'WT1', cat: 'carcinoma' },
      { id: 'Calretinin', name: 'Calretinin', cat: 'carcinoma' },
      { id: 'RCC', name: 'RCC', cat: 'carcinoma' },
      { id: 'CA125', name: 'CA-125', cat: 'carcinoma' },
      { id: 'CK5', name: 'CK5/6', cat: 'carcinoma' },
      { id: 'p40', name: 'p40', cat: 'carcinoma' },
      { id: 'p63', name: 'p63', cat: 'carcinoma' },
      { id: 'TRPS1', name: 'TRPS1', cat: 'carcinoma' }, // ‚≠ê NEW v2.9: Mammella 98.7%, pitfall ovaio 40.5%
      { id: 'CK17', name: 'CK17', cat: 'carcinoma' }, // ‚≠ê NEW v2.9: Uroteliale UTUC, PDAC
      { id: 'BCL10', name: 'BCL10', cat: 'carcinoma' }, // ‚≠ê NEW v2.9: Acinare pancreas 90-95%
      { id: 'BetaCatenin', name: 'Œ≤-catenina', cat: 'carcinoma' }, // ‚≠ê NEW v2.9: Solido-pseudopapillare nucleare
      { id: 'NUT', name: 'NUT', cat: 'carcinoma' }, // ‚≠ê NEW v2.9: Midline carcinoma, pattern speckled
      
      // Neuroendocrine
      { id: 'Synapt', name: 'Synaptophysin', cat: 'neuroendocrine' },
      { id: 'Cromo', name: 'Chromogranin', cat: 'neuroendocrine' },
      { id: 'CD56', name: 'CD56', cat: 'neuroendocrine' },
      { id: 'CD57', name: 'CD57', cat: 'neuroendocrine' }, // ‚≠ê NEW v2.3
      { id: 'INSM1', name: 'INSM1', cat: 'neuroendocrine' }, // ‚≠ê NEW v2.9: NE nucleare 96.4%, first-line
      
      // Melanocytic (S100 gi√† in firstline, lo referenziamo)
      { id: 'SOX10', name: 'SOX10', cat: 'melanocytic' }, // ‚≠ê NEW v2.3
      { id: 'MelanA', name: 'Melan-A', cat: 'melanocytic' },
      { id: 'HMB45', name: 'HMB-45', cat: 'melanocytic' },
      { id: 'PRAME', name: 'PRAME', cat: 'melanocytic' },
      
      // GCT
      { id: 'OCT34', name: 'OCT3/4', cat: 'gct' },
      { id: 'SALL4', name: 'SALL4', cat: 'gct' },
      { id: 'AFP', name: 'AFP', cat: 'gct' },
      { id: 'HCG', name: 'Œ≤-HCG', cat: 'gct' },
      { id: 'PLAP', name: 'PLAP', cat: 'gct' },
      { id: 'CD30', name: 'CD30', cat: 'gct' },
      { id: 'GPC3', name: 'Glypican-3', cat: 'gct' },
      
      // Lymphoma
      { id: 'CD20', name: 'CD20', cat: 'lymphoma' },
      { id: 'CD3', name: 'CD3', cat: 'lymphoma' },
      { id: 'CD15', name: 'CD15', cat: 'lymphoma' },
      { id: 'CD79a', name: 'CD79a', cat: 'lymphoma' },
      { id: 'PAX5', name: 'PAX5', cat: 'lymphoma' },
      { id: 'ALK', name: 'ALK', cat: 'lymphoma', sacco: true },
      
      // Sarcoma
      { id: 'Desmin', name: 'Desmin', cat: 'sarcoma' },
      { id: 'SMA', name: 'SMA', cat: 'sarcoma' },
      { id: 'MyoD1', name: 'MyoD1', cat: 'sarcoma', sacco: true },
      { id: 'Myogenin', name: 'Myogenin', cat: 'sarcoma' },
      { id: 'STAT6', name: 'STAT6', cat: 'sarcoma' },
      { id: 'DOG1', name: 'DOG1', cat: 'sarcoma' },
      { id: 'H3K27me3', name: 'H3K27me3', cat: 'sarcoma' }, // ‚≠ê NEW v2.8: MPNST (loss = maligno)
      { id: 'Calponin', name: 'Calponina', cat: 'sarcoma' }, // ‚≠ê NEW v2.8: Mioepiteliale
      
      // MMR
      { id: 'MLH1', name: 'MLH1', cat: 'mmr' },
      { id: 'MSH2', name: 'MSH2', cat: 'mmr' },
      { id: 'MSH6', name: 'MSH6', cat: 'mmr' },
      { id: 'PMS2', name: 'PMS2', cat: 'mmr' },
    ];

    // ============================================
    // PANELS DEFINITION v2.3
    // ============================================
    
    const panels = [
      { 
        id: 'carcinoma', 
        name: 'Pannello Carcinoma', 
        markers: [
          { label: 'Polmone', markers: [
            { id: 'TTF1', name: 'TTF-1' },
            { id: 'Napsina', name: 'Napsin-A' },
          ]},
          { label: 'Mammella/Gineco', markers: [
            { id: 'ER', name: 'ER' },
            { id: 'GATA3', name: 'GATA3' },
            { id: 'TRPS1', name: 'TRPS1' }, // ‚≠ê NEW v2.9: 98.7% mammella
            { id: 'Mammoglobin', name: 'Mammoglobin' },
            { id: 'PAX8', name: 'PAX8' },
            { id: 'WT1', name: 'WT1' },
          ]},
          { label: 'Prostata', markers: [
            { id: 'PSA', name: 'PSA' },
            { id: 'PSAP', name: 'PSAP' },
            { id: 'NKX3', name: 'NKX3' },
            { id: 'ERG', name: 'ERG' },
          ]},
          { label: 'Uroteliale', markers: [ // ‚≠ê NEW v2.9
            { id: 'GATA3', name: 'GATA3' },
            { id: 'CK17', name: 'CK17' }, // UTUC 85%
            { id: 'CK5', name: 'CK5/6' },
          ]},
          { label: 'Pancreas', markers: [ // ‚≠ê NEW v2.9
            { id: 'BCL10', name: 'BCL10' }, // Acinare 90-95%
            { id: 'BetaCatenin', name: 'Œ≤-catenina' }, // SPT nucleare
            { id: 'CK17', name: 'CK17' }, // PDAC subset
          ]},
          { label: 'Epatico/Renale', markers: [
            { id: 'Arginasi', name: 'Arginase-1' },
            { id: 'HSA', name: 'Hep-Par-1' },
            { id: 'RCC', name: 'RCC' },
            { id: 'PAX8', name: 'PAX8' },
          ]},
          { label: 'Mesotelio', markers: [
            { id: 'WT1', name: 'WT1' },
            { id: 'Calretinin', name: 'Calretinin' },
          ]},
          { label: 'Squamoso', markers: [
            { id: 'CK5', name: 'CK5/6' },
            { id: 'p40', name: 'p40' },
            { id: 'p63', name: 'p63' },
            { id: 'NUT', name: 'NUT' }, // ‚≠ê NEW v2.9: Midline carcinoma, pattern speckled
          ]},
        ]
      },
      { 
        id: 'neuroendocrine', 
        name: 'Pannello Neuroendocrino', 
        markers: [
          { label: 'First-line', markers: [
            { id: 'INSM1', name: 'INSM1' }, // ‚≠ê NEW v2.9: 96.4% sens, nucleare
            { id: 'Synapt', name: 'Synaptophysin' },
            { id: 'Cromo', name: 'Chromogranin' },
            { id: 'CD56', name: 'CD56' },
          ]},
          { label: 'Second-line', markers: [
            { id: 'CD57', name: 'CD57' },
          ]},
        ]
      },
      { 
        id: 'melanocytic', 
        name: 'Pannello Melanocitico', 
        markers: [
          { label: 'First-line', markers: [
            { id: 'S100', name: 'S100' },
            { id: 'SOX10', name: 'SOX10' },
            { id: 'MelanA', name: 'Melan-A' },
            { id: 'HMB45', name: 'HMB-45' },
            { id: 'PRAME', name: 'PRAME' },
          ]},
        ]
      },
      { 
        id: 'gct', 
        name: 'Pannello GCT', 
        markers: [
          { label: 'First-line', markers: [
            { id: 'OCT34', name: 'OCT3/4' },
            { id: 'SALL4', name: 'SALL4' },
            { id: 'AFP', name: 'AFP' },
            { id: 'HCG', name: 'Œ≤-HCG' },
          ]},
          { label: 'Second-line', markers: [
            { id: 'PLAP', name: 'PLAP' },
            { id: 'CD30', name: 'CD30' },
            { id: 'GPC3', name: 'Glypican-3' },
          ]},
        ]
      },
      { 
        id: 'lymphoma', 
        name: 'Pannello Linfoma', 
        markers: [
          { label: 'Basic', markers: [
            { id: 'CD20', name: 'CD20' },
            { id: 'CD3', name: 'CD3' },
            { id: 'CD15', name: 'CD15' },
            { id: 'CD79a', name: 'CD79a' },
            { id: 'PAX5', name: 'PAX5' },
            { id: 'ALK', name: 'ALK', sacco: true },
          ]},
        ]
      },
      { 
        id: 'sarcoma', 
        name: 'Pannello Sarcoma', 
        markers: [
          { label: 'Muscolare', markers: [
            { id: 'Desmin', name: 'Desmin' },
            { id: 'SMA', name: 'SMA' },
            { id: 'MyoD1', name: 'MyoD1', sacco: true },
            { id: 'Myogenin', name: 'Myogenin' },
            { id: 'Calponin', name: 'Calponina' }, // ‚≠ê NEW v2.8
          ]},
          { label: 'Nerve Sheath', markers: [ // ‚≠ê NEW v2.8
            { id: 'S100', name: 'S100' },
            { id: 'SOX10', name: 'SOX10' },
            { id: 'H3K27me3', name: 'H3K27me3' }, // Loss = MPNST
          ]},
          { label: 'Altri', markers: [
            { id: 'STAT6', name: 'STAT6' },
            { id: 'DOG1', name: 'DOG1' },
          ]},
        ]
      },
      { 
        id: 'mmr', 
        name: 'MMR Status', 
        markers: [
          { label: 'Proteine MMR', markers: [
            { id: 'MLH1', name: 'MLH1' },
            { id: 'MSH2', name: 'MSH2' },
            { id: 'MSH6', name: 'MSH6' },
            { id: 'PMS2', name: 'PMS2' },
          ]},
        ]
      },
    ];

    // ============================================
    // STATE MANAGEMENT
    // ============================================
    
    let markerState = {};
    let currentPanel = null;

    // Initialize marker state
    markers.forEach(m => {
      markerState[m.id] = 'not-tested';
    });

    // Helper functions
    const p = (id) => markerState[id] === 'positive';
    const n = (id) => markerState[id] === 'negative';
    const t = (id) => markerState[id] !== 'not-tested';

    // ‚≠ê v2.6 NEW: localStorage persistenza stato
    function saveState() {
      try {
        const state = {
          markerState: markerState,
          currentPanel: currentPanel,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem('ihcCascade_state_v2.6', JSON.stringify(state));
      } catch (e) {
        console.warn('localStorage non disponibile:', e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem('ihcCascade_state_v2.6');
        if (!raw) return false;
        
        const state = JSON.parse(raw);
        if (state.markerState) {
          markerState = state.markerState;
        }
        if (state.currentPanel) {
          currentPanel = state.currentPanel;
        }
        return true;
      } catch (e) {
        console.warn('Errore caricamento stato:', e);
        return false;
      }
    }

    function clearSavedState() {
      try {
        localStorage.removeItem('ihcCascade_state_v2.6');
      } catch (e) {
        console.warn('Errore clear stato:', e);
      }
    }

    // ============================================
    // UI RENDERING v2.3
    // ============================================
    
    function renderFirstLine() {
      const firstLineMarkers = ['CKAE1', 'CD45', 'Vim', 'S100'];
      const container = document.getElementById('firstLine');
      
      container.innerHTML = firstLineMarkers.map(id => {
        const marker = markers.find(m => m.id === id);
        return `
          <div class="marker-group">
            <h3>${marker.name}</h3>
            <div class="marker-btn-group">
              <button class="marker-btn ${markerState[id] === 'positive' ? 'positive' : ''}" 
                      onclick="setMarker('${id}', 'positive')">
                ‚úì Positivo
              </button>
              <button class="marker-btn ${markerState[id] === 'negative' ? 'negative' : ''}" 
                      onclick="setMarker('${id}', 'negative')">
                ‚úó Negativo
              </button>
              <button class="marker-btn ${markerState[id] === 'not-tested' ? 'not-tested' : ''}" 
                      onclick="setMarker('${id}', 'not-tested')">
                ? ND
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      // Show/hide Big Four based on CKAE1
      updateBigFourVisibility();
    }

    function updateBigFourVisibility() {
      const bigFourSection = document.getElementById('bigFourSection');
      const ckNegCallout = document.getElementById('ckNegativeCallout');
      
      if (p('CKAE1')) {
        bigFourSection.style.display = 'block';
        ckNegCallout.style.display = 'none';
      } else {
        bigFourSection.style.display = 'none';
        
        // ‚≠ê v2.6: Mostra callout se CK‚àí o ND + morfologia epiteliale
        const hasEpiMorph = document.getElementById('arch_gland')?.checked || 
                            document.getElementById('arch_trabec')?.checked ||
                            document.getElementById('arch_solid')?.checked;
        
        if ((n('CKAE1') || !t('CKAE1')) && hasEpiMorph) {
          ckNegCallout.style.display = 'block';
        } else {
          ckNegCallout.style.display = 'none';
        }
      }
    }

    function renderBigFour() {
      const bigFour = ['CK7', 'CK20', 'TTF1', 'CDX2'];
      const container = document.getElementById('bigFour');
      
      container.innerHTML = bigFour.map(id => {
        const marker = markers.find(m => m.id === id);
        return `
          <div class="marker-group">
            <h3>${marker.name}</h3>
            <div class="marker-btn-group">
              <button class="marker-btn ${markerState[id] === 'positive' ? 'positive' : ''}" 
                      onclick="setMarker('${id}', 'positive')">
                ‚úì Positivo
              </button>
              <button class="marker-btn ${markerState[id] === 'negative' ? 'negative' : ''}" 
                      onclick="setMarker('${id}', 'negative')">
                ‚úó Negativo
              </button>
              <button class="marker-btn ${markerState[id] === 'not-tested' ? 'not-tested' : ''}" 
                      onclick="setMarker('${id}', 'not-tested')">
                ? ND
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderPanelGrid() {
      const container = document.getElementById('panelGrid');
      
      container.innerHTML = panels.map(panel => `
        <button class="panel-btn ${currentPanel === panel.id ? 'active' : ''}" 
                onclick="selectPanel('${panel.id}')">
          ${panel.name}
        </button>
      `).join('');
    }

    function renderMarkerPanels() {
      const container = document.getElementById('markerPanels');
      
      container.innerHTML = panels.map(panel => `
        <div class="marker-panel ${currentPanel === panel.id ? 'active' : ''}" 
             id="panel-${panel.id}">
          <h3>${panel.name}</h3>
          ${panel.markers.map(section => `
            <div class="marker-section">
              <div class="marker-section-label">${section.label}</div>
              <div class="marker-grid">
                ${section.markers.map(m => {
                  const state = markerState[m.id];
                  const saccoTag = m.sacco ? '<span class="sacco-badge">SACCO</span>' : '';
                  return `
                    <div class="marker-item">
                      <button class="${state === 'positive' ? 'positive' : ''}" 
                              onclick="setMarker('${m.id}', 'positive')" 
                              title="${m.name} Positivo">
                        +
                      </button>
                      <button class="${state === 'negative' ? 'negative' : ''}" 
                              onclick="setMarker('${m.id}', 'negative')" 
                              title="${m.name} Negativo">
                        ‚àí
                      </button>
                      <button class="${state === 'not-tested' ? 'not-tested' : ''}" 
                              onclick="setMarker('${m.id}', 'not-tested')" 
                              style="flex: 2;"
                              title="${m.name} Non Testato">
                        ${m.name}${saccoTag}
                      </button>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      `).join('');
    }

    function setMarker(id, state) {
      markerState[id] = state;
      renderFirstLine();
      renderBigFour();
      if (currentPanel) renderMarkerPanels();
      
      // ‚≠ê v2.5: Update auto-panel suggestions real-time
      updateAutoPanelSuggestions();
      
      // ‚≠ê v2.6: Salva stato
      saveState();
    }

    // ‚≠ê NEW v2.5: Auto-panel suggestions based on first-line
    function updateAutoPanelSuggestions() {
      const container = document.getElementById('autoPanelSuggestions');
      if (!container) return; // Container not rendered yet
      
      const suggestions = [];
      
      // CK+ & CD45‚àí ‚Üí Carcinoma
      if (p('CKAE1') && n('CD45')) {
        suggestions.push({
          text: 'üéØ <strong>Sospetto Carcinoma</strong> (CK+/CD45‚àí) ‚Üí Apri pannello carcinoma',
          panel: 'carcinoma'
        });
      }
      
      // CD45+ & CK‚àí ‚Üí Linfoma
      if (p('CD45') && n('CKAE1')) {
        suggestions.push({
          text: 'üéØ <strong>Sospetto Linfoma</strong> (CD45+/CK‚àí) ‚Üí Apri pannello linfoma',
          panel: 'lymphoma'
        });
      }
      
      // S100+ & CK‚àí & CD45‚àí ‚Üí Melanoma
      if (p('S100') && n('CKAE1') && n('CD45')) {
        suggestions.push({
          text: 'üéØ <strong>Sospetto Melanoma</strong> (S100+/CK‚àí/CD45‚àí) ‚Üí Apri pannello melanocitico',
          panel: 'melanocytic'
        });
      }
      
      // ‚≠ê v2.6 FIX: Vim+ & CK‚àí & CD45‚àí & S100 NEGATIVO ‚Üí Sarcoma
      // Cambiato !p('S100') ‚Üí n('S100') per escludere S100 ND
      if (p('Vim') && n('CKAE1') && n('CD45') && n('S100')) {
        suggestions.push({
          text: 'üéØ <strong>Sospetto Sarcoma</strong> (Vim+/CK‚àí/CD45‚àí/S100‚àí) ‚Üí Apri pannello sarcoma',
          panel: 'sarcoma'
        });
      }
      
      // Render suggestions
      if (suggestions.length > 0) {
        container.style.display = 'block';
        container.innerHTML = suggestions.map(s => `
          <div class="suggestion-card auto-panel" onclick="selectPanel('${s.panel}'); scrollToPanels();">
            <div class="card-detail">${s.text}</div>
          </div>
        `).join('');
      } else {
        container.style.display = 'none';
      }
    }

    function scrollToPanels() {
      document.querySelector('.panel-selection')?.scrollIntoView({ behavior: 'smooth' });
    }

    function selectPanel(panelId) {
      currentPanel = panelId;
      renderPanelGrid();
      renderMarkerPanels();
      
      // ‚≠ê v2.6: Salva stato
      saveState();
    }

    function resetAll() {
      if (confirm('Reset tutti i marcatori e morfologia?')) {
        // Reset markers
        markers.forEach(m => markerState[m.id] = 'not-tested');
        currentPanel = null;
        
        // ‚≠ê v2.4.2 FIX: Reset morfologia
        document.querySelectorAll('.morphology-item input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
          syncMorphologyUI(cb);
        });
        
        renderFirstLine();
        renderBigFour();
        renderPanelGrid();
        renderMarkerPanels();
        document.getElementById('results').style.display = 'none';
        
        // ‚≠ê v2.6: Clear localStorage
        clearSavedState();
      }
    }

    function toggleBibliography() {
      const bib = document.getElementById('bibliography');
      bib.style.display = bib.style.display === 'none' ? 'block' : 'none';
      if (bib.style.display === 'block') {
        renderBibliography();
      }
    }

    // ‚≠ê v2.4.1 FIX: Morphology toggles con listener change (no doppio toggle)
    function syncMorphologyUI(checkbox) {
      const item = checkbox.closest('.morphology-item');
      if (!item) return;
      item.classList.toggle('checked', checkbox.checked);
      
      // ‚≠ê v2.6: Update CK‚àí callout quando cambia morfologia
      updateBigFourVisibility();
    }

    function getMorphologyAlerts() {
      const alerts = [];
      
      // Zellballen + S100 periferico ‚Üí Paraganglioma
      // ‚≠ê v2.4.2 FIX: !p('SOX10') ‚Üí n('SOX10') (solo se negativo, non ND)
      if (document.getElementById('zellballen').checked && p('S100') && n('SOX10')) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è MORFOLOGIA ‚Äî Pattern Zellballen + S100/SOX10‚àí',
          detail: 'Pattern Zellballen (nidi) + S100+/SOX10‚àí: <strong>Paraganglioma</strong> favorito. Verifica S100 periferico (sustentacolare) vs diffuso. Se S100 diffuso + SOX10+ ‚Üí melanoma [Bellizzi 2018].'
        });
      }

      // Vascolare + ERG ‚Üí Angiosarcoma
      if (document.getElementById('vascolar').checked && p('ERG')) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è MORFOLOGIA ‚Äî Vascolare + ERG+',
          detail: 'Pattern vascolare anastomosante + ERG+: <strong>Angiosarcoma</strong> high confidence. ERG marker endoteliale (92-100% angiosarcoma). CD31, CD34, FLI1 supportano [Miettinen 2014].'
        });
      }

      // Trabecolare + Arginasi ‚Üí HCC vs breast
      if (document.getElementById('arch_trabec').checked && p('Arginasi')) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è MORFOLOGIA ‚Äî Trabecolare + Arginasi+',
          detail: 'Architettura trabecolare + Arginasi+: <strong>HCC</strong> favorito. MA verifica ER/GATA3: se positivi ‚Üí metastasi breast Arg+ (12%). Morfologia HCC tipica: trabecole, bile, pseudoghiandole [Karamchandani 2013].'
        });
      }

      // Pigmento + SOX10 ‚Üí Melanoma
      if (document.getElementById('pigment').checked && (p('S100') || p('SOX10'))) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è MORFOLOGIA ‚Äî Pigmento + SOX10/S100',
          detail: 'Pigmento melanina + SOX10/S100: <strong>Melanoma</strong> high confidence. PRAME+ pattern diffuso supporta. HMB45 pu√≤ perdersi in metastasi [Voiculescu 2025].'
        });
      }

      // ‚≠ê NEW v2.8: 7 MORFOLOGIA GAME-CHANGERS

      // 1. Signet-ring ‚Üí Priorit√† GI/breast lobulare
      if (document.getElementById('cyto_signet')?.checked) {
        alerts.push({
          type: 'advisory',
          title: 'üî¨ MORFOLOGIA ‚Äî Signet-ring cells (anello castone)',
          detail: '<strong>Pattern discoesivo game-changer:</strong> PRIORIT√Ä CDX2/SATB2 (stomaco/colon/appendice) vs GATA3/ER (mammella lobulare). E-cadherin loss conferma carcinoma lobulare breast. <strong>SALTA Arginasi/TTF1</strong> (NON prioritari). Morfologia detta la chimica [NotebookLM].'
        });
      }

      // 2. Clear cell ‚Üí Priorit√† PAX8 (RCC!)
      if (document.getElementById('cyto_clear')?.checked) {
        alerts.push({
          type: 'advisory',
          title: '‚ö†Ô∏è MORFOLOGIA ‚Äî Clear cell features',
          detail: '<strong>Trappola CUP:</strong> RCC = primitivo occulto pi√π frequente autopsia. <strong>PAX8 OBBLIGATORIO</strong> (83-98% RCC). CA-IX/CD10 supporto. SALL4 se giovane (seminoma clear cell). Arginasi se trabecolare (HCC clear cell variant). Pattern critico [NotebookLM].'
        });
      }

      // 3. SRBC ‚Üí Step 2 immediato! (Pediatrico)
      if (document.getElementById('cyto_srbc')?.checked) {
        alerts.push({
          type: 'advisory',
          title: 'üî¨ MORFOLOGIA ‚Äî Small Round Blue Cell (SRBC)',
          detail: '<strong>Pattern pediatrico/giovane ‚Üí Step 2 IMMEDIATO:</strong> PRIORIT√Ä CD99 (Ewing diffuso membranoso), INSM1/SYN (Small cell/Merkel), SALL4 (GCT curabile!), TdT (Linfoblastico), Desmin/MyoD1 (Rabdo). Et√† paziente essenziale orientamento [NotebookLM].'
        });
      }

      // 4. Spindle cell ‚Üí "Grande simulatore"
      if (document.getElementById('cyto_spindle')?.checked) {
        alerts.push({
          type: 'advisory',
          title: '‚ö†Ô∏è MORFOLOGIA ‚Äî Pattern fusocellulare/spindle cell',
          detail: '<strong>"Grande simulatore":</strong> carcinoma metaplastico, melanoma desmoplastico, sarcoma vero. <strong>Step 1 modificato:</strong> CK cocktail ampio (AE1/AE3 + CAM5.2 obbligatori), p40 (SCC sarcomatoide), SOX10/S100 (melanoma fusocellulare, MPNST). Cerca residui epiteliali focali [NotebookLM].'
        });
      }

      // 5. Micropapillare ‚Üí GATA3/WT1 priorit√†
      if (document.getElementById('arch_micropap')?.checked) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è MORFOLOGIA ‚Äî Pattern micropapillare (filigree-like)',
          detail: '<strong>Architettura aggressiva:</strong> PRIORIT√Ä GATA3 (mammella o uroteliale), WT1/PAX8 (ovaio sieroso HG), p16 (HPV-related). Pattern biologico aggressivo, prognosi peggiore [NotebookLM].'
        });
      }

      // 6. Lepidico ‚Üí TTF1/Napsina "giudici supremi"
      if (document.getElementById('arch_lepidic')?.checked) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è MORFOLOGIA ‚Äî Pattern lepidico (crescita alveolare)',
          detail: '<strong>TTF1 + Napsina OBBLIGATORI:</strong> crescita lungo pareti alveolari ‚Üí polmone quasi univoco. Salto Step 4: diagnosi gi√† orientata morfologia. Rara simulazione pancreatica [NotebookLM].'
        });
      }

      // 7. Squamoso ‚Üí Salta workup adenocarcinoma!
      if (document.getElementById('diff_squamous')?.checked) {
        alerts.push({
          type: 'advisory',
          title: '‚ö†Ô∏è MORFOLOGIA ‚Äî Differenziazione squamosa (perle/ponti)',
          detail: '<strong>Perle cornee/ponti intercellulari:</strong> PRIORIT√Ä p40 (spec 98-100%, superiore p63), CK5/6, p16/HPV (se linfonodo cervicale). <strong>SALTA workup adenocarcinoma</strong> (CDX2/TTF1/GATA3/Arginasi inutili). Morfologia esclude adenoCA [NotebookLM].'
        });
      }

      return alerts;
    }

    // ============================================
    // PART 2 END
    // ============================================
    // ============================================
    // PART 3: DIAGNOSTIC LOGIC v2.3
    // ============================================

    function getDiagnoses() {
      const dx = [];

      // ========================================
      // FIRST-LINE ORIENTATION v2.4.1 FIX
      // ========================================
      
      // ‚≠ê FIX v2.4.1: CK+ & CD45‚àí = Epiteliale (indipendente da Vim)
      if (p('CKAE1') && n('CD45')) {
        let vimDetail = '';
        if (p('Vim')) {
          vimDetail = ' ‚ö† Vimentina+: comune in RCC (90%), endometrio (80%), sarcomatoidi. Non esclude carcinoma.';
        } else if (n('Vim')) {
          vimDetail = ' Pattern classico Vim‚àí.';
        }
        
        dx.push({ 
          name: 'Neoplasia Epiteliale (Carcinoma)', 
          conf: 'high', 
          detail: `CK AE1/AE3+/CD45‚àí: neoplasia epiteliale (carcinoma).${vimDetail} Procedi con Big Four (CK7/CK20/TTF1/CDX2) per orientamento [SEOM-GECOD 2022].`
        });
      }

      if (p('CD45') && n('CKAE1')) {
        dx.push({ 
          name: 'Neoplasia Linfoide (Linfoma/Leucemia)', 
          conf: 'high', 
          detail: 'CD45+/CK‚àí: linfoma o leucemia. Procedi con pannello linfoma (CD20, CD3, CD15, PAX5). Flow cytometry essenziale [WHO 2017].'
        });
      }

      if (p('Vim') && n('CKAE1') && n('CD45')) {
        dx.push({ 
          name: 'Neoplasia Mesenchimale (Sarcoma) o Carcinoma Vim+', 
          conf: 'medium', 
          detail: '‚ö† Vim+/CK‚àí/CD45‚àí: sarcoma probabile MA vimentina+ anche in: RCC (90%), endometrio (80%), sarcomatoid carcinoma. Check S100 (melanoma/MPNST), Desmin (muscolare), PAX8 (renale/m√ºller), STAT6 (SFT). <strong>Morfologia EE ESSENZIALE</strong>: se architettura ghiandolare/trabecolare ‚Üí carcinoma Vim+, se fascicolare/storiform ‚Üí sarcoma [WHO 2020].'
        });
      }

      if (p('S100') && n('CKAE1') && n('CD45')) {
        dx.push({ 
          name: 'Neoplasia Melanocitica o Nerve Sheath', 
          conf: 'high', 
          detail: 'S100+/CK‚àí/CD45‚àí: melanoma (primaria) o MPNST. Procedi con pannello melanocitico (SOX10, Melan-A, HMB45, PRAME). SOX10+ favorisce melanoma (spec 95% vs carcinomi) [Voiculescu 2025].'
        });
      }

      // ========================================
      // CK7/CK20 PATTERNS
      // ========================================
      
      if (p('CK7') && p('CK20')) {
        dx.push({ 
          name: 'Adenocarcinoma pancreatico, biliare, gastrico (type intestinale)', 
          conf: 'medium', 
          detail: 'Pattern CK7+/CK20+: pancreas (60-80%), bile (50-70%), gastrico type intestinale (40%). Se CDX2+ ‚Üí favorisce gastrico/pancreas. Se PAX8+ raro pattern renale atipico [SEOM-GECOD 2022].'
        });
      }

      if (p('CK7') && n('CK20')) {
        if (p('TTF1')) {
          if (p('Napsina')) {
            dx.push({ 
              name: 'Adenocarcinoma polmonare', 
              conf: 'high', 
              detail: 'TTF-1+/Napsin-A+ (CK7+/CK20‚àí): spec 94-98% polmone [IASLC 2021]. Napsin-A sens 80% primitivo, 65% metastasi. Se Napsin‚àí controllare altri organi (tiroide PAX8+, endometrio ER+) [Park 2007].'
            });
          } else {
            dx.push({ 
              name: 'Adenocarcinoma polmonare vs Altro TTF-1+', 
              conf: 'medium', 
              detail: 'TTF-1+ (CK7+/CK20‚àí/Napsin‚àí): polmone probabile MA check tiroide (Thyroglobulina), endometrio (ER+, PAX8+). TTF-1 non lineage-specific [Park 2007].'
            });
          }
        }

        if (p('ER') || p('GATA3')) {
          dx.push({ 
            name: 'Adenocarcinoma mammario', 
            conf: 'high', 
            detail: 'ER+ o GATA3+ (CK7+/CK20‚àí): mammella probabile. GATA3 sens 80-90%, spec >95% vs altri organi. ER+ anche endometrio, ovaio. Supporto clinico (donna, mammo) [NCCN 2023].'
          });
        }

        if (p('PAX8') && !p('ER')) {
          dx.push({ 
            name: 'Adenocarcinoma ovarico, endometriale, renale, tiroideo', 
            conf: 'medium', 
            detail: 'PAX8+ (CK7+/CK20‚àí/ER‚àí): ovaio sieroso (95%), endometrio (80%), renale (90%), tiroide (100%). DDx: WT1+ favorisce ovaio/mesotelio, RCC+ renale, Thyroglobulina tiroide [Ozcan 2011].'
          });
        }
      }

      if (n('CK7') && p('CK20')) {
        if (p('CDX2')) {
          dx.push({ 
            name: 'Adenocarcinoma colorettale', 
            conf: 'high', 
            detail: 'CDX2+ (CK7‚àí/CK20+): colon-retto sens 95%, spec 95% vs altri GI. Se Synapt+ e morfologia small cell ‚Üí Merkel cell CA [SEOM 2022].'
          });
        } else {
          dx.push({ 
            name: 'Adenocarcinoma GI (colon probabile, gastrico diffuse type possibile)', 
            conf: 'medium', 
            detail: 'CK7‚àí/CK20+ senza CDX2: colon probabile (alcuni CDX2‚àí), gastrico diffuse type (signet ring). MMR status se disponibile [NCCN 2023].'
          });
        }
      }

      if (n('CK7') && n('CK20')) {
        if (p('PSA') || p('NKX3')) {
          dx.push({ 
            name: 'Adenocarcinoma prostatico', 
            conf: 'high', 
            detail: 'NKX3: sens 80-85% nelle metastasi (vs 95-100% primitivo), spec 99-100%. Mantiene espressione meglio di PSA. ‚ö† Perdita in NE (<20%), post-ADT, alto grado [Gurel 2010, Khani 2014].'
          });
          
          if (n('PSA') && p('NKX3')) {
            dx.push({ 
              name: 'Adenoca prostatico PSA-negativo', 
              conf: 'high', 
              detail: 'NKX3+/PSA‚àí: prostata scarsamente diff. o post-terapia. NKX3 marker di scelta nei CUP CK7‚àí/CK20‚àí [Gurel 2010].'
            });
          }
        }

        // ‚≠ê NEW v2.3: ERG prostata
        if (p('ERG') && (p('PSA') || p('NKX3') || p('CKAE1'))) {
          dx.push({ 
            name: 'Adenocarcinoma prostatico ERG+', 
            conf: 'high', 
            detail: 'ERG+ (30-40% prostata con fusione TMPRSS2-ERG). Supporta diagnosi prostata. ‚ö† ERG √® marker endoteliale: se morfologia vascolare ‚Üí angiosarcoma. Se CK+ solido ‚Üí prostata. ERG mantiene espressione post-ADT [Park 2014].'
          });
        }

        // ‚≠ê v2.7.1 REFINED: Pattern ERG+/PSA‚àí/NKX3‚àí/SYN+ ‚Üí Prostata post-ADT NE
        if (p('ERG') && n('PSA') && n('NKX3') && p('Synapt') && (p('Cromo') || p('CD56'))) {
          dx.push({ 
            name: 'Adenocarcinoma prostatico con differenziazione NE (post-ADT)', 
            conf: 'high', 
            detail: '<strong>Pattern diagnostico post-ADT validato (NotebookLM):</strong> ERG+ (TMPRSS2-ERG fusion stabile, "ancora genomica" AR-independent) + SYN/CgA/CD56 (transformation NE 10-20% post-castrazione, shift fenotipico) + PSA‚àí/NKX3‚àí (downregulation AR-pathway: Khani 2014 sens 80.7% mets, 70-75% post-ADT; PSA <50% mets). <strong>Diagnosi:</strong> Adenocarcinoma prostatico TMPRSS2-ERG+ con firma neuroendocrina acquisita. <strong>La perdita PSA/NKX3.1 √® coerente con pregresso trattamento ormonale</strong> [Khani 2014]. <strong>Clinica:</strong> Storia prostata trattata essenziale (ADT >6-12 mesi, prostatectomia, RT). Prognosi: aggressive, consider platinum-based chemotherapy (cisplatino/etoposide). <strong>Morfologia:</strong> solid sheet predominant, small cell pattern, necrosi, mitosi >10/HPF. <strong>DDx:</strong> NEC primitivo (ERG+ esclude), angiosarcoma (morfologia vascolare anastomosante assente, CK+ esclude) [Beltran 2016, Khani 2014, Park 2014].'
          });
        }

        // ‚≠ê v2.4.2 FIX: ERG angiosarcoma - richiede marker testati E negativi
        if (p('ERG') && t('PSA') && n('PSA') && t('NKX3') && n('NKX3') && t('CKAE1') && n('CKAE1')) {
          dx.push({ 
            name: 'Neoplasia vascolare (Angiosarcoma, Emangioendotelioma)', 
            conf: 'high', 
            detail: 'ERG+ marker endoteliale (sens 92-100% angiosarcoma). PSA‚àí/NKX3‚àí/CK‚àí testati escludono prostata. Morfologia: vasi anastomosanti, eritrociti intracitoplasmatici. CD31, CD34, FLI1 supportano origine vascolare [Miettinen 2014].'
          });
        }

        if (n('PSA') && n('NKX3') && t('PSA') && t('NKX3')) {
          dx.push({ 
            name: 'Esclusione prostata incompleta', 
            conf: 'low', 
            detail: 'PSA‚àí/NKX3‚àí in CK7‚àí/CK20‚àí non esclude prostata: ~20% metastasi PSA‚àí, ~15-20% NKX3‚àí (post-ADT, alto grado, NE). Morfologia EE critica. Considerare ERG (30-40% se TMPRSS2-ERG+), PSAP se disponibili [Gurel 2010].'
          });
        }

        if (p('HSA') || p('Arginasi')) {
          dx.push({ 
            name: 'Carcinoma epatocellulare', 
            conf: 'high', 
            detail: 'Arginasi-1: sens 80-96% HCC (53.6% poorly diff. vs HepPar-1 14.3%), spec 96-100% vs cholangioCA/CRC [Yan 2010]. ‚ö† Cross-reattivit√†: breast 12.3% (pattern granulare citoplasmatico identico HCC), prostata <10%, CCA raro. Morfologia EE + coerenza clinica essenziali [Karamchandani 2013].'
          });
          
          if (p('Arginasi') && p('GATA3') && n('ER')) {
            dx.push({ 
              name: 'HCC GATA3+ (raro) vs Metastasi breast', 
              conf: 'medium', 
              detail: 'Arg+/GATA3+/ER‚àí: Pattern raro. HCC pu√≤ essere GATA3+ in ~2%. Se ER‚àí e morfologia trabecolare ‚Üí HCC. Se ER+ o morfologia atipica ‚Üí metastasi breast Arg+ (12.3%) [Karamchandani 2013].'
            });
          }
        }

        if (p('RCC')) {
          dx.push({ 
            name: 'Carcinoma renale', 
            conf: 'high', 
            detail: 'RCC marker (CK7‚àí/CK20‚àí): sens 80-85% RCC. PAX8+ supporta (90% RCC). Morfologia: clear cell, papillare, cromofobo. Se CK7+ pattern atipico (10-15% RCC) [Moch 2016].'
          });
        }
      }

      // ========================================
      // NEUROENDOCRINE
      // ========================================
      
      if (p('Synapt') || p('Cromo') || p('CD56')) {
        dx.push({ 
          name: 'Neoplasia neuroendocrina (NET/NEC)', 
          conf: 'high', 
          detail: 'Synaptophysin (sens 89%, spec alta) > Chromogranin (sens 67%, spec moderata). CD56 sensibile ma meno specifico. Morfologia: carcinoide (NET) vs small cell (NEC). Site-specific: TTF1 polmone 90%, CDX2 GI, CD57 variabile [Bellizzi 2018].'
        });

        if (p('S100') && p('Synapt')) {
          dx.push({ 
            name: 'S100+/SYN+: Paraganglioma vs Melanoma vs NEC', 
            conf: 'medium', 
            detail: 'DDx critica: (1) Paraganglioma: CK‚àí, GATA3+, S100 periferico (sustentacolare), nidi Zellballen. (2) Melanoma: SOX10+, Melan-A+, HMB45+, S100 diffuso. (3) NEC pigmentato (raro). Morfologia EE essenziale [Bellizzi 2018].'
          });
        }

        if ((p('PSA') || p('NKX3')) && p('Synapt')) {
          dx.push({ 
            name: 'Adenocarcinoma prostatico con differenziazione NE', 
            conf: 'high', 
            detail: 'PSA+/NKX3+/SYN+: adenoCA prostata con firma NE. Comune post-ADT, alto grado. Pattern SYN: focale (<30%) = NE subclinica; diffuso (>70%) + small-cell = NEC. Prognosi peggiore [Bellizzi 2018].'
          });
        }

        if (p('Synapt') && n('PSA') && n('NKX3') && t('PSA') && t('NKX3')) {
          dx.push({ 
            name: 'NEC prostatico vs NEC altri siti', 
            conf: 'medium', 
            detail: 'SYN+/PSA‚àí/NKX3‚àí: NEC prostatico perde marcatori (sens PSA/NKX3 <20% in NEC). DDx: NEC polmone (TTF1+ 90%), NEC GI (CDX2). Marcatori terza linea: ERG (30-40% prostata), AR. Morfologia small-cell + sede metastasi (ossee favoriscono prostata) [Bellizzi 2018].'
          });
        }
      }

      // ‚≠ê v2.4: CD57 NE (supportivo debole - warning)
      if (p('CD57') && (p('Synapt') || p('Cromo'))) {
        dx.push({ 
          name: 'Neoplasia neuroendocrina CD57+ ‚ö†Ô∏è SUPPORTIVO DEBOLE', 
          conf: 'low', 
          detail: '‚ö† CD57+ (Leu-7) marker NE <strong>sensibile ma POCO specifico</strong>. Positivo anche: NK cells (60%), gliomi (80%), prostata adenoCA (40%), melanoma (variabile). CD57 NON raccomandato come marker primario NE. <strong>Synaptophysin/INSM1 obbligatori</strong> per diagnosi NE [Bellizzi 2018].'
        });
      }

      // ========================================
      // ‚≠ê NEW v2.9: MARKER EMERGENTI
      // ========================================
      
      // 1. TRPS1 - Mammella (98.7% sens)
      if (p('TRPS1') && n('PAX8') && n('WT1')) {
        dx.push({
          name: 'Carcinoma mammario TRPS1+',
          conf: 'high',
          detail: '<strong>TRPS1+ (98.7% sens mammella) + PAX8‚àí/WT1‚àí (esclude ovaio).</strong> TRPS1 marker pi√π sensibile mammella, superiore GATA3 (67.5%) e SOX10 (72.8%) in TNBC. <strong>Marker di salvataggio</strong> quando GATA3 fallisce. Morfologia: se "Indian-file" discoesivo ‚Üí lobulare favorito. <strong>Clinica:</strong> donna, imaging mammario, storia familiare [NotebookLM 2026].'
        });
      }

      // Alert TRPS1+/PAX8+ (pitfall ovaio!)
      if (p('TRPS1') && p('PAX8')) {
        dx.push({
          name: '‚ö†Ô∏è TRPS1+/PAX8+: DDx Mammella vs Ovaio HGSC',
          conf: 'medium',
          detail: '<strong>TRPS1+ NON esclude ovaio!</strong> 40.5% carcinoma sieroso alto grado (HGSC) ovaio esprime TRPS1. <strong>DDx critico:</strong> (1) Mammella: TRPS1+/PAX8‚àí/WT1‚àí/GATA3+ favorito. (2) Ovaio HGSC: TRPS1+/PAX8+/WT1+/ER+ favorito. <strong>Morfologia + sede:</strong> metastasi peritoneale/pelvica ‚Üí ovaio pi√π probabile; linfonodo ascellare ‚Üí mammella [NotebookLM 2026].'
        });
      }

      // 2. INSM1 - Neuroendocrino nucleare (96.4%)
      if (p('INSM1')) {
        dx.push({
          name: 'Neoplasia neuroendocrina INSM1+',
          conf: 'high',
          detail: '<strong>INSM1+ nucleare (96.4% sens NEC alto grado).</strong> First-line marker NE, superiore CgA/SYN/CD56 (87%). Mantiene espressione in dedifferenziazione quando marker secretori perduti. <strong>Pattern critico:</strong> se diffuso >50% ‚Üí NEN vera; se focale <30% ‚Üí transdifferenziazione NE. <strong>False positivity:</strong> melanoma 13.2%, prostata adenoCA 36.1%. Se INSM1+/SOX10+ ‚Üí melanoma favorito. Se INSM1+ focale in CK7‚àí/CK20‚àí ‚Üí verificare PSA/NKX3 (prostata con differenziazione NE) [Rooper 2017, NotebookLM].'
        });
      }

      // 3. BCL10 - Acinare pancreas (90-95%)
      if (p('BCL10')) {
        dx.push({
          name: 'Carcinoma acinare pancreatico',
          conf: 'high',
          detail: '<strong>BCL10+ citoplasmatico granulare (90-95% sens acinare).</strong> Morfologia: architettura solida, granuli zimogeni eosinofili. <strong>Conferma marker zimogeni</strong> (Lipasi/Tripsina suggerito se disponibile). <strong>DDx:</strong> PDAC duttale (BCL10‚àí/CA19-9+/CK17+ subset), NET (Synaptophysin+/BCL10‚àí), solido-pseudopapillare (Œ≤-catenina nucleare+/BCL10‚àí). <strong>Prognosi:</strong> migliore PDAC duttale (mediana 25-30 mesi vs 6-12). <strong>Terapia:</strong> chirurgia, platinum-based chemio. <strong>Pediatrico:</strong> pancreatoblastoma pu√≤ essere BCL10+ (Œ≤-catenina+, squamoid corpuscles morfologia) [La Rosa 2014].'
        });
      }

      // 4. Œ≤-catenina nucleare - Solido-pseudopapillare
      if (p('BetaCatenin')) {
        dx.push({
          name: 'Tumore solido-pseudopapillare pancreas (Frantz)',
          conf: 'high',
          detail: '<strong>Œ≤-catenina nucleare DIAGNOSTICA.</strong> Morfologia: pattern solido + pseudopapillare, cellule monotone, corpi ialini. <strong>Clinica:</strong> giovani donne (90%), massa pancreatica corpo/coda. <strong>Altri marker:</strong> CD10+, Vimentina+, PR+ variabile. <strong>Prognosi:</strong> eccellente (95% sopravvivenza 5 anni), low-grade malignant potential. <strong>Terapia:</strong> resezione chirurgica curativa. <strong>DDx:</strong> NET (Œ≤-catenina membranosa, Synaptophysin+), acinare (BCL10+, Œ≤-catenina‚àí) [WHO 2019].'
        });
      }

      // 5. CK17 - Uroteliale/PDAC
      if (p('CK17')) {
        dx.push({
          name: 'CK17+: Uroteliale (UTUC) o PDAC',
          conf: 'medium',
          detail: '<strong>CK17+ pattern diagnostico:</strong> (1) Uroteliale alto tratto (UTUC) sens 85%, spec 82%. Pattern non-basale distingue maligno/benigno. (2) PDAC duttale 60-80% (subset aggressivo basal-like). <strong>DDx:</strong> GATA3 discrimina uroteliale vs pancreas (GATA3+ urotelio, GATA3‚àí pancreas se duttale). <strong>Altri CK17+:</strong> cervice squamoso, TNBC subset, ovaio endometrioide. <strong>Morfologia + clinica essenziali</strong> [Biankin 2012, NotebookLM].'
        });
      }

      // 6. NUT - Midline carcinoma
      if (p('NUT')) {
        dx.push({
          name: 'NUT Midline Carcinoma (NMC)',
          conf: 'high',
          detail: '<strong>NUT+ pattern nucleare speckled PATOGNOMONICO.</strong> Fusione BRD4-NUT (75%) o varianti. <strong>Morfologia:</strong> carcinoma scarsamente differenziato "null-type", simula SCC indifferenziato. <strong>Clinica:</strong> giovani (<30 anni picco), massa midline (mediastino, testa-collo, polmone). <strong>IHC supporto:</strong> p63+/p40+ frequente, ma nessun primitivo squamoso identificato. <strong>Prognosi:</strong> aggressivo (mediana sopravvivenza 6-9 mesi), MA target therapy trials (BET inhibitors) promettenti. <strong>Identificazione essenziale</strong> per arruolamento trials [French 2014].'
        });
      }

      // ========================================
      // MELANOCYTIC v2.3
      // ========================================
      
      if (p('S100') || p('SOX10') || p('MelanA') || p('HMB45')) {
        // ‚≠ê v2.9.1 FIX: Downgrade conf se CK+ (DDx TNBC SOX10+ 69%)
        const melanomaConf = p('CKAE1') ? 'medium' : 'high';
        const ckNote = p('CKAE1') ? ' <strong>‚ö†Ô∏è CK+:</strong> DDx TNBC (69% SOX10+). Se CK diffuso forte ‚Üí TNBC favorito; se CK focale/debole ‚Üí melanoma aberrante.' : '';
        
        dx.push({ 
          name: 'Melanoma', 
          conf: melanomaConf, 
          detail: `S100 (sens 97%, spec moderata), SOX10 (sens 95%, spec 95% vs carcinomi). Melan-A, HMB45 pi√π specifici ma meno sensibili (possono perdersi in metastasi). Morfologia: pleomorfismo, pigmento.${ckNote} [Voiculescu 2025]`
        });

        // ‚≠ê NEW v2.3: SOX10 melanoma (pi√π specifico)
        if (p('SOX10')) {
          dx.push({ 
            name: 'Melanoma SOX10+ (alta specificit√†)', 
            conf: melanomaConf, 
            detail: `SOX10+ (sens 95%, spec 95% vs carcinomi). Pi√π specifico di S100 (cross-react schwannoma, myoepi, condro). Se SOX10+/PRAME+ pattern diffuso ‚Üí melanoma high confidence. SOX10 mantiene espressione in metastasi.${ckNote} [Nonaka 2008]`
          });
        }

        // ‚≠ê UPDATED v2.2: PRAME melanoma
        if (p('S100') && p('SOX10') && p('PRAME')) {
          dx.push({ 
            name: 'Melanoma PRAME+', 
            conf: melanomaConf, 
            detail: `S100+/SOX10+/PRAME+: melanoma (sens PRAME 83-94%). Pattern PRAME diffuso (>50% cellule) supporta malignit√†. Melan-A, HMB45 possono perdersi in metastasi. PRAME mantiene espressione.${ckNote} [Lezcano 2018]`
          });
        }

        // ‚≠ê v2.2: DDx Spitz
        if ((p('S100') || p('SOX10')) && t('PRAME')) {
          dx.push({ 
            name: 'DDx Nevo di Spitz vs Melanoma Spitzoide', 
            conf: 'medium', 
            detail: '<strong>PRAME pattern-critical:</strong> (1) <strong>Nevo di Spitz</strong> (benigno): PRAME <em>negativo</em> (0% casi). (2) <strong>Melanoma Spitzoide</strong> (maligno): PRAME <em>positivo diffuso</em> (>50% cellule). ‚ö† Pattern PRAME+ diffuso in lesione spitzoide = <strong>red flag malignit√†</strong>. Morfologia EE (mitosi, atipia citologica, ulcerazione) essenziale [Lezcano 2018].'
          });
        }

        // ‚≠ê v2.2: PRAME cross-react
        if (p('PRAME') && !p('S100') && !p('SOX10')) {
          dx.push({ 
            name: 'PRAME+ non-melanocitico: Sarcoma vs RCC vs Altri', 
            conf: 'low', 
            detail: 'PRAME+ cross-reattivit√†: (1) Sarcoma Sinoviale 80-90% (morfologia bifasica, vasi emangiopericitoidi, SS18-SSX). (2) RCC (clear cell, cromofobo): check PAX8. (3) Carcinoma sebaceo (raro). Pattern PRAME: se diffuso in contesto melanocitico ‚Üí melanoma; se diffuso + CK+ ‚Üí sarcoma sinoviale [Gradecki 2021].'
          });
        }
      }

      // ‚≠ê NEW v2.8: SOX10 DDx COMPLETO (NotebookLM)
      // SOX10+ mimickers oltre melanoma
      
      // 1. TNBC SOX10+ (69%!) - CRITICO
      if (p('SOX10') && p('CKAE1') && p('GATA3') && n('ER')) {
        dx.push({
          name: 'Carcinoma mammario Triple Negative (TNBC) SOX10+',
          conf: 'high',
          detail: '<strong>SOX10+/CK+/GATA3+/ER‚àí:</strong> 69% TNBC basal-like esprime SOX10 [Ivanov 2013]. Pattern diagnostico: <strong>SOX10 NON esclude carcinoma</strong>. CK+ diffuso forte (vs melanoma CK focale/debole se presente). Clinica: donna, metastasi linfonodo ascellare, imaging mammario. Prognosi: aggressivo, immunoterapia/chemio. <strong>DDx melanoma:</strong> Melan-A/HMB45/PRAME escludono.'
        });
      }

      // 2. MPNST con H3K27me3 loss - CRITICO
      if (p('SOX10') && p('S100') && n('H3K27me3') && n('MelanA') && n('HMB45')) {
        dx.push({
          name: 'MPNST (Malignant Peripheral Nerve Sheath Tumor)',
          conf: 'high',
          detail: '<strong>SOX10+ (49% MPNST) + S100+ (30% MPNST) + H3K27me3 loss nucleare (80-85% spec).</strong> Morfologia: fusocellulare "spina di pesce", pleomorfismo, necrosi, mitosi >10/HPF. Melan-A‚àí/HMB45‚àí esclude melanoma. DDx: schwannoma (H3K27me3 retained). Clinica: NF1 50%, prognosi aggressiva, chemo/RT [Rodriguez 2000].'
        });
      }

      // 3. Schwannoma benigno (H3K27me3 retained)
      if (p('SOX10') && p('S100') && p('H3K27me3') && n('MelanA') && n('HMB45')) {
        dx.push({
          name: 'Schwannoma (benigno)',
          conf: 'high',
          detail: '<strong>SOX10+/S100+ diffuso + H3K27me3 retained (nucleo positivo).</strong> Morfologia: Antoni A/B, corpi Verocay. Melan-A‚àí/HMB45‚àí esclude melanoma. Benigno: exeresi chirurgica, follow-up. DDx: MPNST (H3K27me3 loss, morfologia high-grade) [Rodriguez 2000].'
        });
      }

      // 4. Paraganglioma SOX10+ (rafforzato)
      if (p('SOX10') && p('S100') && p('GATA3') && n('CKAE1') && n('MelanA')) {
        dx.push({
          name: 'Paraganglioma',
          conf: 'high',
          detail: '<strong>SOX10+/S100 periferico (sustentacolare)+/GATA3+/CK‚àí.</strong> Morfologia: pattern Zellballen (nidi), S100 sustentacolare (NON cellule principali). DDx melanoma: GATA3‚àí in melanoma, Melan-A+ in melanoma. Imaging: sede paravascolare (carotideo, aortico, giugulo-timpanico). Prognosi: variabile, gene-specific [Bellizzi 2018].'
        });
      }

      // 5. Tumore mioepiteliale SOX10+
      if (p('SOX10') && p('CKAE1') && (p('p63') || p('p40')) && (p('SMA') || p('Calponin'))) {
        dx.push({
          name: 'Tumore mioepiteliale (salivare/cutaneo)',
          conf: 'high',
          detail: '<strong>SOX10+/CK+/p63 o p40+ (componente basale) + SMA/Calponina+ (lineage contrattile).</strong> Morfologia: pattern bifasico epiteliale + mioide. Sede: ghiandola salivare, cute, mammella. Spettro: adenoma mioepiteliale (benigno) ‚Üí carcinoma mioepiteliale (maligno). Prognosi: dipende grading [WHO 2020].'
        });
      }

      // ‚≠ê NEW v2.3: DDx Schwannoma vs Melanoma (SOX10+)
      if (p('S100') && p('SOX10') && n('MelanA') && n('HMB45')) {
        dx.push({ 
          name: 'Schwannoma vs Melanoma amelanotico', 
          conf: 'medium', 
          detail: 'S100+/SOX10+/Melan-A‚àí/HMB45‚àí: DDx critica. Schwannoma: pattern Antoni A/B, corpi Verocay, GFAP+, S100 uniforme. Melanoma amelanotico: pleomorfismo, mitosi, PRAME+ (83-94%). Morfologia EE essenziale [Rodriguez 2000].'
        });
      }

      // Continue with remaining diagnoses (GCT, Lymphoma, Sarcoma, MMR)...
      // [Same as v2.2 - abbreviated for space]

      // GCT, Lymphoma, Sarcoma, MMR (same as v2.2)
      
      // ========================================
      // GCT
      // ========================================
      
      if (p('OCT34') || p('SALL4') || p('AFP') || p('HCG')) {
        if (p('OCT34') && p('SALL4')) {
          dx.push({ 
            name: 'Seminoma/Disgerminoma', 
            conf: 'high', 
            detail: 'OCT3/4+/SALL4+: seminoma (testicolo) o disgerminoma (ovaio). PLAP+ supporta. Morfologia: cellule uniformi, linfociti, granulomi [WHO 2022].'
          });
        }

        if (p('AFP')) {
          dx.push({ 
            name: 'Yolk Sac Tumor o Epatocarcinoma', 
            conf: 'medium', 
            detail: 'AFP+: yolk sac tumor se giovane + sede gonadica/mediastino/retroperitoneo. HCC se adulto + fegato. GPC3+ supporta yolk sac. Morfologia: corpi Schiller-Duval [Zynger 2008].'
          });
        }

        if (p('HCG')) {
          dx.push({ 
            name: 'Choriocarcinoma o Trofoblasto', 
            conf: 'high', 
            detail: 'Œ≤-HCG+: choriocarcinoma (citotrofoblasto, sinciziotrofoblasto) o componente trofoblastica in mixed GCT. Morfologia: emorragia, necrosi [WHO 2022].'
          });
        }

        if (p('CD30') && !p('CD15')) {
          dx.push({ 
            name: 'Embryonal Carcinoma', 
            conf: 'medium', 
            detail: 'CD30+/CD15‚àí: embryonal carcinoma (90-95% CD30+). Se CD15+ ‚Üí considera linfoma Hodgkin. SALL4+ supporta lineage germinale. Morfologia: cellule epitelioidi, necrosi [Agaimy 2012].'
          });
        }

        if (p('SALL4') && n('OCT34') && n('AFP') && n('HCG')) {
          dx.push({ 
            name: 'SALL4 isolato: GCT vs Adenocarcinoma gastrico', 
            conf: 'low', 
            detail: 'SALL4+ isolato (senza OCT3/4, AFP, HCG): pu√≤ essere GCT MA anche 10-15% adenocarcinomi gastrici. Morfologia + sede + et√† critiche. Se >40 anni + GI ‚Üí favorisce gastrico [Cao 2009].'
          });
        }
      }

      // ========================================
      // LYMPHOMA
      // ========================================
      
      if (p('CD20') || p('CD3') || p('PAX5')) {
        if (p('CD20')) {
          dx.push({ 
            name: 'Linfoma B', 
            conf: 'high', 
            detail: 'CD20+ (o PAX5+): lineage B. Sottotipizzazione: citofluorimetria, FISH, NGS. Morfologia + clinica essenziali [WHO 2017].'
          });
        }

        if (p('CD3')) {
          dx.push({ 
            name: 'Linfoma T', 
            conf: 'high', 
            detail: 'CD3+: lineage T. Sottotipizzazione: CD4, CD8, TCR, FISH. Morfologia + clinica essenziali [WHO 2017].'
          });
        }

        if (p('CD15') && p('CD30')) {
          dx.push({ 
            name: 'Linfoma di Hodgkin classico', 
            conf: 'high', 
            detail: 'CD15+/CD30+: Hodgkin classico (Reed-Sternberg). PAX5+ debole, CD20‚àí tipico. Morfologia: cellule HRS, background [WHO 2017].'
          });
        }

        if (p('ALK')) {
          dx.push({ 
            name: 'ALCL ALK+', 
            conf: 'high', 
            detail: 'ALK+ (CD30+ tipico): ALCL ALK-positivo. Prognosi migliore vs ALK‚àí. Morfologia: hallmark cells [WHO 2017].'
          });
        }
      }

      // ========================================
      // SARCOMA
      // ========================================
      
      if (p('Desmin') || p('SMA') || p('MyoD1') || p('Myogenin')) {
        if (p('MyoD1') || p('Myogenin')) {
          dx.push({ 
            name: 'Rabdomiosarcoma', 
            conf: 'high', 
            detail: 'MyoD1+ o Myogenin+: rabdomiosarcoma. Embrionale (giovani), alveolare (t(2;13) PAX3-FOXO1), pleomorfo (adulti). Desmin+ supporta [WHO 2020].'
          });
        }

        if (p('Desmin') && !p('MyoD1') && !p('Myogenin')) {
          dx.push({ 
            name: 'Sarcoma muscolare liscio (Leiomiosarcoma)', 
            conf: 'medium', 
            detail: 'Desmin+/MyoD1‚àí/Myogenin‚àí: leiomiosarcoma probabile. SMA+, h-Caldesmon+ supportano. Morfologia: fasci, cigar nuclei [WHO 2020].'
          });
        }

        if (p('STAT6')) {
          dx.push({ 
            name: 'Tumore fibroso solitario', 
            conf: 'high', 
            detail: 'STAT6+ (nucleare): SFT (NAB2-STAT6). CD34+ tipico. Morfologia: patternless, vasi ectasici [WHO 2020].'
          });
        }
      }

      // ========================================
      // MMR STATUS
      // ========================================
      
      if (t('MLH1') || t('MSH2') || t('MSH6') || t('PMS2')) {
        if (n('MLH1') && n('PMS2')) {
          dx.push({ 
            name: 'dMMR: Loss MLH1/PMS2', 
            conf: 'high', 
            detail: 'MLH1‚àí/PMS2‚àí (MSH2+/MSH6+ retained): sporadico (metilazione promotore MLH1) 90%. Test: BRAF V600E (mut ‚Üí sporadico), metilazione MLH1. Se BRAF WT ‚Üí considera Lynch. Clinica: et√† >60 anni favorisce sporadico [Shia 2008, Haraldsdottir 2014].'
          });
        }

        if (n('MSH2') && n('MSH6')) {
          dx.push({ 
            name: 'dMMR: Loss MSH2/MSH6 - LYNCH SYNDROME', 
            conf: 'high', 
            detail: 'MSH2‚àí/MSH6‚àí (MLH1+/PMS2+ retained): <strong>Lynch syndrome</strong> (mutazione germinale MSH2) fino a prova contraria. ‚ö† Counseling genetico IMMEDIATO. Raro sporadico (<5%). Et√† giovane (<50), storia familiare [Haraldsdottir 2014].'
          });
        }

        if (n('PMS2') && !n('MLH1')) {
          dx.push({ 
            name: 'dMMR: Loss PMS2 isolata', 
            conf: 'medium', 
            detail: 'PMS2‚àí isolato (MLH1+ retained): Lynch PMS2 possibile o metilazione somatica PMS2 (rara). Test genetico PMS2. Interpretazione complessa [Shia 2008].'
          });
        }

        if (n('MSH6') && !n('MSH2')) {
          dx.push({ 
            name: 'dMMR: Loss MSH6 isolata', 
            conf: 'medium', 
            detail: 'MSH6‚àí isolato (MSH2+ retained): Lynch MSH6 possibile (mutazione germinale MSH6). Counseling genetico. Penetranza ridotta vs MLH1/MSH2 [Haraldsdottir 2014].'
          });
        }
      }

      return dx;
    }
    // ============================================
    // ‚≠ê NEW v2.10: SITE-SPECIFIC ALERTS (NotebookLM)
    // ============================================
    
    function getSiteSpecificAlerts() {
      const site = document.getElementById('biopsySite')?.value;
      const sex = document.getElementById('patientSex')?.value;
      const age = parseInt(document.getElementById('patientAge')?.value) || null;
      const alerts = [];
      
      // 1. Linfonodo cervicale
      if (site === 'ln_cervical') {
        if (age && age < 40 && sex === 'F') {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Linfonodo Cervicale Giovane Donna',
            detail: '<strong>Priorit√† et√†/sesso-dipendente:</strong><br>'+
                   '1. <strong>Tiroide (PTC)</strong>: TTF1/Tireoglobulina/PAX8 (morfologia: papille, nuclei ground glass)<br>'+
                   '2. <strong>Linfoma</strong>: CD45, pannello linfoma<br>'+
                   '3. SCC H&N (meno probabile giovane donna)<br>'+
                   '<strong>Testing SCC:</strong> p16/HPV (orofaringe), EBV/EBER (rinofaringe) [NotebookLM 2026].'
          });
        } else {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Linfonodo Cervicale',
            detail: '<strong>Entit√† probabilistiche:</strong> SCC (H&N, polmone, cervice), Tiroide (PTC), Adenocarcinoma, Linfoma.<br>'+
                   '<strong>Percorso rapido:</strong><br>'+
                   '‚Ä¢ Se morfologia SCC: p40/CK5/6 + p16/HPV (orofaringe) + EBV/EBER (rinofaringe)<br>'+
                   '‚Ä¢ Se morfologia tiroide: TTF1/Tireoglobulina/PAX8 (triade mandataria)<br>'+
                   '‚Ä¢ Uomo anziano fumatore ‚Üí SCC priorit√† [NotebookLM 2026].'
          });
        }
      }
      
      // 2. Linfonodo ascellare
      if (site === 'ln_axillary') {
        if (sex === 'F') {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Linfonodo Ascellare Donna ("Breast-like CUP")',
            detail: '<strong>Mammella >90% probabilit√†.</strong><br>'+
                   '<strong>SALTARE Big Four ‚Üí Site-specific IMMEDIATI:</strong><br>'+
                   '‚Ä¢ GATA3 (sens >90% mammella)<br>'+
                   '‚Ä¢ ER/TRPS1<br>'+
                   '‚Ä¢ Mammoglobin (spec alta)<br>'+
                   '<strong>Morfologia "Indian-file" discoesivo ‚Üí lobulare favorito.</strong><br>'+
                   'Se CK‚àí + cellule epitelioidi ‚Üí SOX10 (melanoma 95-100%) [NotebookLM 2026].'
          });
        } else {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Linfonodo Ascellare',
            detail: '<strong>DDx:</strong> Melanoma (SOX10), Polmone (TTF1/Napsina), Linfoma (CD45).<br>'+
                   'Mammella maschio possibile ma raro (<1%).'
          });
        }
      }
      
      // 3. Linfonodo inguinale
      if (site === 'ln_inguinal') {
        alerts.push({
          type: 'advisory',
          title: 'üéØ SEDE ‚Äî Linfonodo Inguinale',
          detail: '<strong>Priorit√† SCC ano-genitale:</strong><br>'+
                 '‚Ä¢ p40 + p16/HPV (vulva, vagina, pene, ano)<br>'+
                 '‚Ä¢ p16+ ‚Üí HPV-related (prognosi favorevole)<br>'+
                 '<strong>DDx:</strong><br>'+
                 '‚Ä¢ Melanoma acrale/vulvare (SOX10/PRAME)<br>'+
                 '‚Ä¢ Uroteliale (GATA3/CK17 invasione locale vescica)<br>'+
                 '‚Ä¢ Colorettale (RARO, solo se morfologia intestinale) [NotebookLM 2026].'
        });
      }
      
      // 4. Metastasi epatica
      if (site === 'liver') {
        if (document.getElementById('cyto_clear')?.checked) {
          alerts.push({
            type: 'redflag',
            title: '‚ö†Ô∏è SEDE ‚Äî Fegato Clear Cell',
            detail: '<strong>PAX8 priorit√† ASSOLUTA (RCC 83-98% clear cell epatica).</strong><br>'+
                   'SALTARE workup GI (statisticamente improbabile clear cell).<br>'+
                   'CA-IX/CD10 supporto RCC [NotebookLM 2026].'
          });
        } else {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Metastasi Epatica',
            detail: '<strong>Big Four + Site-specific INSIEME:</strong><br>'+
                   '1. CDX2/SATB2 (colon - pi√π frequente)<br>'+
                   '2. Arginasi (HCC primitivo)<br>'+
                   '3. PAX8 (RCC)<br>'+
                   '4. Synaptophysin/INSM1 (NET)<br>'+
                   '5. BCL10 se granuli zimogeni visibili (acinare pancreas) [NotebookLM 2026].'
          });
        }
      }
      
      // 5. Metastasi ossea
      if (site === 'bone') {
        if (sex === 'M') {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Osso Maschio',
            detail: '<strong>"Cinque Grandi" metastasi ossee (LEAN PANEL):</strong><br>'+
                   '1. Prostata (PSA/NKX3/ERG) - pi√π frequente<br>'+
                   '2. Polmone (TTF1)<br>'+
                   '3. RCC (PAX8)<br>'+
                   '4. Tiroide (TTF1/Tireoglobulina)<br>'+
                   '5. Melanoma (SOX10)<br>'+
                   '<strong>Big Four CONFONDE.</strong> Site-specific diretto migliore.<br>'+
                   'Osteoclasti-like: tumore osso primitivo o carcinoma alto grado [NotebookLM 2026].'
          });
        } else if (sex === 'F') {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Osso Femmina',
            detail: '<strong>"Cinque Grandi" metastasi ossee (LEAN PANEL):</strong><br>'+
                   '1. Mammella (GATA3/ER/TRPS1) - pi√π frequente<br>'+
                   '2. Polmone (TTF1)<br>'+
                   '3. RCC (PAX8)<br>'+
                   '4. Tiroide (TTF1/Tireoglobulina)<br>'+
                   '5. Ovaio (PAX8/WT1/ER)<br>'+
                   '<strong>Big Four CONFONDE.</strong> Site-specific diretto migliore [NotebookLM 2026].'
          });
        }
      }
      
      // 6. Metastasi polmonare
      if (site === 'lung') {
        if (document.getElementById('arch_lepidic')?.checked) {
          alerts.push({
            type: 'advisory',
            title: '‚ÑπÔ∏è SEDE ‚Äî Polmone Pattern Lepidico',
            detail: '<strong>Pattern lepidico (crescita alveolare) ‚Üí Polmone 95%+ probabilit√†.</strong><br>'+
                   'TTF1/Napsina A <strong>confermativi</strong> (diagnosi quasi fatta da morfologia).<br>'+
                   'Rara simulazione pancreatica [NotebookLM 2026].'
          });
        } else {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Metastasi Polmonare',
            detail: '<strong>DDx critico: Primitivo vs Metastasi</strong><br>'+
                   'TTF1+/Napsina A+ ‚Üí Primitivo polmonare FAVORITO<br>'+
                   '<strong>TTF1+ mimickers:</strong><br>'+
                   '‚Ä¢ Tiroide (PAX8+, Tireoglobulina+)<br>'+
                   '‚Ä¢ NEC extrapolmonare (Synaptophysin+)<br>'+
                   '‚Ä¢ Rari GI/ginecologici [NotebookLM 2026].'
          });
        }
      }
      
      // 7. Versamento sieroso
      if (site === 'effusion') {
        if (age && age < 50 && sex === 'F') {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Versamento Giovane Donna',
            detail: '<strong>Priorit√† Ovaio Sieroso HG (triade):</strong><br>'+
                   '‚Ä¢ WT1+ / PAX8+ / ER+<br>'+
                   '‚Ä¢ CA-125 sierico essenziale<br>'+
                   '<strong>DDx Mesotelioma:</strong> 2/3 positivi Calretinina/WT1/D2-40<br>'+
                   '<strong>DDx Adenocarcinoma:</strong> 2/3 positivi MOC31/BerEP4/PAX8 [NotebookLM 2026].'
          });
        } else {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Versamento Sieroso',
            detail: '<strong>Mesotelioma vs Adenocarcinoma (2/3 positivi):</strong><br>'+
                   '<strong>Mesotelioma:</strong> Calretinina, WT1, D2-40<br>'+
                   '<strong>Adenocarcinoma:</strong> MOC31, BerEP4, PAX8<br>'+
                   '<strong>Ovaio sieroso (triade):</strong> WT1+/PAX8+/ER+ [NotebookLM 2026].'
          });
        }
      }
      
      return alerts;
    }
    
    // ============================================
    // PART 4: ALERTS, SUGGESTIONS, GAPS v2.3
    // ============================================

    function getAlerts() {
      const alerts = [];

      // Curable neoplasms
      if (p('CD20') || p('CD3') || p('CD15')) {
        alerts.push({ 
          type: 'curable', 
          title: 'üíä CURABLE ‚Äî Linfoma', 
          detail: 'Linfoma: potenzialmente curabile. Sottotipizzazione urgente per terapia target. Flow cytometry, FISH, NGS raccomandati [WHO 2017].'
        });
      }

      if ((p('OCT34') || p('SALL4')) && (p('AFP') || p('HCG'))) {
        alerts.push({ 
          type: 'curable', 
          title: 'üíä CURABLE ‚Äî GCT', 
          detail: 'GCT: ottima risposta a chemio (cisplatino). Staging urgente. AFP, HCG sierici. Consulenza oncologia [NCCN 2023].'
        });
      }

      // RED FLAGS
      if (p('PSA') && n('NKX3')) {
        alerts.push({ 
          type: 'redflag', 
          title: '‚ö† RED FLAG ‚Äî PSA+/NKX3‚àí', 
          detail: 'Pattern improbabile. PSA sens <50% mets, NKX3 mantiene 80-85%. Controllare prelievo/colorazione [Gurel 2010].'
        });
      }

      if (p('TTF1') && n('Napsina') && n('CK7')) {
        alerts.push({ 
          type: 'redflag', 
          title: '‚ö† RED FLAG ‚Äî TTF1+/Napsina‚àí/CK7‚àí', 
          detail: 'NON polmone. TTF1+ in: tiroide (Thyroglobulina+), endometrio (ER+/PAX8+), neuroblastoma (SYN+) [Park 2007].'
        });
      }

      if (p('Arginasi') && (p('ER') || p('GATA3'))) {
        alerts.push({ 
          type: 'redflag', 
          title: '‚ö† RED FLAG ‚Äî Arginasi+/GATA3+ o Arginasi+/ER+', 
          detail: 'Pattern sospetto metastasi mammaria Arginasi+ (12.3% breast CA). Morfologia EE critica: se ‚â† HCC tipico ‚Üí metastasi breast. Se = HCC ‚Üí HCC GATA3+ (2% raro) [Karamchandani 2013].'
        });
      }

      // ADVISORY
      if (n('PRAME') && (p('S100') || p('SOX10'))) {
        alerts.push({ 
          type: 'advisory', 
          title: '‚ÑπÔ∏è ADVISORY ‚Äî Lesione melanocitica PRAME‚àí', 
          detail: 'Se morfologia spitzoide: PRAME‚àí favorisce <strong>Nevo di Spitz</strong> (benigno). Se morfologia melanoma convenzionale PRAME‚àí: ~10-15% melanomi PRAME-negativi esistono (sensibilit√† 83-94%, non 100%). Morfologia EE + clinica essenziali [Lezcano 2018].'
        });
      }

      // ‚≠ê v2.6 FIX: CD57 isolato RED FLAG - usa n() per marker testati negativi
      if (p('CD57') && n('Synapt') && n('Cromo') && n('CD56')) {
        alerts.push({ 
          type: 'redflag', 
          title: '‚ö† RED FLAG ‚Äî CD57+ isolato (altri marker NE negativi)', 
          detail: 'CD57+ con Synaptophysin‚àí/Chromogranin‚àí/CD56‚àí (testati): <strong>NON diagnosi NE</strong>. CD57+ in: NK cells (60%), gliomi (80%), prostata adenoCA (40%), melanoma. <strong>Synaptophysin/INSM1 obbligatori</strong> per conferma NE. CD57 √® marker supportivo debole [Bellizzi 2018].'
        });
      }

      // ‚≠ê v2.7.1 REFINED: Pattern ERG+/PSA‚àí/SYN+ ‚Üí Prostata post-ADT con NE transformation
      // NotebookLM validation: pattern confermato, bibliografia validata
      if (p('ERG') && n('PSA') && n('NKX3') && p('Synapt')) {
        alerts.push({ 
          type: 'advisory', 
          title: 'üî¨ PATTERN POST-ADT ‚Äî ERG+/PSA‚àí/NKX3‚àí/SYN+', 
          detail: '<strong>Pattern diagnostico: Adenocarcinoma prostatico con differenziazione NE post-ADT.</strong><br><br>' +
                 '<strong>Firma molecolare:</strong> ERG+ (TMPRSS2-ERG fusion mantiene espressione AR-indipendente, "ancora genomica" stabile) + Synaptophysin+ (NE transformation 10-20% post-castrazione, shift fenotipico sotto pressione ADT).<br><br>' +
                 '<strong>PSA‚àí/NKX3‚àí √® ATTESO in post-ADT:</strong> Khani 2014 dimostra che NKX3.1 scende a sens 80.7% nelle mets (vs 98.6% primitivo), fino a 70-75% nei pazienti ADT-trattati per downregulation AR-pathway. PSA sens <50% mets post-ADT. <strong>La perdita PSA/NKX3.1 √® coerente con pregresso trattamento ormonale descritto in letteratura</strong> [Khani 2014]. ERG mantiene perch√© genomico (fusion stabile, AR-independent).<br><br>' +
                 '<strong>Clinica essenziale:</strong> Verificare storia prostata trattata (prostatectomia/RT + ADT), tempo da terapia (transformation tipica >6-12 mesi), imaging osseo/epatico, PSA sierico trend. Pattern NE post-ADT ‚Üí consider platinum-based chemotherapy (cisplatino/etoposide) vs enzalutamide [Beltran 2016, Khani 2014, Park 2014].<br><br>' +
                 '<strong>Clinica essenziale:</strong> Verificare storia prostata trattata (prostatectomia/RT + ADT), tempo da terapia, imaging osseo/epatico. Pattern NE post-ADT ‚Üí consider platinum-based chemotherapy vs enzalutamide [Beltran 2016, Park 2014].<br><br>' +
                 '<strong>DDx:</strong> NEC primitivo (ma ERG+ esclude), angiosarcoma ERG+ (ma morfologia vascolare anastomosante assente).'
        });
      }

      // ‚≠ê NEW v2.7: Advisory ERG+ alta specificit√† ‚Üí Check storia clinica prostata
      if (p('ERG') && n('PSA') && n('NKX3') && !p('Synapt')) {
        alerts.push({ 
          type: 'advisory', 
          title: '‚ÑπÔ∏è ADVISORY ‚Äî ERG+ con PSA‚àí/NKX3‚àí', 
          detail: '<strong>ERG+ in contesto PSA‚àí/NKX3‚àí:</strong> Due scenari principali:<br><br>' +
                 '<strong>1. Adenocarcinoma prostatico TMPRSS2-ERG+ (30-40%)</strong> con loss PSA/NKX3 (post-ADT, high-grade, dedifferenziazione). Verificare storia clinica prostata. ERG mantiene espressione (AR-independent).<br><br>' +
                 '<strong>2. Neoplasia vascolare (Angiosarcoma 92-100%)</strong>: richiede morfologia vasi anastomosanti, eritrociti intracitoplasmatici. CD31/CD34/FLI1 supportano. Se morfologia NON vascolare ‚Üí prostata favorita.<br><br>' +
                 '<strong>Storia clinica essenziale:</strong> Prostata nota? ADT? Imaging osseo? Tempo da terapia? <strong>Morfologia EE critica</strong> per DDx angiosarcoma vs prostata [Park 2014, Miettinen 2014].'
        });
      }

      // ‚≠ê NEW v2.4: INSM1 alert preventivi (per futura implementazione)
      // NOTE: INSM1 non disponibile FBF, ma alert logici preparati
      /*
      if (p('INSM1') && (p('NKX3') || p('ERG') || p('PSA'))) {
        alerts.push({ 
          type: 'redflag', 
          title: '‚ö† ALERT ‚Äî INSM1+/Marcatori Prostata+', 
          detail: 'INSM1+ in 36% adenocarcinomi prostatici (firma NE epigenetica, NON NEC puro). Se NKX3+/ERG+/PSA+ ‚Üí adenoCA prostata con differenziazione NE. Pattern INSM1: <em>focale</em> (<30%) = NE subclinica; <em>diffuso</em> (>70%) + small-cell = NEC. Morfologia EE critica [Rooper 2017].'
        });
      }

      if (p('INSM1') && p('SOX10')) {
        alerts.push({ 
          type: 'redflag', 
          title: '‚ö† ALERT ‚Äî INSM1+/SOX10+', 
          detail: 'INSM1+ in 13% melanomi (falso positivo NE). Se SOX10+/PRAME+ ‚Üí <strong>melanoma</strong> high confidence, NON NEN. INSM1 NON specifico per NE. Synaptophysin/Chromogranin obbligatori per conferma NE [Rooper 2017].'
        });
      }
      */

      // ‚≠ê NEW v2.8: SOX10 DDx ALERTS (NotebookLM)
      
      // Alert SOX10+ isolato ‚Üí DDx completo
      if (p('SOX10') && !t('MelanA') && !t('HMB45') && !t('PRAME') && !t('GATA3')) {
        alerts.push({
          type: 'advisory',
          title: 'üî¨ ADVISORY ‚Äî SOX10+ Pattern Ambiguo',
          detail: '<strong>SOX10+ richiede DDx completo:</strong><br><br>' +
                 '<strong>1. Melanoma (95% SOX10+):</strong> Aggiungere Melan-A, HMB45, PRAME (83-94%). PRAME+ diffuso blindano malignit√†.<br><br>' +
                 '<strong>2. TNBC (69% SOX10+):</strong> Aggiungere GATA3. Se SOX10+/CK+/GATA3+ ‚Üí TNBC basal-like. Donna + linfonodo ascellare [Ivanov 2013].<br><br>' +
                 '<strong>3. MPNST (49% SOX10+):</strong> Se morfologia fusocellulare, aggiungere H3K27me3. Loss nucleare (80-85%) ‚Üí MPNST high-grade. NF1 storia?<br><br>' +
                 '<strong>4. Schwannoma (100% SOX10+):</strong> Se S100+ diffuso, aggiungere H3K27me3. Retained ‚Üí benigno [Rodriguez 2000].<br><br>' +
                 '<strong>5. Paraganglioma (SOX10+):</strong> Se Zellballen, aggiungere GATA3. SOX10+/GATA3+/CK‚àí ‚Üí paraganglioma.<br><br>' +
                 '<strong>Morfologia EE essenziale:</strong> Pigmento ‚Üí melanoma; Ghiandolare ‚Üí TNBC; Fusocellulare ‚Üí MPNST/schwannoma; Zellballen ‚Üí paraganglioma.'
        });
      }

      // Alert SOX10+/CK+ ‚Üí DDx melanoma vs TNBC
      if (p('SOX10') && p('CKAE1') && !t('GATA3')) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è ADVISORY ‚Äî SOX10+/CK+ Pattern',
          detail: '<strong>SOX10+/CK+: DDx critico melanoma vs TNBC (69% SOX10+).</strong><br><br>' +
                 'Aggiungere GATA3 (TNBC), Melan-A/HMB45/PRAME (melanoma).<br><br>' +
                 '<strong>CK pattern critico:</strong><br>' +
                 '‚Ä¢ Se CK diffuso forte ‚Üí TNBC favorito<br>' +
                 '‚Ä¢ Se CK focale debole ‚Üí melanoma aberrante<br><br>' +
                 'Morfologia EE essenziale [Ivanov 2013, NotebookLM].'
        });
      }

      // ‚≠ê NEW v2.9: ALERT MARKER EMERGENTI
      
      // INSM1 false positivity (riattivato)
      if (p('INSM1') && (p('PSA') || p('NKX3') || p('ERG'))) {
        alerts.push({ 
          type: 'advisory', 
          title: '‚ÑπÔ∏è ADVISORY ‚Äî INSM1+/Prostata+', 
          detail: 'INSM1+ in 36% adenoCA prostatici (differenziazione NE). <strong>Pattern INSM1 critico:</strong> focale <30% ‚Üí adenoCA con NE; diffuso >50% + small-cell ‚Üí NEC puro. Se NKX3+/ERG+ ‚Üí prostata favorita. Morfologia EE essenziale [Rooper 2017].'
        });
      }

      if (p('INSM1') && p('SOX10')) {
        alerts.push({ 
          type: 'advisory', 
          title: '‚ÑπÔ∏è ADVISORY ‚Äî INSM1+/SOX10+', 
          detail: 'INSM1+ in 13.2% melanomi (falso positivo NE). Se SOX10+/PRAME+ ‚Üí <strong>melanoma</strong> high confidence, NON NEN. Synaptophysin/Chromogranin obbligatori conferma NE [Rooper 2017].'
        });
      }

      // TRPS1+/PAX8+ pitfall ovaio
      if (p('TRPS1') && (p('PAX8') || p('WT1'))) {
        alerts.push({
          type: 'advisory',
          title: '‚ö†Ô∏è ADVISORY ‚Äî TRPS1+/PAX8+: Pitfall Ovaio',
          detail: '<strong>TRPS1+ NON esclude ovaio!</strong> 40.5% HGSC ovaio esprime TRPS1. <strong>Discriminare:</strong> Mammella (TRPS1+/PAX8‚àí/WT1‚àí/GATA3+) vs Ovaio (TRPS1+/PAX8+/WT1+/ER+). Sede metastasi critica: peritoneale/pelvica ‚Üí ovaio favorito; linfonodo ascellare ‚Üí mammella [NotebookLM 2026].'
        });
      }

      // NUT giovane midline
      if (p('NUT') || (p('p63') && p('p40') && !t('NUT'))) {
        if (!t('NUT')) {
          alerts.push({
            type: 'advisory',
            title: '‚ÑπÔ∏è ADVISORY ‚Äî SCC Indifferenziato: Testare NUT?',
            detail: 'Carcinoma squamoso indifferenziato "null-type". <strong>Se giovane (<30) + massa midline (mediastino/testa-collo):</strong> considerare NUT Midline Carcinoma. Pattern NUT+ speckled nucleare patognomonico. <strong>Identificazione essenziale</strong> per target therapy trials (BET inhibitors) [French 2014].'
          });
        }
      }

      // BCL10+ conferma acinare
      if (p('BCL10') && !t('INSM1')) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è ADVISORY ‚Äî BCL10+: Conferma vs NET',
          detail: 'BCL10+ suggerisce carcinoma acinare pancreas (90-95%). <strong>DDx NET pancreas:</strong> INSM1/Synaptophysin discrimina (acinare BCL10+/INSM1‚àí, NET BCL10‚àí/INSM1+). Morfologia: granuli zimogeni eosinofili [La Rosa 2014].'
        });
      }

      return alerts;
    }

    function getSuggestions() {
      const s = [];

      // First-line suggestions
      if (!t('CKAE1') && !t('CD45') && !t('Vim') && !t('S100')) {
        s.push('‚≠ê <strong>STEP 1 obbligatorio:</strong> Inizia con <code>First-line</code> (CK AE1/AE3, CD45, Vimentin, S100) per orientamento [SEOM-GECOD 2022].');
      }

      // Big Four after CK+
      if (p('CKAE1') && !t('CK7') && !t('CK20')) {
        s.push('CK AE1/AE3 positivo: procedi con <code>Big Four</code> (CK7, CK20, TTF-1, CDX2) per orientamento carcinoma [SEOM-GECOD 2022].');
      }

      // CK7+/CK20- suggestions
      if (p('CK7') && n('CK20')) {
        if (!t('TTF1')) {
          s.push('CK7+/CK20‚àí: aggiungere <code>TTF-1</code> per escludere polmone/tiroide [IASLC 2021].');
        }
        if (!t('PAX8') && !t('ER')) {
          s.push('CK7+/CK20‚àí: aggiungere <code>PAX8</code>, <code>ER</code>, <code>GATA3</code> per ovaio/endometrio/mammella [NCCN 2023].');
        }
      }

      // ‚≠ê v2.8 CURABILI-FIRST: CK7-/CK20- suggestions (NotebookLM)
      if (n('CK7') && n('CK20')) {
        // ‚≠ê v2.9.1 FIX: Guardrail CKAE1+ richiesto per pattern CK7/20
        if (!p('CKAE1')) {
          // Alert: CK7/20 senza conferma epiteliale
          s.push('‚ö†Ô∏è <strong>CK7‚àí/CK20‚àí senza conferma epiteliale:</strong> Pattern CK7/CK20 richiede <code>CK AE1/AE3+</code> per orientamento carcinoma. Se CKAE1 negativo/ND ‚Üí lineage NON epiteliale confermato. Verificare <code>CD45</code> (linfoma), <code>S100/SOX10</code> (melanoma), <code>Vimentin</code> (sarcoma) [SEOM-GECOD].');
        } else {
          // Priorit√† STEP 2 (Curabili) prima di Step 4 (Organo-specifici)
          if (!t('SALL4') || !t('Synapt') || !t('p40') || !t('PAX8')) {
            s.push('‚≠ê <strong>CK7‚àí/CK20‚àí ‚Üí PRIORIT√Ä STEP 2 CURABILI:</strong><br>' +
                   '1. <code>SALL4</code> (GCT curabile 100% sens seminoma)<br>' +
                   '2. <code>Synaptophysin</code> (NEC chemiosensibile)<br>' +
                   '3. <code>p40</code> (SCC 98% spec, cambia iter)<br>' +
                   '4. <code>PAX8</code> (RCC 83-98%, primario CUP frequente)<br>' +
                   '<strong>DOPO esclusione curabili</strong> ‚Üí Arginasi (HCC), NKX3 (prostata) [SEOM-GECOD, NotebookLM].');
          }
        }
      }

      // ‚≠ê NEW v2.3: SOX10 suggestion
      if (p('S100') && !t('SOX10')) {
        s.push('S100+: aggiungere <code>SOX10</code> (spec 95% vs carcinomi, pi√π specifico di S100). Disponibile FBF. Se SOX10+/PRAME+ ‚Üí melanoma high confidence [Nonaka 2008].');
      }

      // ‚≠ê NEW v2.3: ERG suggestion for NEC CUP
      if (p('Synapt') && n('PSA') && n('NKX3') && !t('ERG')) {
        s.push('NEC PSA‚àí/NKX3‚àí in uomo con metastasi ossee: <code>ERG</code> disponibile FBF (30-40% prostata TMPRSS2-ERG). Complementare AR. TTF1 ambiguo (60% prostata, 90% polmone) [Park 2014].');
      }

      // NKX3 priority
      if (n('PSA') && !t('NKX3')) {
        s.push('PSA neg: <code>NKX3</code> mandatoria (sens 80-85% mets, spec 99-100%). PSA‚àí/NKX3‚àí non esclude prostata: 20% falsi neg (post-ADT, NE, alto grado). ERG terza linea [Gurel 2010].');
      }

      // Arginasi reflex
      if (p('Arginasi') && !t('ER') && !t('GATA3')) {
        s.push('Arginasi+: se lesione epatica in donna, aggiungere <code>ER</code>, <code>GATA3</code>, <code>Mammoglobin</code> per escludere metastasi breast Arg+ (12.3%) [Karamchandani 2013].');
      }

      // PRAME suggestions
      if (p('S100') && p('SOX10') && !t('PRAME')) {
        s.push('S100+/SOX10+ melanoma: aggiungere <code>PRAME</code> (sens 83-94%, spec alta vs nevi). Utile DDx: Nevo Spitz (PRAME‚àí) vs Melanoma Spitzoide (PRAME+ diffuso >50%). Pattern diffuso supporta malignit√† [Lezcano 2018].');
      }

      if (p('PRAME') && !t('S100') && !t('SOX10')) {
        s.push('PRAME+: verificare lineage. Se <code>CK+</code> ‚Üí sarcoma sinoviale (80-90% PRAME+). Se <code>PAX8+</code> ‚Üí RCC. Se <code>S100+/SOX10+</code> ‚Üí melanoma. Pattern diffuso pi√π specifico [Gradecki 2021].');
      }

      // Melanocytic panel
      if (p('SOX10') && !t('MelanA')) {
        s.push('SOX10+: aggiungere <code>Melan-A</code>, <code>HMB-45</code>, <code>PRAME</code> per conferma melanoma [Voiculescu 2025].');
      }

      // NE panel
      if (p('Synapt') && !t('TTF1') && !t('CDX2')) {
        s.push('NEN: aggiungere <code>TTF-1</code> (polmone 90%), <code>CDX2</code> (GI) per site assignment [Bellizzi 2018].');
      }

      // GCT panel
      if (p('OCT34') && !t('AFP') && !t('HCG')) {
        s.push('OCT3/4+: aggiungere <code>AFP</code>, <code>Œ≤-HCG</code> per sottotipizzazione GCT. Dosaggio sierico essenziale [NCCN 2023].');
      }

      // MMR incomplete
      if ((t('MLH1') || t('MSH2') || t('MSH6') || t('PMS2')) && 
          !(t('MLH1') && t('MSH2') && t('MSH6') && t('PMS2'))) {
        s.push('MMR incompleto: testare tutti e 4 (MLH1, MSH2, MSH6, PMS2) per interpretazione corretta [Shia 2008].');
      }

      return s;
    }

    function getGaps(panelId) {
      const gaps = [];
      
      if (panelId === 'carcinoma' || panelId === 'neuroendocrine' || !panelId) {
        gaps.push('‚ö† <code>INSM1</code> non in FBF. Sens 96.4% NEN (superiore a SYN+CgA+CD56: 87.4%), spec 96.2% [Rooper 2017]. <strong>Falsi+:</strong> melanoma 13%, prostata adenoCA 36% (firma NE epigenetica), sarcomi. <strong>Pattern:</strong> diffuso (>50% NEN), focale (<30% falsi+). TMA >14k: 3.8% non-NE. Attivazione consigliata per biopsie mediastiniche/polmonari.');
        
        gaps.push('<code>TRPS1</code> ‚Äî marcatore breast CA (spec TN), surrogato GCDFP-15/Mammoglobin. Citato PDF CUP 2023. Non disponibile FBF.');
        
        gaps.push('<code>NKX3.1</code> ‚Äî verificare se NKX3 (cod. 22581) = NKX3.1. Marker prostata sens 80-85% mets, spec 99-100%. Critico per CUP [Gurel 2010].');
        
        gaps.push('<code>Prosteina (P501S)</code> ‚Äî sens ~95% prostata, spec ~98%. Superiore PSA in scarsamente diff., mantiene espressione post-ADT. Non disponibile FBF.');
        
        gaps.push('<code>MOC31</code>/<code>Claudina-4</code> ‚Äî DDx mesotelioma vs adenoCA. Sens/spec >90% [Ord√≥√±ez 2005]. Non disponibili FBF.');
      }
      
      return gaps;
    }

    function renderBibliography() {
      const bib = document.getElementById('bibliographyContent');
      bib.innerHTML = `
        <strong>Linee Guida:</strong><br>
        [1] SEOM-GECOD ‚Äî CUP guidelines. <em>SEOM Clin Guidel</em> 2022 (update).<br>
        [2] ESMO ‚Äî CUP management. <em>Ann Oncol</em> 2023;34:228.<br>
        [3] NCCN ‚Äî Occult primary. <em>NCCN Guidelines</em> 2023 v2.<br>
        <br>
        <strong>IHC generale:</strong><br>
        [4] Hainsworth JD+ ‚Äî CUP IHC approach. <em>Oncologist</em> 2020;25:e1566.<br>
        <br>
        <strong>Organo-specifici:</strong><br>
        [5] IASLC ‚Äî IHC in lung cancer. <em>J Thorac Oncol</em> 2021;16:1107.<br>
        [6] Yan BC+ ‚Äî <strong>Arginase-1</strong> for HCC. <em>Am J Surg Pathol</em> 2010;34:1147.<br>
        [7] Gurel B+ ‚Äî <strong>NKX3.1</strong> in mets. <em>Am J Surg Pathol</em> 2010;34:1097. <strong>(Sens 80.7% mets, NOT 98.6%)</strong> <span style="color:var(--pos)">‚úì FIX</span><br>
        [8] Khani F+ ‚Äî NKX3.1 validation. <em>Clin Cancer Res</em> 2014;20:4925.<br>
        [8b] Park K+ ‚Äî <strong>ERG prostata</strong>. <em>Am J Surg Pathol</em> 2014;38:1685. <strong>(30-40% TMPRSS2-ERG, mantiene post-ADT AR-independent)</strong> <span style="color:var(--pos)">‚úì NEW v2.3</span><br>
        [8c] Beltran H+ ‚Äî <strong>NE prostata post-ADT</strong>. <em>Nat Rev Urol</em> 2016;13:271. <strong>(10-20% transformation NE post-castrazione)</strong> <span style="color:var(--accent)">‚úì NEW v2.7</span><br>
        [9] Karamchandani JR+ ‚Äî <strong>Arginase-1 in breast</strong>. <em>Histopathology</em> 2013;62:804. <strong>(12% positive)</strong> <span style="color:var(--pos)">‚úì FIX</span><br>
        <br>
        <strong>Neuroendocrino:</strong><br>
        [10] Rooper LM+ ‚Äî <strong>INSM1</strong> superior. <em>Am J Surg Pathol</em> 2017;41:1561. <strong>(Sens 96.4%, FP melanoma 13%, prostata 36%)</strong> <span style="color:var(--pos)">‚úì FIX</span><br>
        [11] Bellizzi AM ‚Äî NEN site assignment. <em>Arch Pathol Lab Med</em> 2018;142:530.<br>
        <br>
        <strong>Melanoma:</strong><br>
        [12] Voiculescu VM+ ‚Äî IHC skin cancers. <em>Curr Health Sci J</em> 2025;51:5.<br>
        [13] Nonaka D+ ‚Äî <strong>SOX10</strong> melanoma. <em>Am J Surg Pathol</em> 2008;32:1291. <strong>(Sens 95%, spec 95% vs carcinomi)</strong> <span style="color:var(--pos)">‚úì NEW v2.3</span><br>
        [14] Lezcano C+ ‚Äî <strong>PRAME</strong> in melanoma. <em>Am J Surg Pathol</em> 2018;42:1456. <strong>(DDx Nevo Spitz PRAME‚àí vs Melanoma Spitzoide PRAME+)</strong> <span style="color:var(--warn)">‚úì FIX v2.2</span><br>
        [15] Gradecki SE+ ‚Äî PRAME cross-reattivit√†. <em>Am J Surg Pathol</em> 2021;45:1249. <strong>(Sarcoma sinoviale 80-90%)</strong> <span style="color:var(--pos)">‚úì NEW v2.2</span><br>
        <br>
        <strong>Prostata/Endotelio:</strong><br>
        [16] Park K+ ‚Äî <strong>ERG</strong> prostata & vascular. <em>Am J Surg Pathol</em> 2014;38:373. <strong>(30-40% prostata TMPRSS2-ERG, 92-100% angiosarcoma)</strong> <span style="color:var(--pos)">‚úì NEW v2.3</span><br>
        [17] Miettinen M+ ‚Äî ERG endothelial. <em>Am J Surg Pathol</em> 2014;38:641.<br>
        <br>
        <strong>GCT:</strong><br>
        [18] WHO Classification ‚Äî Tumours urinary & male genital. <em>5th ed</em> 2022.<br>
        [19] Zynger DL+ ‚Äî <strong>SALL4</strong> in GCT. <em>Am J Clin Pathol</em> 2008;129:235.<br>
        [20] Cao D+ ‚Äî SALL4 in adenoCA. <em>Mod Pathol</em> 2009;22:1418. <strong>(10-15% gastric)</strong> <span style="color:var(--pos)">‚úì FIX</span><br>
        [21] Agaimy A+ ‚Äî <strong>CD30+ carcinomas</strong>. <em>Am J Surg Pathol</em> 2012;36:1836.<br>
        <br>
        <strong>MMR:</strong><br>
        [22] Shia J ‚Äî IHC vs MSI. <em>J Mol Diagn</em> 2008;10:293.<br>
        [23] Haraldsdottir S+ ‚Äî <strong>MMR deficiency</strong>. <em>Fam Cancer</em> 2014;13:427.<br>
        <br>
        <strong>Altri:</strong><br>
        [24] Ord√≥√±ez NG ‚Äî IHC mesothelioma. <em>Am J Clin Pathol</em> 2005;123:202.<br>
        [25] Rodriguez FJ+ ‚Äî Schwannoma/MPNST. <em>Am J Surg Pathol</em> 2000;24:405. <strong>(H3K27me3 loss MPNST 80-85%)</strong><br>
        [26] Ivanov S+ ‚Äî <strong>SOX10 in TNBC</strong>. <em>Am J Clin Pathol</em> 2013;139:210. <strong>(69% TNBC basal-like SOX10+)</strong><br>
        <br>
        <strong>‚≠ê v2.9 Marker Emergenti (NotebookLM):</strong><br>
        [27] La Rosa S+ ‚Äî <strong>BCL10 acinar carcinoma</strong>. <em>Am J Surg Pathol</em> 2014;38:1501. <strong>(90-95% sens acinare pancreas)</strong> <span style="color:var(--accent)">‚úì NEW v2.9</span><br>
        [28] Biankin AV+ ‚Äî <strong>CK17 aggressive PDAC</strong>. <em>Gastroenterology</em> 2012;142:730. <strong>(Subset basal-like, poor prognosis)</strong> <span style="color:var(--accent)">‚úì NEW v2.9</span><br>
        [29] French CA+ ‚Äî <strong>NUT midline carcinoma</strong>. <em>Cancer Res</em> 2014;74:2563. <strong>(BRD4-NUT fusion, BET inhibitors)</strong> <span style="color:var(--accent)">‚úì NEW v2.9</span><br>
        [30] NotebookLM 2026 ‚Äî <strong>TRPS1 mammella</strong>. <strong>(98.7% sens TNBC vs GATA3 67.5%, pitfall ovaio 40.5%)</strong> <span style="color:var(--accent)">‚úì NEW v2.9</span><br>
        [31] Rooper LM+ ‚Äî <strong>INSM1 NE/FP</strong>. <em>Am J Surg Pathol</em> 2017;41:316. <strong>(96.4% NEC, FP melanoma 13.2%, prostata 36.1%)</strong> <span style="color:var(--accent)">‚úì NEW v2.9</span><br>
        <br>
        <strong>‚≠ê v2.9 ULTIMATE:</strong><br>
        ‚Ä¢ 6 marker emergenti: TRPS1 (mammella 98.7%), INSM1 (NE 96.4%), BCL10 (acinare 90-95%), CK17 (uroteliale/PDAC), NUT (midline), Œ≤-catenina (SPT)<br>
        ‚Ä¢ Pannello pancreas completo: PDAC (CK17/CA19-9), Acinare (BCL10), NET (INSM1), SPT (Œ≤-catenina nucleare)<br>
        ‚Ä¢ TRPS1 pitfall: ovaio HGSC 40.5%, sempre PAX8/WT1 per discriminare<br>
        ‚Ä¢ INSM1 first-line NE: superiore CgA/SYN (87%), pattern diffuso vs focale critico<br>
        ‚Ä¢ 57 marker totali, 15 pattern morfologici, workflow evidence-based<br>
      `;
    }

    function calculate() {
      const diagnoses = getDiagnoses();
      const alerts = getAlerts();
      const morphAlerts = getMorphologyAlerts(); // ‚≠ê v2.4
      const siteAlerts = getSiteSpecificAlerts(); // ‚≠ê NEW v2.10: Sede-specific
      const allAlerts = [...siteAlerts, ...alerts, ...morphAlerts]; // Merge (site first!)
      const suggestions = getSuggestions();
      const gaps = getGaps(currentPanel);

      document.getElementById('results').style.display = 'block';

      const alertsSection = document.getElementById('alertsSection');
      const alertsContainer = document.getElementById('alertsContainer');
      if (allAlerts.length > 0) {
        alertsSection.style.display = 'block';
        alertsContainer.innerHTML = allAlerts.map(alert => `
          <div class="alert-card ${alert.type}">
            <div class="card-title">${alert.title}</div>
            <div class="card-detail">${alert.detail}</div>
          </div>
        `).join('');
      } else {
        alertsSection.style.display = 'none';
      }

      const diagnosesSection = document.getElementById('diagnosesSection');
      const diagnosesContainer = document.getElementById('diagnosesContainer');
      if (diagnoses.length > 0) {
        diagnosesSection.style.display = 'block';
        diagnosesContainer.innerHTML = diagnoses.map(dx => `
          <div class="diagnosis-card ${dx.conf}">
            <div class="card-title">
              ${dx.name}
              <span class="confidence-badge ${dx.conf}">${
                dx.conf === 'high' ? 'Alta confidenza' : 
                dx.conf === 'medium' ? 'Media confidenza' : 
                'Bassa confidenza'
              }</span>
            </div>
            <div class="card-detail">${dx.detail}</div>
          </div>
        `).join('');
      } else {
        diagnosesSection.style.display = 'none';
      }

      const suggestionsSection = document.getElementById('suggestionsSection');
      const suggestionsContainer = document.getElementById('suggestionsContainer');
      if (suggestions.length > 0) {
        suggestionsSection.style.display = 'block';
        suggestionsContainer.innerHTML = suggestions.map(s => `
          <div class="suggestion-card">
            <div class="card-detail">${s}</div>
          </div>
        `).join('');
      } else {
        suggestionsSection.style.display = 'none';
      }

      const gapsSection = document.getElementById('gapsSection');
      const gapsContainer = document.getElementById('gapsContainer');
      if (gaps.length > 0) {
        gapsSection.style.display = 'block';
        gapsContainer.innerHTML = gaps.map(g => `
          <div class="suggestion-card">
            <div class="card-detail">${g}</div>
          </div>
        `).join('');
      } else {
        gapsSection.style.display = 'none';
      }

      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }

    document.addEventListener('DOMContentLoaded', function() {
      // ‚≠ê v2.6: Carica stato salvato (se esiste)
      const stateLoaded = loadState();
      
      renderFirstLine();
      renderBigFour();
      renderPanelGrid();
      renderMarkerPanels();
      
      // ‚≠ê v2.4.1 FIX: Morphology checkbox listeners
      document.querySelectorAll('.morphology-item input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', () => syncMorphologyUI(cb));
        syncMorphologyUI(cb); // stato iniziale
      });
      
      // ‚≠ê v2.5: Initialize auto-panel suggestions
      updateAutoPanelSuggestions();
      
      // ‚≠ê v2.6: Mostra notifica se stato caricato
      if (stateLoaded) {
        const notice = document.createElement('div');
        notice.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #dcfce7; border: 2px solid #059669; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; font-size: 0.9rem; color: #065f46;';
        notice.innerHTML = '<strong>‚úì Stato ripristinato</strong> - Sessione precedente caricata';
        document.body.appendChild(notice);
        setTimeout(() => notice.remove(), 3000);
      }
    });

  </script>
</body>
</html>

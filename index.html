<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IHC Hub v3.0 ‚Äî True Bayesian Engine</title>
  <style>
    :root{--bg:#f8fafc;--card:#fff;--text:#1e293b;--subtext:#64748b;--accent:#4f46e5;--pos:#059669;--neg:#dc2626;--warn:#d97706;--border:#e2e8f0;--shadow:rgba(0,0,0,.1);--fbf:#3b82f6;--sacco:#a855f7;--flag:#ef4444;--gain:#0891b2}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;padding:16px}
    .container{max-width:1600px;margin:0 auto}
    header{text-align:center;margin-bottom:28px;padding-bottom:18px;border-bottom:3px solid var(--border)}
    h1{font-size:2.4rem;background:linear-gradient(135deg,var(--accent),var(--fbf));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}
    .version{font-size:.85rem;color:var(--subtext);max-width:800px;margin:0 auto}
    .header-badges{display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap}
    .badge{padding:3px 10px;border-radius:20px;font-size:.78rem;font-weight:600}
    .badge.fbf{background:#dbeafe;color:#1d4ed8}.badge.sacco{background:#f3e8ff;color:#7c3aed}.badge.engine{background:#d1fae5;color:#065f46}.badge.version{background:#fef3c7;color:#92400e}
    .tabs-wrapper{display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap;justify-content:center}
    .tab-btn{padding:9px 18px;border:2px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer;font-weight:600;font-size:.92rem;transition:all .2s}
    .tab-btn:hover{border-color:var(--accent)}.tab-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .tab-content{display:none}.tab-content.active{display:block}
    .mode-toggle{display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:14px;padding:8px;background:var(--card);border-radius:10px;border:1px solid var(--border)}
    .mode-toggle label{font-size:.88rem;font-weight:600;cursor:pointer;padding:5px 12px;border-radius:8px;transition:all .2s}
    .mode-toggle input[type=radio]{display:none}
    .mode-toggle input:checked+label.lbl-fbf{background:#dbeafe;color:#1d4ed8}
    .mode-toggle input:checked+label.lbl-all{background:#f3e8ff;color:#7c3aed}
    .info-box{display:flex;gap:10px;padding:14px;background:#eff6ff;border-radius:10px;border-left:4px solid var(--fbf);margin-bottom:18px;font-size:.88rem}
    .lookup-container{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .marker-panel{padding:14px;background:var(--card);border-radius:12px;border:2px solid var(--border)}
    .marker-panel.positive{border-color:var(--pos)}.marker-panel.negative{border-color:var(--neg)}
    .marker-panel h2{font-size:1.05rem;margin-bottom:6px;display:flex;align-items:center;gap:6px}
    .marker-count{background:var(--accent);color:#fff;padding:2px 8px;border-radius:20px;font-size:.78rem}
    .marker-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(135px,1fr));gap:5px;min-height:70px;padding:8px}
    .marker-item{padding:5px 8px;border-radius:7px;font-size:.8rem;cursor:grab;transition:all .15s;border:1px solid var(--border);background:var(--card);display:flex;align-items:center;justify-content:space-between;gap:3px;user-select:none}
    .marker-item:hover{transform:translateY(-1px);box-shadow:0 2px 6px var(--shadow)}
    .marker-item.dragging{opacity:.4}
    .marker-item.selected-pos{background:#d1fae5;border-color:var(--pos)}
    .marker-item.selected-neg{background:#fee2e2;border-color:var(--neg)}
    .marker-item .sacco-tag{font-size:.62rem;padding:1px 3px;border-radius:3px;background:#f3e8ff;color:#7c3aed;font-weight:600}
    .marker-badge{font-size:.68rem}
    .drag-over-pos{background:#d1fae5!important;border-color:var(--pos)!important}
    .drag-over-neg{background:#fee2e2!important;border-color:var(--neg)!important}
    .controls{grid-column:1/-1;display:flex;gap:10px;justify-content:center;margin-top:14px;flex-wrap:wrap}
    .btn{padding:10px 24px;border:none;border-radius:10px;font-size:.95rem;font-weight:700;cursor:pointer;transition:all .2s}
    .btn-analyze{background:linear-gradient(135deg,var(--accent),var(--fbf));color:#fff}
    .btn-analyze:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(79,70,229,.3)}
    .btn-reset{background:var(--card);border:2px solid var(--border);color:var(--subtext)}
    .btn-reset:hover{border-color:var(--neg);color:var(--neg)}
    .results-container{margin-top:22px}.results-container h2{font-size:1.2rem;margin-bottom:14px;color:var(--accent)}
    .diagnosis-result{padding:14px;margin-bottom:10px;border-radius:12px;border-left:5px solid var(--border);background:var(--card);box-shadow:0 1px 4px var(--shadow)}
    .diagnosis-result.high{border-left-color:var(--pos)}.diagnosis-result.medium{border-left-color:var(--warn)}.diagnosis-result.low{border-left-color:var(--subtext)}
    .dx-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .dx-name{font-weight:700;font-size:1.02rem}
    .dx-score{font-weight:800;font-size:1.05rem;padding:3px 10px;border-radius:8px}
    .dx-score.high{background:#d1fae5;color:#065f46}.dx-score.medium{background:#fef3c7;color:#92400e}.dx-score.low{background:#f1f5f9;color:#64748b}
    .dx-reasoning{font-size:.83rem;color:var(--subtext);margin-bottom:6px;line-height:1.7}
    .dx-reasoning .flag{color:var(--flag);font-weight:700}.dx-reasoning .support{color:var(--pos)}.dx-reasoning .exclude{color:var(--neg)}
    .flags-box{margin-top:5px;padding:5px 8px;background:#fef2f2;border-radius:6px;font-size:.8rem}
    .next-best{margin-top:18px;padding:14px;background:linear-gradient(135deg,#ecfdf5,#f0f9ff);border-radius:12px;border:2px solid var(--gain)}
    .next-best h3{color:var(--gain);margin-bottom:8px;font-size:1rem}
    .suggestion{display:flex;align-items:center;gap:8px;padding:6px 10px;margin-bottom:5px;background:#fff;border-radius:8px;border:1px solid #e0f2fe}
    .suggestion .gain-score{font-weight:700;color:var(--gain);min-width:40px}
    .marker-list{display:flex;flex-wrap:wrap;gap:3px;margin-top:5px}
    .marker-tag{padding:2px 6px;border-radius:5px;font-size:.76rem;background:#f1f5f9;border:1px solid var(--border)}
    .marker-tag.pos{background:#d1fae5;border-color:#6ee7b7;font-weight:600}
    .marker-tag.neg{background:#fee2e2;border-color:#fca5a5;font-weight:600}
    .marker-tag.untested{opacity:.5}
    .quiz-container{max-width:680px;margin:0 auto}
    .quiz-card{padding:28px;background:var(--card);border-radius:16px;box-shadow:0 4px 18px var(--shadow)}
    .quiz-title{font-size:1.4rem;font-weight:800;text-align:center;margin-bottom:18px}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:18px}
    .stat-box{text-align:center;padding:8px;background:var(--bg);border-radius:10px}
    .stat-label{font-size:.78rem;color:var(--subtext)}.stat-value{font-size:1.3rem;font-weight:800;color:var(--accent)}
    .marker-chip{display:inline-block;padding:4px 10px;background:#d1fae5;border-radius:8px;margin:3px;font-weight:600;font-size:.88rem}
    .dx-option{padding:12px;margin:6px 0;border:2px solid var(--border);border-radius:10px;cursor:pointer;font-weight:600;transition:all .2s;text-align:center}
    .dx-option:hover{border-color:var(--accent);background:#f8faff}
    .feedback{padding:12px;border-radius:10px;text-align:center;font-weight:600;margin-top:12px;min-height:18px}
    .feedback.correct{background:#d1fae5;color:#065f46}.feedback.incorrect{background:#fee2e2;color:#991b1b}
    .empty-state{text-align:center;padding:35px;color:var(--subtext)}
    /* Cascade wizard */
    .casc-step{flex:1;text-align:center;padding:8px;border-radius:8px;font-size:.82rem;font-weight:600;background:#f1f5f9;color:var(--subtext);transition:all .2s}
    .casc-step.active{background:var(--accent);color:#fff}
    .casc-step.done{background:#d1fae5;color:#065f46}
    .casc-panel{padding:24px;background:var(--card);border-radius:14px;box-shadow:0 2px 12px var(--shadow)}
    .morph-btn{padding:16px;border:2px solid var(--border);border-radius:12px;cursor:pointer;text-align:center;transition:all .2s;background:var(--card)}
    .morph-btn:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 12px var(--shadow)}
    .morph-btn.selected{border-color:var(--accent);background:#eef2ff;font-weight:700}
    .morph-btn .morph-icon{font-size:1.8rem;margin-bottom:6px}
    .morph-btn .morph-label{font-weight:700;font-size:.95rem;margin-bottom:3px}
    .morph-btn .morph-hint{font-size:.78rem;color:var(--subtext)}
    .bf-card{padding:14px;border:2px solid var(--border);border-radius:10px;background:var(--card)}
    .bf-card .bf-name{font-weight:700;font-size:.95rem;margin-bottom:8px;text-align:center}
    .bf-toggles{display:flex;gap:6px;justify-content:center}
    .bf-toggles button{padding:6px 16px;border:2px solid var(--border);border-radius:8px;cursor:pointer;font-weight:700;font-size:.9rem;background:var(--card);transition:all .15s}
    .bf-toggles button.sel-pos{background:#d1fae5;border-color:var(--pos);color:#065f46}
    .bf-toggles button.sel-neg{background:#fee2e2;border-color:var(--neg);color:#991b1b}
    .bf-toggles button.sel-unk{background:#fef3c7;border-color:var(--warn);color:#92400e}
    .panel-marker{padding:8px 12px;border:2px solid var(--border);border-radius:8px;cursor:pointer;text-align:center;font-size:.85rem;font-weight:600;transition:all .15s;background:var(--card)}
    .panel-marker:hover{border-color:var(--accent)}
    .panel-marker.pm-pos{background:#d1fae5;border-color:var(--pos);color:#065f46}
    .panel-marker.pm-neg{background:#fee2e2;border-color:var(--neg);color:#991b1b}
    /* Semaforo disponibilit√† */
    .site-fbf{border-left:4px solid #22c55e}.site-sacco{border-left:4px solid #f59e0b}.site-nd{border-left:4px solid #ef4444;opacity:.85}
    .site-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:5px;vertical-align:middle}
    .site-dot.dot-fbf{background:#22c55e}.site-dot.dot-sacco{background:#f59e0b}.site-dot.dot-nd{background:#ef4444}
    .site-legend{display:flex;gap:14px;justify-content:center;font-size:.78rem;color:var(--subtext);margin-bottom:10px;flex-wrap:wrap}
    .site-legend span{display:flex;align-items:center;gap:4px}
    @media print{body{padding:0;background:#fff;font-size:10pt}.tabs-wrapper,.controls,.mode-toggle,.info-box,#availableMarkersWrap,.empty-state,.next-best{display:none!important}.tab-content{display:block!important}.diagnosis-result{break-inside:avoid;box-shadow:none;border:1px solid #ccc}.audit-stamp{display:block!important}}
    @media(max-width:768px){.lookup-container{grid-template-columns:1fr}.marker-grid{grid-template-columns:repeat(auto-fill,minmax(110px,1fr))}h1{font-size:1.8rem}}

    /* Morphology selector */
    .morph-selector{display:flex;gap:6px;align-items:center;justify-content:center;margin-bottom:12px;padding:8px;background:var(--card);border-radius:10px;border:1px solid var(--border);flex-wrap:wrap}
    .morph-selector select{padding:5px 10px;border:2px solid var(--accent);border-radius:8px;font-size:.88rem;font-weight:600;background:var(--card);cursor:pointer}
    .morph-selector .ts-label{font-size:.82rem;color:var(--subtext);margin-left:12px}
    .morph-selector select.ts-select{border-color:var(--gain);font-size:.82rem}
    /* Confidence badge */
    .conf-badge{display:inline-block;padding:2px 8px;border-radius:6px;font-size:.72rem;font-weight:700;margin-left:6px}
    .conf-badge.conf-high{background:#d1fae5;color:#065f46}
    .conf-badge.conf-mid{background:#fef3c7;color:#92400e}
    .conf-badge.conf-low{background:#fee2e2;color:#991b1b}
    /* Red flag score */
    .flag-score{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:6px;font-size:.75rem;font-weight:700;margin-left:6px}
    .flag-score.fs-0{background:#d1fae5;color:#065f46}
    .flag-score.fs-1{background:#fef3c7;color:#92400e}
    .flag-score.fs-2{background:#fee2e2;color:#991b1b}
    /* Warning bar */
    .warn-bar{padding:8px 14px;background:#fef3c7;border-left:4px solid var(--warn);border-radius:8px;font-size:.85rem;margin-bottom:14px;display:none}
    /* Tumor board mode */
    .tb-toggle{font-size:.82rem;margin-left:auto;display:flex;align-items:center;gap:4px}
    .tb-toggle input{cursor:pointer}
    /* Audit stamp */
    .audit-stamp{font-size:.72rem;color:var(--subtext);text-align:right;margin-top:6px;font-family:monospace}
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>üß¨ IHC Hub v3.1</h1>
    <p class="version">Motore Bayesiano ¬∑ Filtro Morfologico ¬∑ Classi di Confidenza ¬∑ Risparmio Tessuto ¬∑ Tumor Board</p>
    <div class="header-badges">
      <span class="badge fbf">143 FBF</span>
      <span class="badge sacco">+29 SACCO</span>
      <span class="badge engine">Motore Bayesiano</span>
      <span class="badge version">v3.1</span>
    </div>
  </header>

  <div class="tabs-wrapper">
    <button class="tab-btn active" onclick="switchTab('cascade')">üìä IHC Cascade</button>
    <button class="tab-btn" onclick="switchTab('inverse')">üîç Ricerca Inversa</button>
    <button class="tab-btn" onclick="switchTab('quiz')">üéÆ Quiz</button>
  </div>

  <!-- INVERSE -->
  <div id="inverse-tab" class="tab-content">
    <div class="mode-toggle">
      <span style="font-size:.88rem;">üè•</span>
      <input type="radio" name="siteMode" id="modeFBF" value="fbf" checked onchange="onModeChange()">
      <label for="modeFBF" class="lbl-fbf">Solo FBF (143)</label>
      <input type="radio" name="siteMode" id="modeAll" value="all" onchange="onModeChange()">
      <label for="modeAll" class="lbl-all">FBF + SACCO (172)</label>
      <span class="tb-toggle"><input type="checkbox" id="tbMode" onchange="onTBToggle()"> Tumor Board</span>
    </div>
    <div class="morph-selector">
      <span style="font-size:.88rem;">üî¨ Morfologia:</span>
      <select id="morphSelect" onchange="onMorphChange()">
        <option value="any">‚Äî Non specificata ‚Äî</option>
        <option value="epiteliale">Epiteliale / Carcinoma</option>
        <option value="linfoide">Linfoide</option>
        <option value="mesenchimale">Mesenchimale / Sarcoma</option>
        <option value="melanocitico">Melanocitico</option>
        <option value="neuroendocrino">Neuroendocrino</option>
        <option value="germinale">Germinale</option>
      </select>
      <span class="ts-label">üß´ Risparmio tessuto:</span>
      <select id="tsSelect" class="ts-select" onchange="onTSChange()">
        <option value="0">Nessun limite</option>
        <option value="1">Max 1 marker</option>
        <option value="2">Max 2 marker</option>
        <option value="3">Max 3 marker</option>
      </select>
    </div>
    <div class="info-box"><span>üí°</span><div><strong>v3.1:</strong> Bayes LR ¬∑ Morfologia modula priore ¬∑ Classe di confidenza (Œî top1-top2) ¬∑ Punteggio criticit√† ¬∑ IG pesato su posteriore ¬∑ Risparmio tessuto ¬∑ Modalit√† Tumor Board. Trascina ‚Üí POS/NEG ‚Üí ANALIZZA.</div></div>
    <div class="lookup-container">
      <div class="marker-panel positive"><h2>‚úÖ Positivi <span class="marker-count" id="posCount">0</span></h2><div class="marker-grid" id="positivePanel" ondrop="handleDrop(event,'positive')" ondragover="handleDragOver(event,'positive')" ondragleave="handleDragLeave(event,'positive')"><p style="color:var(--subtext);text-align:center;padding:12px;grid-column:1/-1;">Trascina qui ‚Üí</p></div></div>
      <div class="marker-panel negative"><h2>‚ùå Negativi <span class="marker-count" id="negCount" style="background:var(--neg);">0</span></h2><div class="marker-grid" id="negativePanel" ondrop="handleDrop(event,'negative')" ondragover="handleDragOver(event,'negative')" ondragleave="handleDragLeave(event,'negative')"><p style="color:var(--subtext);text-align:center;padding:12px;grid-column:1/-1;">Trascina qui ‚Üí</p></div></div>
      <div id="availableMarkersWrap" style="grid-column:1/-1;padding:16px;background:var(--card);border:3px dashed var(--fbf);border-radius:12px;">
        <h3 style="margin-bottom:8px;color:var(--fbf);display:flex;align-items:center;gap:6px;">üìã Disponibili <span class="marker-count" id="availCount">0</span><input type="text" id="markerSearch" placeholder="Cerca..." oninput="renderAvailableMarkers()" style="margin-left:auto;padding:4px 8px;border:1px solid var(--border);border-radius:8px;font-size:.83rem;width:160px;"></h3>
        <div id="siteLegend" class="site-legend" style="display:none;"><span><span class="site-dot dot-fbf"></span>FBF</span><span><span class="site-dot dot-sacco"></span>SACCO</span><span><span class="site-dot dot-nd"></span>Non disponibile</span></div>
        <div class="marker-grid" id="availableMarkers" style="max-height:320px;overflow-y:auto;border:2px dashed var(--fbf);padding:8px;"></div>
      </div>
      <div class="controls"><button class="btn btn-analyze" onclick="analyzeMarkers()">üîç ANALIZZA (Bayes)</button><button class="btn btn-reset" onclick="resetLookup()">üîÑ RESET</button></div>
    </div>
    <div id="warnBar" class="warn-bar"></div>
    <div id="lookupResults" style="display:none;"><div class="results-container"><h2>üìä Risultati ‚Äî Analisi Bayesiana</h2><div id="diagnosisResults"></div></div><div id="nextBestSection"></div></div>
    <div id="emptyLookupState" class="empty-state"><h2>üëà Trascina i marker</h2><p>POS e NEG ‚Üí ANALIZZA</p></div>
  </div>

  <!-- QUIZ -->
  <div id="quiz-tab" class="tab-content">
    <div class="quiz-container"><div class="quiz-card">
      <div class="quiz-title">üéÆ INDOVINA LA DIAGNOSI</div>
      <div class="stats"><div class="stat-box"><div class="stat-label">Corrette</div><div class="stat-value" id="correctCount">0</div></div><div class="stat-box"><div class="stat-label">Serie üî•</div><div class="stat-value" id="streakCount">0</div></div><div class="stat-box"><div class="stat-label">Precisione</div><div class="stat-value" id="accuracyPercent">0%</div></div><div class="stat-box"><div class="stat-label">Totale</div><div class="stat-value" id="totalCount">0</div></div></div>
      <div class="markers-display"><h3>Marker POSITIVI:</h3><div id="quizMarkersList"></div></div>
      <p style="font-size:.95rem;color:var(--subtext);margin-bottom:16px;">Diagnosi pi√π probabile?</p>
      <div id="quizOptions"></div>
      <div id="quizFeedback" class="feedback"></div>
      <button class="btn btn-analyze" onclick="nextQuizRound()" style="margin-top:12px;">‚è≠Ô∏è PROSSIMA</button>
    </div></div>
  </div>

  <!-- CASCADE GUIDATA -->
  <div id="cascade-tab" class="tab-content active">
    <div style="max-width:800px;margin:0 auto;">
      <!-- NUOVO CASO -->
      <div style="text-align:center;margin-bottom:14px;">
        <button onclick="cascReset()" style="padding:14px 40px;border:none;border-radius:12px;background:linear-gradient(135deg,#ef4444,#b91c1c);color:#fff;font-weight:800;font-size:1.1rem;cursor:pointer;box-shadow:0 4px 14px rgba(239,68,68,.35);transition:all .2s;letter-spacing:.3px;" onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 6px 20px rgba(239,68,68,.45)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 14px rgba(239,68,68,.35)'">üÜï Nuovo Caso</button>
      </div>
      <!-- PROGRESS BAR -->
      <div id="cascadeProgress" style="display:flex;gap:4px;margin-bottom:18px;">
        <div class="casc-step active" id="cStep1">1. Morfologia</div>
        <div class="casc-step" id="cStep2">2. Screening IHC</div>
        <div class="casc-step" id="cStep3">3. CK secondo livello</div>
        <div class="casc-step" id="cStep4">4. Pannello mirato</div>
        <div class="casc-step" id="cStep5">5. Diagnosi</div>
      </div>

      <!-- STEP 1: MORFOLOGIA -->
      <div id="cascStep1" class="casc-panel">
        <h2 style="margin-bottom:6px;">üî¨ Passo 1 ‚Äî Impressione Morfologica</h2>
        <p style="color:var(--subtext);margin-bottom:16px;font-size:.9rem;">Cosa vedi all'EE? Seleziona il pattern predominante.</p>
        <div id="morphButtons" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;"></div>
      </div>

      <!-- PASSO 2: PANNELLO SCREENING (CK/Vim/S100/CD45) -->
      <div id="cascStep2" class="casc-panel" style="display:none;">
        <h2 style="margin-bottom:6px;">üß´ Passo 2 ‚Äî Pannello di Screening</h2>
        <p style="color:var(--subtext);margin-bottom:16px;font-size:.9rem;">I 4 marker fondamentali ‚Äî coprono il 95% della diagnostica. Seleziona +, ‚àí o ? (non testato).</p>
        <div id="screenGrid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;"></div>
        <div id="screenHint" style="margin-top:14px;padding:10px;background:#eff6ff;border-radius:8px;font-size:.85rem;color:var(--accent);text-align:center;"></div>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:18px;">
          <button class="btn btn-reset" onclick="cascBack(1)">‚Üê Indietro</button>
          <button class="btn btn-analyze" onclick="cascFromScreening()">Avanti ‚Üí</button>
        </div>
      </div>

      <!-- PASSO 3: CK SECONDO LIVELLO (solo epiteliale) -->
      <div id="cascStep3" class="casc-panel" style="display:none;">
        <h2 style="margin-bottom:6px;">üß™ Passo 3 ‚Äî CK di Secondo Livello</h2>
        <p style="color:var(--subtext);margin-bottom:16px;font-size:.9rem;">Pannello CK di secondo livello per carcinomi. Seleziona +, ‚àí o ?.</p>
        <div id="bigFourGrid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;"></div>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:18px;">
          <button class="btn btn-reset" onclick="cascBack(2)">‚Üê Indietro</button>
          <button class="btn btn-analyze" onclick="cascAdvance(4)">Avanti ‚Üí</button>
        </div>
      </div>

      <!-- STEP 4: PANNELLO SPECIFICO -->
      <div id="cascStep4" class="casc-panel" style="display:none;">
        <h2 style="margin-bottom:6px;">üéØ Passo 4 ‚Äî Pannello Mirato</h2>
        <p style="color:var(--subtext);margin-bottom:4px;font-size:.9rem;" id="cascPanelHint"></p>
        <div id="cascPanelSummary" style="margin-bottom:14px;"></div>
        <div id="panelGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:8px;"></div>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:18px;">
          <button class="btn btn-reset" id="panelBackBtn" onclick="cascBack(3)">‚Üê Indietro</button>
          <button class="btn btn-analyze" onclick="cascAdvance(5)">üîç Calcola Diagnosi</button>
        </div>
      </div>

      <!-- STEP 5: RISULTATI -->
      <div id="cascStep5" class="casc-panel" style="display:none;">
        <h2 style="margin-bottom:6px;">üìä Passo 5 ‚Äî Diagnosi Differenziale</h2>
        <div id="cascAudit" style="font-size:.8rem;color:var(--subtext);margin-bottom:12px;"></div>
        <div id="cascResults"></div>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:18px;">
          <button class="btn btn-reset" onclick="cascBack(4)">‚Üê Modifica Pannello</button>
          <button class="btn btn-analyze" onclick="cascReset()">üîÑ Ricomincia</button>
          <button class="btn btn-analyze" onclick="cascToInverse()" style="background:var(--gain);">‚Üó Apri in Ricerca Inversa</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>

const markerDB = {
'ACTINA_HHF35':{display:'Actina HHF35',aliases:['actina hhf35','hhf35'],site:'fbf'},
'ACTINA_SMA':{display:'Actina m.l. (SMA)',aliases:['actina ml','sma','smooth muscle actin'],site:'fbf'},
'AFP':{display:'AFP',aliases:['alfa-fetoproteina','alpha-fetoprotein'],site:'fbf'},
'ALK_D5F3':{display:'Alk D5F3',aliases:['alk d5f3','alk'],site:'fbf'},
'ANDROGENI':{display:'Androgeni',aliases:['androgen','ar'],site:'fbf'},
'ANNEXIN_A1':{display:'Annexin A1',aliases:['annexin a1'],site:'fbf'},
'ARGINASI':{display:'Arginasi',aliases:['arginase'],site:'fbf'},
'ATRX':{display:'ATRX',aliases:['atrx'],site:'fbf'},
'BCL1':{display:'BCL-1',aliases:['bcl-1','bcl1','cyclina d1','cyclin d1'],site:'fbf'},
'BCL10':{display:'BCL-10',aliases:['bcl-10','bcl10'],site:'fbf'},
'BCL2':{display:'BCL-2',aliases:['bcl-2','bcl2'],site:'fbf'},
'BCL6':{display:'BCL-6',aliases:['bcl-6','bcl6'],site:'fbf'},
'BETA_CATENIN':{display:'\u03b2-Catenina',aliases:['beta-catenina','beta-catenin'],site:'fbf'},
'BRG1':{display:'BRG-1/SMARCA4',aliases:['brg1','smarca4','brg-1','brgl'],site:'fbf'},
'CA125':{display:'CA-125',aliases:['ca-125','ca125'],site:'fbf'},
'CAIX':{display:'CA-IX',aliases:['ca-ix','ca9','caix'],site:'fbf'},
'CALCITONINA':{display:'Calcitonina',aliases:['calcitonina','calcitonin'],site:'fbf'},
'CALDESMON':{display:'Caldesmon',aliases:['caldesmon','caldesmone','h-caldesmon'],site:'fbf'},
'CALPONINA':{display:'Calponina',aliases:['calponina','calponin'],site:'fbf'},
'CALRETININA':{display:'Calretinina',aliases:['calretinina','calretinin'],site:'fbf'},
'CD1':{display:'CD-1a',aliases:['cd-1','cd1','cd1a'],site:'fbf'},
'CD10':{display:'CD-10',aliases:['cd-10','cd10','calla'],site:'fbf'},
'CD117':{display:'CD-117',aliases:['cd-117','cd117','c-kit','kit'],site:'fbf'},
'CD138':{display:'CD-138',aliases:['cd-138','cd138','syndecan-1'],site:'fbf'},
'CD14':{display:'CD-14',aliases:['cd-14','cd14'],site:'fbf'},
'CD15':{display:'CD-15',aliases:['cd-15','cd15','leu-m1'],site:'fbf'},
'CD163':{display:'CD-163',aliases:['cd-163','cd163'],site:'fbf'},
'CD19':{display:'CD-19',aliases:['cd-19','cd19'],site:'fbf'},
'CD2':{display:'CD-2',aliases:['cd-2','cd2'],site:'fbf'},
'CD20':{display:'CD-20',aliases:['cd-20','cd20','l26'],site:'fbf'},
'CD21':{display:'CD-21',aliases:['cd-21','cd21'],site:'fbf'},
'CD23':{display:'CD-23',aliases:['cd-23','cd23'],site:'fbf'},
'CD3':{display:'CD-3',aliases:['cd-3','cd3'],site:'fbf'},
'CD30':{display:'CD-30',aliases:['cd-30','cd30','ki-1'],site:'fbf'},
'CD31':{display:'CD-31',aliases:['cd-31','cd31','pecam'],site:'fbf'},
'CD34':{display:'CD-34',aliases:['cd-34','cd34'],site:'fbf'},
'CD38':{display:'CD-38',aliases:['cd-38','cd38'],site:'fbf'},
'CD4':{display:'CD-4',aliases:['cd-4','cd4'],site:'fbf'},
'CD44':{display:'CD-44',aliases:['cd-44','cd44'],site:'fbf'},
'CD45':{display:'CD-45',aliases:['cd-45','cd45','lca'],site:'fbf'},
'CD5':{display:'CD-5',aliases:['cd-5','cd5'],site:'fbf'},
'CD56':{display:'CD-56',aliases:['cd-56','cd56','ncam'],site:'fbf'},
'CD61':{display:'CD-61',aliases:['cd-61','cd61'],site:'fbf'},
'CD68_KP1':{display:'CD-68 KP1',aliases:['cd68 kp1','cd-68 kp1','cd68'],site:'fbf'},
'CD68_PGM1':{display:'CD-68 PG-M1',aliases:['cd68 pg-m1','cd-68 pg-m1'],site:'fbf'},
'CD7':{display:'CD-7',aliases:['cd-7','cd7'],site:'fbf'},
'CD79A':{display:'CD-79a',aliases:['cd-79a','cd79a','cd79'],site:'fbf'},
'CD8':{display:'CD-8',aliases:['cd-8','cd8'],site:'fbf'},
'CD99':{display:'CD-99',aliases:['cd-99','cd99','mic2'],site:'fbf'},
'CDK4':{display:'CDK4',aliases:['cdk4'],site:'fbf'},
'CDX2':{display:'CDX-2',aliases:['cdx-2','cdx2'],site:'fbf'},
'CEA_MONO':{display:'CEA Mono',aliases:['cea mono','cea monoclonale'],site:'fbf'},
'CK19':{display:'CK 19',aliases:['ck 19','ck19'],site:'fbf'},
'CK20':{display:'CK 20',aliases:['ck 20','ck20'],site:'fbf'},
'CK34BE12':{display:'CK 34\u03b2E12',aliases:['ck 34be12','34be12'],site:'fbf'},
'CK56':{display:'CK 5/6',aliases:['ck 5/6','ck5/6','ck5'],site:'fbf'},
'CK7':{display:'CK 7',aliases:['ck 7','ck7'],site:'fbf'},
'CKAE':{display:'CK AE1/AE3',aliases:['ck ae1/ae3','ae1/ae3','ck pan','panck'],site:'fbf'},
'CKCAM52':{display:'CK CAM 5.2',aliases:['ck cam 5.2','cam 5.2'],site:'fbf'},
'CLAUDINA18':{display:'Claudina-18',aliases:['claudina-18','claudin-18','cldn18'],site:'fbf'},
'CMV':{display:'CMV',aliases:['cmv','citomegalovirus'],site:'fbf'},
'CMYC':{display:'C-myc',aliases:['c-myc','cmyc','myc'],site:'fbf'},
'CROMOGRANINA':{display:'Cromogranina',aliases:['cromogranina','chromogranin','cga'],site:'fbf'},
'D240':{display:'D2-40',aliases:['d2-40','d240','podoplanina'],site:'fbf'},
'DESMINA':{display:'Desmina',aliases:['desmina','desmin'],site:'fbf'},
'DOG1':{display:'DOG1',aliases:['dog1','dog-1'],site:'fbf'},
'ECAD':{display:'E-Caderina',aliases:['e-caderina','e-cadherin','e-cad'],site:'fbf'},
'EMA':{display:'EMA',aliases:['ema','epithelial membrane antigen'],site:'fbf'},
'EPCAM':{display:'EP-CAM',aliases:['ep-cam','epcam','berep4','ber-ep4'],site:'fbf'},
'ER':{display:'ER',aliases:['er','estrogen receptor'],site:'fbf'},
'ERG':{display:'ERG',aliases:['erg'],site:'fbf'},
'FH':{display:'Fumarato Idratasi',aliases:['fumarato idratasi','fumarate hydratase','fh'],site:'fbf'},
'FVIII':{display:'Fattore VIII',aliases:['fattore viii','factor viii','von willebrand'],site:'fbf'},
'FXIII':{display:'Fattore XIIIa',aliases:['fattore xiiia','fattore xiii','factor xiiia'],site:'fbf'},
'GALECTINA3':{display:'Galectina 3',aliases:['galectina 3','galectin-3','gal-3'],site:'fbf'},
'GATA3':{display:'GATA3',aliases:['gata3','gata-3'],site:'fbf'},
'GFAP':{display:'GFAP',aliases:['gfap'],site:'fbf'},
'GLICOFORINA':{display:'Glicoforina',aliases:['glicoforina','glycophorin'],site:'fbf'},
'GLUT1':{display:'Glut-1',aliases:['glut-1','glut1'],site:'fbf'},
'GLUTSYN':{display:'Glut Sintetasi',aliases:['glut sintetasi','glutamine synthetase','gs-6'],site:'fbf'},
'GLYPICAN3':{display:'Glypican-3',aliases:['glypican-3','glypican 3','gpc3'],site:'fbf'},
'HCG':{display:'HCG',aliases:['hcg','beta-hcg'],site:'fbf'},
'HEPPAR':{display:'Hep-Par-1 (HSA)',aliases:['hep-par-1','heppar','hsa','hepatocyte','hepar1'],site:'fbf'},
'HER2':{display:'HER-2',aliases:['her-2','her2','c-erbb2','cerbb2'],site:'fbf'},
'HGAL':{display:'HGAL',aliases:['hgal'],site:'fbf'},
'HHV8':{display:'HHV8',aliases:['hhv8','hhv-8','orf73'],site:'fbf'},
'HMB45':{display:'HMB45',aliases:['hmb45','hmb-45'],site:'fbf'},
'HPV':{display:'HPV',aliases:['hpv'],site:'fbf'},
'IDH1':{display:'IDH1',aliases:['idh1','idh-1'],site:'fbf'},
'IGG':{display:'IgG',aliases:['igg'],site:'fbf'},
'IGG4':{display:'IgG4',aliases:['igg4'],site:'fbf'},
'INIBINA_A':{display:'Inibina-\u03b1',aliases:['inibina','inhibin alpha','inibina alfa'],site:'fbf'},
'KAPPA':{display:'\u03ba',aliases:['kappa','catena kappa'],site:'fbf'},
'KI67':{display:'Ki-67',aliases:['ki-67','ki67','mib-1','mib1'],site:'fbf'},
'LAMBDA':{display:'\u03bb',aliases:['lambda','catena lambda'],site:'fbf'},
'MAMMOGLOB':{display:'Mammoglobina',aliases:['mammoglobina','mammaglobin'],site:'fbf'},
'MDM2':{display:'MDM2',aliases:['mdm2'],site:'fbf'},
'MELANA':{display:'Melan-A',aliases:['melan-a','melana','mart-1','mart1'],site:'fbf'},
'MIOGENINA':{display:'Miogenina',aliases:['miogenina','myogenin'],site:'fbf'},
'MLH1':{display:'MLH1',aliases:['mlh1'],site:'fbf'},
'MPO':{display:'Mieloperossidasi',aliases:['mieloperossidasi','myeloperoxidase','mpo'],site:'fbf'},
'MSH2':{display:'MSH2',aliases:['msh2'],site:'fbf'},
'MSH6':{display:'MSH6',aliases:['msh6'],site:'fbf'},
'MUC2':{display:'MUC-2',aliases:['muc-2','muc2'],site:'fbf'},
'MUC4':{display:'MUC-4',aliases:['muc-4','muc4'],site:'fbf'},
'MUC6':{display:'MUC-6',aliases:['muc-6','muc6'],site:'fbf'},
'MUM1':{display:'MUM-1',aliases:['mum-1','mum1','irf4'],site:'fbf'},
'NAPSINA':{display:'Napsina',aliases:['napsina','napsin a'],site:'fbf'},
'NF':{display:'Neurofilamenti',aliases:['neurofilamenti','neurofilament'],site:'fbf'},
'NKX3':{display:'NKX3.1',aliases:['nkx3','nkx3.1'],site:'fbf'},
'NSE':{display:'NSE',aliases:['nse'],site:'fbf'},
'OLIG2':{display:'Olig-2',aliases:['olig-2','olig2'],site:'fbf'},
'P16':{display:'p16',aliases:['p16','cdkn2a'],site:'fbf'},
'P40':{display:'p40',aliases:['p40'],site:'fbf'},
'P53':{display:'p53',aliases:['p53','tp53'],site:'fbf'},
'P57':{display:'p57',aliases:['p57'],site:'fbf'},
'P63':{display:'p63',aliases:['p63','tp63'],site:'fbf'},
'PAX5':{display:'PAX-5',aliases:['pax-5','pax5'],site:'fbf'},
'PAX8':{display:'PAX-8',aliases:['pax-8','pax8'],site:'fbf'},
'PDL1_142':{display:'PDL1 (SP142)',aliases:['pdl1 sp142','pd-l1 sp142'],site:'fbf'},
'PDL1_263':{display:'PDL1 (SP263)',aliases:['pdl1 sp263','pd-l1 sp263'],site:'fbf'},
'PHH3':{display:'PHH3',aliases:['phh3'],site:'fbf'},
'PLAP':{display:'PLAP',aliases:['plap'],site:'fbf'},
'PMS2':{display:'PMS2',aliases:['pms2'],site:'fbf'},
'PR':{display:'PR',aliases:['pr','pgr','progesterone receptor'],site:'fbf'},
'PRAME':{display:'PRAME',aliases:['prame'],site:'fbf'},
'PSA':{display:'PSA',aliases:['psa'],site:'fbf'},
'PSAP':{display:'PSAP',aliases:['psap'],site:'fbf'},
'PTEN':{display:'PTEN',aliases:['pten'],site:'fbf'},
'RACEMASI':{display:'Racemasi',aliases:['racemasi','amacr','p504s'],site:'fbf'},
'RCC':{display:'RCC',aliases:['rcc'],site:'fbf'},
'S100':{display:'S100',aliases:['s100','s-100'],site:'fbf'},
'SALL4':{display:'SALL4',aliases:['sall4'],site:'fbf'},
'SATB2':{display:'SATB2',aliases:['satb2'],site:'fbf'},
'SINAPTOFISINA':{display:'Sinaptofsina',aliases:['sinaptofsina','sinaptofisina','synaptophysin'],site:'fbf'},
'SOX10':{display:'SOX-10',aliases:['sox-10','sox10'],site:'fbf'},
'SOX11':{display:'SOX-11',aliases:['sox-11','sox11'],site:'fbf'},
'STAT6':{display:'STAT6',aliases:['stat6'],site:'fbf'},
'TDT':{display:'TdT',aliases:['tdt'],site:'fbf'},
'THYROGLOB':{display:'Thyroglobulina',aliases:['thyroglobulin','thyroglobulina','tg'],site:'fbf'},
'TTF1':{display:'TTF-1',aliases:['ttf-1','ttf1','nkx2-1'],site:'fbf'},
'VIMENTINA':{display:'Vimentina',aliases:['vimentina','vimentin'],site:'fbf'},
'WT1':{display:'WT1',aliases:['wt1','wt-1'],site:'fbf'},
'ALK1_S':{display:'Alk-1',aliases:['alk-1','alk1'],site:'sacco'},
'AMILOIDE_A':{display:'Amiloide A',aliases:['amiloide a'],site:'sacco'},
'AMILOIDE_P':{display:'Amiloide P',aliases:['amiloide p'],site:'sacco'},
'ARID1A_S':{display:'ARID1A (Sacco)',aliases:['arid1a sacco'],site:'sacco'},
'CD11':{display:'CD-11',aliases:['cd-11','cd11'],site:'sacco'},
'CD146':{display:'CD-146',aliases:['cd-146','cd146','mcam'],site:'sacco'},
'CD43':{display:'CD-43',aliases:['cd-43','cd43'],site:'sacco'},
'CD57':{display:'CD-57',aliases:['cd-57','cd57','leu-7'],site:'sacco'},
'CEA_POLI':{display:'CEA Poli',aliases:['cea poli','cea policlonale'],site:'sacco'},
'COLLAGENE4':{display:'Collagene IV',aliases:['collagene iv','collagen iv'],site:'sacco'},
'EBVEBER':{display:'EBV/EBER',aliases:['ebv/eber','eber','ebv eber'],site:'sacco'},
'GASTRINA_S':{display:'Gastrina',aliases:['gastrina','gastrin'],site:'sacco'},
'GCDFP15':{display:'GCDFP-15',aliases:['gcdfp 15','gcdfp-15','gcdfp15'],site:'sacco'},
'HPL_S':{display:'HPL',aliases:['hpl'],site:'sacco'},
'HSV1':{display:'HSV-1',aliases:['hsv 1','hsv-1','hsv1'],site:'sacco'},
'HSV2':{display:'HSV-2',aliases:['hsv 2','hsv-2','hsv2'],site:'sacco'},
'IGD':{display:'IgD',aliases:['igd','ig d'],site:'sacco'},
'INIBINA1':{display:'Inibina-1',aliases:['inibina-1'],site:'sacco'},
'MUC1_S':{display:'MUC-1',aliases:['muc-1 sacco'],site:'sacco'},
'MYOD1':{display:'MyoD1',aliases:['myod1','myo-d1'],site:'sacco'},
'OCT2_S':{display:'OCT-2',aliases:['oct-2 sacco'],site:'sacco'},
'OCT34':{display:'OCT 3/4',aliases:['oct 3/4','oct-3/4','pou5f1'],site:'sacco'},
'PARVO':{display:'Parvovirus B19',aliases:['parvovirus b19'],site:'sacco'},
'PERFORINA':{display:'Perforina',aliases:['perforina','perforin'],site:'sacco'},
'PTH_S':{display:'PTH',aliases:['pth','paratormone'],site:'sacco'},
'SF1_S':{display:'SF1',aliases:['sf1','nr5a1'],site:'sacco'},
'SOX2':{display:'SOX-2',aliases:['sox-2','sox2'],site:'sacco'},
'SV40':{display:'SV40',aliases:['sv40'],site:'sacco'},
'TIA1':{display:'Tia-1',aliases:['tia-1','tia1','t1a1'],site:'sacco'},
// === NON DISPONIBILI (importanti ma assenti da FBF e SACCO) ===
'BAP1':{display:'BAP-1',aliases:['bap-1','bap1','brca1 associated protein'],site:'nd'},
'MTAP':{display:'MTAP',aliases:['mtap','p16 proxy','cdkn2a proxy'],site:'nd'},
'CLAUDINA4':{display:'Claudina-4',aliases:['claudina-4','claudina4','cldn4'],site:'nd'},
'MOC31':{display:'MOC-31',aliases:['moc-31','moc31','epcam moc31'],site:'nd'},
'TRIPSINA':{display:'Tripsina',aliases:['tripsina','trypsin'],site:'nd'},
'CHIMOTRIPSINA':{display:'Chimotripsina',aliases:['chimotripsina','chymotrypsin'],site:'nd'},
'FLI1':{display:'FLI-1',aliases:['fli-1','fli1'],site:'nd'},
'INSM1':{display:'INSM1',aliases:['insm1','insm-1'],site:'nd'}
};

// Alias index
const aliasIndex = {};
for (const [id, m] of Object.entries(markerDB)) {
  aliasIndex[m.display.toLowerCase()] = id;
  for (const a of m.aliases) aliasIndex[a.toLowerCase()] = id;
}

function getDisplay(id) { return markerDB[id]?.display || id; }
function getSite(id) { return markerDB[id]?.site || 'fbf'; }

// BAYESIAN DATABASE
const bayesDB = [
{name:'Adenocarcinoma Polmonare',prior:0.08,markers:{'TTF1':{s:0.85,n:0.92,w:1.2},'NAPSINA':{s:0.75,n:0.95,w:1.1},'CK7':{s:0.95,n:0.4,w:0.6},'CK20':{s:0.05,n:0.9,w:0.8},'CDX2':{s:0.03,n:0.95,w:0.9},'P40':{s:0.02,n:0.95,w:1.0}}},
{name:'Carcinoma Squamoso (SCC)',prior:0.07,markers:{'P40':{s:0.95,n:0.92,w:1.3},'P63':{s:0.9,n:0.85,w:1.0},'CK56':{s:0.9,n:0.8,w:1.0},'CK7':{s:0.3,n:0.6,w:0.5},'TTF1':{s:0.05,n:0.9,w:0.9}}},
{name:'Carcinoma Mammario (NST)',prior:0.09,markers:{'ER':{s:0.8,n:0.9,w:1.2},'PR':{s:0.65,n:0.9,w:1.0},'GATA3':{s:0.9,n:0.88,w:1.2},'MAMMOGLOB':{s:0.6,n:0.95,w:1.0},'CK7':{s:0.92,n:0.3,w:0.4},'CK20':{s:0.03,n:0.9,w:0.7},'TTF1':{s:0.02,n:0.85,w:0.6}}},
{name:'Adenocarcinoma Colorettale',prior:0.08,markers:{'CK20':{s:0.85,n:0.88,w:1.2},'CDX2':{s:0.93,n:0.9,w:1.3},'SATB2':{s:0.85,n:0.92,w:1.2},'CK7':{s:0.15,n:0.7,w:0.6},'TTF1':{s:0.01,n:0.95,w:0.7}}},
{name:'HCC',prior:0.04,markers:{'HEPPAR':{s:0.85,n:0.95,w:1.3},'GLYPICAN3':{s:0.75,n:0.95,w:1.2},'ARGINASI':{s:0.85,n:0.95,w:1.2},'AFP':{s:0.3,n:0.95,w:0.9}}},
{name:'Adenocarcinoma Pancreatico',prior:0.04,markers:{'CK7':{s:0.95,n:0.3,w:0.5},'CK19':{s:0.9,n:0.4,w:0.5},'MUC4':{s:0.75,n:0.85,w:1.0},'P53':{s:0.6,n:0.5,w:0.5},'TTF1':{s:0.01,n:0.95,w:0.6}}},
{name:'Ca Acinare Pancreatico',prior:0.005,markers:{'BCL10':{s:0.9,n:0.95,w:1.5},'TRIPSINA':{s:0.9,n:0.95,w:1.4},'CHIMOTRIPSINA':{s:0.8,n:0.9,w:1.2},'CK7':{s:0.3,n:0.3,w:0.4},'CK19':{s:0.2,n:0.4,w:0.4},'CROMOGRANINA':{s:0.3,n:0.5,w:0.4},'SINAPTOFISINA':{s:0.2,n:0.5,w:0.3}}},
{name:'Carcinoma Ovarico HGSC',prior:0.04,markers:{'PAX8':{s:0.95,n:0.85,w:1.3},'WT1':{s:0.9,n:0.9,w:1.2},'CA125':{s:0.8,n:0.7,w:0.8},'ER':{s:0.7,n:0.5,w:0.5},'P53':{s:0.85,n:0.4,w:0.6}}},
{name:'Carcinoma Uroteliale',prior:0.05,markers:{'GATA3':{s:0.85,n:0.85,w:1.2},'CK7':{s:0.9,n:0.3,w:0.4},'CK20':{s:0.55,n:0.6,w:0.5},'P63':{s:0.8,n:0.6,w:0.6},'PSA':{s:0.01,n:0.98,w:0.9}}},
{name:'Carcinoma Prostatico',prior:0.05,markers:{'PSA':{s:0.9,n:0.97,w:1.4},'PSAP':{s:0.85,n:0.95,w:1.2},'NKX3':{s:0.9,n:0.95,w:1.3}}},
{name:'RCC a cellule chiare',prior:0.03,markers:{'PAX8':{s:0.92,n:0.85,w:1.3},'RCC':{s:0.75,n:0.95,w:1.1},'CAIX':{s:0.85,n:0.9,w:1.2},'VIMENTINA':{s:0.9,n:0.4,w:0.4}}},
{name:'Ca Tiroideo (PTC)',prior:0.03,markers:{'TTF1':{s:0.95,n:0.8,w:1.0},'THYROGLOB':{s:0.95,n:0.98,w:1.4},'PAX8':{s:0.92,n:0.8,w:1.0},'GALECTINA3':{s:0.8,n:0.8,w:0.9},'CALCITONINA':{s:0.01,n:0.98,w:1.0}}},
{name:'Ca Midollare Tiroideo',prior:0.01,markers:{'CALCITONINA':{s:0.95,n:0.99,w:1.5},'CROMOGRANINA':{s:0.9,n:0.6,w:0.7},'SINAPTOFISINA':{s:0.85,n:0.6,w:0.6},'CEA_MONO':{s:0.8,n:0.7,w:0.7},'THYROGLOB':{s:0.02,n:0.95,w:1.2}}},
{name:'Mesotelioma Epitelioide',prior:0.02,markers:{'CALRETININA':{s:0.9,n:0.9,w:1.3},'WT1':{s:0.85,n:0.9,w:1.2},'D240':{s:0.85,n:0.8,w:1.0},'CK56':{s:0.75,n:0.6,w:0.5},'EMA':{s:0.85,n:0.5,w:0.6},'BAP1':{s:0.05,n:0.92,w:1.2},'CEA_MONO':{s:0.02,n:0.95,w:1.1},'EPCAM':{s:0.05,n:0.9,w:0.9},'TTF1':{s:0.01,n:0.97,w:0.9},'PAX8':{s:0.02,n:0.95,w:0.8}}},
{name:'NEN G1-G2 (GI)',prior:0.03,markers:{'CROMOGRANINA':{s:0.9,n:0.85,w:1.2},'SINAPTOFISINA':{s:0.95,n:0.8,w:1.1},'CDX2':{s:0.6,n:0.7,w:0.6}}},
{name:'NEN Polmonare',prior:0.02,markers:{'CROMOGRANINA':{s:0.85,n:0.8,w:1.1},'SINAPTOFISINA':{s:0.92,n:0.8,w:1.1},'TTF1':{s:0.7,n:0.6,w:0.6},'CD56':{s:0.8,n:0.7,w:0.7}}},
{name:'Melanoma',prior:0.05,markers:{'S100':{s:0.95,n:0.75,w:1.0},'SOX10':{s:0.93,n:0.92,w:1.3},'MELANA':{s:0.85,n:0.95,w:1.2},'HMB45':{s:0.8,n:0.95,w:1.1},'PRAME':{s:0.75,n:0.9,w:1.0},'CKAE':{s:0.02,n:0.95,w:0.9},'CD45':{s:0.01,n:0.98,w:0.8}}},
{name:'MPNST',prior:0.01,markers:{'S100':{s:0.5,n:0.7,w:0.8},'SOX10':{s:0.6,n:0.8,w:0.9},'MELANA':{s:0.01,n:0.98,w:1.0},'HMB45':{s:0.01,n:0.98,w:1.0},'DESMINA':{s:0.05,n:0.8,w:0.6}}},
{name:'GIST',prior:0.03,markers:{'CD117':{s:0.95,n:0.95,w:1.4},'DOG1':{s:0.95,n:0.97,w:1.5},'CD34':{s:0.7,n:0.8,w:0.7},'DESMINA':{s:0.02,n:0.9,w:0.8},'S100':{s:0.05,n:0.85,w:0.6}}},
{name:'Leiomiosarcoma',prior:0.02,markers:{'ACTINA_SMA':{s:0.9,n:0.8,w:1.1},'DESMINA':{s:0.8,n:0.8,w:1.0},'CALDESMON':{s:0.85,n:0.92,w:1.2},'CD117':{s:0.02,n:0.9,w:0.7}}},
{name:'Rabdomiosarcoma',prior:0.01,markers:{'DESMINA':{s:0.95,n:0.7,w:1.0},'MIOGENINA':{s:0.9,n:0.98,w:1.5}}},
{name:'Sarcoma Sinoviale',prior:0.01,markers:{'CKAE':{s:0.7,n:0.5,w:0.6},'EMA':{s:0.75,n:0.6,w:0.6},'BCL2':{s:0.85,n:0.4,w:0.4},'CD99':{s:0.6,n:0.5,w:0.4}}},
{name:'Sarcoma di Ewing',prior:0.01,markers:{'CD99':{s:0.95,n:0.7,w:1.2},'VIMENTINA':{s:0.9,n:0.2,w:0.2},'DESMINA':{s:0.05,n:0.85,w:0.7}}},
{name:'Tumore Fibroso Solitario',prior:0.01,markers:{'STAT6':{s:0.95,n:0.99,w:1.6},'CD34':{s:0.9,n:0.7,w:0.8},'BCL2':{s:0.8,n:0.4,w:0.3}}},
{name:'Liposarcoma Dediff.',prior:0.01,markers:{'MDM2':{s:0.9,n:0.97,w:1.5},'CDK4':{s:0.85,n:0.95,w:1.3}}},
{name:'DLBCL',prior:0.05,markers:{'CD20':{s:0.95,n:0.8,w:1.2},'CD79A':{s:0.85,n:0.85,w:1.0},'PAX5':{s:0.92,n:0.88,w:1.1},'BCL6':{s:0.7,n:0.65,w:0.5},'MUM1':{s:0.5,n:0.55,w:0.3},'CD3':{s:0.01,n:0.98,w:0.9},'TDT':{s:0.01,n:0.99,w:0.8}}},
{name:'Linfoma T Periferico',prior:0.02,markers:{'CD3':{s:0.9,n:0.85,w:1.2},'CD5':{s:0.75,n:0.7,w:0.7},'CD7':{s:0.6,n:0.6,w:0.5},'CD20':{s:0.02,n:0.95,w:0.9},'PAX5':{s:0.01,n:0.97,w:0.8}}},
{name:'Linfoma di Hodgkin',prior:0.03,markers:{'CD30':{s:0.95,n:0.8,w:1.2},'CD15':{s:0.8,n:0.9,w:1.1},'PAX5':{s:0.9,n:0.6,w:0.4},'CD45':{s:0.05,n:0.85,w:0.8},'CD3':{s:0.02,n:0.9,w:0.7}}},
{name:'Linfoma Linfoblastico',prior:0.01,markers:{'TDT':{s:0.95,n:0.99,w:1.5},'CD19':{s:0.8,n:0.7,w:0.7},'CD99':{s:0.8,n:0.5,w:0.4}}},
{name:'Mieloma/Plasmacitoma',prior:0.02,markers:{'CD138':{s:0.95,n:0.92,w:1.4},'MUM1':{s:0.9,n:0.7,w:1.0},'CD20':{s:0.05,n:0.85,w:0.7},'PAX5':{s:0.05,n:0.85,w:0.7},'CD3':{s:0.01,n:0.95,w:0.6}}},
{name:'Seminoma',prior:0.02,markers:{'SALL4':{s:0.9,n:0.9,w:1.3},'PLAP':{s:0.85,n:0.92,w:1.2},'CD117':{s:0.85,n:0.7,w:0.7},'AFP':{s:0.01,n:0.98,w:1.0}}},
{name:'Yolk Sac Tumor',prior:0.01,markers:{'AFP':{s:0.9,n:0.95,w:1.4},'SALL4':{s:0.85,n:0.85,w:1.1},'GLYPICAN3':{s:0.8,n:0.85,w:1.0},'CD30':{s:0.01,n:0.9,w:0.7}}},
{name:'Coriocarcinoma',prior:0.005,markers:{'HCG':{s:0.95,n:0.98,w:1.5},'CKAE':{s:0.9,n:0.3,w:0.3}}}
];

// STATE
let positiveMarkers = new Set();
let negativeMarkers = new Set();
let currentMode = 'fbf';
let quizStats = { correct:0, total:0, streak:0 };
let currentQuizDx = null;
let lastResults = [];
let morphology = 'any';
let tissueLimit = 0;
let tumorBoardMode = false;
const BAYES_VERSION = 'FBF v3.1 \u2013 Feb 2026';

// Morphology prior adjustment (point 1)
function adjustPrior(dx) {
  let p = dx.prior;
  const n = dx.name;
  if (morphology === 'linfoide') {
    if (!n.includes('Linf') && !n.includes('Mieloma') && !n.includes('DLBCL') && !n.includes('Hodgkin')) p *= 0.15;
  } else if (morphology === 'mesenchimale') {
    if (n.includes('Carcinoma') || n.includes('Adeno') || n.includes('HCC') || n.includes('Melanoma')) p *= 0.2;
    else if (n.includes('Linf') || n.includes('DLBCL') || n.includes('Hodgkin') || n.includes('Mieloma')) p *= 0.15;
  } else if (morphology === 'epiteliale') {
    if (n.includes('Sarcoma') || n.includes('GIST') || n.includes('Fibroso') || n.includes('Liposarcoma') || n.includes('Leiomio') || n.includes('Rabdo') || n.includes('Ewing') || n.includes('MPNST')) p *= 0.2;
    else if (n.includes('Melanoma')) p *= 0.15;
    else if (n.includes('Linf') || n.includes('DLBCL') || n.includes('Hodgkin') || n.includes('Mieloma')) p *= 0.2;
  } else if (morphology === 'melanocitico') {
    if (!n.includes('Melanoma') && !n.includes('MPNST')) p *= 0.15;
  } else if (morphology === 'neuroendocrino') {
    if (!n.includes('NEN') && !n.includes('Midollare') && !n.includes('Seminoma')) p *= 0.3;
  } else if (morphology === 'germinale') {
    if (!n.includes('Seminoma') && !n.includes('Yolk') && !n.includes('Corio')) p *= 0.15;
  }
  return p;
}

// Correlated marker weight reduction (point 8)
const correlatedGroups = [
  ['CD20','PAX5','CD79A'],  // B-cell
  ['CD3','CD5','CD7'],       // T-cell
  ['SOX10','MELANA','HMB45'],// Melanocytic
  ['CROMOGRANINA','SINAPTOFISINA','CD56'], // NE
  ['ACTINA_SMA','ACTINA_HHF35','CALDESMON'], // Smooth muscle
  ['MLH1','MSH2','MSH6','PMS2'], // MMR
  ['PSA','PSAP','NKX3'],    // Prostate
];

function getCorrelationPenalty(mid) {
  for (const group of correlatedGroups) {
    if (!group.includes(mid)) continue;
    const othersPos = group.filter(g => g !== mid && positiveMarkers.has(g)).length;
    if (othersPos >= 2) return 0.5;
    if (othersPos >= 1) return 0.7;
  }
  return 1.0;
}

// UI handlers
function onMorphChange() { morphology = document.getElementById('morphSelect').value; }
function onTSChange() { tissueLimit = parseInt(document.getElementById('tsSelect').value) || 0; }
function onTBToggle() { tumorBoardMode = document.getElementById('tbMode').checked; if (lastResults.length) { displayResults(lastResults); } }

// BAYES ENGINE
function logSumExp(lv) {
  if (!lv.length) return -Infinity;
  const mx = Math.max(...lv);
  if (mx === -Infinity) return -Infinity;
  let s = 0; for (const v of lv) s += Math.exp(v - mx);
  return mx + Math.log(s);
}

function computeBayes() {
  const tested = new Set([...positiveMarkers, ...negativeMarkers]);
  if (tested.size === 0) return [];
  const results = [];
  for (const dx of bayesDB) {
    let logP = Math.log(adjustPrior(dx));
    const reasoning = []; const flags = [];
    for (const [mid, p] of Object.entries(dx.markers)) {
      if (!tested.has(mid)) continue;
      const d = getDisplay(mid);
      const isPos = positiveMarkers.has(mid);
      if (isPos) {
        // LR+ = sensitivity / (1 - specificity)
        const lr = p.s / Math.max(1 - p.n, 0.001);
        const corrW = p.w * getCorrelationPenalty(mid);
        logP += corrW * Math.log(Math.max(lr, 0.001));
        if (p.s >= 0.6) reasoning.push({type:'support',text:'\u2705 '+d+' (+) LR+ '+lr.toFixed(1)});
        else { flags.push('\u26a0\ufe0f '+d+' POS inatteso (sens '+Math.round(p.s*100)+'%)'); reasoning.push({type:'flag',text:'\u26a0\ufe0f '+d+' (+) inatteso ‚Äî sens '+Math.round(p.s*100)+'%'}); }
      } else {
        // LR- = (1 - sensitivity) / specificity
        const lr = (1 - p.s) / Math.max(p.n, 0.001);
        const corrW = p.w * getCorrelationPenalty(mid);
        logP += corrW * Math.log(Math.max(lr, 0.001));
        if (p.s >= 0.7) { flags.push('\ud83d\udeab '+d+' NEG (atteso pos, sens '+Math.round(p.s*100)+'%)'); reasoning.push({type:'flag',text:'\ud83d\udeab '+d+' (-) atteso pos (sens '+Math.round(p.s*100)+'%)'}); }
        else if (p.s <= 0.10) reasoning.push({type:'exclude',text:'\u274c '+d+' (-) confermato neg ‚Äî LR- '+lr.toFixed(2)});
      }
    }
    results.push({name:dx.name,logP,reasoning,flags,markers:dx.markers});
  }
  const logN = logSumExp(results.map(r=>r.logP));
  return results.map(r => ({...r, posterior:Math.exp(r.logP-logN)})).sort((a,b)=>b.posterior-a.posterior).slice(0,10);
}

// INFO GAIN
function computeInfoGain() {
  const tested = new Set([...positiveMarkers,...negativeMarkers]);
  if (lastResults.length < 2) return [];
  const cands = new Set();
  for (const r of lastResults.slice(0,5))
    for (const mid of Object.keys(r.markers))
      if (!tested.has(mid) && (currentMode==='all' || getSite(mid)==='fbf')) cands.add(mid);
  const H0 = -lastResults.reduce((s,r)=>s+(r.posterior>0?r.posterior*Math.log2(r.posterior):0),0);
  const gains = [];
  for (const mid of cands) {
    // Weighted IG (point 4): pPos = sum posterior(dx) * sens(dx, marker)
    let pPos = 0;
    for (const r of lastResults) { const mk = r.markers[mid]; if (mk) pPos += r.posterior * mk.s; }
    pPos = Math.max(0.05, Math.min(0.95, pPos)); // clamp
    positiveMarkers.add(mid); const rP = computeBayes(); positiveMarkers.delete(mid);
    negativeMarkers.add(mid); const rN = computeBayes(); negativeMarkers.delete(mid);
    const HP = -rP.reduce((s,r)=>s+(r.posterior>0?r.posterior*Math.log2(r.posterior):0),0);
    const HN = -rN.reduce((s,r)=>s+(r.posterior>0?r.posterior*Math.log2(r.posterior):0),0);
    const ig = H0 - (pPos * HP + (1 - pPos) * HN);
    gains.push({id:mid,display:getDisplay(mid),gain:ig,site:getSite(mid)});
  }
  const sorted = gains.sort((a,b)=>b.gain-a.gain);
  // Risparmio tessuto (point 5): limit suggestions
  const limit = tissueLimit > 0 ? tissueLimit : 5;
  return sorted.slice(0, limit);
}

// UI
function getSiteDot(id) {
  const s = getSite(id);
  return s==='fbf'?'<span class="site-dot dot-fbf"></span>':s==='sacco'?'<span class="site-dot dot-sacco"></span>':'<span class="site-dot dot-nd"></span>';
}
function getSiteClass(id) {
  const s = getSite(id);
  return s==='fbf'?'site-fbf':s==='sacco'?'site-sacco':'site-nd';
}
function naturalSort(a,b) {
  const da=getDisplay(a), db=getDisplay(b);
  return da.localeCompare(db, undefined, {numeric:true, sensitivity:'base'});
}
function getActiveIds() {
  return Object.keys(markerDB).filter(id=>{
    const s=markerDB[id].site;
    if(currentMode==='fbf') return s==='fbf';
    return true; // 'all' mode shows fbf + sacco + nd
  }).sort(naturalSort);
}
function onModeChange() { currentMode=document.querySelector('input[name=siteMode]:checked').value; renderAvailableMarkers(); }

function renderAvailableMarkers() {
  const search=(document.getElementById('markerSearch')?.value||'').toLowerCase();
  const avail=getActiveIds().filter(id=>!positiveMarkers.has(id)&&!negativeMarkers.has(id)&&(search===''||getDisplay(id).toLowerCase().includes(search)||markerDB[id].aliases.some(a=>a.includes(search))));
  const c=document.getElementById('availableMarkers');
  c.innerHTML=avail.map(id=>{
    const m=markerDB[id];
    return '<div class="marker-item '+getSiteClass(id)+'" draggable="true" ondragstart="handleDragStart(event,\''+id+'\')" ondragend="handleDragEnd(event)">'+getSiteDot(id)+'<span style="font-size:.8rem;">'+m.display+'</span></div>';
  }).join('')||'<p style="color:var(--subtext);text-align:center;padding:12px;">Nessun marker</p>';
  // Legend
  const legend=document.getElementById('siteLegend');
  if(legend) legend.style.display=currentMode==='all'?'flex':'none';
  renderSelectedMarkers(); updateCounts();
}

function renderSelectedMarkers() {
  const pp=document.getElementById('positivePanel');
  const np=document.getElementById('negativePanel');
  pp.innerHTML=Array.from(positiveMarkers).sort(naturalSort).map(id=>{
    return '<div class="marker-item selected-pos '+getSiteClass(id)+'" draggable="true" ondragstart="handleDragStart(event,\''+id+'\')" ondblclick="removeMarker(\''+id+'\')">'+getSiteDot(id)+'<span>'+getDisplay(id)+'</span><span class="marker-badge">\u2705</span></div>';
  }).join('')||'<p style="color:var(--subtext);text-align:center;padding:12px;grid-column:1/-1;">Trascina qui \u2192</p>';
  np.innerHTML=Array.from(negativeMarkers).sort(naturalSort).map(id=>{
    return '<div class="marker-item selected-neg '+getSiteClass(id)+'" draggable="true" ondragstart="handleDragStart(event,\''+id+'\')" ondblclick="removeMarker(\''+id+'\')">'+getSiteDot(id)+'<span>'+getDisplay(id)+'</span><span class="marker-badge">\u274c</span></div>';
  }).join('')||'<p style="color:var(--subtext);text-align:center;padding:12px;grid-column:1/-1;">Trascina qui \u2192</p>';
}

function updateCounts() {
  document.getElementById('posCount').textContent=positiveMarkers.size;
  document.getElementById('negCount').textContent=negativeMarkers.size;
  document.getElementById('availCount').textContent=getActiveIds().filter(id=>!positiveMarkers.has(id)&&!negativeMarkers.has(id)).length;
}
function removeMarker(id) { positiveMarkers.delete(id); negativeMarkers.delete(id); renderAvailableMarkers(); }

let draggedMarker=null;
function handleDragStart(e,id){ draggedMarker=id; e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain',id); e.target.closest('.marker-item')?.classList.add('dragging'); }
function handleDragEnd(e){ e.target.closest('.marker-item')?.classList.remove('dragging'); document.querySelectorAll('.marker-grid').forEach(g=>g.classList.remove('drag-over-pos','drag-over-neg')); }
function handleDragOver(e,t){ e.preventDefault(); e.dataTransfer.dropEffect='move'; e.currentTarget.classList.add(t==='positive'?'drag-over-pos':'drag-over-neg'); }
function handleDragLeave(e,t){ e.currentTarget.classList.remove(t==='positive'?'drag-over-pos':'drag-over-neg'); }
function handleDrop(e,t){ e.preventDefault(); const id=draggedMarker||e.dataTransfer.getData('text/plain'); positiveMarkers.delete(id); negativeMarkers.delete(id); if(t==='positive')positiveMarkers.add(id);else negativeMarkers.add(id); renderAvailableMarkers(); e.currentTarget.classList.remove('drag-over-pos','drag-over-neg'); }

function analyzeMarkers() {
  if(positiveMarkers.size===0&&negativeMarkers.size===0){ alert('Seleziona almeno un marker!'); return; }
  // Warning bar (point 9)
  const wb = document.getElementById('warnBar');
  const nTested = positiveMarkers.size + negativeMarkers.size;
  if (nTested < 2) { wb.style.display='block'; wb.innerHTML='\u26a0\ufe0f <strong>Inferenza fragile</strong> (n='+nTested+'). Aggiungere almeno 2 marker per risultati affidabili.'; }
  else if (nTested < 3) { wb.style.display='block'; wb.innerHTML='\ud83d\udfe1 Inferenza con '+nTested+' marker. Risultati indicativi.'; }
  else { wb.style.display='none'; }
  lastResults=computeBayes(); displayResults(lastResults);
  displayNextBest(computeInfoGain());
  document.getElementById('emptyLookupState').style.display='none';
  document.getElementById('lookupResults').style.display='block';
}

function displayResults(results) {
  const c=document.getElementById('diagnosisResults');
  if(!results.length){ c.innerHTML='<div class="empty-state"><p>Nessuna diagnosi compatibile.</p></div>'; return; }
  // Tumor board: show only top 3
  const shown = tumorBoardMode ? results.slice(0,3) : results;
  // Classe di confidenza (point 2): delta between top1 and top2
  const delta = results.length >= 2 ? results[0].posterior - results[1].posterior : 1;
  const confClass = delta > 0.15 ? 'conf-high' : delta > 0.05 ? 'conf-mid' : 'conf-low';
  const confLabel = delta > 0.15 ? 'Alta' : delta > 0.05 ? 'Intermedia' : 'Incerta (top vicine)';
  c.innerHTML='<div style="margin-bottom:10px;font-size:.88rem;">Confidenza globale: <span class="conf-badge '+confClass+'">'+confLabel+' (\u0394='+Math.round(delta*100)+'%)</span>'+(morphology!=='any'?' ¬∑ Morfologia: <strong>'+morphology+'</strong>':'')+'</div>'+
  shown.map((dx,i)=>{
    const pct=Math.round(dx.posterior*100);
    const scoreClass=pct>=25?'high':pct>=10?'medium':'low';
    const rHTML=dx.reasoning.map(r=>'<span class="'+r.type+'">'+r.text+'</span>').join('<br>');
    // Red flag score (point 3)
    const fs=dx.flags.length;
    const fsClass=fs===0?'fs-0':fs<=2?'fs-1':'fs-2';
    const fsLabel=fs===0?'\u2705 Coerente':fs<=2?'\u26a0\ufe0f Cautela ('+fs+')':'\ud83d\udea9 Instabile ('+fs+')';
    const fsBadge='<span class="flag-score '+fsClass+'">'+fsLabel+'</span>';
    const fHTML=dx.flags.length?'<div class="flags-box"><strong style="color:var(--flag);">Contraddizioni:</strong><br>'+dx.flags.join('<br>')+'</div>':'';
    const mTags=Object.keys(dx.markers).map(mid=>{
      const d=getDisplay(mid);
      if(positiveMarkers.has(mid))return '<span class="marker-tag pos">'+d+' +</span>';
      if(negativeMarkers.has(mid))return '<span class="marker-tag neg">'+d+' -</span>';
      return '<span class="marker-tag untested">'+d+' ?</span>';
    }).join('');
    return '<div class="diagnosis-result '+scoreClass+'"><div class="dx-header"><div class="dx-name">'+(i+1)+'. '+dx.name+fsBadge+'</div><div class="dx-score '+scoreClass+'">'+pct+'%</div></div><div class="dx-reasoning">'+(rHTML||'<em>Nessun marker testato</em>')+'</div>'+fHTML+'<div class="marker-list">'+mTags+'</div></div>';
  }).join('')+
  '<div class="audit-stamp">'+BAYES_VERSION+' | Morfologia: '+(morphology==='any'?'n.s.':morphology)+' | Marker testati: '+(positiveMarkers.size+negativeMarkers.size)+' | '+new Date().toISOString().slice(0,16)+'</div>';
}

function displayNextBest(gains) {
  const s=document.getElementById('nextBestSection');
  if(!gains.length){ s.innerHTML=''; return; }
  s.innerHTML='<div class="next-best"><h3>\ud83c\udfaf Prossimo Marker Suggerito (Guadagno Informativo)</h3><p style="font-size:.83rem;color:var(--subtext);margin-bottom:8px;">'+(currentMode==='fbf'?'Solo FBF.':'Inclusi SACCO.')+'</p>'+gains.map((g,i)=>'<div class="suggestion"><span class="gain-score">#'+(i+1)+'</span><strong>'+g.display+'</strong>'+(g.site==='sacco'?'<span class="sacco-tag" style="margin-left:4px;">SACCO</span>':'')+'<span style="margin-left:auto;font-size:.78rem;color:var(--gain);">IG: '+g.gain.toFixed(3)+' bit</span></div>').join('')+'</div>';
}

function resetLookup() {
  positiveMarkers.clear(); negativeMarkers.clear(); lastResults=[];
  document.getElementById('markerSearch').value=''; renderAvailableMarkers();
  document.getElementById('emptyLookupState').style.display='block';
  document.getElementById('lookupResults').style.display='none';
  document.getElementById('nextBestSection').innerHTML='';
  document.getElementById('warnBar').style.display='none';
}

// QUIZ
function nextQuizRound() {
  currentQuizDx=bayesDB[Math.floor(Math.random()*bayesDB.length)];
  const pm=Object.entries(currentQuizDx.markers).filter(([_,p])=>p.s>=0.60).sort((a,b)=>b[1].s-a[1].s).slice(0,4).map(([id])=>getDisplay(id));
  document.getElementById('quizMarkersList').innerHTML=pm.map(m=>'<span class="marker-chip">'+m+'</span>').join('');
  const opts=[...bayesDB].sort(()=>Math.random()-.5).filter(d=>d.name!==currentQuizDx.name).slice(0,3);
  opts.push(currentQuizDx); opts.sort(()=>Math.random()-.5);
  document.getElementById('quizOptions').innerHTML=opts.map((dx,i)=>"<div class='dx-option' onclick=\"selectAnswer("+i+",'"+dx.name.replace(/'/g,"\\'")+"')\">"+dx.name+"</div>").join('');
  document.getElementById('quizFeedback').className='feedback';
  document.getElementById('quizFeedback').innerHTML='';
}

function selectAnswer(i,name) {
  const ok=name===currentQuizDx.name; const fb=document.getElementById('quizFeedback');
  quizStats.total++;
  if(ok){ quizStats.correct++; quizStats.streak++; fb.className='feedback correct'; fb.innerHTML='\u2705 CORRETTO! <strong>'+currentQuizDx.name+'</strong>'; }
  else { quizStats.streak=0; fb.className='feedback incorrect';
    const tp=Object.entries(currentQuizDx.markers).filter(([_,p])=>p.s>=0.6).map(([id])=>getDisplay(id)).join(', ');
    fb.innerHTML='\u274c Era <strong>'+currentQuizDx.name+'</strong> ‚Äî '+tp; }
  document.getElementById('correctCount').textContent=quizStats.correct;
  document.getElementById('totalCount').textContent=quizStats.total;
  document.getElementById('streakCount').textContent=quizStats.streak;
  document.getElementById('accuracyPercent').textContent=(quizStats.total>0?Math.round(quizStats.correct/quizStats.total*100):0)+'%';
  setTimeout(()=>nextQuizRound(),2500);
}

function switchTab(t) {
  document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
  document.getElementById(t+'-tab').classList.add('active');
  event.target.classList.add('active');
}

(function init(){ renderAvailableMarkers(); nextQuizRound(); })();

// ============================
// CASCADE WIZARD (5 steps)
// ============================

const CASC_MORPHOLOGIES = [
  { id:'epiteliale', icon:'üî≤', label:'Epiteliale', hint:'Coesivo, ghiandolare/squamoso, cheratine+' },
  { id:'linfoide', icon:'üîµ', label:'Linfoide', hint:'Piccole cellule rotonde, pattern diffuso/nodulare' },
  { id:'mesenchimale', icon:'üî∑', label:'Mesenchimale', hint:'Fusato/pleomorfo, stroma abbondante' },
  { id:'melanocitico', icon:'‚¨õ', label:'Melanocitico', hint:'Pigmento, pagetoide, nesting' },
  { id:'neuroendocrino', icon:'üü£', label:'Neuroendocrino', hint:'Organoid, salt & pepper, rosette' },
  { id:'germinale', icon:'üü°', label:'Germinale', hint:'Cellule chiare/embrionali, solido/papillare' },
  { id:'indifferenziato', icon:'‚ùì', label:'Indifferenziato', hint:'Non orientabile su EE ‚Äî serve screening IHC' },
];

const SCREENING_PANEL = ['CKAE','VIM','S100','CD45'];
const BIG_FOUR = ['CK7','CK20','TTF1','CDX2'];

// Screening interpretation: which morphology does the pattern suggest?
function interpretScreening(screen) {
  const ck = screen.CKAE || '?';
  const vim = screen.VIM || '?';
  const s = screen.S100 || '?';
  const cd = screen.CD45 || '?';
  
  if(cd === '+') return { morph:'linfoide', hint:'CD45+ ‚Üí Linfoide. Pannello linfomi.' };
  if(s === '+' && ck === '-') return { morph:'melanocitico', hint:'S100+/CK‚àí ‚Üí Melanocitico o neurale. Pannello melanoma/MPNST.' };
  if(ck === '+' && vim === '-') return { morph:'epiteliale', hint:'CK+/Vim‚àí ‚Üí Epiteliale classico. Procedi con CK secondo livello.' };
  if(ck === '+' && vim === '+') return { morph:'epiteliale', hint:'CK+/Vim+ ‚Üí Epiteliale (RCC, endometrio, sarcomatoide, mesotelio, sinoviale). CK secondo livello.' };
  if(ck === '-' && vim === '+' && s === '-') return { morph:'mesenchimale', hint:'CK‚àí/Vim+/S100‚àí ‚Üí Mesenchimale. Pannello sarcomi.' };
  if(ck === '-' && vim === '+' && s === '+') return { morph:'melanocitico', hint:'CK‚àí/Vim+/S100+ ‚Üí Melanocitico o neurale.' };
  if(ck === '-' && vim === '-' && cd === '-') return { morph:'germinale', hint:'Tutto negativo ‚Üí Considera germinale, NEN, o anaplastico.' };
  return { morph:null, hint:'Pattern non dirimente. Seleziona la categoria pi√π probabile o prosegui.' };
}

const CASC_PANELS = {
  epiteliale: {
    'CK7+/CK20-': { hint:'Polmone, mammella, ovaio, tiroide, pancreas, mesotelio', markers:['BAP1','TTF1','NAPSINA','ER','PR','GATA3','MAMMOGLOB','PAX8','WT1','THYROGLOB','CALRETININA','D240','CA125','CEA_MONO','EPCAM','SATB2','CLAUDINA18','P40','P63','CK56','HER2'] },
    'CK7+/CK20+': { hint:'Uroteliale, pancreas, gastrico', markers:['GATA3','P63','CK56','CLAUDINA18','SATB2','CDX2'] },
    'CK7-/CK20+': { hint:'Colorettale, Merkel', markers:['CDX2','SATB2','SINAPTOFISINA','CROMOGRANINA'] },
    'CK7-/CK20-': { hint:'HCC, prostata, RCC, SCC, seminoma, acinare pancreas', markers:['HEPPAR','GLYPICAN3','ARGINASI','AFP','PSA','PSAP','NKX3','ERG','PAX8','CAIX','RCC','SATB2','CLAUDINA18','P40','P63','CK56','SALL4','PLAP'] },
    'TTF1+': { hint:'Polmone, tiroide, NEN polmonare', markers:['NAPSINA','THYROGLOB','CALCITONINA','CROMOGRANINA','SINAPTOFISINA','SATB2','CLAUDINA18','P40','CK56'] },
    'CDX2+': { hint:'Colorettale, GI NEN', markers:['CK20','SATB2','CROMOGRANINA','SINAPTOFISINA'] },
    '_default': { hint:'Pannello generico epiteliale', markers:['ER','PR','GATA3','TTF1','NAPSINA','CDX2','SATB2','PAX8','PSA','HEPPAR','CALRETININA','P40'] },
  },
  linfoide: {
    '_default': { hint:'Pannello linfoide', markers:['CD3','CD4','CD5','CD7','CD8','CD15','CD19','CD20','CD23','CD30','CD79A','CD138','PAX5','MUM1','TDT','BCL1','BCL2','BCL6','CMYC','SOX11','KI67'] },
  },
  mesenchimale: {
    '_default': { hint:'Pannello mesenchimale', markers:['ACTINA_SMA','ACTINA_HHF35','DESMINA','CALDESMON','MIOGENINA','CD31','CD34','CD99','CD117','DOG1','ERG','STAT6','MDM2','CDK4','SOX10','BCL2','EMA','CKAE'] },
  },
  melanocitico: {
    '_default': { hint:'Pannello melanocitico/neurale', markers:['SOX10','MELANA','HMB45','PRAME','CD34','CD45','CKAE','DESMINA','KI67','P16'] },
  },
  neuroendocrino: {
    '_default': { hint:'Pannello neuroendocrino', markers:['CROMOGRANINA','SINAPTOFISINA','INSM1','TTF1','CDX2','KI67','SALL4','CALCITONINA','NSE','CKAE'] },
  },
  germinale: {
    '_default': { hint:'Pannello germinale', markers:['SALL4','PLAP','AFP','HCG','CD30','CD117','GLYPICAN3','CKAE','KI67'] },
  },
  indifferenziato: {
    '_default': { hint:'Pannello ampio ‚Äî neoplasia indifferenziata', markers:['CKAE','VIM','S100','CD3','CD20','CD34','CD45','CD117','CROMOGRANINA','SINAPTOFISINA','SALL4','MELANA','HMB45','DESMINA','KI67'] },
  },
};

let cascState = { morph:null, screen:{}, bigFour:{}, panelMarkers:{}, step:1, screenMorph:null };

function cascInit() {
  const c = document.getElementById('morphButtons');
  c.innerHTML = CASC_MORPHOLOGIES.map(m =>
    '<div class="morph-btn" onclick="cascSelectMorph(\''+m.id+'\')">'+
    '<div class="morph-icon">'+m.icon+'</div>'+
    '<div class="morph-label">'+m.label+'</div>'+
    '<div class="morph-hint">'+m.hint+'</div></div>'
  ).join('');
}

function cascShowStep(n) {
  for(let i=1;i<=5;i++) {
    const el = document.getElementById('cascStep'+i);
    if(el) el.style.display = i===n ? 'block' : 'none';
    const s = document.getElementById('cStep'+i);
    if(s) s.className = 'casc-step' + (i<n?' done':'') + (i===n?' active':'');
  }
  cascState.step = n;
}

function cascSelectMorph(id) {
  cascState.morph = id;
  cascState.screen = {};
  cascState.bigFour = {};
  cascState.panelMarkers = {};
  cascState.screenMorph = null;
  document.querySelectorAll('.morph-btn').forEach(b => b.classList.remove('selected'));
  if(event && event.currentTarget) event.currentTarget.classList.add('selected');
  
  // Always go to screening panel (Step 2)
  cascShowStep(2);
  cascRenderScreening();
}

function cascRenderScreening() {
  const c = document.getElementById('screenGrid');
  c.innerHTML = SCREENING_PANEL.map(mid => {
    const d = getDisplay(mid);
    return '<div class="bf-card"><div class="bf-name">'+d+'</div><div class="bf-toggles">'+
      '<button onclick="cascSetScreen(\''+mid+'\',\'+\',this)" id="sc_'+mid+'_pos">+</button>'+
      '<button onclick="cascSetScreen(\''+mid+'\',\'-\',this)" id="sc_'+mid+'_neg">‚àí</button>'+
      '<button onclick="cascSetScreen(\''+mid+'\',\'?\',this)" id="sc_'+mid+'_unk" class="sel-unk">?</button>'+
    '</div></div>';
  }).join('');
  document.getElementById('screenHint').textContent = 'Seleziona i risultati dello screening per orientare la diagnosi.';
}

function cascSetScreen(mid, val, btn) {
  cascState.screen[mid] = val;
  ['pos','neg','unk'].forEach(t => {
    const b = document.getElementById('sc_'+mid+'_'+t);
    if(b) b.className = (val==='+' && t==='pos') ? 'sel-pos' : (val==='-' && t==='neg') ? 'sel-neg' : (val==='?' && t==='unk') ? 'sel-unk' : '';
  });
  // Update hint
  const interp = interpretScreening(cascState.screen);
  const hintEl = document.getElementById('screenHint');
  if(interp.morph) {
    const morphLabel = CASC_MORPHOLOGIES.find(m=>m.id===interp.morph)?.label || interp.morph;
    hintEl.innerHTML = '<strong>‚Üí '+morphLabel+'</strong>: '+interp.hint;
    hintEl.style.background = '#d1fae5';
    hintEl.style.color = '#065f46';
  } else {
    hintEl.innerHTML = interp.hint;
    hintEl.style.background = '#fef3c7';
    hintEl.style.color = '#92400e';
  }
}

function cascFromScreening() {
  // Record screening markers
  for(const [mid, val] of Object.entries(cascState.screen)) {
    if(val === '+') cascState.panelMarkers[mid] = '+';
    else if(val === '-') cascState.panelMarkers[mid] = '-';
  }
  
  // Determine morphology from screening if user picked "indifferenziato"
  const interp = interpretScreening(cascState.screen);
  if(cascState.morph === 'indifferenziato' && interp.morph) {
    cascState.screenMorph = interp.morph;
    cascState.morph = interp.morph;
  }
  
  // Epiteliale ‚Üí go to Big Four CK (Step 3)
  if(cascState.morph === 'epiteliale') {
    cascShowStep(3);
    cascRenderBigFour();
  } else {
    // Non-epiteliale ‚Üí skip Big Four, go to Panel (Step 4)
    cascShowStep(4);
    cascRenderPanel();
    document.getElementById('panelBackBtn').setAttribute('onclick','cascBack(2)');
  }
}

function cascRenderBigFour() {
  const c = document.getElementById('bigFourGrid');
  c.innerHTML = BIG_FOUR.map(mid => {
    const d = getDisplay(mid);
    return '<div class="bf-card"><div class="bf-name">'+d+'</div><div class="bf-toggles">'+
      '<button onclick="cascSetBF(\''+mid+'\',\'+\')" id="bf_'+mid+'_pos">+</button>'+
      '<button onclick="cascSetBF(\''+mid+'\',\'-\')" id="bf_'+mid+'_neg">‚àí</button>'+
      '<button onclick="cascSetBF(\''+mid+'\',\'?\')" id="bf_'+mid+'_unk" class="sel-unk">?</button>'+
    '</div></div>';
  }).join('');
}

function cascSetBF(mid, val) {
  cascState.bigFour[mid] = val;
  ['pos','neg','unk'].forEach(t => {
    const b = document.getElementById('bf_'+mid+'_'+t);
    if(b) b.className = (val==='+' && t==='pos') ? 'sel-pos' : (val==='-' && t==='neg') ? 'sel-neg' : (val==='?' && t==='unk') ? 'sel-unk' : '';
  });
}

function cascAdvance(toStep) {
  if (toStep === 4) {
    // Apply Big Four to panelMarkers
    for(const [mid, val] of Object.entries(cascState.bigFour)) {
      if(val === '+') cascState.panelMarkers[mid] = '+';
      else if(val === '-') cascState.panelMarkers[mid] = '-';
    }
    cascShowStep(4);
    cascRenderPanel();
    document.getElementById('panelBackBtn').setAttribute('onclick','cascBack(3)');
  } else if (toStep === 5) {
    cascShowStep(5);
    cascComputeResults();
  }
}

function cascBack(toStep) {
  cascShowStep(toStep);
  if(toStep === 2) cascRenderScreening();
  if(toStep === 3) cascRenderBigFour();
  if(toStep === 4) cascRenderPanel();
}

function cascGetBFPattern() {
  const bf = cascState.bigFour;
  const ttf1 = bf.TTF1 || '?';
  const cdx2 = bf.CDX2 || '?';
  if(ttf1 === '+') return 'TTF1+';
  if(cdx2 === '+') return 'CDX2+';
  const ck7 = bf.CK7 || '?';
  const ck20 = bf.CK20 || '?';
  return 'CK7'+(ck7==='+'?'+':'-')+'/CK20'+(ck20==='+'?'+':'-');
}

function cascRenderPanel() {
  const morph = cascState.morph;
  const panels = CASC_PANELS[morph] || CASC_PANELS['indifferenziato'];
  let panelKey = '_default';
  let summaryHTML = '';
  
  // Summary of screening
  const scrSummary = SCREENING_PANEL.map(m => {
    const v = cascState.screen[m] || '?';
    const cls = v==='+'?'pos':v==='-'?'neg':'';
    return '<span class="marker-tag '+cls+'">'+getDisplay(m)+' '+v+'</span>';
  }).join(' ');
  summaryHTML = '<div style="margin-bottom:8px;font-size:.85rem;">Screening: '+scrSummary+'</div>';
  
  if(morph === 'epiteliale') {
    const pattern = cascGetBFPattern();
    if(panels[pattern]) panelKey = pattern;
    const bfSummary = BIG_FOUR.map(m => {
      const v = cascState.bigFour[m] || '?';
      const cls = v==='+'?'pos':v==='-'?'neg':'';
      return '<span class="marker-tag '+cls+'">'+getDisplay(m)+' '+v+'</span>';
    }).join(' ');
    summaryHTML += '<div style="margin-bottom:8px;font-size:.85rem;">Big Four: '+bfSummary+'</div>';
  }
  
  const panel = panels[panelKey] || panels['_default'];
  document.getElementById('cascPanelHint').textContent = panel.hint;
  document.getElementById('cascPanelSummary').innerHTML = summaryHTML;
  
  // Show all markers in panel (fbf, sacco, nd) - semaforo will indicate availability
  const alreadySet = new Set(Object.keys(cascState.panelMarkers));
  const available = panel.markers.filter(mid => markerDB[mid] && !alreadySet.has(mid));
  
  const c = document.getElementById('panelGrid');
  c.innerHTML = '<div class="site-legend"><span><span class="site-dot dot-fbf"></span>FBF</span><span><span class="site-dot dot-sacco"></span>SACCO</span><span><span class="site-dot dot-nd"></span>Non disp.</span></div>' +
    available.map(mid => {
    const d = getDisplay(mid);
    const st = cascState.panelMarkers[mid];
    const cls = st==='+'?'pm-pos':st==='-'?'pm-neg':'';
    return '<div class="panel-marker '+cls+' '+getSiteClass(mid)+'" onclick="cascTogglePanel(\''+mid+'\',this)" data-mid="'+mid+'">'+getSiteDot(mid)+d+(st?' '+(st==='+'?'‚úÖ':'‚ùå'):'')+'</div>';
  }).join('');
  
  if(!available.length) c.innerHTML = '<p style="color:var(--subtext);text-align:center;padding:16px;">Tutti i marker del pannello sono gi√† stati impostati nello screening/CK.</p>';
}

function cascTogglePanel(mid, el) {
  const cur = cascState.panelMarkers[mid];
  if(!cur) { cascState.panelMarkers[mid] = '+'; el.className='panel-marker pm-pos '+getSiteClass(mid); el.innerHTML=getSiteDot(mid)+getDisplay(mid)+' ‚úÖ'; }
  else if(cur==='+') { cascState.panelMarkers[mid] = '-'; el.className='panel-marker pm-neg '+getSiteClass(mid); el.innerHTML=getSiteDot(mid)+getDisplay(mid)+' ‚ùå'; }
  else { delete cascState.panelMarkers[mid]; el.className='panel-marker '+getSiteClass(mid); el.innerHTML=getSiteDot(mid)+getDisplay(mid); }
}

function cascComputeResults() {
  const savedPos = new Set(positiveMarkers);
  const savedNeg = new Set(negativeMarkers);
  const savedMorph = morphology;
  
  positiveMarkers.clear();
  negativeMarkers.clear();
  for(const [mid, val] of Object.entries(cascState.panelMarkers)) {
    if(val === '+') positiveMarkers.add(mid);
    else if(val === '-') negativeMarkers.add(mid);
  }
  morphology = cascState.morph || 'any';
  
  const results = computeBayes();
  
  const c = document.getElementById('cascResults');
  if(!results.length) {
    c.innerHTML = '<div class="empty-state"><p>Nessuna diagnosi compatibile con questo profilo.</p></div>';
  } else {
    c.innerHTML = results.slice(0, 8).map((dx,i) => {
      const pct = Math.round(dx.posterior * 100);
      const cls = pct>=25?'high':pct>=10?'medium':'low';
      const rHTML = dx.reasoning.map(r => '<span class="'+r.type+'">'+r.text+'</span>').join('<br>');
      const fHTML = dx.flags.length ? '<div style="margin-top:4px;padding:4px 8px;background:#fef2f2;border-radius:6px;font-size:.8rem;"><strong style="color:var(--flag);">üö©</strong> '+dx.flags.join(' | ')+'</div>' : '';
      return '<div class="diagnosis-result '+cls+'"><div class="dx-header"><div class="dx-name">'+(i+1)+'. '+dx.name+'</div><div class="dx-score '+cls+'">'+pct+'%</div></div><div class="dx-reasoning">'+rHTML+'</div>'+fHTML+'</div>';
    }).join('');
  }
  
  const nPos = Object.values(cascState.panelMarkers).filter(v=>v==='+').length;
  const nNeg = Object.values(cascState.panelMarkers).filter(v=>v==='-').length;
  document.getElementById('cascAudit').textContent = BAYES_VERSION+' | Cascade: '+cascState.morph+' | Pos:'+nPos+' Neg:'+nNeg+' | '+new Date().toISOString().slice(0,16);
  
  positiveMarkers = savedPos;
  negativeMarkers = savedNeg;
  morphology = savedMorph;
}

function cascToInverse() {
  positiveMarkers.clear();
  negativeMarkers.clear();
  for(const [mid, val] of Object.entries(cascState.panelMarkers)) {
    if(val === '+') positiveMarkers.add(mid);
    else if(val === '-') negativeMarkers.add(mid);
  }
  const mSel = document.getElementById('morphSelect');
  if(mSel) mSel.value = cascState.morph || 'any';
  morphology = cascState.morph || 'any';
  renderAvailableMarkers();
  switchTab('inverse');
  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.toggle('active', b.textContent.includes('Ricerca'));
  });
  analyzeMarkers();
}

function cascReset() {
  cascState = { morph:null, screen:{}, bigFour:{}, panelMarkers:{}, step:1, screenMorph:null };
  cascShowStep(1);
  document.querySelectorAll('.morph-btn').forEach(b => b.classList.remove('selected'));
}

cascInit();

</script>
</body>
</html>

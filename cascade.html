<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IHC Cascade v2.3 - CUP Diagnostic Tool</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --subtext: #64748b;
      --accent: #4f46e5;
      --pos: #059669;
      --neg: #dc2626;
      --warn: #d97706;
      --border: #e2e8f0;
      --shadow: rgba(0, 0, 0, 0.1);
      --sacco: #e879f9;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border);
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(135deg, var(--accent), var(--pos));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .version {
      color: var(--subtext);
      font-size: 0.9rem;
    }

    .version strong {
      color: var(--warn);
    }

    /* STEP 1: First-Line Orientation */
    .first-line {
      background: linear-gradient(135deg, #fef3c7, #fed7aa);
      border: 2px solid var(--warn);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px var(--shadow);
    }

    .first-line h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: #92400e;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .first-line .step-label {
      background: var(--warn);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    /* Big Four */
    .big-four {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .marker-group {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .marker-group h3 {
      font-size: 1.1rem;
      margin-bottom: 15px;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .marker-btn-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .marker-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--border);
      background: white;
      color: var(--text);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all 0.2s;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .marker-btn:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .marker-btn.positive {
      background: var(--pos);
      color: white;
      border-color: var(--pos);
    }

    .marker-btn.negative {
      background: var(--neg);
      color: white;
      border-color: var(--neg);
    }

    .marker-btn.not-tested {
      opacity: 0.5;
    }

    /* Panel Selection */
    .panel-selection {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .panel-selection h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: var(--accent);
    }

    .panel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .panel-btn {
      padding: 15px;
      background: white;
      border: 2px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all 0.2s;
      text-align: center;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .panel-btn:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .panel-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* Marker Panel */
    .marker-panel {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      display: none;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .marker-panel.active {
      display: block;
    }

    .marker-panel h3 {
      font-size: 1.2rem;
      margin-bottom: 20px;
      color: var(--accent);
    }

    .marker-section {
      margin-bottom: 25px;
    }

    .marker-section-label {
      font-size: 0.85rem;
      color: var(--subtext);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .marker-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
    }

    .marker-item {
      display: flex;
      gap: 6px;
    }

    .marker-item button {
      flex: 1;
      padding: 10px;
      border: 2px solid var(--border);
      background: white;
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      min-width: 40px;
      box-shadow: 0 1px 2px var(--shadow);
    }

    .marker-item button:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 6px var(--shadow);
    }

    .marker-item button.positive {
      background: var(--pos);
      color: white;
      border-color: var(--pos);
    }

    .marker-item button.negative {
      background: var(--neg);
      color: white;
      border-color: var(--neg);
    }

    .marker-item button.not-tested {
      opacity: 0.4;
    }

    /* SACCO-only marker badge */
    .sacco-badge {
      background: var(--sacco);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 4px;
    }

    /* ‚≠ê NEW v2.4: Morphology Check Section */
    .morphology-check {
      background: linear-gradient(135deg, #f0fdf4, #dcfce7);
      border: 2px solid var(--pos);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px var(--shadow);
    }

    .morphology-check h2 {
      font-size: 1.3rem;
      margin-bottom: 10px;
      color: #065f46;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .morphology-check p {
      color: #065f46;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }

    .morphology-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
    }

    .morphology-item {
      background: white;
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      transition: all 0.2s;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .morphology-item:hover {
      border-color: var(--pos);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .morphology-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .morphology-item label {
      flex: 1;
      cursor: pointer;
      font-size: 0.95rem;
      color: var(--text);
    }

    .morphology-item.checked {
      border-color: var(--pos);
      background: #f0fdf4;
    }

    /* Results */
    .results {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .results h2 {
      font-size: 1.3rem;
      margin-bottom: 20px;
      color: var(--accent);
    }

    .result-section {
      margin-bottom: 25px;
    }

    .result-section h3 {
      font-size: 1.1rem;
      margin-bottom: 15px;
      color: var(--pos);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .diagnosis-card,
    .alert-card,
    .suggestion-card {
      background: #f8fafc;
      border-left: 4px solid var(--accent);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .diagnosis-card.high {
      border-left-color: var(--pos);
    }

    .diagnosis-card.medium {
      border-left-color: var(--warn);
    }

    .diagnosis-card.low {
      border-left-color: var(--subtext);
    }

    .alert-card {
      border-left-color: var(--warn);
      background: #fef3c7;
    }

    .alert-card.redflag {
      border-left-color: var(--neg);
      background: #fee2e2;
    }

    /* ‚≠ê v2.6 FIX: Classi alert curable e advisory */
    .alert-card.curable {
      border-left-color: var(--pos);
      background: #dcfce7;
    }

    .alert-card.advisory {
      border-left-color: var(--accent);
      background: #eff6ff;
    }

    .suggestion-card {
      border-left-color: var(--accent);
    }

    /* ‚≠ê NEW v2.5: Auto-panel suggestion clickable */
    .suggestion-card.auto-panel {
      cursor: pointer;
      transition: all 0.2s;
      border-left-width: 4px;
    }

    .suggestion-card.auto-panel:hover {
      background: #eff6ff;
      border-left-color: var(--pos);
      transform: translateX(4px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .suggestion-card.auto-panel .card-detail {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .suggestion-card.auto-panel .card-detail::after {
      content: '‚Üí';
      font-size: 1.2rem;
      color: var(--accent);
      margin-left: auto;
    }

    .card-title {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 1rem;
    }

    .card-detail {
      color: var(--subtext);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .confidence-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 8px;
    }

    .confidence-badge.high {
      background: #d1fae5;
      color: #065f46;
    }

    .confidence-badge.medium {
      background: #fed7aa;
      color: #92400e;
    }

    .confidence-badge.low {
      background: #e2e8f0;
      color: #475569;
    }

    /* Actions */
    .actions {
      display: flex;
      gap: 12px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px var(--shadow);
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: #4338ca;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .btn-secondary {
      background: white;
      color: var(--text);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--accent);
      box-shadow: 0 4px 12px var(--shadow);
    }

    /* Bibliografia */
    .bibliography {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .bibliography h2 {
      font-size: 1.3rem;
      margin-bottom: 20px;
      color: var(--accent);
    }

    .bibliography-content {
      color: var(--subtext);
      font-size: 0.9rem;
      line-height: 1.8;
    }

    .bibliography-content strong {
      color: var(--text);
    }

    /* Disclaimer */
    .disclaimer {
      background: #fef3c7;
      border: 2px solid var(--warn);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      color: var(--text);
      font-size: 0.9rem;
      line-height: 1.6;
      box-shadow: 0 2px 4px var(--shadow);
    }

    .disclaimer strong {
      color: #92400e;
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 20px;
      color: var(--subtext);
      font-size: 0.85rem;
      border-top: 1px solid var(--border);
    }

    /* Responsive */
    @media (max-width: 768px) {
      h1 {
        font-size: 1.8rem;
      }

      .big-four {
        grid-template-columns: 1fr;
      }

      .panel-grid {
        grid-template-columns: 1fr;
      }

      .marker-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
    }

    /* Utility */
    code {
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      color: var(--accent);
      border: 1px solid var(--border);
    }

    em {
      color: var(--warn);
      font-style: normal;
      font-weight: 600;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--subtext);
    }

    /* ‚≠ê v2.22: Fix marker label alignment */
    .marker-name {
      min-width: 80px;
      max-width: 100px;
      display: inline-block;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üî¨ IHC Cascade CUP</h1>
      <p class="version">
        Version <strong>2.22 ENHANCED</strong> | 
        Dr. Filippo Bianchi | 
        SC Anatomia Patologica ASST Fatebenefratelli-Sacco
      </p>
      <p class="version" style="margin-top: 8px;">
        <strong style="color: var(--pos);">v2.22 ENHANCED (Anticorpi Corretti):</strong> 
        ‚úÖ 172 anticorpi corretti (FBF bianco=131, SACCO rosa=41) | 
        üìä Diagnosi principale ENORME (3.5rem) | 
        üü¢ Logica clinica [+] [-] [n.t.] con colori FBF/SACCO
        <br><em style="font-size: 0.85rem; color: #64748b;">Based on: PDF Foglio1 FBF + Vollmer 2009 Bayes</em>
      <a href="https://notebooklm.google.com/notebook/24ad79d4-b4f7-43ba-bf95-24d15bcb4af1" target="_blank" rel="noopener noreferrer" style="display: inline-block; margin-top: 12px; padding: 12px 24px; background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 0.95rem; transition: all 0.2s; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
  üìì NotebookLM (Avvocato del Diavolo)
</a>
<style>
  a[href*="notebooklm.google.com"]:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 24px rgba(139, 92, 246, 0.5);
  }
</style></p>
    </header>

    <!-- ‚≠ê NEW v2.10: STEP 0 - Dati Clinici -->
    <div style="background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border: 2px solid #6b7280; border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 12px var(--shadow);">
      <h2 style="font-size: 1.3rem; margin-bottom: 15px; color: #1f2937; display: flex; align-items: center; gap: 10px;">
        <span style="background: #6b7280; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">STEP 0</span>
        Dati Clinici Essenziali
      </h2>
      <p style="color: #374151; margin-bottom: 15px; font-size: 0.9rem;">
        <strong>‚ö†Ô∏è Obbligatorio:</strong> La probabilit√† pre-test √® definita da et√†, sesso e sede anatomica. 
        Questi dati orientano l'algoritmo IHC e ottimizzano il risparmio di tessuto.
      </p>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
        <div>
          <label style="display: block; font-weight: 600; color: #1f2937; margin-bottom: 8px;">
            Et√† paziente (anni):
          </label>
          <input type="number" id="patientAge" min="0" max="120" 
                 style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem;"
                 placeholder="Es: 67">
        </div>
        
        <div>
          <label style="display: block; font-weight: 600; color: #1f2937; margin-bottom: 8px;">
            Sesso:
          </label>
          <select id="patientSex" 
                  style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem;">
            <option value="">Non specificato</option>
            <option value="M">Maschio</option>
            <option value="F">Femmina</option>
          </select>
        </div>
        
        <div>
          <label style="display: block; font-weight: 600; color: #1f2937; margin-bottom: 8px;">
            Sede biopsia:
          </label>
          <select id="biopsySite" 
                  style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem;">
            <option value="">Seleziona sede...</option>
            <option value="ln_cervical">Linfonodo cervicale (collo)</option>
            <option value="ln_axillary">Linfonodo ascellare</option>
            <option value="ln_inguinal">Linfonodo inguinale</option>
            <option value="liver">Metastasi epatica</option>
            <option value="bone">Metastasi ossea</option>
            <option value="lung">Metastasi polmonare</option>
            <option value="effusion">Versamento sieroso</option>
            <option value="soft_tissue">Tessuti molli</option>
            <option value="other">Altra sede</option>
          </select>
        </div>
      </div>
      
      <p style="margin-top: 15px; font-size: 0.85rem; color: #6b7280; font-style: italic;">
        üí° <strong>Nota:</strong> Sede biopsia attiva alert specifici e pannelli lean ottimizzati 
        per risparmiare tessuto (es. "Ascella donna" ‚Üí GATA3/TRPS1 immediati, salta Big Four).
      </p>
    </div>

    <!-- ‚≠ê v2.10: Morfologia EE ‚Üí STEP 1 (PRIMA IHC!) -->
    <div class="morphology-check">
      <h2>
        <span style="background: var(--pos); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">STEP 1</span>
        Morfologia EE ‚Äî "Il Vetrino Non Mente"
      </h2>
      <p>
        <strong style="color: var(--pos);">‚ö†Ô∏è PRIMA di QUALSIASI IHC:</strong> il vetrino non mente, 
        la morfologia detta la chimica. L'immunoistochimica va sempre orientata e correlata alla morfologia EE. 
        <strong style="color: var(--pos);">v2.10: Morfologia guida workflow</strong> 
        (blocca pannelli inappropriati, attiva alert game-changers).
      </p>
      
      <div class="morphology-grid">
        <!-- Architettura -->
        <div style="grid-column: 1 / -1; font-weight: 600; color: var(--accent); margin-top: 10px; margin-bottom: 5px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">
          üìê ARCHITETTURA
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="arch_gland">
          <label for="arch_gland">Ghiandolare</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="arch_solid">
          <label for="arch_solid">Solida</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="arch_trabec">
          <label for="arch_trabec">Trabecolare</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="arch_micropap">
          <label for="arch_micropap">üÜï Micropapillare (filigree-like)</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="arch_lepidic">
          <label for="arch_lepidic">üÜï Lepidico (crescita alveolare)</label>
        </div>

        <!-- Citologia -->
        <div style="grid-column: 1 / -1; font-weight: 600; color: var(--accent); margin-top: 15px; margin-bottom: 5px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">
          üî¨ CITOLOGIA
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="cyto_signet">
          <label for="cyto_signet">üÜï Signet-ring cells (anello castone)</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="cyto_clear">
          <label for="cyto_clear">üÜï Clear cell (cellule chiare)</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="cyto_srbc">
          <label for="cyto_srbc">üÜï Small round blue cell (SRBC)</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="cyto_spindle">
          <label for="cyto_spindle">üÜï Spindle cell (fusocellulare)</label>
        </div>

        <!-- Differenziazione -->
        <div style="grid-column: 1 / -1; font-weight: 600; color: var(--accent); margin-top: 15px; margin-bottom: 5px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">
          üß¨ DIFFERENZIAZIONE
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="diff_squamous">
          <label for="diff_squamous">üÜï Squamoso (perle cornee/ponti)</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="diff_mucin">
          <label for="diff_mucin">üÜï Produzione di muco</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="pigment">
          <label for="pigment">Pigmento melanina</label>
        </div>

        <!-- Pattern Specifici -->
        <div style="grid-column: 1 / -1; font-weight: 600; color: var(--accent); margin-top: 15px; margin-bottom: 5px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">
          üéØ PATTERN SPECIFICI
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="zellballen">
          <label for="zellballen">Zellballen (nidi)</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="vascolar">
          <label for="vascolar">Vascolare anastomosante</label>
        </div>

        <!-- Attivit√† Proliferativa -->
        <div style="grid-column: 1 / -1; font-weight: 600; color: var(--accent); margin-top: 15px; margin-bottom: 5px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">
          ‚ö° ATTIVIT√Ä PROLIFERATIVA
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="necro">
          <label for="necro">Necrosi presente</label>
        </div>
        <div class="morphology-item">
          <input type="checkbox" id="mitosi">
          <label for="mitosi">Mitosi frequenti (>10/HPF)</label>
        </div>
      </div>
    </div>

    <!-- ‚≠ê NEW v2.12: PREDICT IMMUNOPROFILE -->
    <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border: 2px solid #0284c7; border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 12px var(--shadow);">
      <h2 style="font-size: 1.3rem; margin-bottom: 15px; color: #0369a1; display: flex; align-items: center; gap: 10px;">
        <span style="background: #0284c7; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">üîç PREDICT</span>
        Immunoprofilo Atteso per Diagnosi Sospetta
      </h2>
      <p style="color: #0369a1; margin-bottom: 15px; font-size: 0.9rem;">
        <strong>‚ö° Nuovo:</strong> Cerca una diagnosi per vedere pattern IHC atteso (% positivit√†, morfologia, molecolare, DDx)
      </p>
      
      <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="predictSearch" 
               placeholder="Es: sarcoma sinoviale, melanoma, carcinoma renale..."
               style="flex: 1; padding: 12px; border: 2px solid #0284c7; border-radius: 8px; font-size: 1rem;"
               list="diagnosisSuggestions">
        <button onclick="searchImmunoprofile()" 
                style="padding: 12px 24px; background: #0284c7; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
          Cerca
        </button>
        <button onclick="clearImmunoprofile()" 
                style="padding: 12px 20px; background: #64748b; color: white; border: none; border-radius: 8px; cursor: pointer;">
          Reset
        </button>
      </div>
      
      <datalist id="diagnosisSuggestions">
        <!-- Populated by JavaScript -->
      </datalist>
      
      <div id="immunoprofileResults" style="display: none; margin-top: 20px;">
        <!-- Populated by searchImmunoprofile() -->
      </div>
    </div>

    <!-- ‚≠ê v2.10: STEP 2 - First-Line (dopo morfologia!) -->
    <div class="first-line">
      <h2>
        <span class="step-label">STEP 2</span>
        Orientamento Iniziale IHC
      </h2>
      <p style="color: #92400e; margin-bottom: 15px; font-size: 0.9rem;">
        <strong>Dopo morfologia EE:</strong> CK AE1/AE3 (epiteliale), CD45 (linfoide), 
        Vimentin (mesenchimale), S100 (melanoma/neural). <strong style="color: var(--pos);">Il reagente va interpretato alla luce di STEP 1.</strong>
      </p>
      <div class="big-four" id="firstLine">
        <!-- Generated by JavaScript -->
      </div>
    </div>

    <!-- ‚≠ê NEW v2.5: Auto-Panel Suggestions -->
    <div id="autoPanelSuggestions" style="display: none; margin-bottom: 30px;">
      <!-- Generated by updateAutoPanelSuggestions() -->
    </div>

    <!-- ‚≠ê v2.6 NEW: CK‚àí Callout Guardrail -->
    <div id="ckNegativeCallout" style="display: none;">
      <div style="background: linear-gradient(135deg, #fef3c7, #fed7aa); border: 2px solid var(--warn); border-radius: 12px; padding: 20px; margin-bottom: 30px; box-shadow: 0 4px 12px var(--shadow);">
        <h3 style="font-size: 1.1rem; margin-bottom: 12px; color: #92400e; display: flex; align-items: center; gap: 8px;">
          ‚ö†Ô∏è GUARDRAIL ‚Äî CK AE1/AE3 Negativo con Morfologia Epiteliale
        </h3>
        <p style="color: #92400e; margin-bottom: 10px; font-size: 0.95rem;">
          <strong>Se morfologia ghiandolare/trabecolare/solida MA CK‚àí:</strong>
        </p>
        <ul style="color: #92400e; margin-left: 20px; font-size: 0.9rem; line-height: 1.6;">
          <li><strong>Ripeti CK</strong> con clone diverso (AE1/AE3 + CAM5.2)</li>
          <li>Verifica <strong>fissazione</strong> e <strong>recupero antigenico</strong></li>
          <li>Considera <strong>EMA, MOC31, Claudina-4</strong> <span style="color: #b45309;">(se disponibili; altrimenti consulenza esterna)</span></li>
          <li>Alcuni carcinomi sono <strong>CK‚àí veri</strong>: renale cromofobo, epatoide, rabdoide</li>
          <li>Pannello alternativo: <strong>PAX8, GATA3, ER</strong> (carcinomi site-specific)</li>
        </ul>
        <p style="color: #92400e; margin-top: 10px; font-size: 0.85rem; font-style: italic;">
          <strong>Il vetrino non mente:</strong> morfologia EE + IHC = diagnosi integrata
        </p>
      </div>
    </div>

    <!-- ‚≠ê v2.10: STEP 3 - Big Four (conditionally shown if CK+) -->
    <div id="bigFourSection" style="display: none;">
      <div style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); border: 2px solid var(--accent); border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 12px var(--shadow);">
        <h2 style="font-size: 1.3rem; margin-bottom: 15px; color: #1e40af; display: flex; align-items: center; gap: 10px;">
          <span style="background: var(--accent); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">STEP 3</span>
          Big Four (SE CK+)
        </h2>
        <p style="color: #1e40af; margin-bottom: 15px; font-size: 0.9rem;">
          <strong>Solo se CK AE1/AE3 positivo:</strong> orienta l'origine dell'adenocarcinoma. 
          <strong style="color: var(--pos);">Pu√≤ essere saltato se sede anatomica chiara (es. ascella donna ‚Üí GATA3 diretto).</strong>
        </p>
        <div class="big-four" id="bigFour">
          <!-- Generated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Panel Selection -->
    <div class="panel-selection">
      <h2>
        <span style="background: var(--accent); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-right: 10px;">STEP 3</span>
        Pannelli IHC Specifici
      </h2>
      <div class="panel-grid" id="panelGrid">
        <!-- Generated by JavaScript -->
      </div>
    </div>

    <!-- Marker Panels -->
    <div id="markerPanels">
      <!-- Generated by JavaScript -->
    </div>

    <!-- Actions -->
    <div class="actions">
      <button class="btn btn-primary" onclick="calculate()">üîç Calcola Diagnosi</button>
      <button class="btn btn-secondary" onclick="resetAll()">üîÑ Reset Tutto</button>
      <button class="btn btn-secondary" onclick="toggleBibliography()">üìö Bibliografia</button>
    </div>

    <!-- Results -->
    <div class="results" id="results" style="display: none;">
      <!-- ‚≠ê DIAGNOSI PRINCIPALE - PRIMA DI TUTTO! -->
      <div class="result-section" id="diagnosesSection" style="display: none;">
        <div id="diagnosesContainer"></div>
      </div>
      
      <h2 style="margin-top: 40px;">üìä Risultati</h2>
      
      <div class="result-section" id="alertsSection" style="display: none;">
        <h3>‚ö†Ô∏è Alert & Red Flags</h3>
        <div id="alertsContainer"></div>
      </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="copyReportHTML()" style="background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
              üìã Copia Referto (HTML)
            </button>
            <button onclick="copyReportText()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
              üìÑ Copia Testo
            </button>
            <button onclick="showReportPreview()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
              üëÅÔ∏è Anteprima
            </button>
          </div>
        </div>
        <div id="diagnosesContainer"></div>
      </div>

      <!-- ‚≠ê NEW v2.15: PROBABILITY GAME -->
      <div class="result-section" id="probabilitySection" style="display: none;">
        <h3>üé≤ Probabilit√† Diagnostiche (GAME)</h3>
        <p style="font-size: 0.9rem; color: var(--subtext); margin-bottom: 15px;">
          Calcolo bayesiano basato su marker positivi/negativi vs immunoprofili database
        </p>
        <div id="probabilityContainer"></div>
      </div>

      <div class="result-section" id="suggestionsSection" style="display: none;">
        <h3>üí° Suggerimenti</h3>
        <div id="suggestionsContainer"></div>
      </div>

      <div class="result-section" id="gapsSection" style="display: none;">
        <h3>üîß Marcatori Non Disponibili FBF</h3>
        <div id="gapsContainer"></div>
      </div>
    </div>

    <!-- Bibliografia -->
    <div class="bibliography" id="bibliography" style="display: none;">
      <h2>üìö Bibliografia</h2>
      <div class="bibliography-content" id="bibliographyContent">
        <!-- Generated by JavaScript -->
      </div>
    </div>

    <!-- Disclaimer -->
    <div class="disclaimer">
      <strong>‚öï Disclaimer v2.13 UMILT√Ä EPISTEMICA</strong> ‚Äî Supporto didattico-decisionale per CUP con <strong>rigore epistemico e onest√† scientifica</strong>.<br><br>
      
      <strong>‚≠ê v2.13 UMILT√Ä EPISTEMICA (NotebookLM "Avvocato del Diavolo"):</strong><br>
      ‚Ä¢ <strong>PRINCIPIO FONDAMENTALE:</strong> Questo tool fornisce <strong>PROBABILIT√Ä BAYESIANE</strong>, NON verit√† ontologiche<br>
      ‚Ä¢ <strong>Il vetrino EE resta gold standard epistemico</strong> ‚Äî Se discordanza morfologia-IHC: morfologia ha priorit√†<br>
      ‚Ä¢ <strong>Marker "High Confidence" ‚â† certezza assoluta:</strong> Eccezioni documentate (Arg-1+ mammella 12%, INSM1+ prostata 36%, TRPS1+ ovaio 40%)<br>
      ‚Ä¢ <strong>Plasticit√† fenotipica tumori alto grado:</strong> Dedifferenziazione ‚Üí loss marker lineage; gain marker aberranti atteso<br>
      ‚Ä¢ <strong>Caveat database:</strong> Arginasi mapping metabolico (non solo lineage), INSM1 marca plasticit√† (non solo NE), NKX3 loss post-ADT, TRPS1 workflow peritoneale mandatorio<br>
      ‚Ä¢ <strong>"L'onest√† dell'incompletezza √® l'unico rigore che ci resta"</strong> ‚Äî NotebookLM 2026<br><br>
      
      <strong>v2.12 PREDICT IMMUNOPROFILE + FBF SACCO:</strong> Database 12 diagnosi, badge ‚úÖ FBF vs ‚ö†Ô∏è esterno, tool bidirezionale (IHC‚Üídiagnosi E diagnosi‚ÜíIHC atteso).<br>
      <strong>v2.16 BAYES VOLLMER:</strong> Formula bayesiana P(Dx|IHC) = [P(IHC|Dx)√óP(Dx)] / Œ£[...], prior mortalit√† CUP (Vollmer 2009 AJCP).<br>
      <strong>v2.15 PROBABILITY:</strong> Calcolo probabilit√† diagnostica con ranking Bayes, top 5 output.<br>
      <strong>v2.14 DATABASE:</strong> 18 diagnosi PREDICT (HCC, Pancreas, Ovaio, Uroteliale, NET GI, Tiroide), 64 marker.<br>
      <strong>v2.13 EPISTEMICO:</strong> Umilt√† epistemica (NotebookLM 2026), 3 alert, 5 fix database (Arg-1, INSM1, NKX3, TRPS1, H3K27).<br>
      <strong>v2.11 QC + BIG FOUR:</strong> 8 alert QC tecnici, 7 alert Big Four futility, tissue-sparing validated.<br>
      <strong>v2.10 WORKFLOW:</strong> Morfologia STEP 1 (prima IHC), Sede-specific 7 alert, Pannelli lean.<br>
      <strong>Validazione scientifica: Vollmer RT (2009) Am J Clin Pathol 131:723-730, ImmunoGenius (2021) Diag Pathol, Kaufman O (2002) Pathologe.</strong><br><br>
      
      <strong>Se morfologia e IHC sono incompatibili, scrivere:</strong><br>
      <em>"Il profilo IHC suggerisce [X], ma morfologia incompatibile. Si raccomanda correlazione clinica/molecolare."</em>
    </div>

    <footer>
      <p>&copy; 2026 ASST Fatebenefratelli-Sacco | IHC Cascade v2.22 BAYES VOLLMER | 
      Uso interno e didattico</p>
      <p style="margin-top: 8px; font-size: 0.75rem;">
        "Il vetrino non mente, il reagente s√¨ - L'onest√† dell'incompletezza √® rigore scientifico"<br>
        <em style="color: #94a3b8;">Bayes theorem per IHC: Vollmer 2009, replicato con validazione epidemiologica 2026</em>
      </p>
    </footer>
  </div>

  <script>
    // ============================================
    // PART 1: DATA STRUCTURES & STATE v2.3
    // ============================================
    // ============================================
    // MARKER DEFINITIONS v2.3
    // ============================================
    
    const markers = [
      // First-line orientation
      { id: 'CKAE1', name: 'CK AE1/AE3', cat: 'firstline' },
      { id: 'CD45', name: 'CD45', cat: 'firstline' },
      { id: 'Vim', name: 'Vimentina', cat: 'firstline' },
      { id: 'S100', name: 'S100', cat: 'firstline' },
      
      // Big Four
      { id: 'CK7', name: 'CK7', cat: 'bigfour' },
      { id: 'CK20', name: 'CK20', cat: 'bigfour' },
      { id: 'TTF1', name: 'TTF-1', cat: 'bigfour' },
      { id: 'CDX2', name: 'CDX2', cat: 'bigfour' },
      
      // Carcinoma general
      { id: 'PAX8', name: 'PAX8', cat: 'carcinoma' },
      { id: 'Napsina', name: 'Napsin-A', cat: 'carcinoma' },
      { id: 'ER', name: 'ER', cat: 'carcinoma' },
      { id: 'GATA3', name: 'GATA3', cat: 'carcinoma' },
      { id: 'Mammoglobin', name: 'Mammoglobin', cat: 'carcinoma' },
      { id: 'PSA', name: 'PSA', cat: 'carcinoma' },
      { id: 'PSAP', name: 'PSAP', cat: 'carcinoma' },
      { id: 'NKX3', name: 'NKX3', cat: 'carcinoma' },
      { id: 'ERG', name: 'ERG', cat: 'carcinoma' },
      { id: 'Arginasi', name: 'Arginase-1', cat: 'carcinoma' },
      { id: 'HSA', name: 'Hep-Par-1', cat: 'carcinoma' },
      { id: 'WT1', name: 'WT1', cat: 'carcinoma' },
      { id: 'Calretinin', name: 'Calretinin', cat: 'carcinoma' },
      { id: 'RCC', name: 'RCC', cat: 'carcinoma' },
      { id: 'CA125', name: 'CA-125', cat: 'carcinoma' },
      { id: 'CK5', name: 'CK5/6', cat: 'carcinoma' },
      { id: 'p40', name: 'p40', cat: 'carcinoma' },
      { id: 'p63', name: 'p63', cat: 'carcinoma' },
      { id: 'TRPS1', name: 'TRPS1', cat: 'carcinoma' },
      { id: 'CK17', name: 'CK17', cat: 'carcinoma' },
      { id: 'BCL10', name: 'BCL10', cat: 'carcinoma' },
      { id: 'BetaCatenin', name: 'Œ≤-catenina', cat: 'carcinoma' },
      { id: 'NUT', name: 'NUT', cat: 'carcinoma' },
      { id: 'Glypican3', name: 'Glypican-3', cat: 'carcinoma', sacco: true },
      { id: 'CA199', name: 'CA 19-9', cat: 'carcinoma', sacco: true },
      { id: 'Thyroglobulin', name: 'Thyroglobulin', cat: 'carcinoma', sacco: true },
      { id: 'HBME1', name: 'HBME-1', cat: 'carcinoma' },
      { id: 'Calcitonin', name: 'Calcitonin', cat: 'neuroendocrine', sacco: true },
      
      // ‚≠ê SACCO MARKERS SYNC v2.22 (41 anticorpi da CSV)
      // CD markers SACCO
      { id: 'CD10', name: 'CD-10', cat: 'lymphoma', sacco: true },
      { id: 'CD11', name: 'CD-11', cat: 'lymphoma', sacco: true },
      { id: 'CD14', name: 'CD-14', cat: 'lymphoma', sacco: true },
      { id: 'CD43', name: 'CD-43', cat: 'lymphoma', sacco: true },
      { id: 'CD138', name: 'CD-138', cat: 'lymphoma', sacco: true },
      { id: 'CD146', name: 'CD-146', cat: 'lymphoma', sacco: true },
      // ALK markers SACCO
      { id: 'ALK1', name: 'ALK-1', cat: 'carcinoma', sacco: true },
      { id: 'ALKD5F3', name: 'ALK D5F3', cat: 'lymphoma', sacco: true },
      // Amiloidi SACCO
      { id: 'AMILOIDEL', name: 'Amiloide Œõ', cat: 'carcinoma', sacco: true },
      { id: 'AMILOIDEP', name: 'Amiloide P', cat: 'carcinoma', sacco: true },
      // Annexin & ARID SACCO
      { id: 'ANNEXINA1', name: 'Annexin A1', cat: 'carcinoma', sacco: true },
      { id: 'ARID1A', name: 'ARID1A', cat: 'carcinoma', sacco: true },
      // Virus markers SACCO
      { id: 'CMV', name: 'CMV', cat: 'carcinoma', sacco: true },
      { id: 'EBVEBER', name: 'EBV/EBER', cat: 'lymphoma', sacco: true },
      { id: 'HSV1', name: 'HSV 1', cat: 'carcinoma', sacco: true },
      { id: 'HSV2', name: 'HSV 2', cat: 'carcinoma', sacco: true },
      { id: 'PARVOB19', name: 'Parvovirus B19', cat: 'carcinoma', sacco: true },
      { id: 'SV40', name: 'SV40', cat: 'carcinoma', sacco: true },
      // Collagene & HPV SACCO
      { id: 'COLIV', name: 'Collagene IV', cat: 'carcinoma', sacco: true },
      { id: 'HPV', name: 'HPV', cat: 'carcinoma', sacco: true },
      // Immunoglobuline SACCO
      { id: 'IGD', name: 'IgD', cat: 'lymphoma', sacco: true },
      { id: 'IGG', name: 'IgG', cat: 'lymphoma', sacco: true },
      // MUC & Hormones SACCO
      { id: 'MUC1', name: 'MUC-1', cat: 'carcinoma', sacco: true },
      { id: 'MUC2', name: 'MUC-2', cat: 'carcinoma', sacco: true },
      { id: 'MUC4', name: 'MUC-4', cat: 'carcinoma', sacco: true },
      { id: 'MUC6', name: 'MUC-6', cat: 'carcinoma', sacco: true },
      { id: 'INIBINA1', name: 'Inibina-1', cat: 'carcinoma', sacco: true },
      { id: 'GASTRINA', name: 'Gastrina', cat: 'carcinoma', sacco: true },
      { id: 'PTH', name: 'PTH', cat: 'carcinoma', sacco: true },
      { id: 'HPL', name: 'HPL', cat: 'carcinoma', sacco: true },
      // Transcription factors SACCO
      { id: 'OCT2', name: 'OCT-2', cat: 'lymphoma', sacco: true },
      { id: 'SOX2', name: 'Sox-2', cat: 'carcinoma', sacco: true },
      { id: 'SF1', name: 'SF1', cat: 'carcinoma', sacco: true },
      // Others SACCO
      { id: 'PERFORMA', name: 'Performa', cat: 'carcinoma', sacco: true },
      { id: 'TIA1', name: 'Tia-1', cat: 'lymphoma', sacco: true },
      
      // Neuroendocrine
      { id: 'Synapt', name: 'Synaptophysin', cat: 'neuroendocrine' },
      { id: 'Cromo', name: 'Chromogranin', cat: 'neuroendocrine' },
      { id: 'CD56', name: 'CD56', cat: 'neuroendocrine', sacco: true },
      { id: 'CD57', name: 'CD57', cat: 'neuroendocrine', sacco: true },
      { id: 'INSM1', name: 'INSM1', cat: 'neuroendocrine' },
      
      // Melanocytic
      { id: 'SOX10', name: 'SOX10', cat: 'melanocytic' },
      { id: 'MelanA', name: 'Melan-A', cat: 'melanocytic' },
      { id: 'HMB45', name: 'HMB-45', cat: 'melanocytic' },
      { id: 'PRAME', name: 'PRAME', cat: 'melanocytic' },
      
      // GCT
      { id: 'OCT34', name: 'OCT3/4', cat: 'gct', sacco: true },
      { id: 'SALL4', name: 'SALL4', cat: 'gct' },
      { id: 'AFP', name: 'AFP', cat: 'gct' },
      { id: 'HCG', name: 'Œ≤-HCG', cat: 'gct' },
      { id: 'PLAP', name: 'PLAP', cat: 'gct' },
      { id: 'CD30', name: 'CD30', cat: 'gct' },
      { id: 'GPC3', name: 'Glypican-3', cat: 'gct' },
      
      // Lymphoma
      { id: 'CD20', name: 'CD20', cat: 'lymphoma' },
      { id: 'CD3', name: 'CD3', cat: 'lymphoma' },
      { id: 'CD15', name: 'CD15', cat: 'lymphoma' },
      { id: 'CD79a', name: 'CD79a', cat: 'lymphoma' },
      { id: 'PAX5', name: 'PAX5', cat: 'lymphoma' },
      { id: 'ALK', name: 'ALK', cat: 'lymphoma', sacco: true },
      
      // Sarcoma
      { id: 'Desmin', name: 'Desmin', cat: 'sarcoma' },
      { id: 'SMA', name: 'SMA', cat: 'sarcoma' },
      { id: 'MyoD1', name: 'MyoD1', cat: 'sarcoma', sacco: true },
      { id: 'Myogenin', name: 'Myogenin', cat: 'sarcoma' },
      { id: 'STAT6', name: 'STAT6', cat: 'sarcoma' },
      { id: 'DOG1', name: 'DOG1', cat: 'sarcoma' },
      { id: 'H3K27me3', name: 'H3K27me3', cat: 'sarcoma' },
      { id: 'Calponin', name: 'Calponina', cat: 'sarcoma' },
      { id: 'INI1', name: 'INI1/SMARCB1', cat: 'sarcoma' },
      { id: 'SMARCA4', name: 'SMARCA4', cat: 'sarcoma' },
      
      // MMR
      { id: 'MLH1', name: 'MLH1', cat: 'mmr' },
      { id: 'MSH2', name: 'MSH2', cat: 'mmr' },
      { id: 'MSH6', name: 'MSH6', cat: 'mmr' },
      { id: 'PMS2', name: 'PMS2', cat: 'mmr' },
    ];

    // ============================================
    // ‚≠ê NEW v2.12: IMMUNOPROFILE DATABASE
    // ============================================
    
    const immunoprofileDB = [
      {
        name: 'Sarcoma Sinoviale',
        keywords: ['sinoviale', 'synovial', 'sinovial'],
        positive: [
          { marker: 'TLE1', pct: '90-95%', note: '‚≠ê Pi√π sensibile/specifico', pattern: 'Nucleare diffuso' },
          { marker: 'CK (AE1/AE3, CAM5.2)', pct: '85-95%', note: 'Focale tipico', pattern: 'Focale citoplasmatico' },
          { marker: 'EMA', pct: '70-90%', pattern: 'Membranoso/citoplasmatico' },
          { marker: 'BCL2', pct: '95-100%', pattern: 'Citoplasmatico diffuso' },
          { marker: 'CD99', pct: '60-70%', pattern: 'Membranoso' }
        ],
        negative: [
          { marker: 'SOX10', pct: '0-5%', note: 'Esclude MPNST' },
          { marker: 'S100', pct: '0-10%', note: 'Focale se positivo' },
          { marker: 'Desmin', pct: 'Negativo', note: 'Esclude rabdo' },
          { marker: 'CD34', pct: 'Negativo tipico' },
          { marker: 'SMA', pct: 'Negativo tipico' }
        ],
        molecular: [
          'SS18-SSX fusion: 95%+ (diagnostico)',
          't(X;18)(p11;q11)',
          'SS18-SSX1 (bifasico 60%), SS18-SSX2 (monofasico)'
        ],
        morphology: [
          'Bifasico (30%): epiteliale + fusato',
          'Monofasico (70%): solo fusato',
          'Pattern emangiopericytoma-like',
          'Calcificazioni (30%)',
          'Nuclei ovali, cromatina fine'
        ],
        ddx: [
          'Se TLE1‚àí: MPNST (SOX10+, H3K27me3 loss)',
          'Se CK‚àí: Sarcoma monofasico vs MPNST',
          'Se S100+ diffuso: MPNST vs Schwannoma',
          'Fibrosarcoma (TLE1‚àí, CK‚àí)'
        ],
        refs: ['Fisher 2017', 'Joyama 2006']
      },
      {
        name: 'Melanoma',
        keywords: ['melanoma', 'melano'],
        positive: [
          { marker: 'SOX10', pct: '95-100%', note: '‚≠ê Pi√π sensibile', pattern: 'Nucleare' },
          { marker: 'S100', pct: '95-98%', note: 'Molto sensibile', pattern: 'Nucleare + citoplasmatico' },
          { marker: 'Melan-A (MART-1)', pct: '75-92%', pattern: 'Citoplasmatico' },
          { marker: 'HMB45', pct: '69-93%', note: 'Meno sensibile metastasi', pattern: 'Citoplasmatico' },
          { marker: 'PRAME', pct: '90-95%', note: '‚≠ê Nuovo, molto specifico', pattern: 'Nucleare diffuso' }
        ],
        negative: [
          { marker: 'CK (AE1/AE3)', pct: 'Negativo tipico', note: 'MA: 5% melanomi CK+ aberrante!' },
          { marker: 'CD45', pct: 'Negativo' },
          { marker: 'EMA', pct: 'Negativo tipico' }
        ],
        molecular: [
          'BRAF V600E: 40-50% (target therapy)',
          'NRAS: 15-20%',
          'NF1: 10-15%',
          'KIT: 2-8% (acrale, mucoso)',
          'PDL1 expression: variabile (immunoterapia)'
        ],
        morphology: [
          'Epitelioide: cellule grandi, citoplasma abbondante',
          'Fusato: nuclei fusati, fasci',
          'Desmoplastico: S100+ ma Melan-A‚àí/HMB45‚àí (pitfall!)',
          'Amelanotico: pigmento assente (5-10%)',
          'Nucleoli prominenti, mitosi'
        ],
        ddx: [
          'Melanoma desmoplastico: S100+, SOX10+, MA Melan-A‚àí/HMB45‚àí (‚ö†Ô∏è pitfall!)',
          'Melanoma amelanotico: pu√≤ essere S100‚àí (5%!), testare HMB45/Melan-A',
          'MPNST: SOX10+, S100+ focale, H3K27me3 loss (vs retained melanoma)',
          'Carcinoma: CK+, SOX10‚àí (MA 69% TNBC SOX10+! pitfall)',
          'Sarcoma: Vim+, tutti melanoma marker‚àí'
        ],
        refs: ['Elder 2018', 'Ohsie 2008']
      },
      {
        name: 'Carcinoma Renale Clear Cell (RCC)',
        keywords: ['renale', 'rcc', 'rene', 'clear cell', 'kidney'],
        positive: [
          { marker: 'PAX8', pct: '83-98%', note: '‚≠ê Pi√π sensibile', pattern: 'Nucleare' },
          { marker: 'CA-IX (Carbonic Anhydrase IX)', pct: '85-95%', note: 'Molto specifico', pattern: 'Membranoso' },
          { marker: 'CD10', pct: '85-95%', pattern: 'Membranoso apicale' },
          { marker: 'RCC', pct: '80-90%', pattern: 'Citoplasmatico' },
          { marker: 'Vimentin', pct: '95-100%', pattern: 'Citoplasmatico' }
        ],
        negative: [
          { marker: 'CK7', pct: 'Negativo tipico', note: 'MA: 10-20% papillare type 2 CK7+!' },
          { marker: 'CK20', pct: 'Negativo' },
          { marker: 'TTF1', pct: 'Negativo' },
          { marker: 'CDX2', pct: 'Negativo' }
        ],
        molecular: [
          'VHL loss/mutation: 75-80%',
          '3p deletion (diagnostico)',
          'PBRM1, SETD2, BAP1 mutations',
          'PD-L1 expression: immunoterapia target'
        ],
        morphology: [
          'Clear cell pattern (citoplasma chiaro ricco glicogeno/lipidi)',
          'Vascolarizzazione ricca (arcuate vessels)',
          'Pattern solido, tubulare, cystic',
          'Nuclei con cromatina fine, nucleoli prominenti'
        ],
        ddx: [
          'HCC: Arginasi+/HSA+, PAX8‚àí ‚ö†Ô∏è CAVEAT: Arg-1+ pu√≤ essere upregulation metabolica in metastasi epatiche (12% mammella)! Non solo lineage. Serve morfologia + pannello origine.',
          'Adrenocortical CA: Melan-A+/Inhibin+, PAX8‚àí',
          'Clear cell papillary RCC: CK7+/CA-IX+, indolente',
          'Metastasi: sede + clinica essenziali'
        ],
        refs: ['Moch 2016 WHO', 'Srigley 2013']
      },
      {
        name: 'GIST (Gastrointestinal Stromal Tumor)',
        keywords: ['gist', 'stromale', 'gastrointestinal'],
        positive: [
          { marker: 'CD117 (c-KIT)', pct: '95%', note: '‚≠ê Gold standard', pattern: 'Citoplasmatico diffuso' },
          { marker: 'DOG1 (Discovered on GIST-1)', pct: '97-98%', note: '‚≠ê Pi√π sensibile CD117!', pattern: 'Citoplasmatico/membranoso' },
          { marker: 'CD34', pct: '60-70%', pattern: 'Membranoso' },
          { marker: 'Vimentin', pct: '95-100%' }
        ],
        negative: [
          { marker: 'Desmin', pct: '1-2%', note: 'Se Desmin+ ‚Üí leiomiosarcoma favorito' },
          { marker: 'S100', pct: '5%', note: 'Se S100+ ‚Üí Schwannoma GI favorito' },
          { marker: 'SOX10', pct: 'Negativo tipico' },
          { marker: 'SMA', pct: '30-40%', note: 'Focale possibile, ma Desmin‚àí discrimina' }
        ],
        molecular: [
          'KIT (exon 11 most common): 75-80% (target imatinib)',
          'PDGFRA: 5-10% (some imatinib-resistant)',
          'Wild-type (SDH-deficient): 10-15% giovani',
          'Mutational testing MANDATORIO per therapy'
        ],
        morphology: [
          'Fusato (spindle cell) 70%',
          'Epitelioide 20%',
          'Misto 10%',
          'Sede: stomaco 60%, small bowel 30%, colon/retto/esofago 10%'
        ],
        ddx: [
          'Leiomiosarcoma: Desmin+/SMA+, CD117‚àí/DOG1‚àí',
          'Schwannoma GI: S100+/SOX10+, CD117‚àí/DOG1‚àí',
          'Fibromatosis: Œ≤-catenin nucleare+, CD117‚àí/DOG1‚àí',
          'Leiomioma: Desmin+, CD117‚àí/DOG1‚àí'
        ],
        refs: ['Miettinen 2014', 'Rubin 2007']
      },
      {
        name: 'Linfoma Diffuso Large B-Cell (DLBCL)',
        keywords: ['linfoma', 'dlbcl', 'large b cell', 'b-cell', 'bcell'],
        positive: [
          { marker: 'CD20', pct: '95-100%', note: '‚≠ê B-cell lineage', pattern: 'Membranoso' },
          { marker: 'CD79a', pct: '90-95%', pattern: 'Citoplasmatico/membranoso' },
          { marker: 'PAX5', pct: '95-100%', note: 'B-cell nuclear marker', pattern: 'Nucleare' },
          { marker: 'CD45', pct: '95-100%', note: 'Leucocyte common antigen', pattern: 'Membranoso' },
          { marker: 'BCL6', pct: '50-70%', note: 'GCB subtype marker', pattern: 'Nucleare' }
        ],
        negative: [
          { marker: 'CD3', pct: 'Negativo', note: 'T-cell marker' },
          { marker: 'CD10', pct: '30-50%', note: 'Se CD10+ ‚Üí GCB subtype' },
          { marker: 'Cytokeratin', pct: 'Negativo' },
          { marker: 'S100', pct: 'Negativo' }
        ],
        molecular: [
          'MYC rearrangement: 5-15% (poor prognosis)',
          'BCL2 rearrangement: 20-30%',
          'BCL6 rearrangement: 30-40%',
          'Double-hit (MYC+BCL2/BCL6): HGBL, aggressive',
          'GCB vs ABC subtype (IHC algorithm): prognosis/therapy'
        ],
        morphology: [
          'Cellule grandi (>2x linfocita normale)',
          'Pattern diffuso (architettura linfonodale distrutta)',
          'Nuclei vescicolosi, nucleoli prominenti',
          'Mitosi frequenti, apoptosi',
          'Necrosi geografica possibile'
        ],
        ddx: [
          'Carcinoma scarsamente differenziato: CK+/CD45‚àí',
          'Melanoma: SOX10+/S100+, CD45‚àí',
          'Linfoma T: CD3+/CD20‚àí',
          'Burkitt: CD10+/BCL2‚àí, Ki67~100%, MYC+'
        ],
        refs: ['Swerdlow 2017 WHO', 'Hans 2004 algorithm']
      },
      {
        name: 'Carcinoma Mammario',
        keywords: ['mammella', 'breast', 'mammario'],
        positive: [
          { marker: 'GATA3', pct: '90-95%', note: '‚≠ê Pi√π specifico', pattern: 'Nucleare' },
          { marker: 'TRPS1', pct: '98.7%', note: '‚≠ê Pi√π sensibile (TNBC 98% vs GATA3 67%!)', pattern: 'Nucleare' },
          { marker: 'ER (Estrogen Receptor)', pct: '70-80%', note: 'Terapeutico', pattern: 'Nucleare' },
          { marker: 'Mammoglobin', pct: '70-80%', note: 'Alta specificit√†', pattern: 'Citoplasmatico' },
          { marker: 'GCDFP-15', pct: '50-60%', pattern: 'Citoplasmatico' }
        ],
        negative: [
          { marker: 'TTF1', pct: 'Negativo tipico' },
          { marker: 'CDX2', pct: 'Negativo' },
          { marker: 'PAX8', pct: 'Negativo' },
          { marker: 'Calretinin', pct: 'Negativo' }
        ],
        molecular: [
          'ER+/HER2‚àí: Luminal A (Ki67 <20%) or B (Ki67 >20%)',
          'ER+/HER2+: Luminal B HER2+',
          'ER‚àí/HER2+: HER2-enriched (trastuzumab target)',
          'ER‚àí/PR‚àí/HER2‚àí: Triple Negative (TNBC) - chemio',
          'BRCA1/2 germline: TNBC association, PARP inhibitors'
        ],
        morphology: [
          'Duttale NST (No Special Type): 70-80%',
          'Lobulare: discoesivo, "Indian-file", E-cadherin loss',
          'Tubulare, mucinoso, papillare: special types',
          'TNBC: alto grado, pushing borders, TILs',
          'Lobulare: TRPS1+ 98%, pattern signet-ring possibile'
        ],
        ddx: [
          'CUP PERITONEALE CRITICO: TRPS1+ isolato AMBIGUO! Ovaio HGSC 40.5% TRPS1+! ‚ö†Ô∏è WORKFLOW MANDATORIO: (1) TRPS1+ ‚Üí NON concludere! (2) Testare PAX8/WT1 SEMPRE. (3) PAX8+/WT1+ ‚Üí Ovaio (anche se TRPS1+!). (4) PAX8‚àí/WT1‚àí ‚Üí Mammella probabile. TRPS1 non sostituisce workup completo peritoneale! Conseguenze terapeutiche disastrose se confuso.',
          'Polmone: TTF1+/Napsina+, GATA3‚àí',
          'GI: CDX2+/SATB2+, GATA3‚àí',
          'Mesotelioma: Calretinin+, GATA3‚àí'
        ],
        refs: ['Allison 2016', 'NotebookLM 2026 TRPS1']
      },
      {
        name: 'MPNST (Malignant Peripheral Nerve Sheath Tumor)',
        keywords: ['mpnst', 'nerve sheath', 'neurofibroma', 'schwann'],
        positive: [
          { marker: 'S100', pct: '50-70%', note: 'Focale tipico (vs Schwannoma diffuso)', pattern: 'Nucleare + citoplasmatico focale' },
          { marker: 'SOX10', pct: '50-60%', note: 'Focale (vs Schwannoma/melanoma diffuso)', pattern: 'Nucleare focale' },
          { marker: 'H3K27me3 LOSS', pct: '80-85%', note: '‚≠ê Diagnostico! Distingue da Schwannoma', pattern: 'Loss nucleare (controllo interno!)' }
        ],
        negative: [
          { marker: 'Melan-A', pct: 'Negativo', note: 'Discrimina da melanoma' },
          { marker: 'HMB45', pct: 'Negativo', note: 'Discrimina da melanoma' },
          { marker: 'Desmin', pct: 'Negativo', note: 'Discrimina da rabdo' },
          { marker: 'Cytokeratin', pct: '10%', note: 'Epithelioid MPNST pu√≤ essere CK+ focale!' }
        ],
        molecular: [
          'H3K27me3 loss (PRC2 complex): 80-85% (SUZ12, EED loss)',
          'NF1 germline: 50% MPNST arise in NF1 patients',
          'CDKN2A deletion (p16 loss)',
          'TP53 mutation'
        ],
        morphology: [
          'Fascicolare ("herringbone" pattern)',
          'Cellule fusate, nuclei wavy/buckled',
          'Necrosi geografica (vs Schwannoma rara)',
          'Perivascular accentuation',
          'Epithelioid MPNST: cellule grandi, can mimic melanoma!'
        ],
        ddx: [
          'Schwannoma: S100+/SOX10+ diffuso (100%), H3K27me3 RETAINED ‚úÖ',
          'Melanoma: Melan-A+/HMB45+, H3K27me3 retained',
          'Sarcoma sinoviale: TLE1+/CK+, S100‚àí/SOX10‚àí',
          'Fibrosarcoma: S100‚àí/SOX10‚àí, H3K27me3 retained'
        ],
        refs: ['Rodriguez 2000', 'Prieto-Granada 2016 H3K27me3']
      },
      {
        name: 'Carcinoma Prostatico',
        keywords: ['prostata', 'prostate', 'prostatico'],
        positive: [
          { marker: 'PSA', pct: '95-100%', note: '‚≠ê Gold standard', pattern: 'Citoplasmatico granulare' },
          { marker: 'NKX3.1', pct: '95-98%', note: '‚ö†Ô∏è Post-ADT: Loss 20-30%! NON "resistente"', pattern: 'Nucleare' },
          { marker: 'PSAP (Prostatic Acid Phosphatase)', pct: '90-95%', pattern: 'Citoplasmatico' },
          { marker: 'ERG', pct: '40-50%', note: '‚≠ê UNICO marker STABILE post-ADT! Fusion molecolare retained', pattern: 'Nucleare' },
          { marker: 'P501S (Prostein)', pct: '95%', pattern: 'Citoplasmatico' }
        ],
        negative: [
          { marker: 'CK20', pct: 'Negativo' },
          { marker: 'CDX2', pct: 'Negativo' },
          { marker: 'TTF1', pct: 'Negativo' },
          { marker: 'PAX8', pct: 'Negativo' }
        ],
        molecular: [
          'TMPRSS2-ERG fusion: 40-50% (ERG IHC surrogate)',
          'PTEN loss: 40-50% (poor prognosis)',
          'TP53 mutation: advanced disease',
          'DNA mismatch repair deficiency: 3-5% (Lynch, immunotherapy)'
        ],
        morphology: [
          'Gleason pattern: cribriform, fused, single cells',
          'Amphophilic cytoplasm, nucleoli prominenti',
          'ABSENCE ghiandole benigne (vs BPH)',
          'Pattern small acini (Gleason 3)',
          'Pattern solid/necrotic (Gleason 5)'
        ],
        ddx: [
          'Post-ADT CRITICO: PSA loss 30-50%, NKX3.1 loss 20-30%, PSAP loss 40-50%. ‚≠ê ERG √® UNICO marker stabile (fusion ancora+)! Pattern PSA‚àí/NKX3‚àí NON esclude prostata se morfologia compatibile + ERG+',
          'NE differentiation: Synaptophysin+/INSM1+, PSA¬± focale (plasticit√† fenotipica, non NEC vero se morfologia non small cell)',
          'Uroteliale: GATA3+/CK20+, PSA‚àí',
          'Colorettale: CDX2+/SATB2+, PSA‚àí'
        ],
        refs: ['Epstein 2016 WHO', 'Khani 2014 post-ADT']
      },
      {
        name: 'Adenocarcinoma Polmonare',
        keywords: ['polmone', 'lung', 'polmonare', 'adenocarcinoma'],
        positive: [
          { marker: 'TTF1 (Thyroid Transcription Factor-1)', pct: '75-85%', note: '‚≠ê Pi√π specifico', pattern: 'Nucleare' },
          { marker: 'Napsin A', pct: '80-85%', note: '‚≠ê Specifico polmone', pattern: 'Citoplasmatico granulare' },
          { marker: 'CK7', pct: '95-100%', pattern: 'Citoplasmatico' },
          { marker: 'CK20', pct: 'Negativo tipico (discrimina GI)', pattern: '-' }
        ],
        negative: [
          { marker: 'CDX2', pct: 'Negativo', note: 'Discrimina GI' },
          { marker: 'SATB2', pct: 'Negativo', note: 'Discrimina colorettale' },
          { marker: 'PAX8', pct: 'Negativo', note: 'Discrimina RCC/tiroide/ovaio' },
          { marker: 'GATA3', pct: 'Negativo', note: 'Discrimina uroteliale/mammella' }
        ],
        molecular: [
          'EGFR mutation: 15% Caucasian, 50% Asian (tyrosine kinase inhibitors)',
          'ALK rearrangement: 3-5% (crizotinib target)',
          'ROS1 rearrangement: 1-2% (crizotinib)',
          'KRAS mutation: 25-30% (no target therapy)',
          'PD-L1 expression: immunotherapy (pembrolizumab)'
        ],
        morphology: [
          'Pattern lepidico: crescita alveolare (95% polmone!)',
          'Pattern acinar: ghiandole',
          'Pattern solido: lamine solide',
          'Pattern papillare',
          'Pattern micropapillare: poor prognosis'
        ],
        ddx: [
          'TTF1+ mimickers: Tiroide (Tireoglobulina+), NEC extrapolmonare',
          'Mammella: GATA3+/ER+, TTF1‚àí',
          'GI: CDX2+/SATB2+, TTF1‚àí/Napsina‚àí',
          'Mesotelioma: Calretinin+, TTF1‚àí/Napsina‚àí'
        ],
        refs: ['Travis 2015 WHO', 'Rekhtman 2018']
      },
      {
        name: 'Carcinoma Colorettale',
        keywords: ['colon', 'colorettale', 'colorectal', 'intestino', 'retto'],
        positive: [
          { marker: 'CDX2', pct: '90-95%', note: 'GI marker', pattern: 'Nucleare' },
          { marker: 'SATB2', pct: '90-95%', note: '‚≠ê Pi√π specifico colon (99% spec!)', pattern: 'Nucleare' },
          { marker: 'CK20', pct: '75-95%', pattern: 'Citoplasmatico' },
          { marker: 'Villin', pct: '90-95%', pattern: 'Brush border' }
        ],
        negative: [
          { marker: 'CK7', pct: 'Negativo tipico', note: 'MA: 10-15% CK7+ (MSI-H midollare pu√≤ essere CK7+!)' },
          { marker: 'TTF1', pct: 'Negativo' },
          { marker: 'PAX8', pct: 'Negativo' },
          { marker: 'GATA3', pct: 'Negativo' }
        ],
        molecular: [
          'Microsatellite Instability (MSI-H): 15% (Lynch or sporadic)',
          'KRAS mutation: 40-50%',
          'BRAF V600E: 10% (poor prognosis)',
          'MMR deficiency (MLH1/MSH2/MSH6/PMS2): MSI-H, immunotherapy',
          'NRAS, PIK3CA mutations'
        ],
        morphology: [
          'Glandular/cribriform pattern',
          'Dirty necrosis (intraluminal debris)',
          'Midollare MSI-H: solido, TILs prominenti, CK20‚àí/CDX2‚àí possibile!',
          'Mucinoso: >50% mucina extracelllare',
          'Signet-ring: poor prognosis'
        ],
        ddx: [
          'MSI-H midollare: CK20‚àí/CDX2‚àí (loss!), SATB2+ mantiene (‚≠ê salvataggio!)',
          'Gastrico: CK7+/CK20+, CDX2+ possibile (DDx difficile)',
          'Pancreas: CK7+/CK20+, CDX2+ possibile',
          'Appendice mucinoso: pattern simile, sede discrimina'
        ],
        refs: ['Dragomir 2014 SATB2', 'WHO 2019']
      },
      {
        name: 'Rabdomiosarcoma',
        keywords: ['rabdomiosarcoma', 'rabdo', 'rms'],
        positive: [
          { marker: 'Desmin', pct: '95-100%', note: 'Muscolo marker', pattern: 'Citoplasmatico diffuso' },
          { marker: 'MyoD1', pct: '90-95%', note: '‚≠ê Pi√π specifico muscolo scheletrico', pattern: 'Nucleare' },
          { marker: 'Myogenin', pct: '90-95%', note: '‚≠ê Pi√π specifico', pattern: 'Nucleare' },
          { marker: 'MSA (Muscle-Specific Actin)', pct: '85-90%', pattern: 'Citoplasmatico' }
        ],
        negative: [
          { marker: 'Cytokeratin', pct: 'Negativo tipico', note: 'MA: 10-20% focale CK+!' },
          { marker: 'S100', pct: 'Negativo' },
          { marker: 'SOX10', pct: 'Negativo' },
          { marker: 'CD45', pct: 'Negativo' }
        ],
        molecular: [
          'Alveolare: PAX3-FOXO1 t(2;13) 55% or PAX7-FOXO1 t(1;13) 22%',
          'Embrionale: complex karyotype, TP53 mutations',
          'Pleomorfo: adulti, RB1/TP53 loss',
          'Fusion-positive: worse prognosis than fusion-negative'
        ],
        morphology: [
          'Embrionale (60%): bambini, cellule piccole rotonde/ovali, rabdomioblasti',
          'Alveolare (20%): adolescenti/giovani adulti, pattern alveolare, PAX-FOXO1',
          'Pleomorfo (10%): adulti >40 anni, cellule giganti bizzarre',
          'Botrioide: sottomucosa (vescica, vagina)',
          'Rabdomioblasti: citoplasma eosinofilo, cross-striations'
        ],
        ddx: [
          'Leiomiosarcoma: Desmin+, MyoD1‚àí/Myogenin‚àí (DDx critico!)',
          'Sarcoma Ewing: CD99+, Desmin‚àí/MyoD1‚àí',
          'Neuroblastoma: Synaptophysin+/Chromogranin+, Desmin‚àí',
          'Linfoma: CD45+, Desmin‚àí'
        ],
        refs: ['Parham 2013', 'WHO 2020']
      },
      {
        name: 'Mesotelioma Epitelioide',
        keywords: ['mesotelioma', 'mesothelioma', 'pleura', 'peritoneo'],
        positive: [
          { marker: 'Calretinin', pct: '95-100%', note: '‚≠ê Pi√π sensibile', pattern: 'Nucleare + citoplasmatico' },
          { marker: 'WT1', pct: '75-90%', pattern: 'Nucleare' },
          { marker: 'D2-40 (Podoplanin)', pct: '80-90%', pattern: 'Membranoso' },
          { marker: 'Cytokeratin 5/6', pct: '95-100%', pattern: 'Citoplasmatico' }
        ],
        negative: [
          { marker: 'MOC-31', pct: 'Negativo', note: '‚≠ê Adenocarcinoma positivo (discrimina!)' },
          { marker: 'BerEP4', pct: 'Negativo', note: 'Adenocarcinoma positivo' },
          { marker: 'CEA', pct: 'Negativo', note: 'Adenocarcinoma positivo' },
          { marker: 'TTF1', pct: 'Negativo', note: 'Discrimina polmone' },
          { marker: 'PAX8', pct: 'Negativo', note: 'Discrimina ovaio/RCC' }
        ],
        molecular: [
          'BAP1 loss (FISH/IHC): 60-70% mesotelioma maligno (vs reattivo)',
          'CDKN2A (p16) homozygous deletion: 70-80%',
          'NF2 loss: 40-50%',
          'Mesothelin overexpression (target therapy trials)'
        ],
        morphology: [
          'Epitelioide (60%): tubulo-papillare, solido',
          'Sarcomatoide (15%): fusato, pattern sarcomatoso',
          'Bifasico (25%): componente epiteliale + sarcomatoide',
          'Pattern tubulopapillare con psammoma bodies',
          'Invasione stromale (vs reattivo superficiale)'
        ],
        ddx: [
          'Adenocarcinoma (polmone, mammella, GI): MOC31+/BerEP4+, Calretinin‚àí',
          'Ovaio sieroso: PAX8+/WT1+/ER+ (triade), Calretinin+ possibile (pitfall!)',
          'Mesoteliosi reattiva: BAP1 retained, no atypia, superficial',
          'Polmone: TTF1+/Napsina+, Calretinin‚àí'
        ],
        refs: ['Churg 2012', 'Husain 2013 guidelines']
      },
      {
        name: 'HCC (Epatocarcinoma)',
        keywords: ['hcc', 'epatocarcinoma', 'hepatocellular', 'fegato', 'liver'],
        positive: [
          { marker: 'Arginasi-1', pct: '80-90%', note: '‚≠ê Pi√π specifico HCC', pattern: 'Citoplasmatico diffuso' },
          { marker: 'Hep-Par-1 (HSA)', pct: '70-80%', pattern: 'Citoplasmatico granulare' },
          { marker: 'Glypican-3', pct: '75-85%', note: 'HCC maligno (negativo adenoma)', pattern: 'Citoplasmatico + membranoso' },
          { marker: 'CD10', pct: '70-80%', note: 'Pattern canalicolare diagnostico', pattern: 'Canalicolare (bile canaliculi)' },
          { marker: 'AFP', pct: '50-60%', pattern: 'Citoplasmatico' }
        ],
        negative: [
          { marker: 'CK7', pct: 'Negativo (95%)', note: '‚≠ê Discrimina colangiocarcinoma/metastasi' },
          { marker: 'CK20', pct: 'Negativo', note: 'Discrimina GI' },
          { marker: 'PAX8', pct: 'Negativo', note: 'Discrimina RCC' },
          { marker: 'MOC-31', pct: 'Negativo', note: 'Discrimina adenocarcinoma' }
        ],
        molecular: [
          'CTNNB1 (Œ≤-catenin) mutation: 20-40% (nucleare IHC)',
          'TP53 mutation: 30-50%',
          'TERT promoter mutation: 60%',
          'Viral: HBV (50%), HCV (25%) in background'
        ],
        morphology: [
          'Trabecolare (classico): trabecole >3 cellule',
          'Pseudoghiandolare (acinare): lumen centrale',
          'Solido/compatto',
          'Clear cell variant (glicogeno): DDx RCC!',
          'Bile canaliculi (CD10+ pattern canalicolare diagnostico)'
        ],
        ddx: [
          'RCC clear cell: PAX8+/CD10 diffuso (non canalicolare), Arginasi‚àí tipico MA 12% RCC Arg-1+ pitfall!',
          'Adenoma epatico: Glypican-3‚àí, Œ≤-catenin‚àí (vs HCC+)',
          'Colangiocarcinoma: CK7+/CK19+, Arginasi‚àí/HSA‚àí',
          'Mammella metastatica fegato: GATA3+/ER+, Arginasi+ 12% (upregulation metabolica! NON lineage)'
        ],
        refs: ['Kakar 2014', 'Lagana 2013', 'NotebookLM 2026 Arg-1 metabolic']
      },
      {
        name: 'Carcinoma Pancreatico',
        keywords: ['pancreas', 'pancreatico', 'pdac', 'acinare'],
        positive: [
          { marker: 'CK7', pct: '95-100%', note: '‚≠ê Ubiquitario', pattern: 'Citoplasmatico diffuso' },
          { marker: 'CA 19-9', pct: '80-90%', note: 'Duttale (PDAC)', pattern: 'Citoplasmatico' },
          { marker: 'BCL10', pct: '90-95%', note: '‚≠ê Acinare (specifico!)', pattern: 'Citoplasmatico granulare' },
          { marker: 'CK20', pct: '40-60%', note: 'Variabile PDAC', pattern: 'Citoplasmatico' },
          { marker: 'CDX2', pct: '50-70%', note: 'Intestinal differentiation', pattern: 'Nucleare' }
        ],
        negative: [
          { marker: 'TTF1', pct: 'Negativo', note: 'Discrimina polmone' },
          { marker: 'PAX8', pct: 'Negativo', note: 'Discrimina ovaio/RCC' },
          { marker: 'SATB2', pct: 'Negativo (<5%)', note: 'Discrimina colorettale' }
        ],
        molecular: [
          'KRAS mutation: 90-95% PDAC',
          'TP53 mutation: 50-75%',
          'SMAD4 (DPC4) loss: 55% (IHC loss correlato)',
          'CDKN2A loss: 95%',
          'BRCA1/2 mutation: 5-10% (PARP inhibitor target)'
        ],
        morphology: [
          'PDAC (duttale 85%): ghiandole infiltranti, desmoplasia',
          'Acinare (1%): acinare, BCL10+/trypsin+',
          'SPT (Solid-Pseudopapillary 2%): giovani F, Œ≤-catenin nucleare',
          'Neuroendocrino (2%): NET vs NEC',
          'Pattern perineural invasion (PDAC comune)'
        ],
        ddx: [
          'Acinare vs Duttale: BCL10+/trypsin+/lipase+ (acinare), CA19-9+ (duttale)',
          'SPT: Œ≤-catenin nucleare+, CD10+, giovane donna',
          'Colangiocarcinoma: CK7+/CK19+, localizzazione periilare',
          'Gastrico: sede, CDX2+ possibile overlap',
          'Ampollare: CK7+/CK20+/CDX2+, DDx difficile (sede!)'
        ],
        refs: ['Hruban 2019 WHO', 'Maker 2016']
      },
      {
        name: 'Carcinoma Ovarico Sieroso (HGSC)',
        keywords: ['ovaio', 'ovary', 'sieroso', 'serous', 'hgsc'],
        positive: [
          { marker: 'PAX8', pct: '90-95%', note: '‚≠ê M√ºller origin', pattern: 'Nucleare forte' },
          { marker: 'WT1', pct: '85-95%', note: '‚≠ê Sieroso (non endometrioide)', pattern: 'Nucleare' },
          { marker: 'p53', pct: '95-100%', note: '‚≠ê Aberrante (overexpression o null)', pattern: 'Nucleare aberrante' },
          { marker: 'ER', pct: '60-80%', pattern: 'Nucleare' },
          { marker: 'TRPS1', pct: '40-50%', note: '‚ö†Ô∏è PITFALL! Simula mammella', pattern: 'Nucleare' }
        ],
        negative: [
          { marker: 'CDX2', pct: 'Negativo', note: 'Discrimina GI' },
          { marker: 'SATB2', pct: 'Negativo', note: 'Discrimina colorettale' },
          { marker: 'TTF1', pct: 'Negativo', note: 'Discrimina polmone' },
          { marker: 'GATA3', pct: 'Negativo (95%)', note: 'Discrimina mammella (MA overlap 5%)' }
        ],
        molecular: [
          'TP53 mutation: >95% HGSC (IHC surrogate: overexpression o null)',
          'BRCA1/2 mutation: 20-25% (PARP inhibitor target)',
          'Homologous recombination deficiency (HRD): 50%',
          'Low-grade serous: KRAS/BRAF mutation (TP53 wild-type!)'
        ],
        morphology: [
          'HGSC: papillare complesso, slit-like spaces, psammoma',
          'High-grade nuclei (grado 3), mitosi frequenti',
          'Pattern SET (Solid, pseudo-Endometrioid, Transitional-like)',
          'Vs Low-grade serous: nuclei uniformi, mitosi rare, p53 wild-type',
          'Peritoneale: primario vs metastasi GI (IHC essenziale!)'
        ],
        ddx: [
          'CUP PERITONEALE CRITICO: TRPS1+ isolato AMBIGUO! Workflow: (1) TRPS1+ ‚Üí testare PAX8/WT1 SEMPRE (2) PAX8+/WT1+ ‚Üí Ovaio (anche se TRPS1+!) (3) PAX8‚àí/WT1‚àí/GATA3+ ‚Üí Mammella',
          'Mammella: TRPS1+/GATA3+/ER+, PAX8‚àí/WT1‚àí (triade negativa ovaio)',
          'Endometrioide ovaio: WT1‚àí, ER/PR+, p53 wild-type',
          'Mesotelioma: Calretinin+/WT1+ (overlap!), PAX8‚àí (discrimina)',
          'Colorettale: CDX2+/SATB2+, PAX8‚àí/WT1‚àí'
        ],
        refs: ['Kurman 2014 WHO', 'Kobel 2016 p53', 'NotebookLM 2026 TRPS1 peritoneal']
      },
      {
        name: 'Carcinoma Uroteliale',
        keywords: ['uroteliale', 'urothelial', 'vescica', 'bladder', 'ureter'],
        positive: [
          { marker: 'GATA3', pct: '70-85%', note: '‚≠ê Pi√π sensibile uroteliale', pattern: 'Nucleare' },
          { marker: 'CK7', pct: '95-100%', pattern: 'Citoplasmatico' },
          { marker: 'CK20', pct: '50-60%', note: '‚ö†Ô∏è Pattern CK7+/CK20+ possibile!', pattern: 'Citoplasmatico' },
          { marker: 'CK5/6', pct: '70-80%', pattern: 'Citoplasmatico' },
          { marker: 'p63', pct: '75-85%', pattern: 'Nucleare' }
        ],
        negative: [
          { marker: 'PSA', pct: 'Negativo', note: 'Discrimina prostata' },
          { marker: 'NKX3.1', pct: 'Negativo', note: 'Discrimina prostata' },
          { marker: 'CDX2', pct: 'Negativo', note: 'Discrimina colorettale' },
          { marker: 'TTF1', pct: 'Negativo', note: 'Discrimina polmone' }
        ],
        molecular: [
          'FGFR3 mutation/fusion: 15-20% (erdafitinib target)',
          'TP53 mutation: 50% invasivo',
          'RB1 loss: 30%',
          'TERT promoter mutation: 70-80%',
          'PD-L1 expression: 20-30% (immunotherapy)'
        ],
        morphology: [
          'Papillare (30%): papille fibrovascolare',
          'Infiltrante (70%): nidi, cordoni, singole cellule',
          'Variante plasmocitoide: signet-ring-like, E-cadherin loss',
          'Variante micropapillare: papille slender senza core',
          'Differenziazione squamosa (20%), ghiandolare (10%)'
        ],
        ddx: [
          'Prostata: PSA+/NKX3.1+/PSAP+, GATA3‚àí tipico (overlap 5%)',
          'Colorettale: Pattern CK7‚àí/CK20+ classico MA uroteliale CK7+/CK20+ 50-60%! ‚Üí SATB2/CDX2 discriminano',
          'Mammella: GATA3+ overlap! MA mammella TRPS1+/ER+, uroteliale TRPS1‚àí/ER‚àí',
          'Squamoso: CK5/6+/p63+ overlap, MA uroteliale CK7+ (squamoso CK7‚àí)',
          'Adenocarcinoma vescica: CK7+/CK20+/CDX2+, GATA3‚àí (vs uroteliale GATA3+)'
        ],
        refs: ['Moch 2016 WHO', 'Higgins 2011 GATA3']
      },
      {
        name: 'NET Gastrointestinale',
        keywords: ['net', 'neuroendocrino', 'carcinoide', 'gi', 'gastro'],
        positive: [
          { marker: 'Synaptophysin', pct: '90-95%', note: '‚≠ê Pi√π sensibile NE', pattern: 'Citoplasmatico granulare' },
          { marker: 'Chromogranin A', pct: '70-80%', note: 'Secretory granules', pattern: 'Citoplasmatico granulare' },
          { marker: 'INSM1', pct: '96-98%', note: '‚≠ê First-line NE marker', pattern: 'Nucleare' },
          { marker: 'CDX2', pct: '60-80%', note: '‚≠ê GI origin (discrimina polmone!)', pattern: 'Nucleare' },
          { marker: 'CD56', pct: '80-90%', pattern: 'Membranoso' }
        ],
        negative: [
          { marker: 'TTF1', pct: 'Negativo (95%)', note: '‚≠ê Discrimina NET polmonare (TTF1+ 85%)' },
          { marker: 'CDX2 negativo', pct: '20-40%', note: 'Se CDX2‚àí ‚Üí favorisce polmone/pancreas' }
        ],
        molecular: [
          'MEN1 mutation: 20-30% (soprattutto duodeno/pancreas)',
          'DAXX/ATRX loss: 40% pancreas NET (poor prognosis)',
          'Somatostatin receptor expression (SSTR): imaging/therapy target',
          'Ki-67 grading: G1 <3%, G2 3-20%, G3 >20% (WHO 2019)'
        ],
        morphology: [
          'Pattern organoid/trabecolare/insulare',
          'Salt-and-pepper chromatin (cromatina NE)',
          'Nuclei rotondi uniformi, citoplasma granulare',
          'Vascolarizzazione ricca',
          'Grading Ki-67: G1 (<3%), G2 (3-20%), G3 (>20%)'
        ],
        ddx: [
          'NET polmonare: TTF1+ 85% (vs GI TTF1‚àí), CDX2‚àí (vs GI CDX2+)',
          'NET pancreatico: CDX2‚àí tipico, sede pancreas',
          'NEC (high-grade): Ki-67 >20%, morfologia small/large cell, chemiosensibile',
          'Adenocarcinoma: marker NE negativi (INSM1‚àí/Synaptophysin‚àí)',
          'Goblet cell (appendice): mucinoso + NE (dual differentiation)'
        ],
        refs: ['Kl√∂ppel 2017 WHO', 'Bellizzi 2020 CDX2']
      },
      {
        name: 'Carcinoma Tiroideo (PTC)',
        keywords: ['tiroide', 'thyroid', 'ptc', 'papillare', 'tiroideo'],
        positive: [
          { marker: 'TTF1', pct: '95-100%', note: '‚≠ê Tiroide follicolare origin', pattern: 'Nucleare' },
          { marker: 'Thyroglobulin', pct: '95-100%', note: '‚≠ê Specifico tiroide', pattern: 'Citoplasmatico' },
          { marker: 'PAX8', pct: '100%', note: 'Tiroide + RCC + M√ºller', pattern: 'Nucleare' },
          { marker: 'CK19', pct: '95%', note: 'PTC (non follicolare)', pattern: 'Citoplasmatico' },
          { marker: 'HBME-1', pct: '85%', note: 'Maligno (vs adenoma)', pattern: 'Membranoso' }
        ],
        negative: [
          { marker: 'Calcitonin', pct: 'Negativo', note: '‚≠ê Discrimina MTC (calcitonin+)' },
          { marker: 'CEA', pct: 'Negativo PTC', note: 'MTC CEA+' },
          { marker: 'CDX2', pct: 'Negativo', note: 'Discrimina GI' }
        ],
        molecular: [
          'BRAF V600E mutation: 40-45% PTC (targeted therapy)',
          'RET/PTC rearrangement: 20% (soprattutto giovani/radiazioni)',
          'RAS mutation: 10-20% follicolare variant',
          'TERT promoter mutation: aggressivo',
          'PAX8/PPARŒ≥ fusion: follicolare carcinoma'
        ],
        morphology: [
          'PTC classico: papille, nuclei ground-glass, pseudo-inclusioni',
          'Variant follicolare: pattern follicolare MA nuclei PTC',
          'Variant tall cell: cellule alte (>2:1), eosinofile',
          'Psammoma bodies (30-40%)',
          'Invasione capsulare/vascolare (carcinoma vs adenoma)'
        ],
        ddx: [
          'Carcinoma midollare (MTC): Calcitonin+/CEA+/TTF1+/Thyroglobulin‚àí, morfologia NE',
          'Carcinoma anaplastico: loss marker differenziazione (TTF1‚àí/Thyroglobulin‚àí), PAX8+ retained 80%',
          'Metastasi polmone: TTF1+ overlap! MA Thyroglobulin‚àí (discrimina), Napsina+ (polmone)',
          'RCC: PAX8+ overlap! MA TTF1‚àí/Thyroglobulin‚àí (discrimina)',
          'Adenoma follicolare: no invasione, HBME-1‚àí tipico'
        ],
        refs: ['Lloyd 2017 WHO', 'Nikiforov 2016']
      }
    ];

    // ============================================
    // ‚≠ê NEW v2.16: PREVALENCE DATA (Vollmer 2009 + Updates 2026)
    // Mortality-based priors for CUP (Bayes P(Dx))
    // ============================================
    
    const prevalenceData = {
      'Sarcoma Sinoviale': { female: 0.002, male: 0.002 },
      'Melanoma': { female: 0.020, male: 0.025 },
      'Carcinoma Renale Clear Cell (RCC)': { female: 0.024, male: 0.037 },
      'GIST': { female: 0.005, male: 0.006 },
      'Linfoma DLBCL': { female: 0.015, male: 0.018 },
      'Carcinoma Mammario': { female: 0.194, male: 0.002 }, // ‚≠ê Top F: 19.4%
      'MPNST': { female: 0.001, male: 0.001 },
      'Carcinoma Prostatico': { female: 0, male: 0.130 }, // ‚≠ê Top M: 13%
      'Adenocarcinoma Polmonare': { female: 0.146, male: 0.111 }, // ‚≠ê Top F: 14.6%
      'Carcinoma Colorettale': { female: 0.123, male: 0.110 },
      'Rabdomiosarcoma': { female: 0.001, male: 0.001 },
      'Mesotelioma Epitelioide': { female: 0.001, male: 0.002 },
      'HCC (Epatocarcinoma)': { female: 0.025, male: 0.052 },
      'Carcinoma Pancreatico': { female: 0.080, male: 0.079 },
      'Carcinoma Ovarico Sieroso (HGSC)': { female: 0.074, male: 0 },
      'Carcinoma Uroteliale': { female: 0.020, male: 0.045 },
      'NET Gastrointestinale': { female: 0.030, male: 0.035 },
      'Carcinoma Tiroideo (PTC)': { female: 0.004, male: 0.003 }
    };

    // ============================================
    // PANELS DEFINITION v2.3
    // ============================================
    
    const panels = [
      { 
        id: 'carcinoma', 
        name: 'Pannello Carcinoma', 
        markers: [
          { label: 'Polmone', markers: [
            { id: 'TTF1', name: 'TTF-1' },
            { id: 'Napsina', name: 'Napsin-A' },
          ]},
          { label: 'Mammella/Gineco', markers: [
            { id: 'ER', name: 'ER' },
            { id: 'GATA3', name: 'GATA3' },
            { id: 'TRPS1', name: 'TRPS1' }, // ‚≠ê NEW v2.9: 98.7% mammella
            { id: 'Mammoglobin', name: 'Mammoglobin' },
            { id: 'PAX8', name: 'PAX8' },
            { id: 'WT1', name: 'WT1' },
          ]},
          { label: 'Prostata', markers: [
            { id: 'PSA', name: 'PSA' },
            { id: 'PSAP', name: 'PSAP' },
            { id: 'NKX3', name: 'NKX3' },
            { id: 'ERG', name: 'ERG' },
          ]},
          { label: 'Uroteliale', markers: [ // ‚≠ê NEW v2.9
            { id: 'GATA3', name: 'GATA3' },
            { id: 'CK17', name: 'CK17' }, // UTUC 85%
            { id: 'CK5', name: 'CK5/6' },
          ]},
          { label: 'Pancreas', markers: [ // ‚≠ê NEW v2.9
            { id: 'BCL10', name: 'BCL10' }, // Acinare 90-95%
            { id: 'BetaCatenin', name: 'Œ≤-catenina' }, // SPT nucleare
            { id: 'CK17', name: 'CK17' }, // PDAC subset
          ]},
          { label: 'Epatico/Renale', markers: [
            { id: 'Arginasi', name: 'Arginase-1' },
            { id: 'HSA', name: 'Hep-Par-1' },
            { id: 'RCC', name: 'RCC' },
            { id: 'PAX8', name: 'PAX8' },
          ]},
          { label: 'Mesotelio', markers: [
            { id: 'WT1', name: 'WT1' },
            { id: 'Calretinin', name: 'Calretinin' },
          ]},
          { label: 'Squamoso', markers: [
            { id: 'CK5', name: 'CK5/6' },
            { id: 'p40', name: 'p40' },
            { id: 'p63', name: 'p63' },
            { id: 'NUT', name: 'NUT' }, // ‚≠ê NEW v2.9: Midline carcinoma, pattern speckled
          ]},
        ]
      },
      { 
        id: 'neuroendocrine', 
        name: 'Pannello Neuroendocrino', 
        markers: [
          { label: 'First-line', markers: [
            { id: 'INSM1', name: 'INSM1' }, // ‚≠ê NEW v2.9: 96.4% sens, nucleare
            { id: 'Synapt', name: 'Synaptophysin' },
            { id: 'Cromo', name: 'Chromogranin' },
            { id: 'CD56', name: 'CD56' },
          ]},
          { label: 'Second-line', markers: [
            { id: 'CD57', name: 'CD57' },
          ]},
        ]
      },
      { 
        id: 'melanocytic', 
        name: 'Pannello Melanocitico', 
        markers: [
          { label: 'First-line', markers: [
            { id: 'S100', name: 'S100' },
            { id: 'SOX10', name: 'SOX10' },
            { id: 'MelanA', name: 'Melan-A' },
            { id: 'HMB45', name: 'HMB-45' },
            { id: 'PRAME', name: 'PRAME' },
          ]},
        ]
      },
      { 
        id: 'gct', 
        name: 'Pannello GCT', 
        markers: [
          { label: 'First-line', markers: [
            { id: 'OCT34', name: 'OCT3/4' },
            { id: 'SALL4', name: 'SALL4' },
            { id: 'AFP', name: 'AFP' },
            { id: 'HCG', name: 'Œ≤-HCG' },
          ]},
          { label: 'Second-line', markers: [
            { id: 'PLAP', name: 'PLAP' },
            { id: 'CD30', name: 'CD30' },
            { id: 'GPC3', name: 'Glypican-3' },
          ]},
        ]
      },
      { 
        id: 'lymphoma', 
        name: 'Pannello Linfoma', 
        markers: [
          { label: 'Basic', markers: [
            { id: 'CD20', name: 'CD20' },
            { id: 'CD3', name: 'CD3' },
            { id: 'CD15', name: 'CD15' },
            { id: 'CD79a', name: 'CD79a' },
            { id: 'PAX5', name: 'PAX5' },
            { id: 'ALK', name: 'ALK', sacco: true },
          ]},
        ]
      },
      { 
        id: 'sarcoma', 
        name: 'Pannello Sarcoma', 
        markers: [
          { label: 'Muscolare', markers: [
            { id: 'Desmin', name: 'Desmin' },
            { id: 'SMA', name: 'SMA' },
            { id: 'MyoD1', name: 'MyoD1', sacco: true },
            { id: 'Myogenin', name: 'Myogenin' },
            { id: 'Calponin', name: 'Calponina' }, // ‚≠ê NEW v2.8
          ]},
          { label: 'Nerve Sheath', markers: [ // ‚≠ê NEW v2.8
            { id: 'S100', name: 'S100' },
            { id: 'SOX10', name: 'SOX10' },
            { id: 'H3K27me3', name: 'H3K27me3' }, // Loss = MPNST
          ]},
          { label: 'Altri', markers: [
            { id: 'STAT6', name: 'STAT6' },
            { id: 'DOG1', name: 'DOG1' },
          ]},
        ]
      },
      { 
        id: 'mmr', 
        name: 'MMR Status', 
        markers: [
          { label: 'Proteine MMR', markers: [
            { id: 'MLH1', name: 'MLH1' },
            { id: 'MSH2', name: 'MSH2' },
            { id: 'MSH6', name: 'MSH6' },
            { id: 'PMS2', name: 'PMS2' },
          ]},
        ]
      },
    ];

    // ============================================
    // STATE MANAGEMENT
    // ============================================
    
    let markerState = {};
    let currentPanel = null;

    // Initialize marker state
    markers.forEach(m => {
      markerState[m.id] = 'not-tested';
    });

    // Helper functions
    const p = (id) => markerState[id] === 'positive';
    const n = (id) => markerState[id] === 'negative';
    const t = (id) => markerState[id] !== 'not-tested';

    // ‚≠ê v2.6 NEW: localStorage persistenza stato
    function saveState() {
      try {
        const state = {
          markerState: markerState,
          currentPanel: currentPanel,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem('ihcCascade_state_v2.6', JSON.stringify(state));
      } catch (e) {
        console.warn('localStorage non disponibile:', e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem('ihcCascade_state_v2.6');
        if (!raw) return false;
        
        const state = JSON.parse(raw);
        if (state.markerState) {
          markerState = state.markerState;
        }
        if (state.currentPanel) {
          currentPanel = state.currentPanel;
        }
        return true;
      } catch (e) {
        console.warn('Errore caricamento stato:', e);
        return false;
      }
    }

    function clearSavedState() {
      try {
        localStorage.removeItem('ihcCascade_state_v2.6');
      } catch (e) {
        console.warn('Errore clear stato:', e);
      }
    }

    // ============================================
    // UI RENDERING v2.3
    // ============================================
    
    function renderFirstLine() {
      const firstLineMarkers = ['CKAE1', 'CD45', 'Vim', 'S100'];
      const container = document.getElementById('firstLine');
      
      container.innerHTML = firstLineMarkers.map(id => {
        const marker = markers.find(m => m.id === id);
        return `
          <div class="marker-group">
            <h3>${marker.name}</h3>
            <div class="marker-btn-group">
              <button class="marker-btn ${markerState[id] === 'positive' ? 'positive' : ''}" 
                      onclick="setMarker('${id}', 'positive')">
                ‚úì Positivo
              </button>
              <button class="marker-btn ${markerState[id] === 'negative' ? 'negative' : ''}" 
                      onclick="setMarker('${id}', 'negative')">
                ‚úó Negativo
              </button>
              <button class="marker-btn ${markerState[id] === 'not-tested' ? 'not-tested' : ''}" 
                      onclick="setMarker('${id}', 'not-tested')">
                ? ND
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      // Show/hide Big Four based on CKAE1
      updateBigFourVisibility();
    }

    function updateBigFourVisibility() {
      const bigFourSection = document.getElementById('bigFourSection');
      const ckNegCallout = document.getElementById('ckNegativeCallout');
      
      if (p('CKAE1')) {
        bigFourSection.style.display = 'block';
        ckNegCallout.style.display = 'none';
      } else {
        bigFourSection.style.display = 'none';
        
        // ‚≠ê v2.6: Mostra callout se CK‚àí o ND + morfologia epiteliale
        const hasEpiMorph = document.getElementById('arch_gland')?.checked || 
                            document.getElementById('arch_trabec')?.checked ||
                            document.getElementById('arch_solid')?.checked;
        
        if ((n('CKAE1') || !t('CKAE1')) && hasEpiMorph) {
          ckNegCallout.style.display = 'block';
        } else {
          ckNegCallout.style.display = 'none';
        }
      }
    }

    function renderBigFour() {
      const bigFour = ['CK7', 'CK20', 'TTF1', 'CDX2'];
      const container = document.getElementById('bigFour');
      
      container.innerHTML = bigFour.map(id => {
        const marker = markers.find(m => m.id === id);
        return `
          <div class="marker-group">
            <h3>${marker.name}</h3>
            <div class="marker-btn-group">
              <button class="marker-btn ${markerState[id] === 'positive' ? 'positive' : ''}" 
                      onclick="setMarker('${id}', 'positive')">
                ‚úì Positivo
              </button>
              <button class="marker-btn ${markerState[id] === 'negative' ? 'negative' : ''}" 
                      onclick="setMarker('${id}', 'negative')">
                ‚úó Negativo
              </button>
              <button class="marker-btn ${markerState[id] === 'not-tested' ? 'not-tested' : ''}" 
                      onclick="setMarker('${id}', 'not-tested')">
                ? ND
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderPanelGrid() {
      const container = document.getElementById('panelGrid');
      
      container.innerHTML = panels.map(panel => `
        <button class="panel-btn ${currentPanel === panel.id ? 'active' : ''}" 
                onclick="selectPanel('${panel.id}')">
          ${panel.name}
        </button>
      `).join('');
    }

    function renderMarkerPanels() {
      const container = document.getElementById('markerPanels');
      
      container.innerHTML = panels.map(panel => `
        <div class="marker-panel ${currentPanel === panel.id ? 'active' : ''}" 
             id="panel-${panel.id}">
          <h3>${panel.name}</h3>
          ${panel.markers.map(section => `
            <div class="marker-section">
              <div class="marker-section-label">${section.label}</div>
              <div class="marker-grid">
                ${section.markers.map(m => {
                  const state = markerState[m.id];
                  const saccoTag = m.sacco ? '<span class="sacco-badge">SACCO</span>' : '';
                  return `
                    <div class="marker-item">
                      <button class="${state === 'positive' ? 'positive' : ''}" 
                              onclick="setMarker('${m.id}', 'positive')" 
                              title="${m.name} Positivo">
                        +
                      </button>
                      <button class="${state === 'negative' ? 'negative' : ''}" 
                              onclick="setMarker('${m.id}', 'negative')" 
                              title="${m.name} Negativo">
                        ‚àí
                      </button>
                      <button class="${state === 'not-tested' ? 'not-tested' : ''}" 
                              onclick="setMarker('${m.id}', 'not-tested')" 
                              style="flex: 2; min-width: 90px; max-width: 120px; text-align: center; overflow: hidden; text-overflow: ellipsis;"
                              title="${m.name} Non Testato">
                        ${m.name}${saccoTag}
                      </button>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      `).join('');
    }

    function setMarker(id, state) {
      markerState[id] = state;
      renderFirstLine();
      renderBigFour();
      if (currentPanel) renderMarkerPanels();
      
      // ‚≠ê v2.5: Update auto-panel suggestions real-time
      updateAutoPanelSuggestions();
      
      // ‚≠ê v2.6: Salva stato
      saveState();
    }

    // ‚≠ê NEW v2.5: Auto-panel suggestions based on first-line
    function updateAutoPanelSuggestions() {
      const container = document.getElementById('autoPanelSuggestions');
      if (!container) return; // Container not rendered yet
      
      const suggestions = [];
      
      // CK+ & CD45‚àí ‚Üí Carcinoma
      if (p('CKAE1') && n('CD45')) {
        suggestions.push({
          text: 'üéØ <strong>Sospetto Carcinoma</strong> (CK+/CD45‚àí) ‚Üí Apri pannello carcinoma',
          panel: 'carcinoma'
        });
      }
      
      // CD45+ & CK‚àí ‚Üí Linfoma
      if (p('CD45') && n('CKAE1')) {
        suggestions.push({
          text: 'üéØ <strong>Sospetto Linfoma</strong> (CD45+/CK‚àí) ‚Üí Apri pannello linfoma',
          panel: 'lymphoma'
        });
      }
      
      // S100+ & CK‚àí & CD45‚àí ‚Üí Melanoma
      if (p('S100') && n('CKAE1') && n('CD45')) {
        suggestions.push({
          text: 'üéØ <strong>Sospetto Melanoma</strong> (S100+/CK‚àí/CD45‚àí) ‚Üí Apri pannello melanocitico',
          panel: 'melanocytic'
        });
      }
      
      // ‚≠ê v2.6 FIX: Vim+ & CK‚àí & CD45‚àí & S100 NEGATIVO ‚Üí Sarcoma
      // Cambiato !p('S100') ‚Üí n('S100') per escludere S100 ND
      if (p('Vim') && n('CKAE1') && n('CD45') && n('S100')) {
        suggestions.push({
          text: 'üéØ <strong>Sospetto Sarcoma</strong> (Vim+/CK‚àí/CD45‚àí/S100‚àí) ‚Üí Apri pannello sarcoma',
          panel: 'sarcoma'
        });
      }
      
      // Render suggestions
      if (suggestions.length > 0) {
        container.style.display = 'block';
        container.innerHTML = suggestions.map(s => `
          <div class="suggestion-card auto-panel" onclick="selectPanel('${s.panel}'); scrollToPanels();">
            <div class="card-detail">${s.text}</div>
          </div>
        `).join('');
      } else {
        container.style.display = 'none';
      }
    }

    function scrollToPanels() {
      document.querySelector('.panel-selection')?.scrollIntoView({ behavior: 'smooth' });
    }

    function selectPanel(panelId) {
      currentPanel = panelId;
      renderPanelGrid();
      renderMarkerPanels();
      
      // ‚≠ê v2.6: Salva stato
      saveState();
    }

    function resetAll() {
      if (confirm('Reset tutti i marcatori e morfologia?')) {
        // Reset markers
        markers.forEach(m => markerState[m.id] = 'not-tested');
        currentPanel = null;
        
        // ‚≠ê v2.4.2 FIX: Reset morfologia
        document.querySelectorAll('.morphology-item input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
          syncMorphologyUI(cb);
        });
        
        renderFirstLine();
        renderBigFour();
        renderPanelGrid();
        renderMarkerPanels();
        document.getElementById('results').style.display = 'none';
        
        // ‚≠ê v2.6: Clear localStorage
        clearSavedState();
      }
    }

    function toggleBibliography() {
      const bib = document.getElementById('bibliography');
      bib.style.display = bib.style.display === 'none' ? 'block' : 'none';
      if (bib.style.display === 'block') {
        renderBibliography();
      }
    }

    // ‚≠ê v2.4.1 FIX: Morphology toggles con listener change (no doppio toggle)
    function syncMorphologyUI(checkbox) {
      const item = checkbox.closest('.morphology-item');
      if (!item) return;
      item.classList.toggle('checked', checkbox.checked);
      
      // ‚≠ê v2.6: Update CK‚àí callout quando cambia morfologia
      updateBigFourVisibility();
    }

    function getMorphologyAlerts() {
      const alerts = [];
      
      // Zellballen + S100 periferico ‚Üí Paraganglioma
      // ‚≠ê v2.4.2 FIX: !p('SOX10') ‚Üí n('SOX10') (solo se negativo, non ND)
      if (document.getElementById('zellballen').checked && p('S100') && n('SOX10')) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è MORFOLOGIA ‚Äî Pattern Zellballen + S100/SOX10‚àí',
          detail: 'Pattern Zellballen (nidi) + S100+/SOX10‚àí: <strong>Paraganglioma</strong> favorito. Verifica S100 periferico (sustentacolare) vs diffuso. Se S100 diffuso + SOX10+ ‚Üí melanoma [Bellizzi 2018].'
        });
      }

      // Vascolare + ERG ‚Üí Angiosarcoma
      if (document.getElementById('vascolar').checked && p('ERG')) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è MORFOLOGIA ‚Äî Vascolare + ERG+',
          detail: 'Pattern vascolare anastomosante + ERG+: <strong>Angiosarcoma</strong> high confidence. ERG marker endoteliale (92-100% angiosarcoma). CD31, CD34, FLI1 supportano [Miettinen 2014].'
        });
      }

      // Trabecolare + Arginasi ‚Üí HCC vs breast
      if (document.getElementById('arch_trabec').checked && p('Arginasi')) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è MORFOLOGIA ‚Äî Trabecolare + Arginasi+',
          detail: 'Architettura trabecolare + Arginasi+: <strong>HCC</strong> favorito. MA verifica ER/GATA3: se positivi ‚Üí metastasi breast Arg+ (12%). Morfologia HCC tipica: trabecole, bile, pseudoghiandole [Karamchandani 2013].'
        });
      }

      // Pigmento + SOX10 ‚Üí Melanoma
      if (document.getElementById('pigment').checked && (p('S100') || p('SOX10'))) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è MORFOLOGIA ‚Äî Pigmento + SOX10/S100',
          detail: 'Pigmento melanina + SOX10/S100: <strong>Melanoma</strong> high confidence. PRAME+ pattern diffuso supporta. HMB45 pu√≤ perdersi in metastasi [Voiculescu 2025].'
        });
      }

      // ‚≠ê NEW v2.8: 7 MORFOLOGIA GAME-CHANGERS

      // 1. Signet-ring ‚Üí Priorit√† GI/breast lobulare
      if (document.getElementById('cyto_signet')?.checked) {
        alerts.push({
          type: 'advisory',
          title: 'üî¨ MORFOLOGIA ‚Äî Signet-ring cells (anello castone)',
          detail: '<strong>Pattern discoesivo game-changer:</strong> PRIORIT√Ä CDX2/SATB2 (stomaco/colon/appendice) vs GATA3/ER (mammella lobulare). E-cadherin loss conferma carcinoma lobulare breast. <strong>SALTA Arginasi/TTF1</strong> (NON prioritari). Morfologia detta la chimica [NotebookLM].'
        });
      }

      // 2. Clear cell ‚Üí Priorit√† PAX8 (RCC!)
      if (document.getElementById('cyto_clear')?.checked) {
        alerts.push({
          type: 'advisory',
          title: '‚ö†Ô∏è MORFOLOGIA ‚Äî Clear cell features',
          detail: '<strong>Trappola CUP:</strong> RCC = primitivo occulto pi√π frequente autopsia. <strong>PAX8 OBBLIGATORIO</strong> (83-98% RCC). CA-IX/CD10 supporto. SALL4 se giovane (seminoma clear cell). Arginasi se trabecolare (HCC clear cell variant). Pattern critico [NotebookLM].'
        });
      }

      // 3. SRBC ‚Üí Step 2 immediato! (Pediatrico)
      if (document.getElementById('cyto_srbc')?.checked) {
        alerts.push({
          type: 'advisory',
          title: 'üî¨ MORFOLOGIA ‚Äî Small Round Blue Cell (SRBC)',
          detail: '<strong>Pattern pediatrico/giovane ‚Üí Step 2 IMMEDIATO:</strong> PRIORIT√Ä CD99 (Ewing diffuso membranoso), INSM1/SYN (Small cell/Merkel), SALL4 (GCT curabile!), TdT (Linfoblastico), Desmin/MyoD1 (Rabdo). Et√† paziente essenziale orientamento [NotebookLM].'
        });
      }

      // 4. Spindle cell ‚Üí "Grande simulatore"
      if (document.getElementById('cyto_spindle')?.checked) {
        alerts.push({
          type: 'advisory',
          title: '‚ö†Ô∏è MORFOLOGIA ‚Äî Pattern fusocellulare/spindle cell',
          detail: '<strong>"Grande simulatore":</strong> carcinoma metaplastico, melanoma desmoplastico, sarcoma vero. <strong>Step 1 modificato:</strong> CK cocktail ampio (AE1/AE3 + CAM5.2 obbligatori), p40 (SCC sarcomatoide), SOX10/S100 (melanoma fusocellulare, MPNST). Cerca residui epiteliali focali [NotebookLM].'
        });
      }

      // 5. Micropapillare ‚Üí GATA3/WT1 priorit√†
      if (document.getElementById('arch_micropap')?.checked) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è MORFOLOGIA ‚Äî Pattern micropapillare (filigree-like)',
          detail: '<strong>Architettura aggressiva:</strong> PRIORIT√Ä GATA3 (mammella o uroteliale), WT1/PAX8 (ovaio sieroso HG), p16 (HPV-related). Pattern biologico aggressivo, prognosi peggiore [NotebookLM].'
        });
      }

      // 6. Lepidico ‚Üí TTF1/Napsina "giudici supremi"
      if (document.getElementById('arch_lepidic')?.checked) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è MORFOLOGIA ‚Äî Pattern lepidico (crescita alveolare)',
          detail: '<strong>TTF1 + Napsina OBBLIGATORI:</strong> crescita lungo pareti alveolari ‚Üí polmone quasi univoco. Salto Step 4: diagnosi gi√† orientata morfologia. Rara simulazione pancreatica [NotebookLM].'
        });
      }

      // 7. Squamoso ‚Üí Salta workup adenocarcinoma!
      if (document.getElementById('diff_squamous')?.checked) {
        alerts.push({
          type: 'advisory',
          title: '‚ö†Ô∏è MORFOLOGIA ‚Äî Differenziazione squamosa (perle/ponti)',
          detail: '<strong>Perle cornee/ponti intercellulari:</strong> PRIORIT√Ä p40 (spec 98-100%, superiore p63), CK5/6, p16/HPV (se linfonodo cervicale). <strong>SALTA workup adenocarcinoma</strong> (CDX2/TTF1/GATA3/Arginasi inutili). Morfologia esclude adenoCA [NotebookLM].'
        });
      }

      return alerts;
    }

    // ============================================
    // PART 2 END
    // ============================================
    // ============================================
    // PART 3: DIAGNOSTIC LOGIC v2.3
    // ============================================

    function getDiagnoses() {
      const dx = [];

      // ========================================
      // FIRST-LINE ORIENTATION v2.4.1 FIX
      // ========================================
      
      // ‚≠ê FIX v2.4.1: CK+ & CD45‚àí = Epiteliale (indipendente da Vim)
      if (p('CKAE1') && n('CD45')) {
        let vimDetail = '';
        if (p('Vim')) {
          vimDetail = ' ‚ö† Vimentina+: comune in RCC (90%), endometrio (80%), sarcomatoidi. Non esclude carcinoma.';
        } else if (n('Vim')) {
          vimDetail = ' Pattern classico Vim‚àí.';
        }
        
        dx.push({ 
          name: 'Neoplasia Epiteliale (Carcinoma)', 
          conf: 'high', 
          detail: `CK AE1/AE3+/CD45‚àí: neoplasia epiteliale (carcinoma).${vimDetail} Procedi con Big Four (CK7/CK20/TTF1/CDX2) per orientamento [SEOM-GECOD 2022].`
        });
      }

      if (p('CD45') && n('CKAE1')) {
        dx.push({ 
          name: 'Neoplasia Linfoide (Linfoma/Leucemia)', 
          conf: 'high', 
          detail: 'CD45+/CK‚àí: linfoma o leucemia. Procedi con pannello linfoma (CD20, CD3, CD15, PAX5). Flow cytometry essenziale [WHO 2017].'
        });
      }

      if (p('Vim') && n('CKAE1') && n('CD45')) {
        dx.push({ 
          name: 'Neoplasia Mesenchimale (Sarcoma) o Carcinoma Vim+', 
          conf: 'medium', 
          detail: '‚ö† Vim+/CK‚àí/CD45‚àí: sarcoma probabile MA vimentina+ anche in: RCC (90%), endometrio (80%), sarcomatoid carcinoma. Check S100 (melanoma/MPNST), Desmin (muscolare), PAX8 (renale/m√ºller), STAT6 (SFT). <strong>Morfologia EE ESSENZIALE</strong>: se architettura ghiandolare/trabecolare ‚Üí carcinoma Vim+, se fascicolare/storiform ‚Üí sarcoma [WHO 2020].'
        });
      }

      if (p('S100') && n('CKAE1') && n('CD45')) {
        dx.push({ 
          name: 'Neoplasia Melanocitica o Nerve Sheath', 
          conf: 'high', 
          detail: 'S100+/CK‚àí/CD45‚àí: melanoma (primaria) o MPNST. Procedi con pannello melanocitico (SOX10, Melan-A, HMB45, PRAME). SOX10+ favorisce melanoma (spec 95% vs carcinomi) [Voiculescu 2025].'
        });
      }

      // ========================================
      // CK7/CK20 PATTERNS
      // ========================================
      
      if (p('CK7') && p('CK20')) {
        dx.push({ 
          name: 'Adenocarcinoma pancreatico, biliare, gastrico (type intestinale)', 
          conf: 'medium', 
          detail: 'Pattern CK7+/CK20+: pancreas (60-80%), bile (50-70%), gastrico type intestinale (40%). Se CDX2+ ‚Üí favorisce gastrico/pancreas. Se PAX8+ raro pattern renale atipico [SEOM-GECOD 2022].'
        });
      }

      if (p('CK7') && n('CK20')) {
        if (p('TTF1')) {
          if (p('Napsina')) {
            dx.push({ 
              name: 'Adenocarcinoma polmonare', 
              conf: 'high', 
              detail: 'TTF-1+/Napsin-A+ (CK7+/CK20‚àí): spec 94-98% polmone [IASLC 2021]. Napsin-A sens 80% primitivo, 65% metastasi. Se Napsin‚àí controllare altri organi (tiroide PAX8+, endometrio ER+) [Park 2007].'
            });
          } else {
            dx.push({ 
              name: 'Adenocarcinoma polmonare vs Altro TTF-1+', 
              conf: 'medium', 
              detail: 'TTF-1+ (CK7+/CK20‚àí/Napsin‚àí): polmone probabile MA check tiroide (Thyroglobulina), endometrio (ER+, PAX8+). TTF-1 non lineage-specific [Park 2007].'
            });
          }
        }

        if (p('ER') || p('GATA3')) {
          dx.push({ 
            name: 'Adenocarcinoma mammario', 
            conf: 'high', 
            detail: 'ER+ o GATA3+ (CK7+/CK20‚àí): mammella probabile. GATA3 sens 80-90%, spec >95% vs altri organi. ER+ anche endometrio, ovaio. Supporto clinico (donna, mammo) [NCCN 2023].'
          });
        }

        if (p('PAX8') && !p('ER')) {
          dx.push({ 
            name: 'Adenocarcinoma ovarico, endometriale, renale, tiroideo', 
            conf: 'medium', 
            detail: 'PAX8+ (CK7+/CK20‚àí/ER‚àí): ovaio sieroso (95%), endometrio (80%), renale (90%), tiroide (100%). DDx: WT1+ favorisce ovaio/mesotelio, RCC+ renale, Thyroglobulina tiroide [Ozcan 2011].'
          });
        }
      }

      if (n('CK7') && p('CK20')) {
        if (p('CDX2')) {
          dx.push({ 
            name: 'Adenocarcinoma colorettale', 
            conf: 'high', 
            detail: 'CDX2+ (CK7‚àí/CK20+): colon-retto sens 95%, spec 95% vs altri GI. Se Synapt+ e morfologia small cell ‚Üí Merkel cell CA [SEOM 2022].'
          });
        } else {
          dx.push({ 
            name: 'Adenocarcinoma GI (colon probabile, gastrico diffuse type possibile)', 
            conf: 'medium', 
            detail: 'CK7‚àí/CK20+ senza CDX2: colon probabile (alcuni CDX2‚àí), gastrico diffuse type (signet ring). MMR status se disponibile [NCCN 2023].'
          });
        }
      }

      if (n('CK7') && n('CK20')) {
        if (p('PSA') || p('NKX3')) {
          dx.push({ 
            name: 'Adenocarcinoma prostatico', 
            conf: 'high', 
            detail: 'NKX3: sens 80-85% nelle metastasi (vs 95-100% primitivo), spec 99-100%. Mantiene espressione meglio di PSA. ‚ö† Perdita in NE (<20%), post-ADT, alto grado [Gurel 2010, Khani 2014].'
          });
          
          if (n('PSA') && p('NKX3')) {
            dx.push({ 
              name: 'Adenoca prostatico PSA-negativo', 
              conf: 'high', 
              detail: 'NKX3+/PSA‚àí: prostata scarsamente diff. o post-terapia. NKX3 marker di scelta nei CUP CK7‚àí/CK20‚àí [Gurel 2010].'
            });
          }
        }

        // ‚≠ê NEW v2.3: ERG prostata
        if (p('ERG') && (p('PSA') || p('NKX3') || p('CKAE1'))) {
          dx.push({ 
            name: 'Adenocarcinoma prostatico ERG+', 
            conf: 'high', 
            detail: 'ERG+ (30-40% prostata con fusione TMPRSS2-ERG). Supporta diagnosi prostata. ‚ö† ERG √® marker endoteliale: se morfologia vascolare ‚Üí angiosarcoma. Se CK+ solido ‚Üí prostata. ERG mantiene espressione post-ADT [Park 2014].'
          });
        }

        // ‚≠ê v2.7.1 REFINED: Pattern ERG+/PSA‚àí/NKX3‚àí/SYN+ ‚Üí Prostata post-ADT NE
        if (p('ERG') && n('PSA') && n('NKX3') && p('Synapt') && (p('Cromo') || p('CD56'))) {
          dx.push({ 
            name: 'Adenocarcinoma prostatico con differenziazione NE (post-ADT)', 
            conf: 'high', 
            detail: '<strong>Pattern diagnostico post-ADT validato (NotebookLM):</strong> ERG+ (TMPRSS2-ERG fusion stabile, "ancora genomica" AR-independent) + SYN/CgA/CD56 (transformation NE 10-20% post-castrazione, shift fenotipico) + PSA‚àí/NKX3‚àí (downregulation AR-pathway: Khani 2014 sens 80.7% mets, 70-75% post-ADT; PSA <50% mets). <strong>Diagnosi:</strong> Adenocarcinoma prostatico TMPRSS2-ERG+ con firma neuroendocrina acquisita. <strong>La perdita PSA/NKX3.1 √® coerente con pregresso trattamento ormonale</strong> [Khani 2014]. <strong>Clinica:</strong> Storia prostata trattata essenziale (ADT >6-12 mesi, prostatectomia, RT). Prognosi: aggressive, consider platinum-based chemotherapy (cisplatino/etoposide). <strong>Morfologia:</strong> solid sheet predominant, small cell pattern, necrosi, mitosi >10/HPF. <strong>DDx:</strong> NEC primitivo (ERG+ esclude), angiosarcoma (morfologia vascolare anastomosante assente, CK+ esclude) [Beltran 2016, Khani 2014, Park 2014].'
          });
        }

        // ‚≠ê v2.4.2 FIX: ERG angiosarcoma - richiede marker testati E negativi
        if (p('ERG') && t('PSA') && n('PSA') && t('NKX3') && n('NKX3') && t('CKAE1') && n('CKAE1')) {
          dx.push({ 
            name: 'Neoplasia vascolare (Angiosarcoma, Emangioendotelioma)', 
            conf: 'high', 
            detail: 'ERG+ marker endoteliale (sens 92-100% angiosarcoma). PSA‚àí/NKX3‚àí/CK‚àí testati escludono prostata. Morfologia: vasi anastomosanti, eritrociti intracitoplasmatici. CD31, CD34, FLI1 supportano origine vascolare [Miettinen 2014].'
          });
        }

        if (n('PSA') && n('NKX3') && t('PSA') && t('NKX3')) {
          dx.push({ 
            name: 'Esclusione prostata incompleta', 
            conf: 'low', 
            detail: 'PSA‚àí/NKX3‚àí in CK7‚àí/CK20‚àí non esclude prostata: ~20% metastasi PSA‚àí, ~15-20% NKX3‚àí (post-ADT, alto grado, NE). Morfologia EE critica. Considerare ERG (30-40% se TMPRSS2-ERG+), PSAP se disponibili [Gurel 2010].'
          });
        }

        if (p('HSA') || p('Arginasi')) {
          dx.push({ 
            name: 'Carcinoma epatocellulare', 
            conf: 'high', 
            detail: 'Arginasi-1: sens 80-96% HCC (53.6% poorly diff. vs HepPar-1 14.3%), spec 96-100% vs cholangioCA/CRC [Yan 2010]. ‚ö† Cross-reattivit√†: breast 12.3% (pattern granulare citoplasmatico identico HCC), prostata <10%, CCA raro. Morfologia EE + coerenza clinica essenziali [Karamchandani 2013].'
          });
          
          if (p('Arginasi') && p('GATA3') && n('ER')) {
            dx.push({ 
              name: 'HCC GATA3+ (raro) vs Metastasi breast', 
              conf: 'medium', 
              detail: 'Arg+/GATA3+/ER‚àí: Pattern raro. HCC pu√≤ essere GATA3+ in ~2%. Se ER‚àí e morfologia trabecolare ‚Üí HCC. Se ER+ o morfologia atipica ‚Üí metastasi breast Arg+ (12.3%) [Karamchandani 2013].'
            });
          }
        }

        if (p('RCC')) {
          dx.push({ 
            name: 'Carcinoma renale', 
            conf: 'high', 
            detail: 'RCC marker (CK7‚àí/CK20‚àí): sens 80-85% RCC. PAX8+ supporta (90% RCC). Morfologia: clear cell, papillare, cromofobo. Se CK7+ pattern atipico (10-15% RCC) [Moch 2016].'
          });
        }
      }

      // ========================================
      // NEUROENDOCRINE
      // ========================================
      
      if (p('Synapt') || p('Cromo') || p('CD56')) {
        dx.push({ 
          name: 'Neoplasia neuroendocrina (NET/NEC)', 
          conf: 'high', 
          detail: 'Synaptophysin (sens 89%, spec alta) > Chromogranin (sens 67%, spec moderata). CD56 sensibile ma meno specifico. Morfologia: carcinoide (NET) vs small cell (NEC). Site-specific: TTF1 polmone 90%, CDX2 GI, CD57 variabile [Bellizzi 2018].'
        });

        if (p('S100') && p('Synapt')) {
          dx.push({ 
            name: 'S100+/SYN+: Paraganglioma vs Melanoma vs NEC', 
            conf: 'medium', 
            detail: 'DDx critica: (1) Paraganglioma: CK‚àí, GATA3+, S100 periferico (sustentacolare), nidi Zellballen. (2) Melanoma: SOX10+, Melan-A+, HMB45+, S100 diffuso. (3) NEC pigmentato (raro). Morfologia EE essenziale [Bellizzi 2018].'
          });
        }

        if ((p('PSA') || p('NKX3')) && p('Synapt')) {
          dx.push({ 
            name: 'Adenocarcinoma prostatico con differenziazione NE', 
            conf: 'high', 
            detail: 'PSA+/NKX3+/SYN+: adenoCA prostata con firma NE. Comune post-ADT, alto grado. Pattern SYN: focale (<30%) = NE subclinica; diffuso (>70%) + small-cell = NEC. Prognosi peggiore [Bellizzi 2018].'
          });
        }

        if (p('Synapt') && n('PSA') && n('NKX3') && t('PSA') && t('NKX3')) {
          dx.push({ 
            name: 'NEC prostatico vs NEC altri siti', 
            conf: 'medium', 
            detail: 'SYN+/PSA‚àí/NKX3‚àí: NEC prostatico perde marcatori (sens PSA/NKX3 <20% in NEC). DDx: NEC polmone (TTF1+ 90%), NEC GI (CDX2). Marcatori terza linea: ERG (30-40% prostata), AR. Morfologia small-cell + sede metastasi (ossee favoriscono prostata) [Bellizzi 2018].'
          });
        }
      }

      // ‚≠ê v2.4: CD57 NE (supportivo debole - warning)
      if (p('CD57') && (p('Synapt') || p('Cromo'))) {
        dx.push({ 
          name: 'Neoplasia neuroendocrina CD57+ ‚ö†Ô∏è SUPPORTIVO DEBOLE', 
          conf: 'low', 
          detail: '‚ö† CD57+ (Leu-7) marker NE <strong>sensibile ma POCO specifico</strong>. Positivo anche: NK cells (60%), gliomi (80%), prostata adenoCA (40%), melanoma (variabile). CD57 NON raccomandato come marker primario NE. <strong>Synaptophysin/INSM1 obbligatori</strong> per diagnosi NE [Bellizzi 2018].'
        });
      }

      // ========================================
      // ‚≠ê NEW v2.9: MARKER EMERGENTI
      // ========================================
      
      // 1. TRPS1 - Mammella (98.7% sens)
      if (p('TRPS1') && n('PAX8') && n('WT1')) {
        dx.push({
          name: 'Carcinoma mammario TRPS1+',
          conf: 'high',
          detail: '<strong>TRPS1+ (98.7% sens mammella) + PAX8‚àí/WT1‚àí (esclude ovaio).</strong> TRPS1 marker pi√π sensibile mammella, superiore GATA3 (67.5%) e SOX10 (72.8%) in TNBC. <strong>Marker di salvataggio</strong> quando GATA3 fallisce. Morfologia: se "Indian-file" discoesivo ‚Üí lobulare favorito. <strong>Clinica:</strong> donna, imaging mammario, storia familiare [NotebookLM 2026].'
        });
      }

      // Alert TRPS1+/PAX8+ (pitfall ovaio!)
      if (p('TRPS1') && p('PAX8')) {
        dx.push({
          name: '‚ö†Ô∏è TRPS1+/PAX8+: DDx Mammella vs Ovaio HGSC',
          conf: 'medium',
          detail: '<strong>TRPS1+ NON esclude ovaio!</strong> 40.5% carcinoma sieroso alto grado (HGSC) ovaio esprime TRPS1. <strong>DDx critico:</strong> (1) Mammella: TRPS1+/PAX8‚àí/WT1‚àí/GATA3+ favorito. (2) Ovaio HGSC: TRPS1+/PAX8+/WT1+/ER+ favorito. <strong>Morfologia + sede:</strong> metastasi peritoneale/pelvica ‚Üí ovaio pi√π probabile; linfonodo ascellare ‚Üí mammella [NotebookLM 2026].'
        });
      }

      // 2. INSM1 - Neuroendocrino nucleare (96.4%)
      if (p('INSM1')) {
        dx.push({
          name: 'Neoplasia neuroendocrina INSM1+',
          conf: 'high',
          detail: '<strong>INSM1+ nucleare (96.4% sens NEC alto grado).</strong> First-line marker NE, superiore CgA/SYN/CD56 (87%). Mantiene espressione in dedifferenziazione quando marker secretori perduti. <strong>Pattern critico:</strong> se diffuso >50% ‚Üí NEN vera; se focale <30% ‚Üí transdifferenziazione NE. <strong>‚ö†Ô∏è CAVEAT EPISTEMICO (NotebookLM):</strong> INSM1 pu√≤ marcare PLASTICIT√Ä FENOTIPICA alto grado, NON differenziazione NE vera! <strong>False positivity:</strong> melanoma 13.2%, <strong>prostata adenoCA 36.1%</strong> (1/3 adenocarcinomi prostatici convenzionali!)‚Üí In contesto prostata (PSA+/NKX3+), INSM1+ = plasticit√†, NON NEC! INSM1 diagnostico NE solo se: morfologia small cell/NE + pattern diffuso forte + altri NE marker+. Se INSM1+/SOX10+ ‚Üí melanoma favorito. Se INSM1+ focale in CK7‚àí/CK20‚àí ‚Üí verificare PSA/NKX3 (prostata con differenziazione NE). <strong>Rigore:</strong> INSM1 non sostituisce morfologia + correlazione clinica [Rooper 2017, NotebookLM 2026].'
        });
      }

      // 3. BCL10 - Acinare pancreas (90-95%)
      if (p('BCL10')) {
        dx.push({
          name: 'Carcinoma acinare pancreatico',
          conf: 'high',
          detail: '<strong>BCL10+ citoplasmatico granulare (90-95% sens acinare).</strong> Morfologia: architettura solida, granuli zimogeni eosinofili. <strong>Conferma marker zimogeni</strong> (Lipasi/Tripsina suggerito se disponibile). <strong>DDx:</strong> PDAC duttale (BCL10‚àí/CA19-9+/CK17+ subset), NET (Synaptophysin+/BCL10‚àí), solido-pseudopapillare (Œ≤-catenina nucleare+/BCL10‚àí). <strong>Prognosi:</strong> migliore PDAC duttale (mediana 25-30 mesi vs 6-12). <strong>Terapia:</strong> chirurgia, platinum-based chemio. <strong>Pediatrico:</strong> pancreatoblastoma pu√≤ essere BCL10+ (Œ≤-catenina+, squamoid corpuscles morfologia) [La Rosa 2014].'
        });
      }

      // 4. Œ≤-catenina nucleare - Solido-pseudopapillare
      if (p('BetaCatenin')) {
        dx.push({
          name: 'Tumore solido-pseudopapillare pancreas (Frantz)',
          conf: 'high',
          detail: '<strong>Œ≤-catenina nucleare DIAGNOSTICA.</strong> Morfologia: pattern solido + pseudopapillare, cellule monotone, corpi ialini. <strong>Clinica:</strong> giovani donne (90%), massa pancreatica corpo/coda. <strong>Altri marker:</strong> CD10+, Vimentina+, PR+ variabile. <strong>Prognosi:</strong> eccellente (95% sopravvivenza 5 anni), low-grade malignant potential. <strong>Terapia:</strong> resezione chirurgica curativa. <strong>DDx:</strong> NET (Œ≤-catenina membranosa, Synaptophysin+), acinare (BCL10+, Œ≤-catenina‚àí) [WHO 2019].'
        });
      }

      // 5. CK17 - Uroteliale/PDAC
      if (p('CK17')) {
        dx.push({
          name: 'CK17+: Uroteliale (UTUC) o PDAC',
          conf: 'medium',
          detail: '<strong>CK17+ pattern diagnostico:</strong> (1) Uroteliale alto tratto (UTUC) sens 85%, spec 82%. Pattern non-basale distingue maligno/benigno. (2) PDAC duttale 60-80% (subset aggressivo basal-like). <strong>DDx:</strong> GATA3 discrimina uroteliale vs pancreas (GATA3+ urotelio, GATA3‚àí pancreas se duttale). <strong>Altri CK17+:</strong> cervice squamoso, TNBC subset, ovaio endometrioide. <strong>Morfologia + clinica essenziali</strong> [Biankin 2012, NotebookLM].'
        });
      }

      // 6. NUT - Midline carcinoma
      if (p('NUT')) {
        dx.push({
          name: 'NUT Midline Carcinoma (NMC)',
          conf: 'high',
          detail: '<strong>NUT+ pattern nucleare speckled PATOGNOMONICO.</strong> Fusione BRD4-NUT (75%) o varianti. <strong>Morfologia:</strong> carcinoma scarsamente differenziato "null-type", simula SCC indifferenziato. <strong>Clinica:</strong> giovani (<30 anni picco), massa midline (mediastino, testa-collo, polmone). <strong>IHC supporto:</strong> p63+/p40+ frequente, ma nessun primitivo squamoso identificato. <strong>Prognosi:</strong> aggressivo (mediana sopravvivenza 6-9 mesi), MA target therapy trials (BET inhibitors) promettenti. <strong>Identificazione essenziale</strong> per arruolamento trials [French 2014].'
        });
      }

      // ========================================
      // MELANOCYTIC v2.3
      // ========================================
      
      if (p('S100') || p('SOX10') || p('MelanA') || p('HMB45')) {
        // ‚≠ê v2.9.1 FIX: Downgrade conf se CK+ (DDx TNBC SOX10+ 69%)
        const melanomaConf = p('CKAE1') ? 'medium' : 'high';
        const ckNote = p('CKAE1') ? ' <strong>‚ö†Ô∏è CK+:</strong> DDx TNBC (69% SOX10+). Se CK diffuso forte ‚Üí TNBC favorito; se CK focale/debole ‚Üí melanoma aberrante.' : '';
        
        dx.push({ 
          name: 'Melanoma', 
          conf: melanomaConf, 
          detail: `S100 (sens 97%, spec moderata), SOX10 (sens 95%, spec 95% vs carcinomi). Melan-A, HMB45 pi√π specifici ma meno sensibili (possono perdersi in metastasi). Morfologia: pleomorfismo, pigmento.${ckNote} [Voiculescu 2025]`
        });

        // ‚≠ê NEW v2.3: SOX10 melanoma (pi√π specifico)
        if (p('SOX10')) {
          dx.push({ 
            name: 'Melanoma SOX10+ (alta specificit√†)', 
            conf: melanomaConf, 
            detail: `SOX10+ (sens 95%, spec 95% vs carcinomi). Pi√π specifico di S100 (cross-react schwannoma, myoepi, condro). Se SOX10+/PRAME+ pattern diffuso ‚Üí melanoma high confidence. SOX10 mantiene espressione in metastasi.${ckNote} [Nonaka 2008]`
          });
        }

        // ‚≠ê UPDATED v2.2: PRAME melanoma
        if (p('S100') && p('SOX10') && p('PRAME')) {
          dx.push({ 
            name: 'Melanoma PRAME+', 
            conf: melanomaConf, 
            detail: `S100+/SOX10+/PRAME+: melanoma (sens PRAME 83-94%). Pattern PRAME diffuso (>50% cellule) supporta malignit√†. Melan-A, HMB45 possono perdersi in metastasi. PRAME mantiene espressione.${ckNote} [Lezcano 2018]`
          });
        }

        // ‚≠ê v2.2: DDx Spitz
        if ((p('S100') || p('SOX10')) && t('PRAME')) {
          dx.push({ 
            name: 'DDx Nevo di Spitz vs Melanoma Spitzoide', 
            conf: 'medium', 
            detail: '<strong>PRAME pattern-critical:</strong> (1) <strong>Nevo di Spitz</strong> (benigno): PRAME <em>negativo</em> (0% casi). (2) <strong>Melanoma Spitzoide</strong> (maligno): PRAME <em>positivo diffuso</em> (>50% cellule). ‚ö† Pattern PRAME+ diffuso in lesione spitzoide = <strong>red flag malignit√†</strong>. Morfologia EE (mitosi, atipia citologica, ulcerazione) essenziale [Lezcano 2018].'
          });
        }

        // ‚≠ê v2.2: PRAME cross-react
        if (p('PRAME') && !p('S100') && !p('SOX10')) {
          dx.push({ 
            name: 'PRAME+ non-melanocitico: Sarcoma vs RCC vs Altri', 
            conf: 'low', 
            detail: 'PRAME+ cross-reattivit√†: (1) Sarcoma Sinoviale 80-90% (morfologia bifasica, vasi emangiopericitoidi, SS18-SSX). (2) RCC (clear cell, cromofobo): check PAX8. (3) Carcinoma sebaceo (raro). Pattern PRAME: se diffuso in contesto melanocitico ‚Üí melanoma; se diffuso + CK+ ‚Üí sarcoma sinoviale [Gradecki 2021].'
          });
        }
      }

      // ‚≠ê NEW v2.8: SOX10 DDx COMPLETO (NotebookLM)
      // SOX10+ mimickers oltre melanoma
      
      // 1. TNBC SOX10+ (69%!) - CRITICO
      if (p('SOX10') && p('CKAE1') && p('GATA3') && n('ER')) {
        dx.push({
          name: 'Carcinoma mammario Triple Negative (TNBC) SOX10+',
          conf: 'high',
          detail: '<strong>SOX10+/CK+/GATA3+/ER‚àí:</strong> 69% TNBC basal-like esprime SOX10 [Ivanov 2013]. Pattern diagnostico: <strong>SOX10 NON esclude carcinoma</strong>. CK+ diffuso forte (vs melanoma CK focale/debole se presente). Clinica: donna, metastasi linfonodo ascellare, imaging mammario. Prognosi: aggressivo, immunoterapia/chemio. <strong>DDx melanoma:</strong> Melan-A/HMB45/PRAME escludono.'
        });
      }

      // 2. MPNST con H3K27me3 loss - CRITICO
      if (p('SOX10') && p('S100') && n('H3K27me3') && n('MelanA') && n('HMB45')) {
        dx.push({
          name: 'MPNST (Malignant Peripheral Nerve Sheath Tumor)',
          conf: 'high',
          detail: '<strong>SOX10+ (49% MPNST) + S100+ (30% MPNST) + H3K27me3 loss nucleare (80-85% spec).</strong> Morfologia: fusocellulare "spina di pesce", pleomorfismo, necrosi, mitosi >10/HPF. Melan-A‚àí/HMB45‚àí esclude melanoma. DDx: schwannoma (H3K27me3 retained). Clinica: NF1 50%, prognosi aggressiva, chemo/RT [Rodriguez 2000].'
        });
      }

      // 3. Schwannoma benigno (H3K27me3 retained)
      if (p('SOX10') && p('S100') && p('H3K27me3') && n('MelanA') && n('HMB45')) {
        dx.push({
          name: 'Schwannoma (benigno)',
          conf: 'high',
          detail: '<strong>SOX10+/S100+ diffuso + H3K27me3 retained (nucleo positivo).</strong> Morfologia: Antoni A/B, corpi Verocay. Melan-A‚àí/HMB45‚àí esclude melanoma. Benigno: exeresi chirurgica, follow-up. DDx: MPNST (H3K27me3 loss, morfologia high-grade) [Rodriguez 2000].'
        });
      }

      // 4. Paraganglioma SOX10+ (rafforzato)
      if (p('SOX10') && p('S100') && p('GATA3') && n('CKAE1') && n('MelanA')) {
        dx.push({
          name: 'Paraganglioma',
          conf: 'high',
          detail: '<strong>SOX10+/S100 periferico (sustentacolare)+/GATA3+/CK‚àí.</strong> Morfologia: pattern Zellballen (nidi), S100 sustentacolare (NON cellule principali). DDx melanoma: GATA3‚àí in melanoma, Melan-A+ in melanoma. Imaging: sede paravascolare (carotideo, aortico, giugulo-timpanico). Prognosi: variabile, gene-specific [Bellizzi 2018].'
        });
      }

      // 5. Tumore mioepiteliale SOX10+
      if (p('SOX10') && p('CKAE1') && (p('p63') || p('p40')) && (p('SMA') || p('Calponin'))) {
        dx.push({
          name: 'Tumore mioepiteliale (salivare/cutaneo)',
          conf: 'high',
          detail: '<strong>SOX10+/CK+/p63 o p40+ (componente basale) + SMA/Calponina+ (lineage contrattile).</strong> Morfologia: pattern bifasico epiteliale + mioide. Sede: ghiandola salivare, cute, mammella. Spettro: adenoma mioepiteliale (benigno) ‚Üí carcinoma mioepiteliale (maligno). Prognosi: dipende grading [WHO 2020].'
        });
      }

      // ‚≠ê NEW v2.3: DDx Schwannoma vs Melanoma (SOX10+)
      if (p('S100') && p('SOX10') && n('MelanA') && n('HMB45')) {
        dx.push({ 
          name: 'Schwannoma vs Melanoma amelanotico', 
          conf: 'medium', 
          detail: 'S100+/SOX10+/Melan-A‚àí/HMB45‚àí: DDx critica. Schwannoma: pattern Antoni A/B, corpi Verocay, GFAP+, S100 uniforme. Melanoma amelanotico: pleomorfismo, mitosi, PRAME+ (83-94%). Morfologia EE essenziale [Rodriguez 2000].'
        });
      }

      // Continue with remaining diagnoses (GCT, Lymphoma, Sarcoma, MMR)...
      // [Same as v2.2 - abbreviated for space]

      // GCT, Lymphoma, Sarcoma, MMR (same as v2.2)
      
      // ========================================
      // GCT
      // ========================================
      
      if (p('OCT34') || p('SALL4') || p('AFP') || p('HCG')) {
        if (p('OCT34') && p('SALL4')) {
          dx.push({ 
            name: 'Seminoma/Disgerminoma', 
            conf: 'high', 
            detail: 'OCT3/4+/SALL4+: seminoma (testicolo) o disgerminoma (ovaio). PLAP+ supporta. Morfologia: cellule uniformi, linfociti, granulomi [WHO 2022].'
          });
        }

        if (p('AFP')) {
          dx.push({ 
            name: 'Yolk Sac Tumor o Epatocarcinoma', 
            conf: 'medium', 
            detail: 'AFP+: yolk sac tumor se giovane + sede gonadica/mediastino/retroperitoneo. HCC se adulto + fegato. GPC3+ supporta yolk sac. Morfologia: corpi Schiller-Duval [Zynger 2008].'
          });
        }

        if (p('HCG')) {
          dx.push({ 
            name: 'Choriocarcinoma o Trofoblasto', 
            conf: 'high', 
            detail: 'Œ≤-HCG+: choriocarcinoma (citotrofoblasto, sinciziotrofoblasto) o componente trofoblastica in mixed GCT. Morfologia: emorragia, necrosi [WHO 2022].'
          });
        }

        if (p('CD30') && !p('CD15')) {
          dx.push({ 
            name: 'Embryonal Carcinoma', 
            conf: 'medium', 
            detail: 'CD30+/CD15‚àí: embryonal carcinoma (90-95% CD30+). Se CD15+ ‚Üí considera linfoma Hodgkin. SALL4+ supporta lineage germinale. Morfologia: cellule epitelioidi, necrosi [Agaimy 2012].'
          });
        }

        if (p('SALL4') && n('OCT34') && n('AFP') && n('HCG')) {
          dx.push({ 
            name: 'SALL4 isolato: GCT vs Adenocarcinoma gastrico', 
            conf: 'low', 
            detail: 'SALL4+ isolato (senza OCT3/4, AFP, HCG): pu√≤ essere GCT MA anche 10-15% adenocarcinomi gastrici. Morfologia + sede + et√† critiche. Se >40 anni + GI ‚Üí favorisce gastrico [Cao 2009].'
          });
        }
      }

      // ========================================
      // LYMPHOMA
      // ========================================
      
      if (p('CD20') || p('CD3') || p('PAX5')) {
        if (p('CD20')) {
          dx.push({ 
            name: 'Linfoma B', 
            conf: 'high', 
            detail: 'CD20+ (o PAX5+): lineage B. Sottotipizzazione: citofluorimetria, FISH, NGS. Morfologia + clinica essenziali [WHO 2017].'
          });
        }

        if (p('CD3')) {
          dx.push({ 
            name: 'Linfoma T', 
            conf: 'high', 
            detail: 'CD3+: lineage T. Sottotipizzazione: CD4, CD8, TCR, FISH. Morfologia + clinica essenziali [WHO 2017].'
          });
        }

        if (p('CD15') && p('CD30')) {
          dx.push({ 
            name: 'Linfoma di Hodgkin classico', 
            conf: 'high', 
            detail: 'CD15+/CD30+: Hodgkin classico (Reed-Sternberg). PAX5+ debole, CD20‚àí tipico. Morfologia: cellule HRS, background [WHO 2017].'
          });
        }

        if (p('ALK')) {
          dx.push({ 
            name: 'ALCL ALK+', 
            conf: 'high', 
            detail: 'ALK+ (CD30+ tipico): ALCL ALK-positivo. Prognosi migliore vs ALK‚àí. Morfologia: hallmark cells [WHO 2017].'
          });
        }
      }

      // ========================================
      // SARCOMA
      // ========================================
      
      if (p('Desmin') || p('SMA') || p('MyoD1') || p('Myogenin')) {
        if (p('MyoD1') || p('Myogenin')) {
          dx.push({ 
            name: 'Rabdomiosarcoma', 
            conf: 'high', 
            detail: 'MyoD1+ o Myogenin+: rabdomiosarcoma. Embrionale (giovani), alveolare (t(2;13) PAX3-FOXO1), pleomorfo (adulti). Desmin+ supporta [WHO 2020].'
          });
        }

        if (p('Desmin') && !p('MyoD1') && !p('Myogenin')) {
          dx.push({ 
            name: 'Sarcoma muscolare liscio (Leiomiosarcoma)', 
            conf: 'medium', 
            detail: 'Desmin+/MyoD1‚àí/Myogenin‚àí: leiomiosarcoma probabile. SMA+, h-Caldesmon+ supportano. Morfologia: fasci, cigar nuclei [WHO 2020].'
          });
        }

        if (p('STAT6')) {
          dx.push({ 
            name: 'Tumore fibroso solitario', 
            conf: 'high', 
            detail: 'STAT6+ (nucleare): SFT (NAB2-STAT6). CD34+ tipico. Morfologia: patternless, vasi ectasici [WHO 2020].'
          });
        }
      }
      
      // ‚≠ê NEW v2.11.1: INI1/SMARCA4 LOSS DIAGNOSES
      const age = parseInt(document.getElementById('patientAge')?.value) || null;
      
      if (n('INI1')) {
        if (age && age < 18) {
          dx.push({
            name: 'Rhabdoid Tumor (AT/RT se SNC)',
            conf: 'high',
            detail: '<strong>INI1/SMARCB1 LOSS + et√† pediatrica (<18 anni).</strong><br>'+
                   'Morfologia: cellule rabdoidi, nucleo eccentrico, inclusioni eosinofiliche citoplasmatiche.<br>'+
                   'Sedi: SNC (AT/RT), rene (RTK), tessuti molli (MRT).<br>'+
                   '<strong>Prognosi:</strong> Aggressivo, mediana 12-18 mesi.<br>'+
                   '<strong>Genetica:</strong> Testare SMARCB1 germline (predisposizione rhabdoid syndrome 35%).<br>'+
                   '<strong>Pattern IHC:</strong> Loss nucleare diffuso (>90%) diagnostico. EMA+, Vim+ frequenti. CK focale possibile.<br>'+
                   '[Hollmann 2011, WHO 2020]'
          });
        } else {
          dx.push({
            name: 'Epithelioid Sarcoma (proximal-type)',
            conf: 'high',
            detail: '<strong>INI1/SMARCB1 LOSS + et√† adulta.</strong><br>'+
                   'Morfologia: epitelioide, cellule grandi, pattern nodulare, necrosi centrale.<br>'+
                   'Sedi: pelvi, perineo, genital tract (proximal-type). Estremit√† distali (distal-type, INI1 retained).<br>'+
                   '<strong>IHC:</strong> EMA+, CK+ (focale-diffuso), CD34+ (50%), Loss INI1 >90% cellule.<br>'+
                   '<strong>Prognosi:</strong> Aggressiva, metastasi polmonari/linfonodali frequenti. Proximal-type peggiore distal.<br>'+
                   '<strong>DDx:</strong> Carcinoma (PAX8‚àí, TTF1‚àí), Melanoma (SOX10‚àí, se dubbio), Sarcoma sinoviale (TLE1‚àí).<br>'+
                   '[Hollmann 2011, WHO 2020]'
          });
        }
      }
      
      if (n('SMARCA4')) {
        const sex = document.getElementById('patientSex')?.value;
        dx.push({
          name: 'SMARCA4-deficient Undifferentiated Carcinoma',
          conf: 'high',
          detail: '<strong>SMARCA4 LOSS (BRG1).</strong><br>'+
                 'Sedi: Ovaio (giovani donne 30-40 anni, <strong>ipercalcemia 60%</strong>), torace (mediastino, polmone), pelvi.<br>'+
                 'Morfologia: indifferenziata, rabdoide-like, pattern solido, necrosi estesa.<br>'+
                 '<strong>IHC:</strong> SMARCA4 loss nucleare diffuso. CK+ focale/diffuso. INI1 retained (DDx rabdoide). CD34‚àí (DDx SMARCB1-def).<br>'+
                 '<strong>Prognosi:</strong> PESSIMA - mediana sopravvivenza 7-10 mesi. Resistente chemioterapia.<br>'+
                 '<strong>Clinica:</strong> Ipercalcemia paraneoplastica (PTHrP) 60% casi. Massa pelvica rapidamente progressiva.<br>'+
                 (sex === 'F' ? '<strong>Alert:</strong> Giovane donna + ipercalcemia + massa pelvica/ovarica ‚Üí Sospetto SMARCA4-def!<br>' : '')+
                 '<strong>DDx:</strong> Small cell carcinoma hypercalcemic type (SCCOHT, identico SMARCA4-def ovaio).<br>'+
                 '[Le Loarer 2015, Jelinic 2016]'
        });
      }

      // ========================================
      // MMR STATUS
      // ========================================
      
      if (t('MLH1') || t('MSH2') || t('MSH6') || t('PMS2')) {
        if (n('MLH1') && n('PMS2')) {
          dx.push({ 
            name: 'dMMR: Loss MLH1/PMS2', 
            conf: 'high', 
            detail: 'MLH1‚àí/PMS2‚àí (MSH2+/MSH6+ retained): sporadico (metilazione promotore MLH1) 90%. Test: BRAF V600E (mut ‚Üí sporadico), metilazione MLH1. Se BRAF WT ‚Üí considera Lynch. Clinica: et√† >60 anni favorisce sporadico [Shia 2008, Haraldsdottir 2014].'
          });
        }

        if (n('MSH2') && n('MSH6')) {
          dx.push({ 
            name: 'dMMR: Loss MSH2/MSH6 - LYNCH SYNDROME', 
            conf: 'high', 
            detail: 'MSH2‚àí/MSH6‚àí (MLH1+/PMS2+ retained): <strong>Lynch syndrome</strong> (mutazione germinale MSH2) fino a prova contraria. ‚ö† Counseling genetico IMMEDIATO. Raro sporadico (<5%). Et√† giovane (<50), storia familiare [Haraldsdottir 2014].'
          });
        }

        if (n('PMS2') && !n('MLH1')) {
          dx.push({ 
            name: 'dMMR: Loss PMS2 isolata', 
            conf: 'medium', 
            detail: 'PMS2‚àí isolato (MLH1+ retained): Lynch PMS2 possibile o metilazione somatica PMS2 (rara). Test genetico PMS2. Interpretazione complessa [Shia 2008].'
          });
        }

        if (n('MSH6') && !n('MSH2')) {
          dx.push({ 
            name: 'dMMR: Loss MSH6 isolata', 
            conf: 'medium', 
            detail: 'MSH6‚àí isolato (MSH2+ retained): Lynch MSH6 possibile (mutazione germinale MSH6). Counseling genetico. Penetranza ridotta vs MLH1/MSH2 [Haraldsdottir 2014].'
          });
        }
      }

      return dx;
    }
    // ============================================
    // ‚≠ê NEW v2.10: SITE-SPECIFIC ALERTS (NotebookLM)
    // ============================================
    
    function getSiteSpecificAlerts() {
      const site = document.getElementById('biopsySite')?.value;
      const sex = document.getElementById('patientSex')?.value;
      const age = parseInt(document.getElementById('patientAge')?.value) || null;
      const alerts = [];
      
      // 1. Linfonodo cervicale
      if (site === 'ln_cervical') {
        if (age && age < 40 && sex === 'F') {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Linfonodo Cervicale Giovane Donna',
            detail: '<strong>Priorit√† et√†/sesso-dipendente:</strong><br>'+
                   '1. <strong>Tiroide (PTC)</strong>: TTF1/Tireoglobulina/PAX8 (morfologia: papille, nuclei ground glass)<br>'+
                   '2. <strong>Linfoma</strong>: CD45, pannello linfoma<br>'+
                   '3. SCC H&N (meno probabile giovane donna)<br>'+
                   '<strong>Testing SCC:</strong> p16/HPV (orofaringe), EBV/EBER (rinofaringe) [NotebookLM 2026].'
          });
        } else {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Linfonodo Cervicale',
            detail: '<strong>Entit√† probabilistiche:</strong> SCC (H&N, polmone, cervice), Tiroide (PTC), Adenocarcinoma, Linfoma.<br>'+
                   '<strong>Percorso rapido:</strong><br>'+
                   '‚Ä¢ Se morfologia SCC: p40/CK5/6 + p16/HPV (orofaringe) + EBV/EBER (rinofaringe)<br>'+
                   '‚Ä¢ Se morfologia tiroide: TTF1/Tireoglobulina/PAX8 (triade mandataria)<br>'+
                   '‚Ä¢ Uomo anziano fumatore ‚Üí SCC priorit√† [NotebookLM 2026].'
          });
        }
      }
      
      // 2. Linfonodo ascellare
      if (site === 'ln_axillary') {
        if (sex === 'F') {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Linfonodo Ascellare Donna ("Breast-like CUP")',
            detail: '<strong>Mammella >90% probabilit√†.</strong><br>'+
                   '<strong>SALTARE Big Four ‚Üí Site-specific IMMEDIATI:</strong><br>'+
                   '‚Ä¢ GATA3 (sens >90% mammella)<br>'+
                   '‚Ä¢ ER/TRPS1<br>'+
                   '‚Ä¢ Mammoglobin (spec alta)<br>'+
                   '<strong>Morfologia "Indian-file" discoesivo ‚Üí lobulare favorito.</strong><br>'+
                   'Se CK‚àí + cellule epitelioidi ‚Üí SOX10 (melanoma 95-100%) [NotebookLM 2026].'
          });
        } else {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Linfonodo Ascellare',
            detail: '<strong>DDx:</strong> Melanoma (SOX10), Polmone (TTF1/Napsina), Linfoma (CD45).<br>'+
                   'Mammella maschio possibile ma raro (<1%).'
          });
        }
      }
      
      // 3. Linfonodo inguinale
      if (site === 'ln_inguinal') {
        alerts.push({
          type: 'advisory',
          title: 'üéØ SEDE ‚Äî Linfonodo Inguinale',
          detail: '<strong>Priorit√† SCC ano-genitale:</strong><br>'+
                 '‚Ä¢ p40 + p16/HPV (vulva, vagina, pene, ano)<br>'+
                 '‚Ä¢ p16+ ‚Üí HPV-related (prognosi favorevole)<br>'+
                 '<strong>DDx:</strong><br>'+
                 '‚Ä¢ Melanoma acrale/vulvare (SOX10/PRAME)<br>'+
                 '‚Ä¢ Uroteliale (GATA3/CK17 invasione locale vescica)<br>'+
                 '‚Ä¢ Colorettale (RARO, solo se morfologia intestinale) [NotebookLM 2026].'
        });
      }
      
      // 4. Metastasi epatica
      if (site === 'liver') {
        if (document.getElementById('cyto_clear')?.checked) {
          alerts.push({
            type: 'redflag',
            title: '‚ö†Ô∏è SEDE ‚Äî Fegato Clear Cell',
            detail: '<strong>PAX8 priorit√† ASSOLUTA (RCC 83-98% clear cell epatica).</strong><br>'+
                   'SALTARE workup GI (statisticamente improbabile clear cell).<br>'+
                   'CA-IX/CD10 supporto RCC [NotebookLM 2026].'
          });
        } else {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Metastasi Epatica',
            detail: '<strong>Big Four + Site-specific INSIEME:</strong><br>'+
                   '1. CDX2/SATB2 (colon - pi√π frequente)<br>'+
                   '2. Arginasi (HCC primitivo)<br>'+
                   '3. PAX8 (RCC)<br>'+
                   '4. Synaptophysin/INSM1 (NET)<br>'+
                   '5. BCL10 se granuli zimogeni visibili (acinare pancreas) [NotebookLM 2026].'
          });
        }
      }
      
      // 5. Metastasi ossea
      if (site === 'bone') {
        if (sex === 'M') {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Osso Maschio',
            detail: '<strong>"Cinque Grandi" metastasi ossee (LEAN PANEL):</strong><br>'+
                   '1. Prostata (PSA/NKX3/ERG) - pi√π frequente<br>'+
                   '2. Polmone (TTF1)<br>'+
                   '3. RCC (PAX8)<br>'+
                   '4. Tiroide (TTF1/Tireoglobulina)<br>'+
                   '5. Melanoma (SOX10)<br>'+
                   '<strong>Big Four CONFONDE.</strong> Site-specific diretto migliore.<br>'+
                   'Osteoclasti-like: tumore osso primitivo o carcinoma alto grado [NotebookLM 2026].'
          });
        } else if (sex === 'F') {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Osso Femmina',
            detail: '<strong>"Cinque Grandi" metastasi ossee (LEAN PANEL):</strong><br>'+
                   '1. Mammella (GATA3/ER/TRPS1) - pi√π frequente<br>'+
                   '2. Polmone (TTF1)<br>'+
                   '3. RCC (PAX8)<br>'+
                   '4. Tiroide (TTF1/Tireoglobulina)<br>'+
                   '5. Ovaio (PAX8/WT1/ER)<br>'+
                   '<strong>Big Four CONFONDE.</strong> Site-specific diretto migliore [NotebookLM 2026].'
          });
        }
      }
      
      // 6. Metastasi polmonare
      if (site === 'lung') {
        if (document.getElementById('arch_lepidic')?.checked) {
          alerts.push({
            type: 'advisory',
            title: '‚ÑπÔ∏è SEDE ‚Äî Polmone Pattern Lepidico',
            detail: '<strong>Pattern lepidico (crescita alveolare) ‚Üí Polmone 95%+ probabilit√†.</strong><br>'+
                   'TTF1/Napsina A <strong>confermativi</strong> (diagnosi quasi fatta da morfologia).<br>'+
                   'Rara simulazione pancreatica [NotebookLM 2026].'
          });
        } else {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Metastasi Polmonare',
            detail: '<strong>DDx critico: Primitivo vs Metastasi</strong><br>'+
                   'TTF1+/Napsina A+ ‚Üí Primitivo polmonare FAVORITO<br>'+
                   '<strong>TTF1+ mimickers:</strong><br>'+
                   '‚Ä¢ Tiroide (PAX8+, Tireoglobulina+)<br>'+
                   '‚Ä¢ NEC extrapolmonare (Synaptophysin+)<br>'+
                   '‚Ä¢ Rari GI/ginecologici [NotebookLM 2026].'
          });
        }
      }
      
      // 7. Versamento sieroso
      if (site === 'effusion') {
        if (age && age < 50 && sex === 'F') {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Versamento Giovane Donna',
            detail: '<strong>Priorit√† Ovaio Sieroso HG (triade):</strong><br>'+
                   '‚Ä¢ WT1+ / PAX8+ / ER+<br>'+
                   '‚Ä¢ CA-125 sierico essenziale<br>'+
                   '<strong>DDx Mesotelioma:</strong> 2/3 positivi Calretinina/WT1/D2-40<br>'+
                   '<strong>DDx Adenocarcinoma:</strong> 2/3 positivi MOC31/BerEP4/PAX8 [NotebookLM 2026].'
          });
        } else {
          alerts.push({
            type: 'advisory',
            title: 'üéØ SEDE ‚Äî Versamento Sieroso',
            detail: '<strong>Mesotelioma vs Adenocarcinoma (2/3 positivi):</strong><br>'+
                   '<strong>Mesotelioma:</strong> Calretinina, WT1, D2-40<br>'+
                   '<strong>Adenocarcinoma:</strong> MOC31, BerEP4, PAX8<br>'+
                   '<strong>Ovaio sieroso (triade):</strong> WT1+/PAX8+/ER+ [NotebookLM 2026].'
          });
        }
      }
      
      return alerts;
    }
    
    // ============================================
    // ‚≠ê NEW v2.11: QC TECHNICAL ALERTS (NotebookLM #3)
    // ============================================
    
    function getQCAlerts() {
      const alerts = [];
      
      // ‚≠ê NEW v2.11.1: PATTERN NULL - PRIMO ALERT (CRITICO!)
      if (n('CKAE1') && n('CD45') && n('Vim') && n('S100')) {
        alerts.push({
          type: 'redflag',
          title: '‚ö†Ô∏è CRITICAL ‚Äî Pattern Null: First-Line Tutti Negativi',
          detail: '<strong>Tutti marker first-line NEGATIVI (CK‚àí/CD45‚àí/Vim‚àí/S100‚àí)</strong><br><br>'+
                 '<strong>‚ö†Ô∏è STOP WORKFLOW IHC ‚Üí Rivalutare approccio!</strong><br><br>'+
                 '<strong>Possibili scenari (6):</strong><br><br>'+
                 '<strong>1. SWI/SNF-deficient tumor (INI1/SMARCA4 LOSS):</strong><br>'+
                 '‚Ä¢ <strong>Rabdoide tumor</strong> (pediatrico, INI1 loss): cellule rabdoidi, inclusioni eosinofile<br>'+
                 '‚Ä¢ <strong>Epithelioid sarcoma</strong> (adulto, INI1 loss): epitelioide, necrosi centrale<br>'+
                 '‚Ä¢ <strong>SMARCA4-deficient CA</strong> (ovaio giovani, torace): indifferenziato, ipercalcemia 60%<br>'+
                 '‚Üí <strong>TESTARE INI1/SMARCB1 e SMARCA4</strong> se morfologia compatibile!<br><br>'+
                 '<strong>2. Melanoma amelanotico (S100‚àí variante 5-10%):</strong><br>'+
                 '‚Ä¢ Testare HMB45/Melan-A (positivi anche se S100‚àí)<br>'+
                 '‚Ä¢ SOX10 pu√≤ essere positivo (95% melanomi)<br>'+
                 '‚Ä¢ Morfologia: epitelioide, nucleoli prominenti<br><br>'+
                 '<strong>3. Sarcoma indifferenziato/monomorfo:</strong><br>'+
                 '‚Ä¢ TLE1 (sarcoma sinoviale monofasico)<br>'+
                 '‚Ä¢ STAT6 (SFT)<br>'+
                 '‚Ä¢ MDM2/CDK4 (liposarcoma dedifferenziato)<br>'+
                 '‚Ä¢ FLI1/ERG (sarcoma Ewing-like se giovane)<br><br>'+
                 '<strong>4. ERRORE TECNICO (fallimento IHC globale):</strong><br>'+
                 '‚Üí <strong>Verificare controlli positivi IMMEDIATO!</strong><br>'+
                 '‚Üí Se controlli negativi ‚Üí ripetere TUTTO pannello<br>'+
                 '‚Üí Problema retrieval, reagenti, automazione?<br><br>'+
                 '<strong>5. ARTEFATTO PRE-ANALITICO:</strong><br>'+
                 '‚Üí Fissazione ritardata/non tamponata (loss antigeni)<br>'+
                 '‚Üí Decalcificazione eccessiva (metastasi ossea? loss nucleari)<br>'+
                 '‚Üí Tissue aging >2 settimane (degradazione)<br>'+
                 '‚Üí Verificare storia pre-analitica campione<br><br>'+
                 '<strong>6. NON NEOPLASIA:</strong><br>'+
                 '‚Üí Processo reattivo/infiammatorio/riparativo<br>'+
                 '‚Üí Necrosi estesa<br>'+
                 '‚Üí Fibrosi<br>'+
                 '‚Üí <strong>Rivedere morfologia EE attentamente!</strong><br><br>'+
                 '<strong>üî¥ AZIONE MANDATARIA:</strong><br>'+
                 '1. STOP ulteriori marker (risparmia tessuto)<br>'+
                 '2. Rivalutare morfologia EE con attenzione<br>'+
                 '3. Verificare controlli IHC positivi<br>'+
                 '4. Se morfologia rabdoide/epitelioide/indifferenziato ‚Üí INI1/SMARCA4<br>'+
                 '5. Se morfologia melanoma ‚Üí HMB45/Melan-A (anche se S100‚àí)<br>'+
                 '6. Considerare CONSULENZA se pattern persiste<br>'+
                 '7. Considerare microscopia elettronica se tutto negativo<br><br>'+
                 '[Validazione QC pattern null - v2.11.1]'
        });
      }
      
      // 1. PAX8 cross-react linfomi
      if (p('PAX8') && (p('CD45') || document.getElementById('cyto_lymphoid')?.checked)) {
        alerts.push({
          type: 'redflag',
          title: '‚ö†Ô∏è TECHNICAL ‚Äî PAX8+ Pattern Linfoide',
          detail: '<strong>PAX8+ (cloni policlonali/MRQ-50) cross-react linfomi B e linfoidi reattivi</strong> (epitopo N-terminale PAX5).<br><br>'+
                 'Se morfologia LINFOIDE + PAX8+:<br>'+
                 '‚Üí SOSPETTO cross-react tecnico<br>'+
                 '‚Üí Ripetere con clone monoclonale <strong>BC12 o MSVA-708R</strong><br>'+
                 '‚Üí Testare CD45/CD20 conferma linfoma<br><br>'+
                 '[Bellizzi 2013 - Validazione tecnica]'
        });
      }
      
      // 2. Decalcificazione ossea
      const site = document.getElementById('biopsySite')?.value;
      if (site === 'bone' && (n('PAX8') || n('ER') || n('TTF1'))) {
        alerts.push({
          type: 'advisory',
          title: '‚ö†Ô∏è PRE-ANALITICA ‚Äî Metastasi Ossea + Marker Nucleari Loss',
          detail: '<strong>Decalcificazione acidi forti DISTRUGGE antigenicit√† nucleare:</strong><br>'+
                 '‚Ä¢ PAX8, ER, PR: loss confermato ‚ùå<br>'+
                 '‚Ä¢ TTF1, NKX3: dati limitati (probabilmente resistenti)<br><br>'+
                 'Se metastasi ossea + marker nucleari negativi INATTESI:<br>'+
                 '‚Üí Sospetto artefatto decalcificazione<br>'+
                 '‚Üí <strong>Gold standard:</strong> Protocollo Hammersmith (zinco-formalin + acido formico)<br><br>'+
                 '[Hammersmith Protocol - Validazione pre-analitica]'
        });
      }
      
      // 3. AE1/AE3 fallimento HCC/RCC
      if (n('CKAE1') && (p('Arginasi') || p('PAX8') || p('RCC'))) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è CLONE ‚Äî CK AE1/AE3‚àí + Morfologia HCC/RCC',
          detail: '<strong>AE1/AE3 NON riconosce CK18</strong> (espressa stabilmente HCC/RCC).<br><br>'+
                 'Se morfologia HCC/RCC MA CK AE1/AE3‚àí:<br>'+
                 '‚Üí NON escludere carcinoma!<br>'+
                 '‚Üí Testare <strong>CK8/18 diretto</strong><br>'+
                 '‚Üí Site-specific: Arginasi (HCC), PAX8 (RCC)<br><br>'+
                 '[Validazione clone-specific]'
        });
      }
      
      // 4. CD56 tiroide
      if (p('CD56') && site === 'ln_cervical') {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è SPECIFICIT√Ä ‚Äî CD56+ Massa Collo',
          detail: '<strong>CD56 marker NE POCO specifico:</strong><br>'+
                 '‚Ä¢ Tiroide normale/PTC: 100% CD56+! ‚ùå<br>'+
                 '‚Ä¢ Tumori ematologici: cross-react massivo<br><br>'+
                 'CD56+ massa collo:<br>'+
                 '‚Üí NON assume NE senza morfologia/altri marker<br>'+
                 '‚Üí Considerare tiroide: TTF1/Tireoglobulina/PAX8<br>'+
                 '‚Üí <strong>Synaptophysin/INSM1 pi√π specifici NE</strong><br><br>'+
                 '[Validazione sensibilit√†/specificit√†]'
        });
      }
      
      // 5. p16 pattern non-block
      if (p('p63') && !t('p16')) {
        // Suggerisci p16 se p63+ (spesso SCC)
      } else if (p('p16')) {
        // Alert pattern se p16+
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è PATTERN ‚Äî p16+ HPV Surrogate',
          detail: '<strong>p16 HPV-surrogate richiede pattern BLOCK-LIKE:</strong><br>'+
                 '‚Ä¢ Forte + diffuso nucleare E citoplasmatico ‚úÖ<br><br>'+
                 '<strong>p16+ focale o debole:</strong><br>'+
                 '‚Üí Senescenza cellulare (meccanismo INK4A, NON HPV) ‚ùå<br>'+
                 '‚Üí NON utilizzare come surrogato HPV<br><br>'+
                 'Se dubbio ‚Üí <strong>HPV ISH diretto</strong><br><br>'+
                 '[Validazione molecolare]'
        });
      }
      
      // 6. TTF1 citoplasmatico (HCC cross-react)
      if (p('TTF1') && (p('Arginasi') || p('HSA'))) {
        alerts.push({
          type: 'advisory',
          title: '‚ö†Ô∏è SUBCELLULAR ‚Äî TTF1+ Pattern HCC',
          detail: '<strong>TTF1 DEVE essere NUCLEARE.</strong> Pattern citoplasmatico = cross-react HCC (clone 8G7G3/1).<br><br>'+
                 'Se TTF1+ + Arginasi/Hep-Par-1+:<br>'+
                 '‚Üí Verificare localizzazione TTF1<br>'+
                 '‚Üí Se TTF1 SOLO citoplasmatico ‚Üí IGNORARE (errore tecnico)<br>'+
                 '‚Üí Se TTF1 nucleare ‚Üí considera polmone/tiroide<br><br>'+
                 '<strong>Marker nucleari assoluti:</strong> PAX8, TTF1, NKX3, ER, GATA3, p40, SALL4, OCT4, SOX10, Œ≤-catenina<br><br>'+
                 '[Validazione QC subcellulare]'
        });
      }
      
      // 7. CK7+/CK20+ uroteliale alert
      if (p('CK7') && p('CK20') && !t('GATA3') && !t('SATB2')) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è PATTERN ‚Äî CK7+/CK20+: NON Solo Colon!',
          detail: '<strong>Pattern CK7+/CK20+ include:</strong><br>'+
                 '‚Ä¢ Uroteliale: 50-60%! üî•<br>'+
                 '‚Ä¢ Pancreas: 10-20%<br>'+
                 '‚Ä¢ Colangiocarcinoma<br>'+
                 '‚Ä¢ Appendice (ex-goblet cell)<br><br>'+
                 '<strong>Discriminanti necessari:</strong><br>'+
                 '‚Ä¢ SATB2 (colon 99% spec) - testare se non fatto<br>'+
                 '‚Ä¢ GATA3 (uroteliale) - testare se non fatto<br>'+
                 '‚Ä¢ Morfologia + clinica essenziali<br><br>'+
                 '[NotebookLM 2026 - Pattern evolved]'
        });
      }
      
      // 8. CK7-/CK20+ Merkel alert
      if (n('CK7') && p('CK20') && !t('INSM1') && !t('Synapt')) {
        alerts.push({
          type: 'advisory',
          title: '‚ö†Ô∏è DDx ‚Äî CK7‚àí/CK20+: Merkel vs Colon',
          detail: '<strong>Pattern CK7‚àí/CK20+ suggerisce colon (75-95%)</strong><br>'+
                 'MA pitfall <strong>Merkel Cell Carcinoma!</strong><br><br>'+
                 '<strong>Merkel cell:</strong><br>'+
                 '‚Ä¢ CK20+ "dot-like" perinucleare ‚ö†Ô∏è<br>'+
                 '‚Ä¢ Synaptophysin+, INSM1+<br>'+
                 '‚Ä¢ MCPyV+ (80%)<br>'+
                 '‚Ä¢ Morfologia: small blue cell, derma<br><br>'+
                 'Se morfologia NE-like + CK20+ ‚Üí <strong>testare INSM1!</strong><br><br>'+
                 '[NotebookLM 2026 - Pattern impossibili]'
        });
      }
      
      return alerts;
    }
    
    // ============================================
    // ‚≠ê NEW v2.11: BIG FOUR FUTILITY ALERTS (NotebookLM #4)
    // ============================================
    
    function getBigFourFutilityAlerts() {
      const alerts = [];
      
      // 1. Morfologia squamosa
      if (p('p40') || p('p63') || document.getElementById('arch_squamous')?.checked) {
        alerts.push({
          type: 'redflag',
          title: '‚ö†Ô∏è WORKFLOW ‚Äî Morfologia Squamosa: Big Four Inutile',
          detail: '<strong>Pattern squamoso (p40+) ‚Üí Big Four CONTROINDICATO</strong><br>'+
                 '(workup adenocarcinoma inappropriato)<br><br>'+
                 '<strong>Workflow corretto:</strong><br>'+
                 '‚Ä¢ p40 (squamoso 98% spec)<br>'+
                 '‚Ä¢ p16 (HPV surrogate se block-like)<br>'+
                 '‚Ä¢ SOX10 se CK‚àí (melanoma desmoplastico)<br><br>'+
                 '[NotebookLM 2026 - Morfologia bypassa Big Four]'
        });
      }
      
      // 2. Pattern lepidico
      if (document.getElementById('arch_lepidic')?.checked) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è WORKFLOW ‚Äî Pattern Lepidico: CK7 Ridondante',
          detail: '<strong>Morfologia lepidica (crescita alveolare):</strong><br>'+
                 '‚Üí Polmone 95%+ probabilit√†<br>'+
                 '‚Üí TTF1/Napsina A CONFIRMATORI<br>'+
                 '‚Üí CK7 spreco tessuto (ovvio CK7+)<br><br>'+
                 '<strong>Preservare tessuto per EGFR/ALK/ROS1/PD-L1!</strong><br><br>'+
                 '[NotebookLM 2026 - Tissue-sparing]'
        });
      }
      
      // 3. Pattern signet-ring
      if (document.getElementById('cyto_signet')?.checked) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è WORKFLOW ‚Äî Signet-Ring: Big Four Generico',
          detail: '<strong>Pattern signet-ring ‚Üí Big Four troppo ampio</strong><br><br>'+
                 '<strong>Pannello mirato:</strong><br>'+
                 '‚Ä¢ GI: CDX2/SATB2<br>'+
                 '‚Ä¢ Mammella lobulare: GATA3/TRPS1/E-cadherin loss<br>'+
                 '‚Ä¢ Gastrico: HER2 (terapeutico!)<br><br>'+
                 '[NotebookLM 2026 - Site-specific immediato]'
        });
      }
      
      // 4. Pattern clear cell
      if (document.getElementById('cyto_clear')?.checked) {
        alerts.push({
          type: 'redflag',
          title: '‚ö†Ô∏è WORKFLOW ‚Äî Clear Cell: PAX8 Obbligatorio',
          detail: '<strong>Morfologia clear cell ‚Üí Big Four spreco tessuto</strong><br><br>'+
                 '<strong>Workflow corretto:</strong><br>'+
                 '‚Ä¢ PAX8 priorit√† assoluta (rene/ovaio)<br>'+
                 '‚Ä¢ pVHL/CA-IX (RCC)<br>'+
                 '‚Ä¢ HNF-1Œ≤ (ovaio clear cell)<br><br>'+
                 '<strong>Preservare tessuto per target therapy!</strong><br><br>'+
                 '[NotebookLM 2026 - Morfologia detta chimica]'
        });
      }
      
      // 5. Versamento sieroso
      const site = document.getElementById('biopsySite')?.value;
      if (site === 'effusion') {
        alerts.push({
          type: 'redflag',
          title: '‚ö†Ô∏è WORKFLOW ‚Äî Versamento: Big Four Errore Metodologico',
          detail: '<strong>Versamento pleurico/peritoneale:</strong><br>'+
                 '‚Üí Big Four upfront SBAGLIATO!<br><br>'+
                 '<strong>Pannello simultaneo corretto:</strong><br>'+
                 '‚Ä¢ Mesotelio: Calretinina/WT1/D2-40 (2/3 pos)<br>'+
                 '‚Ä¢ Adenocarcinoma: Ber-EP4/MOC31/PAX8 (2/3 pos)<br>'+
                 '‚Ä¢ Ovaio: WT1+/PAX8+/ER+ (triade)<br><br>'+
                 '[NotebookLM 2026 - Sede bypassa Big Four]'
        });
      }
      
      // 6. CK7-/CK20- curabili-first
      if (n('CK7') && n('CK20') && p('CKAE1')) {
        alerts.push({
          type: 'advisory',
          title: '‚≠ê WORKFLOW ‚Äî CK7‚àí/CK20‚àí: Curabili-First v2.8',
          detail: '<strong>Big Four fallito ‚Üí Alternative validate "Big Three":</strong><br><br>'+
                 '<strong>Priorit√† STEP 2 CURABILI (gi√† implementato):</strong><br>'+
                 '1. SALL4 (GCT curabile 100% sens)<br>'+
                 '2. Synaptophysin/INSM1 (NEC chemiosensibile)<br>'+
                 '3. p40 (SCC cambia iter)<br>'+
                 '4. PAX8 (RCC/tiroide/ovaio)<br><br>'+
                 '<strong>DOPO esclusione curabili ‚Üí Step 4 organo-specifici:</strong><br>'+
                 '‚Ä¢ Arginasi (HCC)<br>'+
                 '‚Ä¢ NKX3 (prostata maschi) / GATA3 (mammella femmine)<br><br>'+
                 '<strong>Risparmio tessuto per NGS/MMR/PD-L1!</strong><br><br>'+
                 '[SEOM-GECOD, ESMO 2023, NotebookLM]'
        });
      }
      
      // 7. MSI-H morfologia (loss CK20/CDX2)
      if (document.getElementById('arch_solid')?.checked && 
          document.getElementById('cyto_lymphoid')?.checked) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è MOLECOLARE ‚Äî Morfologia Midollare: Testare MMR',
          detail: '<strong>Morfologia solida + TILs prominenti suggerisce MSI-H</strong><br><br>'+
                 '<strong>Carcinoma midollare MSI-H:</strong><br>'+
                 '‚Ä¢ Loss CK20/CDX2 frequente! ‚ö†Ô∏è<br>'+
                 '‚Ä¢ <strong>SATB2 mantiene espressione</strong> (marker salvataggio)<br><br>'+
                 'Se morfologia midollare + CK20‚àí/CDX2‚àí:<br>'+
                 '‚Üí NON escludere colon!<br>'+
                 '‚Üí <strong>Testare SATB2</strong><br>'+
                 '‚Üí <strong>Testare MMR (MLH1/MSH2/MSH6/PMS2)</strong><br><br>'+
                 'MSI-H = target therapy (anti-PD1)!<br><br>'+
                 '[NotebookLM 2026 - Pattern atipici]'
        });
      }
      
      return alerts;
    }
    
    // ============================================
    // ‚≠ê NEW v2.13: EPISTEMIC ALERTS (NotebookLM "Umilt√† Epistemica")
    // ============================================
    
    function getEpistemicAlerts() {
      const alerts = [];
      
      // Controlla se ci sono diagnosi con high confidence basate su singolo marker
      const diagnoses = getDiagnoses();
      const highConfDx = diagnoses.filter(d => d.conf === 'high');
      
      // Alert 1: MORFOLOGIA > REAGENTE (universale, sempre mostrato se diagnosi presenti)
      if (diagnoses.length > 0) {
        alerts.push({
          type: 'advisory',
          title: 'üî¨ RIGORE EPISTEMICO ‚Äî Morfologia EE Priorit√† Assoluta',
          detail: '<strong>"Il vetrino non mente, il reagente s√¨"</strong> ‚Äî Scuola Rosai<br><br>'+
                 '<strong>Se morfologia EE e IHC sono DISCORDANTI:</strong><br>'+
                 '‚Üí Morfologia EE ha <strong>priorit√† epistemica</strong><br>'+
                 '‚Üí Il reagente pu√≤ mentire per:<br>'+
                 '&nbsp;&nbsp;‚Ä¢ Dedifferenziazione (loss marker lineage)<br>'+
                 '&nbsp;&nbsp;‚Ä¢ Plasticit√† fenotipica (gain marker aberranti)<br>'+
                 '&nbsp;&nbsp;‚Ä¢ Adattamento microambiente (es. Arg-1+ metastasi epatiche)<br>'+
                 '&nbsp;&nbsp;‚Ä¢ Cross-reattivit√† tecnica (es. PAX8+ linfomi clone policlonale)<br>'+
                 '&nbsp;&nbsp;‚Ä¢ Effetti terapeutici (es. NKX3 loss post-ADT)<br><br>'+
                 '<strong>‚ö†Ô∏è AZIONE MANDATORIA:</strong><br>'+
                 'Se incompatibilit√† morfologia-IHC, scrivere nel referto:<br>'+
                 '<em>"Il profilo immunofenotipico suggerisce [diagnosi X], tuttavia la morfologia EE non √® pienamente compatibile. '+
                 'Si raccomanda correlazione clinica, imaging e/o conferma molecolare."</em><br><br>'+
                 '<strong>L\'onest√† dell\'incompletezza √® l\'unico rigore che ci resta.</strong><br>'+
                 '[NotebookLM 2026 ‚Äî Avvocato del Diavolo]'
        });
      }
      
      // Alert 2: SINGLE MARKER ‚â† CERTEZZA (se ci sono diagnosi high confidence)
      if (highConfDx.length > 0) {
        alerts.push({
          type: 'advisory',
          title: '‚ö†Ô∏è HIGH CONFIDENCE ‚â† CERTEZZA ASSOLUTA',
          detail: '<strong>Marker con "High Confidence" (>90% sensibilit√†) sono PROBABILIT√Ä BAYESIANE,<br>'+
                 'NON verit√† ontologiche!</strong><br><br>'+
                 '<strong>Eccezioni documentate in letteratura:</strong><br>'+
                 '‚Ä¢ <strong>Arginasi-1+</strong> mammella metastatica fegato: <strong>12.3%</strong> (upregulation metabolica!)<br>'+
                 '‚Ä¢ <strong>INSM1+</strong> adenocarcinoma prostata: <strong>36.1%</strong> (1/3 casi! plasticit√† fenotipica, NON NE)<br>'+
                 '‚Ä¢ <strong>TRPS1+</strong> ovaio sieroso: <strong>40.5%</strong> (met√† dei casi! NON solo mammella)<br>'+
                 '‚Ä¢ <strong>NKX3.1 loss</strong> prostata post-ADT: <strong>20-30%</strong> (terapia sopprime marker!)<br>'+
                 '‚Ä¢ <strong>SOX10+</strong> TNBC: <strong>69%</strong> (simula melanoma!)<br>'+
                 '‚Ä¢ <strong>CK7‚àí/CK20‚àí</strong> colorettale MSI-H: frequente (dedifferenziazione)<br><br>'+
                 '<strong>‚ö†Ô∏è REGOLA:</strong> UN marker positivo ‚â† diagnosi conclusa<br>'+
                 '‚Üí Sempre contestualizzare: morfologia + clinica + imaging + pannello completo<br>'+
                 '‚Üí Se dubbio ‚Üí conferma molecolare (NGS, FISH, PCR)<br><br>'+
                 '<strong>Il reagente ha un\'agenda biologica che spesso non coincide con la nostra tassonomia d\'organo.</strong><br>'+
                 '[NotebookLM 2026 ‚Äî Karamchandani 2013, Rooper 2017, Khani 2014]'
        });
      }
      
      // Alert 3: PLASTICIT√Ä FENOTIPICA TUMORI ALTO GRADO
      const mitosi = document.getElementById('mitosi')?.checked;
      const necrosi = document.getElementById('necrosi')?.checked;
      const highGradeMorph = mitosi || necrosi;
      
      if (highGradeMorph) {
        alerts.push({
          type: 'advisory',
          title: 'üß¨ PLASTICIT√Ä FENOTIPICA ‚Äî Tumori Alto Grado',
          detail: '<strong>Morfologia alto grado (necrosi/mitosi elevate):</strong><br>'+
                 '‚Üí DEDIFFERENZIAZIONE ‚Üí loss marker lineage attesi<br>'+
                 '‚Üí PLASTICIT√Ä FENOTIPICA ‚Üí gain marker "impossibili"<br><br>'+
                 '<strong>Pattern "impossibili" documentati:</strong><br>'+
                 '‚Ä¢ Adenocarcinoma prostata <strong>INSM1+</strong> (36%!) ‚Üí NON NEC, √® plasticit√†!<br>'+
                 '‚Ä¢ Carcinoma mammario <strong>Arginasi-1+</strong> (12%) ‚Üí NON HCC, √® adattamento metabolico!<br>'+
                 '‚Ä¢ TNBC <strong>SOX10+</strong> (69%!) ‚Üí NON melanoma, √® aberrazione!<br>'+
                 '‚Ä¢ Colorettale MSI-H <strong>CK20‚àí/CDX2‚àí</strong> (frequente!) ‚Üí Loss per dedifferenziazione<br>'+
                 '‚Ä¢ Prostata post-ADT <strong>PSA‚àí/NKX3‚àí</strong> (30-50%) ‚Üí Terapia sopprime marker<br><br>'+
                 '<strong>‚ö†Ô∏è IN TUMORI ALTO GRADO:</strong><br>'+
                 '‚Üí <strong>Morfologia EE > IHC</strong> (sempre!)<br>'+
                 '‚Üí Pattern IHC "strano" √® ATTESO, non errore<br>'+
                 '‚Üí Interpretare marker con massima cautela<br>'+
                 '‚Üí Conferma molecolare raccomandata (NGS, FISH)<br><br>'+
                 '<strong>Le citocheratine sono le prime a "mentire" sotto la pressione della dedifferenziazione.</strong><br>'+
                 '[NotebookLM 2026 ‚Äî Big Four Futility]'
        });
      }
      
      return alerts;
    }
    
    // ============================================
    // PART 4: ALERTS, SUGGESTIONS, GAPS v2.3
    // ============================================

    function getAlerts() {
      const alerts = [];

      // Curable neoplasms
      if (p('CD20') || p('CD3') || p('CD15')) {
        alerts.push({ 
          type: 'curable', 
          title: 'üíä CURABLE ‚Äî Linfoma', 
          detail: 'Linfoma: potenzialmente curabile. Sottotipizzazione urgente per terapia target. Flow cytometry, FISH, NGS raccomandati [WHO 2017].'
        });
      }

      if ((p('OCT34') || p('SALL4')) && (p('AFP') || p('HCG'))) {
        alerts.push({ 
          type: 'curable', 
          title: 'üíä CURABLE ‚Äî GCT', 
          detail: 'GCT: ottima risposta a chemio (cisplatino). Staging urgente. AFP, HCG sierici. Consulenza oncologia [NCCN 2023].'
        });
      }

      // RED FLAGS
      if (p('PSA') && n('NKX3')) {
        alerts.push({ 
          type: 'redflag', 
          title: '‚ö† RED FLAG ‚Äî PSA+/NKX3‚àí', 
          detail: 'Pattern improbabile. PSA sens <50% mets, NKX3 mantiene 80-85%. Controllare prelievo/colorazione [Gurel 2010].'
        });
      }

      if (p('TTF1') && n('Napsina') && n('CK7')) {
        alerts.push({ 
          type: 'redflag', 
          title: '‚ö† RED FLAG ‚Äî TTF1+/Napsina‚àí/CK7‚àí', 
          detail: 'NON polmone. TTF1+ in: tiroide (Thyroglobulina+), endometrio (ER+/PAX8+), neuroblastoma (SYN+) [Park 2007].'
        });
      }

      if (p('Arginasi') && (p('ER') || p('GATA3'))) {
        alerts.push({ 
          type: 'redflag', 
          title: '‚ö† RED FLAG ‚Äî Arginasi+/GATA3+ o Arginasi+/ER+', 
          detail: 'Pattern sospetto metastasi mammaria Arginasi+ (12.3% breast CA). Morfologia EE critica: se ‚â† HCC tipico ‚Üí metastasi breast. Se = HCC ‚Üí HCC GATA3+ (2% raro) [Karamchandani 2013].'
        });
      }

      // ADVISORY
      if (n('PRAME') && (p('S100') || p('SOX10'))) {
        alerts.push({ 
          type: 'advisory', 
          title: '‚ÑπÔ∏è ADVISORY ‚Äî Lesione melanocitica PRAME‚àí', 
          detail: 'Se morfologia spitzoide: PRAME‚àí favorisce <strong>Nevo di Spitz</strong> (benigno). Se morfologia melanoma convenzionale PRAME‚àí: ~10-15% melanomi PRAME-negativi esistono (sensibilit√† 83-94%, non 100%). Morfologia EE + clinica essenziali [Lezcano 2018].'
        });
      }

      // ‚≠ê v2.6 FIX: CD57 isolato RED FLAG - usa n() per marker testati negativi
      if (p('CD57') && n('Synapt') && n('Cromo') && n('CD56')) {
        alerts.push({ 
          type: 'redflag', 
          title: '‚ö† RED FLAG ‚Äî CD57+ isolato (altri marker NE negativi)', 
          detail: 'CD57+ con Synaptophysin‚àí/Chromogranin‚àí/CD56‚àí (testati): <strong>NON diagnosi NE</strong>. CD57+ in: NK cells (60%), gliomi (80%), prostata adenoCA (40%), melanoma. <strong>Synaptophysin/INSM1 obbligatori</strong> per conferma NE. CD57 √® marker supportivo debole [Bellizzi 2018].'
        });
      }

      // ‚≠ê v2.7.1 REFINED: Pattern ERG+/PSA‚àí/SYN+ ‚Üí Prostata post-ADT con NE transformation
      // NotebookLM validation: pattern confermato, bibliografia validata
      if (p('ERG') && n('PSA') && n('NKX3') && p('Synapt')) {
        alerts.push({ 
          type: 'advisory', 
          title: 'üî¨ PATTERN POST-ADT ‚Äî ERG+/PSA‚àí/NKX3‚àí/SYN+', 
          detail: '<strong>Pattern diagnostico: Adenocarcinoma prostatico con differenziazione NE post-ADT.</strong><br><br>' +
                 '<strong>Firma molecolare:</strong> ERG+ (TMPRSS2-ERG fusion mantiene espressione AR-indipendente, "ancora genomica" stabile) + Synaptophysin+ (NE transformation 10-20% post-castrazione, shift fenotipico sotto pressione ADT).<br><br>' +
                 '<strong>PSA‚àí/NKX3‚àí √® ATTESO in post-ADT:</strong> Khani 2014 dimostra che NKX3.1 scende a sens 80.7% nelle mets (vs 98.6% primitivo), fino a 70-75% nei pazienti ADT-trattati per downregulation AR-pathway. PSA sens <50% mets post-ADT. <strong>La perdita PSA/NKX3.1 √® coerente con pregresso trattamento ormonale descritto in letteratura</strong> [Khani 2014]. ERG mantiene perch√© genomico (fusion stabile, AR-independent).<br><br>' +
                 '<strong>Clinica essenziale:</strong> Verificare storia prostata trattata (prostatectomia/RT + ADT), tempo da terapia (transformation tipica >6-12 mesi), imaging osseo/epatico, PSA sierico trend. Pattern NE post-ADT ‚Üí consider platinum-based chemotherapy (cisplatino/etoposide) vs enzalutamide [Beltran 2016, Khani 2014, Park 2014].<br><br>' +
                 '<strong>Clinica essenziale:</strong> Verificare storia prostata trattata (prostatectomia/RT + ADT), tempo da terapia, imaging osseo/epatico. Pattern NE post-ADT ‚Üí consider platinum-based chemotherapy vs enzalutamide [Beltran 2016, Park 2014].<br><br>' +
                 '<strong>DDx:</strong> NEC primitivo (ma ERG+ esclude), angiosarcoma ERG+ (ma morfologia vascolare anastomosante assente).'
        });
      }

      // ‚≠ê NEW v2.7: Advisory ERG+ alta specificit√† ‚Üí Check storia clinica prostata
      if (p('ERG') && n('PSA') && n('NKX3') && !p('Synapt')) {
        alerts.push({ 
          type: 'advisory', 
          title: '‚ÑπÔ∏è ADVISORY ‚Äî ERG+ con PSA‚àí/NKX3‚àí', 
          detail: '<strong>ERG+ in contesto PSA‚àí/NKX3‚àí:</strong> Due scenari principali:<br><br>' +
                 '<strong>1. Adenocarcinoma prostatico TMPRSS2-ERG+ (30-40%)</strong> con loss PSA/NKX3 (post-ADT, high-grade, dedifferenziazione). Verificare storia clinica prostata. ERG mantiene espressione (AR-independent).<br><br>' +
                 '<strong>2. Neoplasia vascolare (Angiosarcoma 92-100%)</strong>: richiede morfologia vasi anastomosanti, eritrociti intracitoplasmatici. CD31/CD34/FLI1 supportano. Se morfologia NON vascolare ‚Üí prostata favorita.<br><br>' +
                 '<strong>Storia clinica essenziale:</strong> Prostata nota? ADT? Imaging osseo? Tempo da terapia? <strong>Morfologia EE critica</strong> per DDx angiosarcoma vs prostata [Park 2014, Miettinen 2014].'
        });
      }

      // ‚≠ê NEW v2.4: INSM1 alert preventivi (per futura implementazione)
      // NOTE: INSM1 non disponibile FBF, ma alert logici preparati
      /*
      if (p('INSM1') && (p('NKX3') || p('ERG') || p('PSA'))) {
        alerts.push({ 
          type: 'redflag', 
          title: '‚ö† ALERT ‚Äî INSM1+/Marcatori Prostata+', 
          detail: 'INSM1+ in 36% adenocarcinomi prostatici (firma NE epigenetica, NON NEC puro). Se NKX3+/ERG+/PSA+ ‚Üí adenoCA prostata con differenziazione NE. Pattern INSM1: <em>focale</em> (<30%) = NE subclinica; <em>diffuso</em> (>70%) + small-cell = NEC. Morfologia EE critica [Rooper 2017].'
        });
      }

      if (p('INSM1') && p('SOX10')) {
        alerts.push({ 
          type: 'redflag', 
          title: '‚ö† ALERT ‚Äî INSM1+/SOX10+', 
          detail: 'INSM1+ in 13% melanomi (falso positivo NE). Se SOX10+/PRAME+ ‚Üí <strong>melanoma</strong> high confidence, NON NEN. INSM1 NON specifico per NE. Synaptophysin/Chromogranin obbligatori per conferma NE [Rooper 2017].'
        });
      }
      */

      // ‚≠ê NEW v2.8: SOX10 DDx ALERTS (NotebookLM)
      
      // Alert SOX10+ isolato ‚Üí DDx completo
      if (p('SOX10') && !t('MelanA') && !t('HMB45') && !t('PRAME') && !t('GATA3')) {
        alerts.push({
          type: 'advisory',
          title: 'üî¨ ADVISORY ‚Äî SOX10+ Pattern Ambiguo',
          detail: '<strong>SOX10+ richiede DDx completo:</strong><br><br>' +
                 '<strong>1. Melanoma (95% SOX10+):</strong> Aggiungere Melan-A, HMB45, PRAME (83-94%). PRAME+ diffuso blindano malignit√†.<br><br>' +
                 '<strong>2. TNBC (69% SOX10+):</strong> Aggiungere GATA3. Se SOX10+/CK+/GATA3+ ‚Üí TNBC basal-like. Donna + linfonodo ascellare [Ivanov 2013].<br><br>' +
                 '<strong>3. MPNST (49% SOX10+):</strong> Se morfologia fusocellulare, aggiungere H3K27me3. Loss nucleare (80-85%) ‚Üí MPNST high-grade. NF1 storia?<br><br>' +
                 '<strong>4. Schwannoma (100% SOX10+):</strong> Se S100+ diffuso, aggiungere H3K27me3. Retained ‚Üí benigno [Rodriguez 2000].<br><br>' +
                 '<strong>5. Paraganglioma (SOX10+):</strong> Se Zellballen, aggiungere GATA3. SOX10+/GATA3+/CK‚àí ‚Üí paraganglioma.<br><br>' +
                 '<strong>Morfologia EE essenziale:</strong> Pigmento ‚Üí melanoma; Ghiandolare ‚Üí TNBC; Fusocellulare ‚Üí MPNST/schwannoma; Zellballen ‚Üí paraganglioma.'
        });
      }

      // Alert SOX10+/CK+ ‚Üí DDx melanoma vs TNBC
      if (p('SOX10') && p('CKAE1') && !t('GATA3')) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è ADVISORY ‚Äî SOX10+/CK+ Pattern',
          detail: '<strong>SOX10+/CK+: DDx critico melanoma vs TNBC (69% SOX10+).</strong><br><br>' +
                 'Aggiungere GATA3 (TNBC), Melan-A/HMB45/PRAME (melanoma).<br><br>' +
                 '<strong>CK pattern critico:</strong><br>' +
                 '‚Ä¢ Se CK diffuso forte ‚Üí TNBC favorito<br>' +
                 '‚Ä¢ Se CK focale debole ‚Üí melanoma aberrante<br><br>' +
                 'Morfologia EE essenziale [Ivanov 2013, NotebookLM].'
        });
      }

      // ‚≠ê NEW v2.9: ALERT MARKER EMERGENTI
      
      // INSM1 false positivity (riattivato)
      if (p('INSM1') && (p('PSA') || p('NKX3') || p('ERG'))) {
        alerts.push({ 
          type: 'advisory', 
          title: '‚ÑπÔ∏è ADVISORY ‚Äî INSM1+/Prostata+', 
          detail: 'INSM1+ in 36% adenoCA prostatici (differenziazione NE). <strong>Pattern INSM1 critico:</strong> focale <30% ‚Üí adenoCA con NE; diffuso >50% + small-cell ‚Üí NEC puro. Se NKX3+/ERG+ ‚Üí prostata favorita. Morfologia EE essenziale [Rooper 2017].'
        });
      }

      if (p('INSM1') && p('SOX10')) {
        alerts.push({ 
          type: 'advisory', 
          title: '‚ÑπÔ∏è ADVISORY ‚Äî INSM1+/SOX10+', 
          detail: 'INSM1+ in 13.2% melanomi (falso positivo NE). Se SOX10+/PRAME+ ‚Üí <strong>melanoma</strong> high confidence, NON NEN. Synaptophysin/Chromogranin obbligatori conferma NE [Rooper 2017].'
        });
      }

      // TRPS1+/PAX8+ pitfall ovaio
      if (p('TRPS1') && (p('PAX8') || p('WT1'))) {
        alerts.push({
          type: 'advisory',
          title: '‚ö†Ô∏è ADVISORY ‚Äî TRPS1+/PAX8+: Pitfall Ovaio',
          detail: '<strong>TRPS1+ NON esclude ovaio!</strong> 40.5% HGSC ovaio esprime TRPS1. <strong>Discriminare:</strong> Mammella (TRPS1+/PAX8‚àí/WT1‚àí/GATA3+) vs Ovaio (TRPS1+/PAX8+/WT1+/ER+). Sede metastasi critica: peritoneale/pelvica ‚Üí ovaio favorito; linfonodo ascellare ‚Üí mammella [NotebookLM 2026].'
        });
      }

      // NUT giovane midline
      if (p('NUT') || (p('p63') && p('p40') && !t('NUT'))) {
        if (!t('NUT')) {
          alerts.push({
            type: 'advisory',
            title: '‚ÑπÔ∏è ADVISORY ‚Äî SCC Indifferenziato: Testare NUT?',
            detail: 'Carcinoma squamoso indifferenziato "null-type". <strong>Se giovane (<30) + massa midline (mediastino/testa-collo):</strong> considerare NUT Midline Carcinoma. Pattern NUT+ speckled nucleare patognomonico. <strong>Identificazione essenziale</strong> per target therapy trials (BET inhibitors) [French 2014].'
          });
        }
      }

      // BCL10+ conferma acinare
      if (p('BCL10') && !t('INSM1')) {
        alerts.push({
          type: 'advisory',
          title: '‚ÑπÔ∏è ADVISORY ‚Äî BCL10+: Conferma vs NET',
          detail: 'BCL10+ suggerisce carcinoma acinare pancreas (90-95%). <strong>DDx NET pancreas:</strong> INSM1/Synaptophysin discrimina (acinare BCL10+/INSM1‚àí, NET BCL10‚àí/INSM1+). Morfologia: granuli zimogeni eosinofili [La Rosa 2014].'
        });
      }

      return alerts;
    }

    // ============================================
    // ‚≠ê v2.17: BAYES CALCULATOR (Vollmer 2009 + Enhanced)
    // Formula: P(Dx|IHC) = [P(IHC|Dx) √ó P(Dx)] / Œ£[P(IHC|Dx_i) √ó P(Dx_i)]
    // ============================================
    
    function calculateProbabilities() {
      try {
        const positiveMarkers = markers.filter(m => p(m.id)).map(m => m.id);
        const negativeMarkers = markers.filter(m => n(m.id)).map(m => m.id);
        
        // Edge case: no markers tested
        if (positiveMarkers.length === 0 && negativeMarkers.length === 0) {
          console.log('[Bayes] No markers tested');
          return [];
        }
        
        // Get sex for P(Dx) prior
        const sex = document.querySelector('input[name="sex"]:checked')?.value || 'female';
        
        console.log(`[Bayes] Sex: ${sex}, Pos: ${positiveMarkers.length}, Neg: ${negativeMarkers.length}`);
        
        // Calculate likelihoods for each diagnosis
        const likelihoods = immunoprofileDB.map(diagnosis => {
          // Count expected positives matched
          const expectedPositives = diagnosis.positive.map(p => {
            const markerId = markers.find(m => 
              p.marker.toLowerCase().includes(m.name.toLowerCase()) || 
              m.name.toLowerCase().includes(p.marker.toLowerCase())
            )?.id;
            return markerId;
          }).filter(Boolean);
          
          const matchedPositives = expectedPositives.filter(id => positiveMarkers.includes(id));
          
          // P(IHC|Dx) for positives: proportion matched
          const positiveLikelihood = expectedPositives.length > 0 
            ? (matchedPositives.length / expectedPositives.length) 
            : 0.5; // Neutral if no expected positives
          
          // Count expected negatives matched
          const expectedNegatives = diagnosis.negative.map(n => {
            const markerId = markers.find(m => 
              n.marker.toLowerCase().includes(m.name.toLowerCase()) || 
              m.name.toLowerCase().includes(n.marker.toLowerCase())
            )?.id;
            return markerId;
          }).filter(Boolean);
          
          const matchedNegatives = expectedNegatives.filter(id => negativeMarkers.includes(id));
          const violatedNegatives = expectedNegatives.filter(id => positiveMarkers.includes(id));
          
          // P(IHC|Dx) for negatives: proportion matched, heavy penalty for violations
          let negativeLikelihood = 1.0;
          if (expectedNegatives.length > 0) {
            negativeLikelihood = (matchedNegatives.length / expectedNegatives.length);
            // Severe penalty for violated negatives (expected negative but found positive)
            if (violatedNegatives.length > 0) {
              negativeLikelihood *= (1 - violatedNegatives.length / expectedNegatives.length);
            }
          }
          
          // Combined likelihood: P(IHC pattern | Dx)
          const likelihood = positiveLikelihood * negativeLikelihood;
          
          // ‚≠ê Bayes: Get prior P(Dx) from prevalenceData
          const prior = prevalenceData[diagnosis.name]?.[sex] || 0.01; // Default 1% if missing
          
          return {
            name: diagnosis.name,
            likelihood: likelihood,
            prior: prior,
            bayesNumerator: likelihood * prior, // P(IHC|Dx) √ó P(Dx)
            matchedPositives: matchedPositives,
            expectedPositives: expectedPositives,
            violatedNegatives: violatedNegatives,
            matchedNegatives: matchedNegatives
          };
        });
        
        // Calculate normalization: Œ£[P(IHC|Dx_i) √ó P(Dx_i)]
        const normalization = likelihoods.reduce((sum, dx) => sum + dx.bayesNumerator, 0);
        
        console.log(`[Bayes] Normalization: ${normalization.toFixed(4)}`);
        
        // Edge case: normalization near zero (all likelihoods zero)
        if (normalization < 0.0001) {
          console.warn('[Bayes] Normalization near zero, no discriminant pattern');
          return [];
        }
        
        // Calculate Bayes probability: P(Dx|IHC) = numerator / normalization
        const probabilities = likelihoods.map(dx => ({
          name: dx.name,
          probability: Math.round((dx.bayesNumerator / normalization) * 100),
          matchedPositives: dx.matchedPositives,
          expectedPositives: dx.expectedPositives,
          violatedNegatives: dx.violatedNegatives,
          matchedNegatives: dx.matchedNegatives,
          prior: dx.prior,
          likelihood: dx.likelihood
        }));
        
        // Sort by probability descending
        probabilities.sort((a, b) => b.probability - a.probability);
        
        // Debug log top 3
        console.log('[Bayes] Top 3:', probabilities.slice(0, 3).map(p => `${p.name}: ${p.probability}%`));
        
        // Return top 5 with >1% probability (pi√π permissivo per vedere tail)
        return probabilities.filter(p => p.probability > 1).slice(0, 5);
        
      } catch (error) {
        console.error('[Bayes] Error calculating probabilities:', error);
        return [];
      }
    }

    // ============================================
    // ‚≠ê NEW v2.22: GENERATE PROFESSIONAL REPORT
    // ============================================
    
    function generateReport() {
      const diagnoses = getDiagnoses();
      const allAlerts = [...getEpistemicAlerts(), ...getQCAlerts(), ...getBigFourFutilityAlerts(), 
                         ...getSiteSpecificAlerts(), ...getAlerts(), ...getMorphologyAlerts()];
      
      if (diagnoses.length === 0) {
        return {
          html: '<p><em>Nessuna diagnosi generata. Inserire marker IHC per ottenere referto.</em></p>',
          text: 'Nessuna diagnosi generata.'
        };
      }
      
      // Get clinical data
      const sede = document.getElementById('sede')?.value || 'Non specificata';
      const sesso = document.querySelector('input[name="sesso"]:checked')?.value || 'Non specificato';
      const eta = document.getElementById('eta')?.value || 'Non specificata';
      
      // Get morphology
      const morphologies = [];
      if (document.getElementById('clear_cell')?.checked) morphologies.push('Clear cell');
      if (document.getElementById('signet_ring')?.checked) morphologies.push('Signet-ring');
      if (document.getElementById('lepidic')?.checked) morphologies.push('Lepidico');
      if (document.getElementById('squamous')?.checked) morphologies.push('Squamoso');
      if (document.getElementById('small_cell')?.checked) morphologies.push('Small cell');
      if (document.getElementById('necrosi')?.checked) morphologies.push('Necrosi');
      if (document.getElementById('mitosi')?.checked) morphologies.push('Mitosi elevate');
      const morphText = morphologies.length > 0 ? morphologies.join(', ') : 'Non specificata';
      
      // Get positive markers
      const positiveMarkers = markers.filter(m => p(m.id)).map(m => m.name);
      const negativeMarkers = markers.filter(m => n(m.id)).map(m => m.name);
      
      // Build HTML report
      let htmlReport = '';
      
      // Header
      htmlReport += '<div style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">';
      htmlReport += '<div style="border-bottom: 2px solid #2563eb; padding-bottom: 10px; margin-bottom: 20px;">';
      htmlReport += '<h3 style="color: #2563eb; margin: 0;">REFERTO IMMUNOISTOCHIMICO</h3>';
      htmlReport += '<p style="font-size: 0.9rem; color: #64748b; margin: 5px 0 0 0;">SC Anatomia Patologica ASST Fatebenefratelli-Sacco</p>';
      htmlReport += '</div>';
      
      // ‚≠ê DIAGNOSI PRINCIPALE - BOX EVIDENZIATO (SUBITO DOPO HEADER!)
      const primaryDx = diagnoses[0]; // Prima diagnosi = principale
      const confColor = primaryDx.conf === 'high' ? '#10b981' : primaryDx.conf === 'medium' ? '#f59e0b' : '#ef4444';
      const confText = primaryDx.conf === 'high' ? 'Alta confidenza' : primaryDx.conf === 'medium' ? 'Media confidenza' : 'Bassa confidenza';
      
      htmlReport += '<div style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 3px solid ' + confColor + '; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">';
      htmlReport += '<h2 style="margin: 0 0 12px 0; color: ' + confColor + '; font-size: 1.5rem;">üìã DIAGNOSI PRINCIPALE</h2>';
      htmlReport += '<p style="margin: 0 0 8px 0; font-size: 1.3rem; font-weight: 700; color: #1e293b;">' + primaryDx.name + '</p>';
      htmlReport += '<p style="margin: 0 0 12px 0; font-size: 0.95rem; color: #64748b;"><strong>Confidenza:</strong> <span style="color: ' + confColor + '; font-weight: 600;">' + confText + '</span></p>';
      htmlReport += '<div style="padding: 12px; background: white; border-radius: 8px; border-left: 4px solid ' + confColor + ';">';
      htmlReport += '<p style="margin: 0; font-size: 1rem; line-height: 1.6; color: #334155;">' + primaryDx.detail + '</p>';
      htmlReport += '</div>';
      htmlReport += '</div>';
      
      // Clinical data
      htmlReport += '<div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-left: 4px solid #2563eb;">';
      htmlReport += '<h4 style="color: #1e40af; margin: 0 0 10px 0;">DATI CLINICI</h4>';
      htmlReport += '<p style="margin: 5px 0;"><strong>Sede:</strong> ' + sede + '</p>';
      htmlReport += '<p style="margin: 5px 0;"><strong>Sesso:</strong> ' + sesso + ' | <strong>Et√†:</strong> ' + eta + '</p>';
      htmlReport += '<p style="margin: 5px 0;"><strong>Morfologia EE:</strong> ' + morphText + '</p>';
      htmlReport += '</div>';
      
      // Immunohistochemistry panel
      htmlReport += '<div style="margin-bottom: 20px;">';
      htmlReport += '<h4 style="color: #1e40af; margin-bottom: 10px;">PANNELLO IMMUNOISTOCHIMICO</h4>';
      if (positiveMarkers.length > 0) {
        htmlReport += '<p style="margin: 5px 0;"><strong>Positivi:</strong> ' + positiveMarkers.join(', ') + '</p>';
      }
      if (negativeMarkers.length > 0) {
        htmlReport += '<p style="margin: 5px 0;"><strong>Negativi:</strong> ' + negativeMarkers.join(', ') + '</p>';
      }
      htmlReport += '</div>';
      
      // ‚≠ê DIAGNOSI DIFFERENZIALI (se >1 diagnosi)
      if (diagnoses.length > 1) {
        htmlReport += '<div style="margin-bottom: 20px;">';
        htmlReport += '<h4 style="color: #1e40af; margin-bottom: 10px;">DIAGNOSI DIFFERENZIALI</h4>';
        
        diagnoses.slice(1).forEach((dx, idx) => {
          const dxConfColor = dx.conf === 'high' ? '#10b981' : dx.conf === 'medium' ? '#f59e0b' : '#ef4444';
          const dxConfText = dx.conf === 'high' ? 'Alta confidenza' : dx.conf === 'medium' ? 'Media confidenza' : 'Bassa confidenza';
          
          htmlReport += '<div style="margin-bottom: 15px; padding: 12px; border-left: 4px solid ' + dxConfColor + '; background: #fafafa;">';
          htmlReport += '<p style="margin: 0 0 8px 0;"><strong style="color: ' + dxConfColor + ';">' + (idx + 2) + '. ' + dx.name + '</strong> <span style="font-size: 0.85rem; color: #64748b;">(' + dxConfText + ')</span></p>';
          htmlReport += '<p style="margin: 0; font-size: 0.95rem;">' + dx.detail + '</p>';
          htmlReport += '</div>';
        });
        
        htmlReport += '</div>';
      }
      
      // Critical alerts (epistemic + QC)
      const criticalAlerts = allAlerts.filter(a => a.type === 'advisory' || a.type === 'critical');
      if (criticalAlerts.length > 0) {
        htmlReport += '<div style="margin-bottom: 20px;">';
        htmlReport += '<h4 style="color: #dc2626; margin-bottom: 10px;">‚ö†Ô∏è ALERT CRITICI E CONSIDERAZIONI</h4>';
        criticalAlerts.slice(0, 3).forEach(alert => {
          htmlReport += '<div style="margin-bottom: 10px; padding: 10px; background: #fef2f2; border-left: 4px solid #dc2626;">';
          htmlReport += '<p style="margin: 0; font-weight: 600; color: #991b1b;">' + alert.title.replace(/<[^>]*>/g, '') + '</p>';
          htmlReport += '<p style="margin: 5px 0 0 0; font-size: 0.9rem;">' + alert.detail.substring(0, 200).replace(/<[^>]*>/g, '') + '...</p>';
          htmlReport += '</div>';
        });
        htmlReport += '</div>';
      }
      
      // Footer
      htmlReport += '<div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #e5e7eb; font-size: 0.85rem; color: #64748b;">';
      htmlReport += '<p style="margin: 5px 0;"><strong>Note:</strong> Questo referto √® generato da IHC Cascade CUP v2.22 ed √® da considerarsi come supporto decisionale. La diagnosi finale richiede correlazione clinica, morfologia EE e valutazione del patologo.</p>';
      htmlReport += '<p style="margin: 5px 0;"><em>"Il vetrino non mente, il reagente s√¨. La morfologia EE ha priorit√† epistemica."</em> ‚Äî Scuola Rosai</p>';
      htmlReport += '</div>';
      
      htmlReport += '</div>';
      
      // Build plain text report
      let textReport = 'REFERTO IMMUNOISTOCHIMICO\n';
      textReport += 'SC Anatomia Patologica ASST Fatebenefratelli-Sacco\n';
      textReport += '='.repeat(60) + '\n\n';
      
      // ‚≠ê DIAGNOSI PRINCIPALE (PRIMA!)
      const primaryDxText = diagnoses[0];
      const confTextPrimary = primaryDxText.conf === 'high' ? 'Alta confidenza' : primaryDxText.conf === 'medium' ? 'Media confidenza' : 'Bassa confidenza';
      textReport += 'üìã DIAGNOSI PRINCIPALE\n';
      textReport += '='.repeat(60) + '\n';
      textReport += primaryDxText.name + ' (' + confTextPrimary + ')\n\n';
      textReport += primaryDxText.detail.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ') + '\n';
      textReport += '='.repeat(60) + '\n\n';
      
      textReport += 'DATI CLINICI\n';
      textReport += 'Sede: ' + sede + '\n';
      textReport += 'Sesso: ' + sesso + ' | Et√†: ' + eta + '\n';
      textReport += 'Morfologia EE: ' + morphText + '\n\n';
      
      textReport += 'PANNELLO IMMUNOISTOCHIMICO\n';
      if (positiveMarkers.length > 0) {
        textReport += 'Positivi: ' + positiveMarkers.join(', ') + '\n';
      }
      if (negativeMarkers.length > 0) {
        textReport += 'Negativi: ' + negativeMarkers.join(', ') + '\n';
      }
      textReport += '\n';
      
      // DIAGNOSI DIFFERENZIALI (se >1)
      if (diagnoses.length > 1) {
        textReport += 'DIAGNOSI DIFFERENZIALI\n';
        diagnoses.slice(1).forEach((dx, idx) => {
          const confText = dx.conf === 'high' ? 'Alta confidenza' : dx.conf === 'medium' ? 'Media confidenza' : 'Bassa confidenza';
          textReport += (idx + 2) + '. ' + dx.name + ' (' + confText + ')\n';
          textReport += '   ' + dx.detail.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ') + '\n\n';
        });
      }
      
      if (criticalAlerts.length > 0) {
        textReport += 'ALERT CRITICI\n';
        criticalAlerts.slice(0, 3).forEach(alert => {
          textReport += '‚ö† ' + alert.title.replace(/<[^>]*>/g, '') + '\n';
        });
        textReport += '\n';
      }
      
      textReport += '-'.repeat(60) + '\n';
      textReport += 'Note: Referto generato da IHC Cascade CUP v2.22\n';
      textReport += 'Correlazione clinica e morfologia EE essenziali.\n';
      textReport += '"Il vetrino non mente, il reagente s√¨" - Scuola Rosai\n';
      
      return { html: htmlReport, text: textReport };
    }

    function getSuggestions() {
      const s = [];

      // First-line suggestions
      if (!t('CKAE1') && !t('CD45') && !t('Vim') && !t('S100')) {
        s.push('‚≠ê <strong>STEP 1 obbligatorio:</strong> Inizia con <code>First-line</code> (CK AE1/AE3, CD45, Vimentin, S100) per orientamento [SEOM-GECOD 2022].');
      }

      // Big Four after CK+
      if (p('CKAE1') && !t('CK7') && !t('CK20')) {
        s.push('CK AE1/AE3 positivo: procedi con <code>Big Four</code> (CK7, CK20, TTF-1, CDX2) per orientamento carcinoma [SEOM-GECOD 2022].');
      }

      // CK7+/CK20- suggestions
      if (p('CK7') && n('CK20')) {
        if (!t('TTF1')) {
          s.push('CK7+/CK20‚àí: aggiungere <code>TTF-1</code> per escludere polmone/tiroide [IASLC 2021].');
        }
        if (!t('PAX8') && !t('ER')) {
          s.push('CK7+/CK20‚àí: aggiungere <code>PAX8</code>, <code>ER</code>, <code>GATA3</code> per ovaio/endometrio/mammella [NCCN 2023].');
        }
      }

      // ‚≠ê v2.8 CURABILI-FIRST: CK7-/CK20- suggestions (NotebookLM)
      if (n('CK7') && n('CK20')) {
        // ‚≠ê v2.9.1 FIX: Guardrail CKAE1+ richiesto per pattern CK7/20
        if (!p('CKAE1')) {
          // Alert: CK7/20 senza conferma epiteliale
          s.push('‚ö†Ô∏è <strong>CK7‚àí/CK20‚àí senza conferma epiteliale:</strong> Pattern CK7/CK20 richiede <code>CK AE1/AE3+</code> per orientamento carcinoma. Se CKAE1 negativo/ND ‚Üí lineage NON epiteliale confermato. Verificare <code>CD45</code> (linfoma), <code>S100/SOX10</code> (melanoma), <code>Vimentin</code> (sarcoma) [SEOM-GECOD].');
        } else {
          // Priorit√† STEP 2 (Curabili) prima di Step 4 (Organo-specifici)
          if (!t('SALL4') || !t('Synapt') || !t('p40') || !t('PAX8')) {
            s.push('‚≠ê <strong>CK7‚àí/CK20‚àí ‚Üí PRIORIT√Ä STEP 2 CURABILI:</strong><br>' +
                   '1. <code>SALL4</code> (GCT curabile 100% sens seminoma)<br>' +
                   '2. <code>Synaptophysin</code> (NEC chemiosensibile)<br>' +
                   '3. <code>p40</code> (SCC 98% spec, cambia iter)<br>' +
                   '4. <code>PAX8</code> (RCC 83-98%, primario CUP frequente)<br>' +
                   '<strong>DOPO esclusione curabili</strong> ‚Üí Arginasi (HCC), NKX3 (prostata) [SEOM-GECOD, NotebookLM].');
          }
        }
      }

      // ‚≠ê NEW v2.3: SOX10 suggestion
      if (p('S100') && !t('SOX10')) {
        s.push('S100+: aggiungere <code>SOX10</code> (spec 95% vs carcinomi, pi√π specifico di S100). Disponibile FBF. Se SOX10+/PRAME+ ‚Üí melanoma high confidence [Nonaka 2008].');
      }

      // ‚≠ê NEW v2.3: ERG suggestion for NEC CUP
      if (p('Synapt') && n('PSA') && n('NKX3') && !t('ERG')) {
        s.push('NEC PSA‚àí/NKX3‚àí in uomo con metastasi ossee: <code>ERG</code> disponibile FBF (30-40% prostata TMPRSS2-ERG). Complementare AR. TTF1 ambiguo (60% prostata, 90% polmone) [Park 2014].');
      }

      // NKX3 priority
      if (n('PSA') && !t('NKX3')) {
        s.push('PSA neg: <code>NKX3</code> mandatoria (sens 80-85% mets, spec 99-100%). PSA‚àí/NKX3‚àí non esclude prostata: 20% falsi neg (post-ADT, NE, alto grado). ERG terza linea [Gurel 2010].');
      }

      // Arginasi reflex
      if (p('Arginasi') && !t('ER') && !t('GATA3')) {
        s.push('Arginasi+: se lesione epatica in donna, aggiungere <code>ER</code>, <code>GATA3</code>, <code>Mammoglobin</code> per escludere metastasi breast Arg+ (12.3%) [Karamchandani 2013].');
      }

      // PRAME suggestions
      if (p('S100') && p('SOX10') && !t('PRAME')) {
        s.push('S100+/SOX10+ melanoma: aggiungere <code>PRAME</code> (sens 83-94%, spec alta vs nevi). Utile DDx: Nevo Spitz (PRAME‚àí) vs Melanoma Spitzoide (PRAME+ diffuso >50%). Pattern diffuso supporta malignit√† [Lezcano 2018].');
      }

      if (p('PRAME') && !t('S100') && !t('SOX10')) {
        s.push('PRAME+: verificare lineage. Se <code>CK+</code> ‚Üí sarcoma sinoviale (80-90% PRAME+). Se <code>PAX8+</code> ‚Üí RCC. Se <code>S100+/SOX10+</code> ‚Üí melanoma. Pattern diffuso pi√π specifico [Gradecki 2021].');
      }

      // Melanocytic panel
      if (p('SOX10') && !t('MelanA')) {
        s.push('SOX10+: aggiungere <code>Melan-A</code>, <code>HMB-45</code>, <code>PRAME</code> per conferma melanoma [Voiculescu 2025].');
      }

      // NE panel
      if (p('Synapt') && !t('TTF1') && !t('CDX2')) {
        s.push('NEN: aggiungere <code>TTF-1</code> (polmone 90%), <code>CDX2</code> (GI) per site assignment [Bellizzi 2018].');
      }

      // GCT panel
      if (p('OCT34') && !t('AFP') && !t('HCG')) {
        s.push('OCT3/4+: aggiungere <code>AFP</code>, <code>Œ≤-HCG</code> per sottotipizzazione GCT. Dosaggio sierico essenziale [NCCN 2023].');
      }

      // MMR incomplete
      if ((t('MLH1') || t('MSH2') || t('MSH6') || t('PMS2')) && 
          !(t('MLH1') && t('MSH2') && t('MSH6') && t('PMS2'))) {
        s.push('MMR incompleto: testare tutti e 4 (MLH1, MSH2, MSH6, PMS2) per interpretazione corretta [Shia 2008].');
      }

      return s;
    }

    function getGaps(panelId) {
      const gaps = [];
      
      if (panelId === 'carcinoma' || panelId === 'neuroendocrine' || !panelId) {
        gaps.push('‚ö† <code>INSM1</code> non in FBF. Sens 96.4% NEN (superiore a SYN+CgA+CD56: 87.4%), spec 96.2% [Rooper 2017]. <strong>Falsi+:</strong> melanoma 13%, prostata adenoCA 36% (firma NE epigenetica), sarcomi. <strong>Pattern:</strong> diffuso (>50% NEN), focale (<30% falsi+). TMA >14k: 3.8% non-NE. Attivazione consigliata per biopsie mediastiniche/polmonari.');
        
        gaps.push('<code>TRPS1</code> ‚Äî marcatore breast CA (spec TN), surrogato GCDFP-15/Mammoglobin. Citato PDF CUP 2023. Non disponibile FBF.');
        
        gaps.push('<code>NKX3.1</code> ‚Äî verificare se NKX3 (cod. 22581) = NKX3.1. Marker prostata sens 80-85% mets, spec 99-100%. Critico per CUP [Gurel 2010].');
        
        gaps.push('<code>Prosteina (P501S)</code> ‚Äî sens ~95% prostata, spec ~98%. Superiore PSA in scarsamente diff., mantiene espressione post-ADT. Non disponibile FBF.');
        
        gaps.push('<code>MOC31</code>/<code>Claudina-4</code> ‚Äî DDx mesotelioma vs adenoCA. Sens/spec >90% [Ord√≥√±ez 2005]. Non disponibili FBF.');
      }
      
      return gaps;
    }

    function renderBibliography() {
      const bib = document.getElementById('bibliographyContent');
      bib.innerHTML = `
        <strong>Linee Guida:</strong><br>
        [1] SEOM-GECOD ‚Äî CUP guidelines. <em>SEOM Clin Guidel</em> 2022 (update).<br>
        [2] ESMO ‚Äî CUP management. <em>Ann Oncol</em> 2023;34:228.<br>
        [3] NCCN ‚Äî Occult primary. <em>NCCN Guidelines</em> 2023 v2.<br>
        <br>
        <strong>IHC generale:</strong><br>
        [4] Hainsworth JD+ ‚Äî CUP IHC approach. <em>Oncologist</em> 2020;25:e1566.<br>
        <br>
        <strong>Organo-specifici:</strong><br>
        [5] IASLC ‚Äî IHC in lung cancer. <em>J Thorac Oncol</em> 2021;16:1107.<br>
        [6] Yan BC+ ‚Äî <strong>Arginase-1</strong> for HCC. <em>Am J Surg Pathol</em> 2010;34:1147.<br>
        [7] Gurel B+ ‚Äî <strong>NKX3.1</strong> in mets. <em>Am J Surg Pathol</em> 2010;34:1097. <strong>(Sens 80.7% mets, NOT 98.6%)</strong> <span style="color:var(--pos)">‚úì FIX</span><br>
        [8] Khani F+ ‚Äî NKX3.1 validation. <em>Clin Cancer Res</em> 2014;20:4925.<br>
        [8b] Park K+ ‚Äî <strong>ERG prostata</strong>. <em>Am J Surg Pathol</em> 2014;38:1685. <strong>(30-40% TMPRSS2-ERG, mantiene post-ADT AR-independent)</strong> <span style="color:var(--pos)">‚úì NEW v2.3</span><br>
        [8c] Beltran H+ ‚Äî <strong>NE prostata post-ADT</strong>. <em>Nat Rev Urol</em> 2016;13:271. <strong>(10-20% transformation NE post-castrazione)</strong> <span style="color:var(--accent)">‚úì NEW v2.7</span><br>
        [9] Karamchandani JR+ ‚Äî <strong>Arginase-1 in breast</strong>. <em>Histopathology</em> 2013;62:804. <strong>(12% positive)</strong> <span style="color:var(--pos)">‚úì FIX</span><br>
        <br>
        <strong>Neuroendocrino:</strong><br>
        [10] Rooper LM+ ‚Äî <strong>INSM1</strong> superior. <em>Am J Surg Pathol</em> 2017;41:1561. <strong>(Sens 96.4%, FP melanoma 13%, prostata 36%)</strong> <span style="color:var(--pos)">‚úì FIX</span><br>
        [11] Bellizzi AM ‚Äî NEN site assignment. <em>Arch Pathol Lab Med</em> 2018;142:530.<br>
        <br>
        <strong>Melanoma:</strong><br>
        [12] Voiculescu VM+ ‚Äî IHC skin cancers. <em>Curr Health Sci J</em> 2025;51:5.<br>
        [13] Nonaka D+ ‚Äî <strong>SOX10</strong> melanoma. <em>Am J Surg Pathol</em> 2008;32:1291. <strong>(Sens 95%, spec 95% vs carcinomi)</strong> <span style="color:var(--pos)">‚úì NEW v2.3</span><br>
        [14] Lezcano C+ ‚Äî <strong>PRAME</strong> in melanoma. <em>Am J Surg Pathol</em> 2018;42:1456. <strong>(DDx Nevo Spitz PRAME‚àí vs Melanoma Spitzoide PRAME+)</strong> <span style="color:var(--warn)">‚úì FIX v2.2</span><br>
        [15] Gradecki SE+ ‚Äî PRAME cross-reattivit√†. <em>Am J Surg Pathol</em> 2021;45:1249. <strong>(Sarcoma sinoviale 80-90%)</strong> <span style="color:var(--pos)">‚úì NEW v2.2</span><br>
        <br>
        <strong>Prostata/Endotelio:</strong><br>
        [16] Park K+ ‚Äî <strong>ERG</strong> prostata & vascular. <em>Am J Surg Pathol</em> 2014;38:373. <strong>(30-40% prostata TMPRSS2-ERG, 92-100% angiosarcoma)</strong> <span style="color:var(--pos)">‚úì NEW v2.3</span><br>
        [17] Miettinen M+ ‚Äî ERG endothelial. <em>Am J Surg Pathol</em> 2014;38:641.<br>
        <br>
        <strong>GCT:</strong><br>
        [18] WHO Classification ‚Äî Tumours urinary & male genital. <em>5th ed</em> 2022.<br>
        [19] Zynger DL+ ‚Äî <strong>SALL4</strong> in GCT. <em>Am J Clin Pathol</em> 2008;129:235.<br>
        [20] Cao D+ ‚Äî SALL4 in adenoCA. <em>Mod Pathol</em> 2009;22:1418. <strong>(10-15% gastric)</strong> <span style="color:var(--pos)">‚úì FIX</span><br>
        [21] Agaimy A+ ‚Äî <strong>CD30+ carcinomas</strong>. <em>Am J Surg Pathol</em> 2012;36:1836.<br>
        <br>
        <strong>MMR:</strong><br>
        [22] Shia J ‚Äî IHC vs MSI. <em>J Mol Diagn</em> 2008;10:293.<br>
        [23] Haraldsdottir S+ ‚Äî <strong>MMR deficiency</strong>. <em>Fam Cancer</em> 2014;13:427.<br>
        <br>
        <strong>Altri:</strong><br>
        [24] Ord√≥√±ez NG ‚Äî IHC mesothelioma. <em>Am J Clin Pathol</em> 2005;123:202.<br>
        [25] Rodriguez FJ+ ‚Äî Schwannoma/MPNST. <em>Am J Surg Pathol</em> 2000;24:405. <strong>(H3K27me3 loss MPNST 80-85%)</strong><br>
        [26] Ivanov S+ ‚Äî <strong>SOX10 in TNBC</strong>. <em>Am J Clin Pathol</em> 2013;139:210. <strong>(69% TNBC basal-like SOX10+)</strong><br>
        <br>
        <strong>‚≠ê v2.9 Marker Emergenti (NotebookLM):</strong><br>
        [27] La Rosa S+ ‚Äî <strong>BCL10 acinar carcinoma</strong>. <em>Am J Surg Pathol</em> 2014;38:1501. <strong>(90-95% sens acinare pancreas)</strong> <span style="color:var(--accent)">‚úì NEW v2.9</span><br>
        [28] Biankin AV+ ‚Äî <strong>CK17 aggressive PDAC</strong>. <em>Gastroenterology</em> 2012;142:730. <strong>(Subset basal-like, poor prognosis)</strong> <span style="color:var(--accent)">‚úì NEW v2.9</span><br>
        [29] French CA+ ‚Äî <strong>NUT midline carcinoma</strong>. <em>Cancer Res</em> 2014;74:2563. <strong>(BRD4-NUT fusion, BET inhibitors)</strong> <span style="color:var(--accent)">‚úì NEW v2.9</span><br>
        [30] NotebookLM 2026 ‚Äî <strong>TRPS1 mammella</strong>. <strong>(98.7% sens TNBC vs GATA3 67.5%, pitfall ovaio 40.5%)</strong> <span style="color:var(--accent)">‚úì NEW v2.9</span><br>
        [31] Rooper LM+ ‚Äî <strong>INSM1 NE/FP</strong>. <em>Am J Surg Pathol</em> 2017;41:316. <strong>(96.4% NEC, FP melanoma 13.2%, prostata 36.1%)</strong> <span style="color:var(--accent)">‚úì NEW v2.9</span><br>
        <br>
        <strong>‚≠ê v2.9 ULTIMATE:</strong><br>
        ‚Ä¢ 6 marker emergenti: TRPS1 (mammella 98.7%), INSM1 (NE 96.4%), BCL10 (acinare 90-95%), CK17 (uroteliale/PDAC), NUT (midline), Œ≤-catenina (SPT)<br>
        ‚Ä¢ Pannello pancreas completo: PDAC (CK17/CA19-9), Acinare (BCL10), NET (INSM1), SPT (Œ≤-catenina nucleare)<br>
        ‚Ä¢ TRPS1 pitfall: ovaio HGSC 40.5%, sempre PAX8/WT1 per discriminare<br>
        ‚Ä¢ INSM1 first-line NE: superiore CgA/SYN (87%), pattern diffuso vs focale critico<br>
        ‚Ä¢ 57 marker totali, 15 pattern morfologici, workflow evidence-based<br>
        <br>
        <strong>‚≠ê v2.11 QC TECNICO (NotebookLM #3):</strong><br>
        [32] Karamchandani DM+ ‚Äî <strong>Arginase-1 breast cross-react</strong>. <em>Am J Surg Pathol</em> 2013;37:850. <strong>(12.3% mammella Arg-1+)</strong> <span style="color:var(--accent)">‚úì NEW v2.11</span><br>
        [33] Bellizzi AM+ ‚Äî <strong>PAX8 clone specificity</strong>. <em>Am J Surg Pathol</em> 2013;37:356. <strong>(BC12 monoclonale vs policlonale cross-react linfomi)</strong> <span style="color:var(--accent)">‚úì NEW v2.11</span><br>
        [34] Ord√≥√±ez NG+ ‚Äî <strong>IHC troubleshooting artifacts</strong>. <em>Adv Anat Pathol</em> 2015;22:94. <strong>(Edge effect, retrieval errors, subcellular mismatch)</strong> <span style="color:var(--accent)">‚úì NEW v2.11</span><br>
        [35] Hammersmith Protocol ‚Äî <strong>Bone decalcification preservation</strong>. <strong>(Zinco-formalin + acido formico gold standard IHC/NGS)</strong> <span style="color:var(--accent)">‚úì NEW v2.11</span><br>
        <br>
        <strong>‚≠ê v2.11 BIG FOUR EVOLVED (NotebookLM #4):</strong><br>
        [36] ESMO Guidelines 2023 ‚Äî <strong>CUP stepwise approach</strong>. <strong>(Curabili-first, sottotipi favorevoli prima primitiva)</strong> <span style="color:var(--accent)">‚úì NEW v2.11</span><br>
        [37] Onkopedia 2025 ‚Äî <strong>Tissue-sparing algorithms</strong>. <strong>(Preservare per NGS/MMR/PD-L1 target therapy)</strong> <span style="color:var(--accent)">‚úì NEW v2.11</span><br>
        [38] Raab SS+ ‚Äî <strong>CK7/CK20 accuracy metastases</strong>. <strong>(40% pattern incoerenti aberrazione fenotipica alto grado)</strong> <span style="color:var(--accent)">‚úì NEW v2.11</span><br>
        [39] Tot T+ ‚Äî <strong>SATB2 vs CDX2 colorectal</strong>. <strong>(SATB2 99% spec, mantiene espressione MSI-H quando CDX2 loss)</strong> <span style="color:var(--accent)">‚úì NEW v2.11</span><br>
        <br>
        <strong>‚≠ê v2.11 ULTIMATE:</strong><br>
        ‚Ä¢ <strong>8 alert QC tecnici:</strong> Cross-react PAX8/linfomi (BC12 monoclonale), Decalcificazione ossea (loss nucleari), AE1/AE3 HCC/RCC (CK18 not recognized), CD56 tiroide (100% PTC), p16 pattern (block-like HPV), TTF1 citoplasmatico (HCC cross-react), CK7+/CK20+ uroteliale (50-60%), Merkel vs colon<br>
        ‚Ä¢ <strong>7 alert Big Four futility:</strong> Squamoso (controindicato), Lepidico (CK7 ridondante), Signet-ring (generico), Clear cell (PAX8 obbligatorio), Versamento (errore metodologico), CK7‚àí/CK20‚àí (Big Three lean), MSI-H (SATB2 salvataggio)<br>
        ‚Ä¢ <strong>QC validato:</strong> Localizzazione subcellulare mandatoria (nucleari assoluti vs membranosi), Clone-specific issues (TTF1 SPT24 vs 8G7G3/1, PAX8 policlonale vs BC12), Tissue aging (>2 settimane), Pre-analitica (fissazione, decalcificazione)<br>
        ‚Ä¢ <strong>Big Four retrocesso:</strong> Mappa base per casi senza indizi morfo-clinici, morfologia bypassa (lepidico, clear, signet, squamoso), sede bypassa (versamenti, osso, ascella), tissue-sparing per NGS<br>
        ‚Ä¢ <strong>Workflow epistemico:</strong> "Il reagente √® voce nel processo; giudizio finale ancorato morfologia. Se alert tecnico, fermati: vetrino grida che reagente ha mentito" ‚Äî NotebookLM 2026<br>
        <br>
        <strong>‚≠ê v2.11.1 PATTERN NULL + SWI/SNF (Fix critico Filippo):</strong><br>
        [40] Hollmann TJ+ ‚Äî <strong>INI1-deficient tumors</strong>. <em>Am J Surg Pathol</em> 2011;35:368. <strong>(Rabdoide pediatrico vs Epithelioid sarcoma adulto, loss >90% diagnostico)</strong> <span style="color:var(--accent)">‚úì NEW v2.11.1</span><br>
        [41] Le Loarer F+ ‚Äî <strong>SMARCA4-deficient undifferentiated CA</strong>. <em>Am J Surg Pathol</em> 2015;39:1656. <strong>(Giovani donne ovaio/torace, prognosi pessima 7-10 mesi, ipercalcemia 60%)</strong> <span style="color:var(--accent)">‚úì NEW v2.11.1</span><br>
        [42] Agaram NP+ ‚Äî <strong>SMARCB1/INI1 immunohistochemistry</strong>. <em>Adv Anat Pathol</em> 2014;21:400. <strong>(Loss pattern interpretation, controlli interni obbligatori)</strong> <span style="color:var(--accent)">‚úì NEW v2.11.1</span><br>
        <br>
        <strong>‚≠ê v2.11.1 ULTIMATE FIX:</strong><br>
        ‚Ä¢ <strong>Pattern Null alert:</strong> CK‚àí/CD45‚àí/Vim‚àí/S100‚àí ‚Üí 6 scenari (SWI/SNF, melanoma amelanotico, sarcoma indifferenziato, errore tecnico, artefatto pre-analitico, non neoplasia)<br>
        ‚Ä¢ <strong>2 marker loss critici:</strong> INI1/SMARCB1 (rabdoide/epithelioid), SMARCA4 (undifferentiated CA ipercalcemia)<br>
        ‚Ä¢ <strong>3 diagnosi nuove:</strong> Rabdoide tumor (pediatrico), Epithelioid sarcoma (adulto), SMARCA4-deficient CA (ovaio giovani donne)<br>
        ‚Ä¢ <strong>Gap chiuso:</strong> Tool era "blind" per tumori rabdoidi/SMARCA4-deficient ‚Üí FIX critico osservazione Filippo!<br>
        ‚Ä¢ <strong>59 marker totali</strong> (+2: INI1, SMARCA4), 42 bibliografia (+3 ref), alert pattern null implementato<br>
      `;
    }
    
    // ============================================
    // ‚≠ê NEW v2.12: IMMUNOPROFILE SEARCH FUNCTIONS
    // ============================================
    
    // ‚≠ê NEW v2.12.2: Helper to check if marker available at FBF Sacco
    function isMarkerAvailableSacco(markerName) {
      // Normalize marker name for matching
      const normalized = markerName.toLowerCase().trim();
      
      // Check in markers array if .sacco flag is present
      const match = markers.find(m => {
        const mName = m.name.toLowerCase();
        const mId = m.id.toLowerCase();
        return normalized.includes(mName) || 
               normalized.includes(mId) ||
               mName.includes(normalized) ||
               mId.includes(normalized);
      });
      
      // If found and has sacco flag, return true
      if (match && match.hasOwnProperty('sacco')) {
        return match.sacco === true;
      }
      
      // Default: assume NOT available (conservative)
      return false;
    }
    
    function populateDiagnosisSuggestions() {
      const datalist = document.getElementById('diagnosisSuggestions');
      immunoprofileDB.forEach(dx => {
        const option = document.createElement('option');
        option.value = dx.name;
        datalist.appendChild(option);
      });
    }
    
    function searchImmunoprofile() {
      const query = document.getElementById('predictSearch').value.toLowerCase().trim();
      const resultsDiv = document.getElementById('immunoprofileResults');
      
      if (!query) {
        resultsDiv.style.display = 'none';
        return;
      }
      
      // Fuzzy search: name or keywords
      const match = immunoprofileDB.find(dx => 
        dx.name.toLowerCase().includes(query) || 
        dx.keywords.some(kw => query.includes(kw))
      );
      
      if (!match) {
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = `
          <div style="padding: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px;">
            <p style="margin: 0; color: #92400e;">
              <strong>‚ùå Diagnosi non trovata:</strong> "${query}"<br>
              Database attualmente contiene ${immunoprofileDB.length} diagnosi. Prova: ${immunoprofileDB.map(d => d.name).join(', ')}
            </p>
          </div>
        `;
        return;
      }
      
      // Found! Render immunoprofile
      let html = `
        <div style="background: white; border: 2px solid #0284c7; border-radius: 12px; padding: 25px;">
          <h3 style="color: #0369a1; margin-top: 0; font-size: 1.4rem; border-bottom: 2px solid #0284c7; padding-bottom: 10px;">
            üìä IMMUNOPROFILO ATTESO ‚Äî ${match.name}
          </h3>
          
          <!-- POSITIVI -->
          <div style="margin-bottom: 25px;">
            <h4 style="color: var(--pos); font-size: 1.1rem; margin-bottom: 12px;">
              ‚úÖ Positivi (Alta probabilit√†):
            </h4>
            <ul style="margin: 0; padding-left: 20px;">
      `;
      
      match.positive.forEach(m => {
        const isSacco = isMarkerAvailableSacco(m.marker);
        const saccoBadge = isSacco 
          ? `<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 8px;">‚úÖ FBF Sacco</span>`
          : `<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 8px;">‚ö†Ô∏è Esterno</span>`;
        
        html += `<li style="margin-bottom: 8px; line-height: 1.5;">
          <strong>${m.marker}:</strong> ${m.pct} ${saccoBadge} ${m.note ? `<span style="color: var(--pos);">${m.note}</span>` : ''}
          ${m.pattern ? `<br><span style="font-size: 0.85rem; color: #64748b;">Pattern: ${m.pattern}</span>` : ''}
        </li>`;
      });
      
      html += `
            </ul>
          </div>
          
          <!-- NEGATIVI -->
          <div style="margin-bottom: 25px;">
            <h4 style="color: var(--neg); font-size: 1.1rem; margin-bottom: 12px;">
              ‚ùå Negativi (Alta probabilit√†):
            </h4>
            <ul style="margin: 0; padding-left: 20px;">
      `;
      
      match.negative.forEach(m => {
        const isSacco = isMarkerAvailableSacco(m.marker);
        const saccoBadge = isSacco 
          ? `<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 8px;">‚úÖ FBF Sacco</span>`
          : `<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 8px;">‚ö†Ô∏è Esterno</span>`;
        
        html += `<li style="margin-bottom: 8px;">
          <strong>${m.marker}:</strong> ${m.pct} ${saccoBadge} ${m.note ? `<span style="color: #64748b; font-style: italic;">(${m.note})</span>` : ''}
        </li>`;
      });
      
      html += `
            </ul>
          </div>
      `;
      
      // MOLECOLARE
      if (match.molecular && match.molecular.length > 0) {
        html += `
          <div style="margin-bottom: 25px; background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #0284c7;">
            <h4 style="color: #0369a1; font-size: 1.1rem; margin-top: 0; margin-bottom: 10px;">
              üß¨ Molecolare:
            </h4>
            <ul style="margin: 0; padding-left: 20px;">
        `;
        match.molecular.forEach(m => {
          html += `<li style="margin-bottom: 6px;">${m}</li>`;
        });
        html += `
            </ul>
          </div>
        `;
      }
      
      // MORFOLOGIA
      if (match.morphology && match.morphology.length > 0) {
        html += `
          <div style="margin-bottom: 25px; background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
            <h4 style="color: #92400e; font-size: 1.1rem; margin-top: 0; margin-bottom: 10px;">
              üî¨ Morfologia Chiave:
            </h4>
            <ul style="margin: 0; padding-left: 20px;">
        `;
        match.morphology.forEach(m => {
          html += `<li style="margin-bottom: 6px;">${m}</li>`;
        });
        html += `
            </ul>
          </div>
        `;
      }
      
      // DDx
      if (match.ddx && match.ddx.length > 0) {
        html += `
          <div style="margin-bottom: 25px; background: #fef2f2; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
            <h4 style="color: #991b1b; font-size: 1.1rem; margin-top: 0; margin-bottom: 10px;">
              ‚ö†Ô∏è DDx Critici (se pattern anomalo):
            </h4>
            <ul style="margin: 0; padding-left: 20px;">
        `;
        match.ddx.forEach(d => {
          html += `<li style="margin-bottom: 6px;">${d}</li>`;
        });
        html += `
            </ul>
          </div>
        `;
      }
      
      // REFS
      if (match.refs && match.refs.length > 0) {
        html += `
          <div style="font-size: 0.85rem; color: #64748b; border-top: 1px solid #e2e8f0; padding-top: 12px;">
            <strong>Bibliografia:</strong> ${match.refs.join(', ')}
          </div>
        `;
      }
      
      html += `</div>`;
      
      resultsDiv.innerHTML = html;
      resultsDiv.style.display = 'block';
      
      // Scroll to results
      resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    function clearImmunoprofile() {
      document.getElementById('predictSearch').value = '';
      document.getElementById('immunoprofileResults').style.display = 'none';
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      populateDiagnosisSuggestions();
      
      // Enter key support
      document.getElementById('predictSearch').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          searchImmunoprofile();
        }
      });
    });

    // ===== DISPONIBILIT√Ä ANTICORPI (BIANCO=FBF, ROSA=SACCO) =====
    const ANTICORPI_DISPONIBILITA = {
      "Œ±-FETOPROTEINA": "FBF", "ACTINA HHF35": "FBF", "ACTINA M.L.": "FBF", "ALK-1": "SACCO",
      "ALK D5F3": "SACCO", "AMILOIDE Œõ": "SACCO", "AMILOIDE P": "SACCO", "ANDROGENI": "FBF",
      "ANNEXIN A1": "SACCO", "ARID1A": "SACCO", "ARGINASE": "FBF", "ATRX": "FBF",
      "BCL-1": "FBF", "BCL-2": "FBF", "BCL-6": "FBF", "BCL-10": "FBF",
      "Œ≤-CATENINA": "FBF", "BRG-1/SMARCA4": "FBF", "CA-125": "FBF", "CA-IX": "FBF",
      "CALCITONINA": "FBF", "CALDESMON": "FBF", "CALPONINA": "FBF", "CALRETININA": "FBF",
      "CEA MONO": "FBF", "CEA POLI": "SACCO", "CLAUDINA -18": "FBF", "C-MYC": "FBF",
      "CMV": "SACCO", "COLLAGENE IV": "SACCO", "CROMOGRANINA": "FBF", "CD-1": "FBF",
      "CD-2": "FBF", "CD-3": "FBF", "CD-4": "FBF", "CD-5": "FBF", "CD-7": "FBF",
      "CD-8": "FBF", "CD-10": "SACCO", "CD-11": "SACCO", "CD-14": "SACCO", "CD-15": "FBF",
      "CD-19": "FBF", "CD-20": "FBF", "CD-21": "FBF", "CD-23": "FBF", "CD-30": "FBF",
      "CD-31": "FBF", "CD-34": "FBF", "CD-38": "FBF", "CD-43": "SACCO", "CD-44": "FBF",
      "CD-45": "FBF", "CD-56": "SACCO", "CD-57": "SACCO", "CD-61": "FBF",
      "CD-68 PG-M1": "FBF", "CD-68 KPI": "FBF", "CD-79": "FBF", "CD-99": "FBF",
      "CD-117": "FBF", "CD-138": "SACCO", "CD-146": "SACCO", "CD-163": "FBF",
      "CDK4": "FBF", "CDX-2": "FBF", "CK 5/6": "FBF", "CK 7": "FBF", "CK 19": "FBF",
      "CK 20": "FBF", "CK 34Œ≤E12": "FBF", "CK (AE1-AE3)": "FBF", "CK CAM 5.2": "FBF",
      "D2-40": "FBF", "DESMINA": "FBF", "DOG1": "FBF", "EBV/EBER": "SACCO",
      "E-CADERINA": "FBF", "EMA": "FBF", "EP-CAM": "FBF", "ERG": "FBF", "ER": "FBF",
      "FATTORE VIII": "FBF", "FATTORE XIII": "FBF", "FUMARATO IDRATASI": "FBF",
      "GALECTINA 3": "FBF", "GATA3": "FBF", "GASTRINA": "SACCO", "GCDFP 15": "SACCO",
      "GFAP": "FBF", "GLICOFORINA": "FBF", "GLYPICAN 3": "FBF", "GLUT-1": "FBF",
      "GLUT SINTETASI": "FBF", "HCG": "FBF", "HER-2": "FBF", "HGAL": "FBF",
      "HHIV8": "FBF", "HMB45": "FBF", "HPL": "SACCO", "HPV": "SACCO", "HSA": "FBF",
      "HSV 1": "SACCO", "HSV 2": "SACCO", "IDH1": "FBF", "IGD": "SACCO", "IGG": "SACCO",
      "IGG4": "FBF", "INIBINA-1": "SACCO", "KI-67": "FBF", "Œ∫": "FBF", "Œª": "FBF",
      "MAMMOGLOBINA": "FBF", "MDM2": "FBF", "MELAN-A": "FBF", "MIELOPEROSSIDASI": "FBF",
      "MIOGENINA": "FBF", "MLH1": "FBF", "MSH2": "FBF", "MSH6": "FBF",
      "MUC-1": "SACCO", "MUC-2": "SACCO", "MUC-4": "SACCO", "MUC-6": "SACCO",
      "MUM-1": "FBF", "MYOD1": "SACCO", "NAPSINA": "FBF", "NEUROFILAMENTI": "FBF",
      "NKX3": "FBF", "NSE": "FBF", "OCT-2": "SACCO", "OCT-3,4": "SACCO", "OLIG-2": "FBF",
      "P16": "FBF", "P40": "FBF", "P53": "FBF", "P57": "FBF", "P63": "FBF",
      "PARVOVIRUS B19": "SACCO", "PAX-5": "FBF", "PAX-8": "FBF", "PDL1 (SP263)": "FBF",
      "PDL1 (SP142)": "FBF", "PDL1 NFG CTRL": "FBF", "PERFORMA": "SACCO", "PHH3": "FBF",
      "PLAP": "FBF", "PMS2 O A": "FBF", "PR": "FBF", "PRAME": "FBF", "PSA": "FBF",
      "PSAP": "FBF", "PTEN": "FBF", "PTH": "SACCO", "RACEMASI": "FBF", "RCC": "FBF",
      "S100": "FBF", "SALL4": "FBF", "SATB2": "FBF", "SOX-2": "SACCO", "SOX-10": "FBF",
      "SOX-11": "FBF", "SF1": "SACCO", "SINAPTOFSINA": "FBF", "STAT6": "FBF",
      "SV40": "SACCO", "TDT": "FBF", "TIA-1": "SACCO", "THYROGLOBULIN": "FBF",
      "TTF1": "FBF", "VIMENTINA": "FBF", "WT1": "FBF"
    };

    function colorizeAntibodies(text, positiveMarkerIds = []) {
      if (!text || typeof text !== 'string') return text;
      let result = text;
      const sortedAbs = Object.keys(ANTICORPI_DISPONIBILITA).sort((a, b) => b.length - a.length);
      
      sortedAbs.forEach(ab => {
        // Trova il marker che corrisponde a questo anticorpo
        let matchedMarker = null;
        for (const marker of markers) {
          if (marker.name.toUpperCase().includes(ab.toUpperCase()) || ab.toUpperCase().includes(marker.name.toUpperCase())) {
            matchedMarker = marker;
            break;
          }
        }
        
        if (!matchedMarker) return;
        
        // Controlla lo stato del marker
        const state = markerState[matchedMarker.id];
        
        // Se non √® stato testato (ND), non lo mostra
        if (state === 'not-tested' || !state) return;
        
        // Determina il simbolo [+] o [-]
        const symbol = state === 'positive' ? '[+]' : '[-]';
        
        const avail = ANTICORPI_DISPONIBILITA[ab];
        let color = avail === "FBF" ? "#10b981" : avail === "SACCO" ? "#f59e0b" : "#ef4444";
        let label = avail === "FBF" ? "FBF" : avail === "SACCO" ? "SACCO" : "N.D.";
        let rgb = color === '#10b981' ? '16,185,129' : color === '#f59e0b' ? '245,158,11' : '239,68,68';
        let regex = new RegExp(`\\b${ab.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&')}\\b`, 'gi');
        
        result = result.replace(regex, m => `<span style="color:${color};font-weight:700;background:rgba(${rgb},0.15);padding:3px 8px;border-radius:4px;cursor:help;border-bottom:2px solid ${color};" title="${ab} ${symbol} (${label})">${m} <strong style="color:${color};">${symbol}</strong></span>`);
      });
      
      return result;
    }

    function calculate() {
      const diagnoses = getDiagnoses();
      const alerts = getAlerts();
      const morphAlerts = getMorphologyAlerts(); // ‚≠ê v2.4
      
      // ‚≠ê Traccia gli anticorpi cliccati (positivi)
      const positiveMarkerIds = [];
      markers.forEach(marker => {
        const checkbox = document.getElementById('cb_' + marker.id);
        if (checkbox && checkbox.checked) {
          positiveMarkerIds.push(marker.id);
        }
      });
      const siteAlerts = getSiteSpecificAlerts(); // ‚≠ê v2.10: Sede-specific
      const qcAlerts = getQCAlerts(); // ‚≠ê v2.11: QC tecnici
      const bigFourAlerts = getBigFourFutilityAlerts(); // ‚≠ê v2.11: Big Four futility
      const epistemicAlerts = getEpistemicAlerts(); // ‚≠ê NEW v2.13: Umilt√† epistemica (NotebookLM)
      const allAlerts = [...epistemicAlerts, ...qcAlerts, ...bigFourAlerts, ...siteAlerts, ...alerts, ...morphAlerts]; // Merge (Epistemic FIRST!)
      const suggestions = getSuggestions();
      const gaps = getGaps(currentPanel);

      document.getElementById('results').style.display = 'block';

      const alertsSection = document.getElementById('alertsSection');
      const alertsContainer = document.getElementById('alertsContainer');
      if (allAlerts.length > 0) {
        alertsSection.style.display = 'block';
        alertsContainer.innerHTML = allAlerts.map(alert => `
          <div class="alert-card ${alert.type}">
            <div class="card-title">${alert.title}</div>
            <div class="card-detail">${alert.detail}</div>
          </div>
        `).join('');
      } else {
        alertsSection.style.display = 'none';
      }

      const diagnosesSection = document.getElementById('diagnosesSection');
      const diagnosesContainer = document.getElementById('diagnosesContainer');
      if (diagnoses.length > 0) {
        diagnosesSection.style.display = 'block';
        
        // PRIMARY DIAGNOSIS - MEGA BOX FIRST
        const primaryDx = diagnoses[0];
        const confColor = primaryDx.conf === 'high' ? '#10b981' : primaryDx.conf === 'medium' ? '#f59e0b' : '#ef4444';
        const confBg = primaryDx.conf === 'high' ? '#dcfce7' : primaryDx.conf === 'medium' ? '#fef3c7' : '#fee2e2';
        
        let html = `
          <div style="margin-bottom: 50px; padding: 25px; background: linear-gradient(135deg, ${confBg} 0%, white 100%); border: 5px solid ${confColor}; border-radius: 20px; box-shadow: 0 16px 48px rgba(0,0,0,0.25); position: relative;">
            <div style="position: absolute; top: 0; left: 25px; background: ${confColor}; color: white; padding: 10px 25px; border-radius: 0 0 14px 14px; font-size: 1rem; font-weight: 900; letter-spacing: 1.5px; text-transform: uppercase; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">‚≠ê DIAGNOSI PRINCIPALE</div>
            <h1 style="margin: 35px 0 20px 0; color: ${confColor}; font-size: 2.2rem; font-weight: 950; line-height: 1.1; word-wrap: break-word;">${colorizeAntibodies(primaryDx.name, positiveMarkerIds)}</h1>
            <div style="display: inline-block; background: ${confColor}; color: white; padding: 14px 28px; border-radius: 12px; font-size: 1.2rem; font-weight: 800; margin-bottom: 25px; box-shadow: 0 6px 16px rgba(0,0,0,0.2); letter-spacing: 0.5px;">
              ${primaryDx.conf === 'high' ? 'üî¥ ALTA CONFIDENZA' : primaryDx.conf === 'medium' ? 'üü° MEDIA CONFIDENZA' : '‚ö™ BASSA CONFIDENZA'}
            </div>
            <div style="background: white; padding: 25px; border-radius: 14px; border-left: 10px solid ${confColor}; margin-top: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <p style="margin: 0; font-size: 1.15rem; line-height: 1.9; color: #1e293b; font-weight: 500;">${colorizeAntibodies(primaryDx.detail, positiveMarkerIds)}</p>
            </div>
          </div>
        `;
        
        // DDx if multiple
        if (diagnoses.length > 1) {
          html += `<div style="margin-bottom: 35px; padding: 22px; background: #f8fafc; border: 2px solid #1e40af; border-radius: 12px;"><h3 style="color: #1e40af; margin: 0 0 18px 0; font-size: 1.3rem; font-weight: 700; border-bottom: 3px solid #1e40af; padding-bottom: 10px;">üìã DIAGNOSI DIFFERENZIALI</h3>`;
          diagnoses.slice(1).forEach((dx, idx) => {
            const dxColor = dx.conf === 'high' ? '#10b981' : dx.conf === 'medium' ? '#f59e0b' : '#ef4444';
            html += `<div style="margin-bottom: 12px; padding: 16px; background: white; border-left: 6px solid ${dxColor}; border-radius: 8px;"><div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px;"><strong style="font-size: 1.15rem;">${idx + 2}. ${colorizeAntibodies(dx.name, positiveMarkerIds)}</strong><span style="font-size: 0.85rem; padding: 6px 14px; background: ${dxColor}; color: white; border-radius: 6px; font-weight: 700;">${dx.conf === 'high' ? 'üî¥ Alta' : dx.conf === 'medium' ? 'üü° Media' : '‚ö™ Bassa'}</span></div><p style="margin: 0; font-size: 0.95rem; color: #475569; line-height: 1.7;">${colorizeAntibodies(dx.detail, positiveMarkerIds)}</p></div>`;
          });
          html += `</div>`;
        }
        
        diagnosesContainer.innerHTML = html;
      } else {
        diagnosesSection.style.display = 'none';
      }

      // ‚≠ê v2.17: Enhanced Probability Visualization
      const probabilities = calculateProbabilities();
      const probabilitySection = document.getElementById('probabilitySection');
      const probabilityContainer = document.getElementById('probabilityContainer');
      if (probabilities.length > 0) {
        probabilitySection.style.display = 'block';
        probabilityContainer.innerHTML = probabilities.map((prob, idx) => {
          const barWidth = prob.probability;
          const barColor = prob.probability >= 70 ? '#10b981' : prob.probability >= 40 ? '#f59e0b' : '#64748b';
          
          // Get marker names for display
          const matchedPosNames = prob.matchedPositives.map(id => 
            markers.find(m => m.id === id)?.name || id
          ).join(', ');
          
          const violatedNegNames = prob.violatedNegatives.map(id => 
            markers.find(m => m.id === id)?.name || id
          ).join(', ');
          
          // Prior badge color
          const priorPct = (prob.prior * 100).toFixed(1);
          const priorColor = prob.prior >= 0.10 ? '#10b981' : prob.prior >= 0.05 ? '#f59e0b' : '#94a3b8';
          
          return `
            <div style="margin-bottom: 20px; padding: 15px; background: #fafafa; border-radius: 8px; border-left: 4px solid ${barColor};">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong style="font-size: 1.1rem; color: #1e293b;">${idx + 1}. ${prob.name}</strong>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <span style="font-size: 0.75rem; padding: 2px 8px; background: ${priorColor}; color: white; border-radius: 4px; font-weight: 600;" title="Prior prevalence P(Dx) from mortality data">P(Dx): ${priorPct}%</span>
                  <span style="font-size: 1.3rem; font-weight: 700; color: ${barColor};">${prob.probability}%</span>
                </div>
              </div>
              
              <div style="width: 100%; height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden; margin-bottom: 10px;">
                <div style="width: ${barWidth}%; height: 100%; background: ${barColor}; transition: width 0.3s;"></div>
              </div>
              
              <div style="font-size: 0.9rem; color: #64748b;">
                ${matchedPosNames ? `<div style="margin-bottom: 4px;">‚úÖ <strong>Match positivi:</strong> <span style="color: #10b981; font-weight: 600;">${matchedPosNames}</span> (${prob.matchedPositives.length}/${prob.expectedPositives.length})</div>` : ''}
                ${prob.matchedNegatives.length > 0 ? `<div style="margin-bottom: 4px;">‚äñ <strong>Negativi confermati:</strong> <span style="font-weight: 600;">${prob.matchedNegatives.length}</span></div>` : ''}
                ${violatedNegNames ? `<div style="color: #dc2626; font-weight: 600; margin-bottom: 4px;">‚ö†Ô∏è <strong>Violazioni:</strong> ${violatedNegNames} (attesi negativi!)</div>` : ''}
                ${prob.likelihood !== undefined ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-size: 0.8rem; color: #94a3b8;"><em>üìä Likelihood: ${(prob.likelihood * 100).toFixed(1)}% | Prior: ${priorPct}% ‚Üí <strong style="color: ${barColor};">Bayes: ${prob.probability}%</strong></em></div>` : ''}
              </div>
            </div>
          `;
        }).join('');
      } else {
        probabilitySection.style.display = 'none';
      }

      const suggestionsSection = document.getElementById('suggestionsSection');
      const suggestionsContainer = document.getElementById('suggestionsContainer');
      if (suggestions.length > 0) {
        suggestionsSection.style.display = 'block';
        suggestionsContainer.innerHTML = suggestions.map(s => `
          <div class="suggestion-card">
            <div class="card-detail">${s}</div>
          </div>
        `).join('');
      } else {
        suggestionsSection.style.display = 'none';
      }

      const gapsSection = document.getElementById('gapsSection');
      const gapsContainer = document.getElementById('gapsContainer');
      if (gaps.length > 0) {
        gapsSection.style.display = 'block';
        gapsContainer.innerHTML = gaps.map(g => `
          <div class="suggestion-card">
            <div class="card-detail">${g}</div>
          </div>
        `).join('');
      } else {
        gapsSection.style.display = 'none';
      }

      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }

    document.addEventListener('DOMContentLoaded', function() {
      // ‚≠ê v2.6: Carica stato salvato (se esiste)
      const stateLoaded = loadState();
      
      renderFirstLine();
      renderBigFour();
      renderPanelGrid();
      renderMarkerPanels();
      
      // ‚≠ê v2.4.1 FIX: Morphology checkbox listeners
      document.querySelectorAll('.morphology-item input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', () => syncMorphologyUI(cb));
        syncMorphologyUI(cb); // stato iniziale
      });
      
      // ‚≠ê v2.5: Initialize auto-panel suggestions
      updateAutoPanelSuggestions();
      
      // ‚≠ê v2.6: Mostra notifica se stato caricato
      if (stateLoaded) {
        const notice = document.createElement('div');
        notice.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #dcfce7; border: 2px solid #059669; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; font-size: 0.9rem; color: #065f46;';
        notice.innerHTML = '<strong>‚úì Stato ripristinato</strong> - Sessione precedente caricata';
        document.body.appendChild(notice);
        setTimeout(() => notice.remove(), 3000);
      }
    });

    // ============================================
    // ‚≠ê NEW v2.22: EXPORT REPORT FUNCTIONS
    // ============================================
    
    function copyReportHTML() {
      const report = generateReport();
      
      // Copy HTML to clipboard
      const blob = new Blob([report.html], { type: 'text/html' });
      const textBlob = new Blob([report.html], { type: 'text/plain' });
      
      const clipboardItem = new ClipboardItem({
        'text/html': blob,
        'text/plain': textBlob
      });
      
      navigator.clipboard.write([clipboardItem]).then(() => {
        showCopyNotification('‚úÖ Referto HTML copiato! Incolla in Word per mantenere formattazione.');
      }).catch(err => {
        // Fallback: copy as text
        navigator.clipboard.writeText(report.html).then(() => {
          showCopyNotification('‚úÖ Referto copiato come HTML (fallback). Incolla in editor.');
        });
      });
    }
    
    function copyReportText() {
      const report = generateReport();
      
      navigator.clipboard.writeText(report.text).then(() => {
        showCopyNotification('‚úÖ Referto testo copiato negli appunti!');
      }).catch(err => {
        showCopyNotification('‚ùå Errore copia: ' + err.message, true);
      });
    }
    
    function showReportPreview() {
      const report = generateReport();
      
      // Create modal
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      
      const content = document.createElement('div');
      content.style.cssText = 'background: white; border-radius: 12px; max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative;';
      
      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '‚úï';
      closeBtn.style.cssText = 'position: absolute; top: 15px; right: 15px; background: #ef4444; color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: bold;';
      closeBtn.onclick = () => modal.remove();
      
      content.innerHTML = report.html;
      content.insertBefore(closeBtn, content.firstChild);
      
      modal.appendChild(content);
      document.body.appendChild(modal);
    }
    
    function showCopyNotification(message, isError = false) {
      const notice = document.createElement('div');
      const bgColor = isError ? '#fef2f2' : '#dcfce7';
      const borderColor = isError ? '#ef4444' : '#10b981';
      const textColor = isError ? '#991b1b' : '#065f46';
      
      notice.style.cssText = `position: fixed; top: 20px; right: 20px; background: ${bgColor}; border: 2px solid ${borderColor}; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; font-size: 0.9rem; color: ${textColor}; max-width: 350px;`;
      notice.innerHTML = message;
      document.body.appendChild(notice);
      setTimeout(() => notice.remove(), 4000);
    }

  </script>
</body>
</html>
